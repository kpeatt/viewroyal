---
phase: 14-scheduled-automation
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - apps/pipeline/scripts/run-pipeline.sh
  - apps/pipeline/com.viewroyal.pipeline.plist
autonomous: false
requirements: [SCHED-01]

must_haves:
  truths:
    - "A launchd plist is installed on the Mac Mini that triggers the pipeline daily at a configured time"
    - "The wrapper script activates the correct Python environment and sets required env vars"
    - "After 24+ hours of no manual intervention, the pipeline has run automatically"
  artifacts:
    - path: "apps/pipeline/scripts/run-pipeline.sh"
      provides: "Shell wrapper that cd's to pipeline dir, activates uv environment, runs update-mode"
      contains: "uv run python main.py --update-mode"
    - path: "apps/pipeline/com.viewroyal.pipeline.plist"
      provides: "launchd plist for daily scheduled execution"
      contains: "StartCalendarInterval"
  key_links:
    - from: "apps/pipeline/com.viewroyal.pipeline.plist"
      to: "apps/pipeline/scripts/run-pipeline.sh"
      via: "ProgramArguments referencing the shell script path"
      pattern: "run-pipeline.sh"
    - from: "apps/pipeline/scripts/run-pipeline.sh"
      to: "apps/pipeline/main.py"
      via: "uv run python main.py --update-mode invocation"
      pattern: "uv run python main.py --update-mode"
---

<objective>
Create the launchd plist and wrapper script for daily unattended pipeline execution.

Purpose: The pipeline must run every day without manual intervention. A launchd plist triggers a shell script at the configured time, which invokes the pipeline in update-mode. The lockfile and logging from Plan 01 ensure safe concurrent protection and output capture.

Output: run-pipeline.sh wrapper script, com.viewroyal.pipeline.plist, installation instructions
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-scheduled-automation/14-01-SUMMARY.md
@apps/pipeline/main.py
@apps/pipeline/pipeline/paths.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wrapper script and launchd plist</name>
  <files>
    apps/pipeline/scripts/run-pipeline.sh
    apps/pipeline/com.viewroyal.pipeline.plist
  </files>
  <action>
Create two files:

**scripts/run-pipeline.sh** -- Shell wrapper for launchd:
```bash
#!/bin/bash
# ViewRoyal.ai Pipeline - Daily Update Runner
# Invoked by launchd (com.viewroyal.pipeline.plist)

set -euo pipefail

# Project paths
PIPELINE_DIR="$HOME/development/viewroyal/apps/pipeline"

# Load environment variables (.env in pipeline dir has Supabase, Gemini, Moshi tokens)
if [ -f "$PIPELINE_DIR/.env" ]; then
    set -a
    source "$PIPELINE_DIR/.env"
    set +a
fi

cd "$PIPELINE_DIR"

# Run pipeline in update-mode (detect changes, re-process, notify)
# Lockfile prevents overlapping runs; logging captures all output to logs/pipeline.log
"$HOME/.local/bin/uv" run python main.py --update-mode 2>&1

exit $?
```

Make the script executable: `chmod +x apps/pipeline/scripts/run-pipeline.sh`

Note: The path to `uv` uses the standard install location `$HOME/.local/bin/uv`. launchd runs with a minimal PATH that does NOT include ~/.local/bin, so the absolute path is required. The `2>&1` ensures stderr is also captured by the logging TeeStream.

**com.viewroyal.pipeline.plist** -- launchd job definition:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.viewroyal.pipeline</string>

    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>/Users/kyle/development/viewroyal/apps/pipeline/scripts/run-pipeline.sh</string>
    </array>

    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>6</integer>
        <key>Minute</key>
        <integer>0</integer>
    </dict>

    <key>StandardOutPath</key>
    <string>/Users/kyle/development/viewroyal/logs/launchd-pipeline.stdout.log</string>
    <key>StandardErrorPath</key>
    <string>/Users/kyle/development/viewroyal/logs/launchd-pipeline.stderr.log</string>

    <key>WorkingDirectory</key>
    <string>/Users/kyle/development/viewroyal/apps/pipeline</string>

    <key>EnvironmentVariables</key>
    <dict>
        <key>HOME</key>
        <string>/Users/kyle</string>
        <key>PATH</key>
        <string>/usr/local/bin:/usr/bin:/bin:/Users/kyle/.local/bin</string>
    </dict>
</dict>
</plist>
```

Key design decisions:
- **6:00 AM daily** via StartCalendarInterval -- council meetings are published during business hours, so 6 AM catches overnight changes before the workday. User can adjust the hour/minute in the plist.
- **StandardOutPath/StandardErrorPath** point to the project's logs/ directory for launchd-level output (separate from the rotating pipeline.log which captures application-level output). These are fallback captures in case something fails before the Python logging initializes.
- **HOME and PATH** are explicitly set because launchd runs with a minimal environment that doesn't source shell profiles.
- The plist references the script by absolute path since launchd doesn't expand ~.
  </action>
  <verify>
Verify script is executable: `ls -la apps/pipeline/scripts/run-pipeline.sh` shows -rwxr-xr-x.
Verify plist is valid XML: `plutil -lint apps/pipeline/com.viewroyal.pipeline.plist` returns "OK".
Verify script references correct paths: grep for `uv run python main.py --update-mode` in the script.
  </verify>
  <done>
run-pipeline.sh wrapper script is executable, sources .env, runs update-mode with absolute uv path. Plist is valid XML, schedules daily at 6 AM, captures stdout/stderr to logs/.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Install launchd plist and verify first scheduled run</name>
  <action>
  Install the launchd plist on the Mac Mini. This requires the user to run the symlink and load commands because launchd configuration is a system-level action.
  </action>
  <instructions>
Install the plist by running these commands:

1. **Create the logs directory** (if not already created by Plan 01):
   ```bash
   mkdir -p ~/development/viewroyal/logs
   ```

2. **Symlink the plist into LaunchAgents:**
   ```bash
   ln -sf ~/development/viewroyal/apps/pipeline/com.viewroyal.pipeline.plist ~/Library/LaunchAgents/com.viewroyal.pipeline.plist
   ```

3. **Load the job:**
   ```bash
   launchctl load ~/Library/LaunchAgents/com.viewroyal.pipeline.plist
   ```

4. **Verify it's loaded:**
   ```bash
   launchctl list | grep viewroyal
   ```
   Should show a line with `com.viewroyal.pipeline`.

5. **Test a manual trigger** (optional -- to verify before waiting for 6 AM):
   ```bash
   launchctl start com.viewroyal.pipeline
   ```
   Then check:
   - `cat ~/development/viewroyal/logs/pipeline.log` -- should show pipeline output
   - `cat ~/development/viewroyal/logs/launchd-pipeline.stdout.log` -- launchd-level stdout
   - Phone should receive a Moshi notification if new content was found (or no notification if nothing changed)

6. **Wait 24+ hours**, then verify:
   - `cat ~/development/viewroyal/logs/pipeline.log` -- shows a run at ~6:00 AM
   - If new content was detected, it appears in the web app
   - If no new content, log shows "No new content detected."

To **unload** the job later: `launchctl unload ~/Library/LaunchAgents/com.viewroyal.pipeline.plist`
To **change the schedule**: edit the `Hour` and `Minute` values in the plist, then unload + reload.
  </instructions>
  <resume-signal>Type "verified" after confirming the pipeline ran automatically, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. `plutil -lint apps/pipeline/com.viewroyal.pipeline.plist` returns OK
2. `run-pipeline.sh` is executable and contains `uv run python main.py --update-mode`
3. `launchctl list | grep viewroyal` shows the job is loaded
4. After manual `launchctl start`, logs/pipeline.log contains pipeline output
5. After 24+ hours, logs/pipeline.log shows an automatic 6 AM run
</verification>

<success_criteria>
- launchd plist is valid, loaded, and scheduled for daily execution
- Wrapper script correctly sources .env, cd's to pipeline dir, invokes update-mode
- After 24+ hours of no intervention, pipeline has run and new content (if any) is in the web app
- Logs directory contains pipeline.log with timestamped output from the automated run
</success_criteria>

<output>
After completion, create `.planning/phases/14-scheduled-automation/14-02-SUMMARY.md`
</output>
