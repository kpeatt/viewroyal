---
phase: 08-unified-search-hybrid-rag
plan: 03
type: execute
wave: 3
depends_on:
  - 08-01
  - 08-02
files_modified:
  - apps/web/app/routes/search.tsx
  - apps/web/app/components/search/search-input.tsx
  - apps/web/app/components/search/search-tabs.tsx
  - apps/web/app/components/search/ai-answer.tsx
  - apps/web/app/components/search/search-results.tsx
  - apps/web/app/components/search/result-card.tsx
  - apps/web/app/components/search/citation-badge.tsx
  - apps/web/app/components/search/source-cards.tsx
requirements:
  - SRCH-01
  - SRCH-02
autonomous: true
must_haves:
  truths:
    - "A single /search page exists with a prominent search input"
    - "Keyword queries show a unified ranked results list with content type filters"
    - "Question queries show a streaming AI answer with inline citations"
    - "The page has two tabs: AI Answer and Search Results, both accessible for any query"
    - "Each result card shows type-appropriate icon, metadata, and preview content"
    - "Citation badges [1], [2] have hover previews showing source content"
  artifacts:
    - path: "apps/web/app/routes/search.tsx"
      provides: "Unified search page with tabbed results"
      min_lines: 100
    - path: "apps/web/app/components/search/ai-answer.tsx"
      provides: "Streaming AI answer display with markdown and citations"
      min_lines: 50
    - path: "apps/web/app/components/search/search-results.tsx"
      provides: "Unified ranked results list with filter controls"
      min_lines: 50
    - path: "apps/web/app/components/search/result-card.tsx"
      provides: "Type-aware result card component"
      min_lines: 40
    - path: "apps/web/app/components/search/citation-badge.tsx"
      provides: "Inline citation with hover preview"
      min_lines: 30
  key_links:
    - from: "apps/web/app/routes/search.tsx"
      to: "/api/search"
      via: "EventSource for AI answers, fetch for keyword results"
      pattern: "EventSource|/api/search"
    - from: "apps/web/app/components/search/ai-answer.tsx"
      to: "apps/web/app/components/search/citation-badge.tsx"
      via: "CitationBadge component usage"
      pattern: "CitationBadge"
    - from: "apps/web/app/routes/search.tsx"
      to: "apps/web/app/lib/intent.ts"
      via: "classifyIntent for tab selection"
      pattern: "classifyIntent"
---

<objective>
Build the unified search page UI with Perplexity-style tabbed results, streaming AI answers, and type-filtered search results.

Purpose: This is the primary user-facing deliverable -- the single search page that replaces both /search and /ask. It needs to feel as polished as Perplexity: single input, auto-detecting intent, showing AI answers with streaming and citations in one tab and ranked results in another.

Output: A complete search.tsx route with supporting search/* components. The old search.tsx is fully replaced.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-unified-search-hybrid-rag/08-RESEARCH.md
@.planning/phases/08-unified-search-hybrid-rag/08-01-SUMMARY.md
@.planning/phases/08-unified-search-hybrid-rag/08-02-SUMMARY.md

Key existing files to reference for patterns:
@apps/web/app/routes/ask.tsx (CitationBadge, ResearchStep, markdown patterns -- move to search components)
@apps/web/app/routes/search.tsx (current search page -- being replaced)
@apps/web/app/components/ui/tabs.tsx (shadcn tabs component)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search UI components</name>
  <files>
    apps/web/app/components/search/search-input.tsx
    apps/web/app/components/search/search-tabs.tsx
    apps/web/app/components/search/ai-answer.tsx
    apps/web/app/components/search/search-results.tsx
    apps/web/app/components/search/result-card.tsx
    apps/web/app/components/search/citation-badge.tsx
    apps/web/app/components/search/source-cards.tsx
  </files>
  <action>
Create the `apps/web/app/components/search/` directory with the following components. Use existing codebase patterns (Tailwind, cn(), lucide-react icons, shadcn components).

**1. `search-input.tsx` -- Search bar component**
Props: `{ query: string; onChange: (q: string) => void; onSubmit: (q: string) => void; isStreaming: boolean; placeholder?: string }`

A full-width search input with:
- Search icon on the left
- Rounded-2xl styling matching existing search.tsx
- Loading spinner on the right when streaming
- Auto-focus on mount
- Keyboard submit (Enter)

**2. `search-tabs.tsx` -- Tab switcher between AI Answer and Search Results**
Props: `{ activeTab: 'ai' | 'results'; onTabChange: (tab: 'ai' | 'results') => void; resultCount: number; hasAiAnswer: boolean }`

Use Radix Tabs (from shadcn/ui) or custom tab buttons styled as pills/chips:
- "AI Answer" tab with Sparkles icon (lucide)
- "Search Results" tab with Search icon + result count badge
- Active tab has filled background, inactive has outline
- Tab content controlled by parent (tabs are header-only, not wrapping content)

**3. `ai-answer.tsx` -- Streaming AI answer display**
Props: `{ answer: string; sources: any[]; agentSteps: AgentEvent[]; isStreaming: boolean; sourceCount: number; onCopy: () => void; copied: boolean }`

Migrate and enhance the answer display from the existing `ask.tsx`:
- Research steps (collapsible, same ResearchStep pattern from ask.tsx)
- Streaming answer rendered with ReactMarkdown
- Citations processed via `processCitationsInChildren` (move from ask.tsx)
- Uses CitationBadge component (from citation-badge.tsx)
- Confidence indicator below the answer: "High confidence -- based on {N} sources" (green), "Medium confidence -- based on {N} sources" (amber), "Low confidence -- based on {N} sources" (zinc). Thresholds: 6+ = High, 3-5 = Medium, 1-2 = Low.
- Copy answer button after streaming completes
- Source cards below (from source-cards.tsx)

Import `AgentEvent` type from `../../services/rag.server`.

**4. `search-results.tsx` -- Unified ranked results list**
Props: `{ results: UnifiedSearchResult[]; query: string; isLoading: boolean }`

- Filter controls as pill buttons at top: All, Motions, Key Statements, Documents, Transcripts
- Each filter toggles a content type filter
- Results rendered as ResultCard components in a vertical list
- "No results found" empty state
- Loading skeleton state

Import `UnifiedSearchResult` type from `../../services/hybrid-search.server`.

**5. `result-card.tsx` -- Individual result card**
Props: `{ result: UnifiedSearchResult; query: string }`

A single card that adapts its display based on `result.type`:
- **motion**: Gavel icon (lucide), shows result badge (CARRIED/DEFEATED), text_content, mover/seconder, meeting date
- **key_statement**: MessageSquare icon, shows statement_type badge, speaker_name, statement text, meeting date
- **document_section**: FileText icon, shows heading as title, content preview, document title
- **transcript_segment**: Mic icon, shows speaker_name, text content with query highlighting, meeting date, "Jump to moment" link

All cards: white bg, rounded-2xl, border-zinc-200, shadow-sm, hover effect. Link to `/meetings/{meeting_id}` (with `#t={start_time}` for transcripts).

**6. `citation-badge.tsx` -- Inline citation with hover preview**
Move and enhance the `CitationBadge` and `processCitationsInChildren` / `processCitationNode` functions from `ask.tsx` into this standalone component.

Props for CitationBadge: `{ num: number; source: any }`

Also export:
- `processCitationsInChildren(children: React.ReactNode, sources: any[]): React.ReactNode`
- `processCitationNode(node: React.ReactNode, sources: any[], key: number): React.ReactNode`

Add source type icons matching the result-card.tsx types:
- `document_section`: FileText icon
- `key_statement`: MessageSquare icon
- Use existing SourceIcon component pattern from ask.tsx for transcript/motion/vote

**7. `source-cards.tsx` -- Source list below AI answer**
Props: `{ sources: any[]; isOpen: boolean; onToggle: () => void }`

Move the sources section from ask.tsx into this component. Show source badges with:
- Numbered badge (1, 2, 3...)
- Type-appropriate icon
- Meeting date and speaker name if available
- Linked to meeting page
- Collapsible with "Sources (N)" header
  </action>
  <verify>
Run `cd /Users/kyle/development/viewroyal/apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` to verify all components compile.
Run `ls apps/web/app/components/search/` to verify all 7 files exist.
  </verify>
  <done>Seven search components created: search-input, search-tabs, ai-answer, search-results, result-card, citation-badge, source-cards. All compile without new TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Build unified search page route</name>
  <files>apps/web/app/routes/search.tsx</files>
  <action>
**Replace** the existing `apps/web/app/routes/search.tsx` with the new unified search page.

The new search.tsx is a client-heavy route with a minimal server loader. The Perplexity-style UX flow:

**Server Loader:**
```typescript
export async function loader({ request }: Route.LoaderArgs) {
  const url = new URL(request.url);
  const q = url.searchParams.get("q") || "";
  const id = url.searchParams.get("id") || "";

  // If there's a cached result ID, fetch it server-side
  if (id) {
    const cached = await getSearchResultCache(id);
    if (cached) {
      return { query: q || cached.query, cachedResult: cached, intent: 'question' as const };
    }
  }

  // Determine intent from query
  const intent = q ? classifyIntent(q) : null;

  // For keyword queries, fetch results server-side for SSR
  if (intent === 'keyword' && q) {
    const results = await hybridSearchAll(q, { limit: 30 });
    return { query: q, results, intent, cachedResult: null };
  }

  return { query: q, results: null, cachedResult: null, intent };
}
```

**Client Component:**

The page has three states:
1. **Empty state** -- No query yet. Show centered search input with example queries below.
2. **Results state** -- Query submitted. Show search input at top, tabbed content below.
3. **Cached state** -- Loaded from shareable URL with cached AI answer.

State management:
- `localQuery`: Current input value
- `activeTab`: 'ai' | 'results' (defaults based on intent)
- `answer`, `sources`, `agentSteps`, `isStreaming`: AI answer state (same pattern as ask.tsx)
- `searchResults`, `isLoadingResults`: Keyword results state
- `cacheId`: After AI answer completes, the cache ID for shareable URL

**UX Flow:**

1. User types query and submits (Enter or click)
2. Client-side classifyIntent determines tab:
   - Question -> activeTab = 'ai', start streaming from /api/search?q=...
   - Keyword -> activeTab = 'results', fetch /api/search?q=...&mode=keyword
3. Both tabs are always accessible -- user can switch between them
4. When switching to the OTHER tab for the first time, trigger its fetch:
   - Switching to 'results' tab: if no results loaded, fetch keyword results
   - Switching to 'ai' tab: if no answer started, start streaming
5. URL updates with query: `?q=the+query` (via setSearchParams)
6. After AI answer completes, URL updates to include cache ID: `?q=the+query&id=abc123`

**For AI answer streaming:**
Use the EventSource pattern from ask.tsx:
```typescript
const eventSource = new EventSource(`/api/search?q=${encodeURIComponent(query)}&context=${ctx}`);
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data) as AgentEvent;
  // Handle tool_call, tool_observation, final_answer_chunk, sources, cache_id, done
};
```

When `cache_id` event received, update URL search params to include `id`.

**For keyword results:**
```typescript
const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&mode=keyword`);
const { results } = await res.json();
```

**Layout structure:**
```
<div className="min-h-screen bg-zinc-50">
  <div className="container mx-auto py-8 px-4 max-w-4xl">
    {/* Search Input -- always visible */}
    <SearchInput ... />

    {/* Empty State OR Results */}
    {!hasQuery ? (
      <EmptyState />
    ) : (
      <>
        {/* Tabs */}
        <SearchTabs activeTab={activeTab} ... />

        {/* Tab Content */}
        {activeTab === 'ai' ? (
          <AiAnswer ... />
        ) : (
          <SearchResults ... />
        )}
      </>
    )}
  </div>
</div>
```

**Empty state design:**
- Centered with large search icon
- "Search View Royal Council Records" heading
- Subtext: "Ask a question or search for keywords across meetings, motions, documents, and transcripts"
- Example query chips: both keyword examples ("bylaw 1234", "traffic calming") and question examples ("What has council decided about housing?", "Who voted against the budget?")
- Clicking a chip triggers the search

**Important details:**
- Import `classifyIntent` from `../lib/intent`
- Import all search/* components
- Import `type AgentEvent` from `../services/rag.server`
- Import `getSearchResultCache, hybridSearchAll, type UnifiedSearchResult` from `../services/hybrid-search.server`
- Import `type Route` from `./+types/search`
- The old search.tsx content is fully replaced -- no backward compatibility needed
- The loader can use `getSupabaseAdminClient` for server-side searches (no auth needed for search)
  </action>
  <verify>
Run `cd /Users/kyle/development/viewroyal/apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` to verify compilation.
Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm build 2>&1 | tail -20` to verify the build succeeds.
  </verify>
  <done>Unified search page at /search shows tabbed AI Answer and Search Results. Intent auto-detection selects the default tab. Empty state shows example queries. Keyword results render as unified ranked list. AI answers stream with citations. Shareable URLs with cached results work.</done>
</task>

</tasks>

<verification>
1. `/search` page loads with empty state and example queries
2. Typing "bylaw" and submitting shows Search Results tab with keyword matches
3. Typing "What has council discussed about housing?" shows AI Answer tab with streaming response
4. Tab switching works -- both tabs accessible for any query
5. Citations appear as numbered badges with hover previews
6. Result cards show type-appropriate icons and metadata
7. Filter controls on Search Results tab filter by content type
8. Build succeeds without errors
</verification>

<success_criteria>
- Single /search page replaces old search and ask pages
- Perplexity-style UI with single input, tabbed results
- Intent detection defaults to correct tab
- Streaming AI answers with markdown and inline citations
- Unified ranked results list with type filters
- Confidence indicator on AI answers
- Source cards below AI answer
- Build compiles without new errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-unified-search-hybrid-rag/08-03-SUMMARY.md`
</output>
