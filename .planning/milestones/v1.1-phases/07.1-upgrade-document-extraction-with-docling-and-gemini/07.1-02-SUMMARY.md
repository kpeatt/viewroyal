---
phase: 07.1-upgrade-document-extraction
plan: 02
subsystem: pipeline
tags: [gemini, pymupdf, image-extraction, r2, boto3, document-orchestrator, pdf-extraction]

# Dependency graph
requires:
  - phase: 07.1-upgrade-document-extraction (plan 01)
    provides: extracted_documents table, document_images table, gemini_extractor.py (detect_boundaries, extract_content)
  - phase: 07-document-intelligence
    provides: document_sections table, document_chunker.py (fallback)
provides:
  - image_extractor.py module for PyMuPDF image extraction with R2 upload
  - document_extractor.py orchestrator connecting Gemini + images + section creation
  - Updated ingester.py calling new extraction pipeline
  - Updated orchestrator.py backfill using new pipeline
  - Docling dependency removed
affects: [07.1-03, document-viewer, rag-qa, backfill]

# Tech tracking
tech-stack:
  added: [boto3]
  patterns: [Gemini extraction orchestrator with automatic fallback, graceful R2 degradation, markdown section splitting at heading boundaries]

key-files:
  created:
    - apps/pipeline/pipeline/ingestion/image_extractor.py
    - apps/pipeline/pipeline/ingestion/document_extractor.py
  modified:
    - apps/pipeline/pipeline/ingestion/ingester.py
    - apps/pipeline/pipeline/orchestrator.py
    - apps/pipeline/pyproject.toml

key-decisions:
  - "Graceful R2 degradation: if boto3 or R2 credentials missing, image uploads silently skip (images are optional)"
  - "Idempotency checks on extracted_documents table instead of document_sections for the new pipeline"
  - "1-second rate limit delay between documents during bulk backfill to respect Gemini rate limits"
  - "Force-mode backfill deletes all extracted_documents and document_sections for clean slate"

patterns-established:
  - "Document extraction orchestrator: detect_boundaries -> extract_content -> extract_images -> insert sections"
  - "Markdown section splitting: split at ## headings, enforce 8000 char max, paragraph-boundary splitting for oversized sections"
  - "Agenda item resolution: normalize item numbers (strip parens/dots/whitespace), try exact then containment match"

requirements-completed: [DOC-01, DOC-04]

# Metrics
duration: 4min
completed: 2026-02-17
---

# Phase 7.1 Plan 2: Extraction Orchestrator and Pipeline Integration Summary

**PyMuPDF image extraction with R2 upload, document extraction orchestrator connecting Gemini boundaries/content/images, integrated into ingester.py and orchestrator.py with Docling removed**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-17T21:29:46Z
- **Completed:** 2026-02-17T21:33:31Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Created image_extractor.py (185 lines) with PyMuPDF image extraction, dimension filtering (min 100px, min 20K area, max 5:1 aspect ratio), deduplication by xref, and R2 upload via boto3
- Created document_extractor.py (301 lines) orchestrating the full pipeline: Gemini boundary detection, Gemini content extraction, PyMuPDF image extraction, markdown section splitting, and database insertion into extracted_documents, document_sections, and document_images
- Updated ingester.py to call extract_and_store_documents instead of the old chunk_document + link_sections_to_agenda_items, with idempotency on extracted_documents
- Updated orchestrator.py backfill to use new pipeline with force-mode clean slate and 1s rate limiting between documents
- Removed Docling dependency, added boto3 for R2 S3-compatible API

## Task Commits

Each task was committed atomically:

1. **Task 1: Create image extractor and document extraction orchestrator** - `3adf2a78` (feat)
2. **Task 2: Integrate new extractor into pipeline and remove Docling** - `fd9e419a` (feat)

## Files Created/Modified
- `apps/pipeline/pipeline/ingestion/image_extractor.py` - PyMuPDF image extraction with R2 upload, dimension filters, lazy singleton client
- `apps/pipeline/pipeline/ingestion/document_extractor.py` - Extraction orchestrator: Gemini boundaries + content + images + sections, with fallback to old chunker
- `apps/pipeline/pipeline/ingestion/ingester.py` - _ingest_document_sections() now uses document_extractor instead of document_chunker
- `apps/pipeline/pipeline/orchestrator.py` - backfill_document_sections() uses new Gemini pipeline with force-mode clean slate
- `apps/pipeline/pyproject.toml` - Removed docling>=2.73.1, added boto3>=1.35.0

## Decisions Made
- R2 image uploads gracefully degrade: if boto3 not installed or credentials missing, images are simply skipped with a warning log (images are optional, not blocking)
- Idempotency for new pipeline checks extracted_documents table rather than document_sections, since extracted_documents is the primary output of the new pipeline
- Backfill force mode deletes extracted_documents and document_sections at municipality level for a clean slate, rather than per-document
- Added 1-second sleep between documents in backfill to respect Gemini API rate limits during bulk processing

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

**External services require manual configuration.** R2 credentials are needed for image uploads, but the pipeline works without them (images are silently skipped). When ready to enable images:

- `R2_ACCESS_KEY_ID` - From Cloudflare Dashboard -> R2 -> Manage R2 API Tokens -> Create API token
- `R2_SECRET_ACCESS_KEY` - Same R2 API token creation page
- `R2_ENDPOINT_URL` - Cloudflare Dashboard -> R2 -> bucket details -> S3 API endpoint
- `R2_BUCKET_NAME` - Create bucket named 'viewroyal-document-images' in R2 dashboard

## Next Phase Readiness
- Full extraction pipeline is integrated and ready for the backfill run (Plan 03)
- Old PyMuPDF chunker preserved as automatic fallback in document_extractor.py
- Plan 03 can proceed: run backfill across all 722 agenda PDFs using the new pipeline

## Self-Check: PASSED

- FOUND: apps/pipeline/pipeline/ingestion/image_extractor.py
- FOUND: apps/pipeline/pipeline/ingestion/document_extractor.py
- FOUND: apps/pipeline/pipeline/ingestion/document_chunker.py (fallback preserved)
- FOUND: .planning/phases/07.1-upgrade-document-extraction-with-docling-and-gemini/07.1-02-SUMMARY.md
- FOUND: commit 3adf2a78 (Task 1)
- FOUND: commit fd9e419a (Task 2)

---
*Phase: 07.1-upgrade-document-extraction*
*Completed: 2026-02-17*
