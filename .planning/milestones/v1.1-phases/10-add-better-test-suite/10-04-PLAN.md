---
phase: 10-add-better-test-suite
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - apps/pipeline/tests/scrapers/test_civicweb.py
  - apps/pipeline/tests/scrapers/test_base.py
  - apps/pipeline/tests/profiling/test_stance_generator.py
  - apps/pipeline/tests/video/test_vimeo.py
  - apps/pipeline/tests/orchestrator/test_orchestrator.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "CivicWeb scraper tests verify HTML parsing and meeting data extraction with mocked HTTP"
    - "Base scraper tests verify MunicipalityConfig and scraper registration"
    - "Stance generator tests verify Gemini interaction and snapshot output structure"
    - "Vimeo client tests verify URL extraction with mocked HTTP responses"
    - "Orchestrator tests verify phase coordination and Archiver class logic"
  artifacts:
    - path: "apps/pipeline/tests/scrapers/test_civicweb.py"
      provides: "CivicWeb scraper tests with mocked HTTP responses"
      min_lines: 50
    - path: "apps/pipeline/tests/profiling/test_stance_generator.py"
      provides: "Stance generation tests with mocked Gemini and snapshot testing"
      min_lines: 50
    - path: "apps/pipeline/tests/video/test_vimeo.py"
      provides: "Vimeo client tests with mocked HTTP"
      min_lines: 30
    - path: "apps/pipeline/tests/orchestrator/test_orchestrator.py"
      provides: "Orchestrator/Archiver integration tests"
      min_lines: 40
  key_links:
    - from: "apps/pipeline/tests/scrapers/test_civicweb.py"
      to: "apps/pipeline/pipeline/scrapers/civicweb.py"
      via: "Import scraper class, mock HTTP via responses library"
      pattern: "responses\\.add|@responses\\.activate"
    - from: "apps/pipeline/tests/profiling/test_stance_generator.py"
      to: "apps/pipeline/pipeline/profiling/stance_generator.py"
      via: "Mock Gemini client, verify output structure"
      pattern: "patch.*stance_generator"
---

<objective>
Write tests for the remaining pipeline modules: scrapers (CivicWeb, base), profiling (stance generator), video (Vimeo client), and orchestrator (Archiver). These cover the outer layers of the pipeline -- data acquisition and coordination.

Purpose: Complete pipeline coverage across all 5 phases (scrape, download, diarize, refine/ingest, embed) plus profiling.
Output: 5 new test files covering scrapers, profiling, video, and orchestrator.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-add-better-test-suite/10-RESEARCH.md
@.planning/phases/10-add-better-test-suite/10-01-SUMMARY.md

@apps/pipeline/tests/conftest.py
@apps/pipeline/pipeline/scrapers/civicweb.py
@apps/pipeline/pipeline/scrapers/base.py
@apps/pipeline/pipeline/profiling/stance_generator.py
@apps/pipeline/pipeline/video/vimeo.py
@apps/pipeline/pipeline/orchestrator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scraper and video client tests</name>
  <files>
    apps/pipeline/tests/scrapers/test_civicweb.py
    apps/pipeline/tests/scrapers/test_base.py
    apps/pipeline/tests/video/test_vimeo.py
  </files>
  <action>
    1. **Read source modules** to understand APIs:
       - `pipeline/scrapers/civicweb.py` -- CivicWeb scraper class, HTML parsing, meeting list extraction
       - `pipeline/scrapers/base.py` -- BaseScraper, MunicipalityConfig, scraper registry
       - `pipeline/video/vimeo.py` -- VimeoClient, URL extraction

    2. **Create `tests/scrapers/__init__.py`** and **`tests/video/__init__.py`** directories.

    3. **Create `tests/scrapers/test_base.py`:**
       - Test MunicipalityConfig creation with valid data
       - Test MunicipalityConfig validation (missing required fields)
       - Test scraper registry: registering and retrieving scrapers
       - Test BaseScraper interface (abstract methods, common behaviors)

    4. **Create `tests/scrapers/test_civicweb.py`:**
       - Use the `responses` library to mock HTTP calls
       - Create small HTML fixtures inline that mimic CivicWeb meeting list pages
       - Test meeting list parsing (extract meeting dates, types, URLs from HTML)
       - Test individual meeting page parsing (extract agenda/minutes PDF URLs)
       - Test handling of empty/malformed HTML
       - Test pagination handling if applicable
       - Test error handling for HTTP failures (500, 404, timeout)
       - Use `@responses.activate` decorator pattern

    5. **Create `tests/video/test_vimeo.py`:**
       - Mock HTTP responses for Vimeo API calls using `responses` library
       - Test URL extraction from Vimeo video ID
       - Test handling of invalid video IDs
       - Test error handling for API failures
       - Test rate limiting behavior if the client implements it
       - If VimeoClient uses `requests`, mock via `responses`. If it uses something else (curl_cffi), use `unittest.mock.patch` instead.
  </action>
  <verify>
    `cd apps/pipeline && uv run pytest tests/scrapers/ tests/video/ -v`
    All tests pass. At least 15 tests across these 3 files.
  </verify>
  <done>Scraper and video client tests cover HTML parsing, HTTP mocking, error handling, and edge cases.</done>
</task>

<task type="auto">
  <name>Task 2: Profiling and orchestrator tests</name>
  <files>
    apps/pipeline/tests/profiling/test_stance_generator.py
    apps/pipeline/tests/orchestrator/test_orchestrator.py
  </files>
  <action>
    1. **Read source modules:**
       - `pipeline/profiling/stance_generator.py` -- stance generation with Gemini, evidence gathering
       - `pipeline/orchestrator.py` -- Archiver class, phase coordination, CLI argument handling

    2. **Create `tests/profiling/__init__.py`** and **`tests/orchestrator/__init__.py`** directories.

    3. **Create `tests/profiling/test_stance_generator.py`:**
       - Mock the Gemini client (patch at module level)
       - Test stance generation for a single councillor with mocked evidence data
       - Test with no evidence data (should handle gracefully)
       - Test confidence thresholds: <3 statements = low, 3-7 = medium, 8+ = high
       - Test category normalization (the Python mirror of the SQL function)
       - Use syrupy snapshot testing for the structure of generated stances:
         - Mock Gemini response with a known-good stance structure
         - Assert the processed output matches the snapshot
         - This validates the downstream processing, not the AI content
       - Test evidence gathering query construction with mocked Supabase

    4. **Create `tests/orchestrator/test_orchestrator.py`:**
       - Test Archiver class initialization
       - Test phase coordination logic (which phases run based on CLI flags)
       - Test `--target` flag handling (single meeting mode)
       - Test `--ingest-only`, `--embed-only` flag handling
       - Test `--rediarize` flag handling
       - Mock all external dependencies (Supabase, Gemini, file system)
       - Test meeting selection logic (which meetings are processed)
       - Test error handling when a phase fails (should log error, continue or abort based on severity)

    5. Run full test suite to confirm everything works together.
  </action>
  <verify>
    `cd apps/pipeline && uv run pytest tests/profiling/ tests/orchestrator/ -v`
    All tests pass. At least 15 tests across these 2 files.
    `uv run pytest -v` -- full suite passes (all existing + new tests from all plans).
  </verify>
  <done>Profiling stance generator and orchestrator have comprehensive tests. Snapshot testing validates AI output structure.</done>
</task>

</tasks>

<verification>
1. `cd apps/pipeline && uv run pytest -v` -- all tests pass
2. `uv run pytest tests/scrapers/ tests/video/ tests/profiling/ tests/orchestrator/ -v` -- at least 30 new tests
3. Snapshot files created by syrupy in `__snapshots__/` directories
4. No external service calls -- all mocked
5. Tests run in under 30 seconds total
</verification>

<success_criteria>
- 5 new test files covering scrapers, video, profiling, and orchestrator
- At least 30 new tests passing
- CivicWeb scraper tests use `responses` library for HTTP mocking
- Stance generator uses syrupy snapshot testing for AI output structure
- Orchestrator tests cover all CLI flag combinations
- All external services mocked; no network calls
- Full pipeline test suite passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/10-add-better-test-suite/10-04-SUMMARY.md`
</output>
