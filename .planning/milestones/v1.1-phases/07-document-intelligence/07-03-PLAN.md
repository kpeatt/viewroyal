---
phase: 07-document-intelligence
plan: 03
type: execute
wave: 1
depends_on: ["07-01", "07-02"]
files_modified:
  - apps/pipeline/pipeline/ingestion/document_chunker.py
  - apps/pipeline/pipeline/ingestion/ingester.py
autonomous: true
requirements:
  - DOC-03

must_haves:
  truths:
    - "Motion results (CARRIED, DEFEATED, TABLED) are not treated as section headings"
    - "Noise headings (OR, continued from previous page, REVIEWED BY) are filtered out"
    - "Repeating table-row headings (same title appearing 5+ times) are merged into a single section"
    - "Sub-headings within staff reports (BACKGROUND, PURPOSE, RECOMMENDATION, ANALYSIS) are folded into their parent section rather than creating separate sections"
    - "Sections are linked to sub-agenda items (6.1.a, 6.1.b) by matching page ranges against the document's structural position, not just title text"
    - "Running --backfill-sections --force produces cleaner, fewer sections with higher linking rate (>50% for agenda packages)"
  artifacts:
    - path: "apps/pipeline/pipeline/ingestion/document_chunker.py"
      provides: "Improved heading detection and noise filtering"
      contains: "NOISE_HEADINGS"
    - path: "apps/pipeline/pipeline/ingestion/document_chunker.py"
      provides: "Improved agenda item linking"
      contains: "link_sections_to_agenda_items"
---

<objective>
Audit and fix document section quality: reduce noise sections, merge fragmented headings, and improve agenda item linking from ~15% to >50%.

Purpose: The current chunker treats every bold/large text as a heading, producing 226 sections for a 223-page document with many noise entries (CARRIED x11, OR x6, repeating table headers x20). Agenda item linking only matches generic parent headings, missing all sub-items (6.1.a, 5.a, etc.). This plan fixes both issues to make the document viewer and downstream search actually useful.

Output: Updated document_chunker.py with noise filtering, sub-heading folding, and position-based agenda item linking. Re-run backfill to verify improvement.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@apps/pipeline/pipeline/ingestion/document_chunker.py
@apps/pipeline/pipeline/ingestion/ingester.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add noise filtering and sub-heading folding to document chunker</name>
  <files>apps/pipeline/pipeline/ingestion/document_chunker.py</files>
  <action>
**Problem 1: Noise headings detected as sections**

Add a `NOISE_HEADINGS` set of strings that should never be treated as section headings:
```python
NOISE_HEADINGS = {
    "CARRIED", "DEFEATED", "TABLED", "OPPOSED", "WITHDRAWN",
    "OR",
    "REVIEWED BY: Initials", "REVIEWED BY:",
    "(continued from previous page)", "(cont'd)",
    "Comments",
}
```

In `_split_at_headings()`, after detecting a heading span, check if the cleaned heading text (stripped, uppercased) matches any `NOISE_HEADINGS` entry. If so, treat as body text instead of starting a new section.

**Problem 2: Sub-headings fragment staff reports**

Add a `SUB_HEADINGS` set — these are internal structure markers within staff reports that should NOT create new top-level sections:
```python
SUB_HEADINGS = {
    "BACKGROUND:", "BACKGROUND",
    "PURPOSE:", "PURPOSE",
    "RECOMMENDATION:", "RECOMMENDATIONS:",
    "ANALYSIS:", "ANALYSIS",
    "ATTACHMENTS:", "ATTACHMENT:",
    "ALIGNMENT:", "ALIGNMENT",
    "PUBLIC PARTICIPATION GOAL:", "PUBLIC PARTICIPATION GOAL",
    "OPTIONS:", "OPTIONS",
    "FINANCIAL IMPLICATIONS:", "FINANCIAL IMPLICATIONS",
    "POLICY IMPLICATIONS:", "POLICY IMPLICATIONS",
    "DISCUSSION:", "DISCUSSION",
}
```

In heading detection: if the heading text matches `SUB_HEADINGS`, do NOT start a new section. Instead, append it as bold/emphasized text within the current section (prepend with `\n\n**{heading}**\n`). This keeps "Staff Report on X" as one section with internal structure preserved.

**Problem 3: Repeating table-row headings**

The "COUNCIL RESOLUTION FOLLOW UP LIST" heading appears 20 times because it's a repeating header on a multi-page table.

After `_split_at_headings()` returns, add a post-processing step: if any `section_title` appears 5+ times in the results, merge all those sections into a single section. Concatenate their text in order, keep the first one's page_start and last one's page_end.

**Problem 4: Very short sections are noise**

Increase `MIN_SECTION_CHARS` from 100 to 150. Also, after filtering short sections, if a section's text is ONLY the heading text (nothing else), drop it entirely (it's a heading with no content below it before the next heading).
  </action>
  <verify>
Run the chunker on the test document and compare before/after:
```python
cd apps/pipeline && uv run python -c "
from pipeline.ingestion.document_chunker import chunk_document
sections = chunk_document('../../viewroyal_archive/Committee of the Whole/2025/11/2025-11-12 Committee of the Whole/Agenda/2025 11 12 Committee of the Whole Meeting - Agenda - Pdf.pdf', 'Test')
print(f'Sections: {len(sections)}')
carried = [s for s in sections if s.get('section_title','') == 'CARRIED']
print(f'CARRIED sections: {len(carried)}')
or_sects = [s for s in sections if s.get('section_title','') == 'OR']
print(f'OR sections: {len(or_sects)}')
council_res = [s for s in sections if 'COUNCIL RESOLUTION' in (s.get('section_title','') or '')]
print(f'Council Resolution sections: {len(council_res)}')
for s in sections[:20]:
    print(f\"  {s['section_order']:3d}. {s.get('section_title','[none]')[:60]:60s} ({len(s['section_text']):5d} chars, p{s.get('page_start','?')}-{s.get('page_end','?')})\")
"
```
Expected: Significantly fewer sections (target <100 from current 226). Zero CARRIED/OR sections. Council Resolution merged to 1.
  </verify>
  <done>Noise headings filtered, sub-headings folded into parent sections, repeating table headers merged, short empty sections dropped.</done>
</task>

<task type="auto">
  <name>Task 2: Improve agenda item linking with position-based matching</name>
  <files>apps/pipeline/pipeline/ingestion/document_chunker.py</files>
  <action>
**Problem: Only 15% of sections link to agenda items**

The current linking uses:
1. Number-pattern match (section title "8.1" matches item_order "8.1") — works for top-level items
2. Title containment — too strict, misses most matches

The real issue: agenda packages are multi-document PDFs where staff reports for item "6.1.a" don't have "6.1.a" in their headings. They have titles like "Development Variance Permit 2025-04" which matches the agenda item title "Development Variance Permit 2025-04 - 1701 Island Highway".

**Improved linking strategy in `link_sections_to_agenda_items()`:**

Keep the existing two strategies, then add a third:

**Strategy 3 (fuzzy title matching):** For sections that didn't match via strategies 1-2:
- Normalize both section_title and agenda_item.title: lowercase, strip punctuation, collapse whitespace
- Check if the normalized section title contains 3+ consecutive words from the normalized agenda item title (or vice versa)
- Require the matching word sequence to be at least 15 characters to avoid false positives on short generic phrases
- If multiple agenda items match, pick the one with the longest matching word sequence

**Strategy 4 (positional/sequential):** For agenda packages specifically:
- Agenda packages have a table of contents on the first few pages listing items with page numbers
- After all other strategies: for sections that are still unlinked AND appear to be the start of a staff report (section_title contains words like "Staff Report", "Report to", or matches pattern of a proper document title — first letter capitalized, >20 chars, not all-caps):
  - Look at which agenda items are "nearby" — items that have at least one section already linked before or after this section's position
  - This is a heuristic: in an agenda package, documents for item 6.1.a come before documents for 6.1.b
  - Don't implement this in v1 — just flag it as a future improvement in comments

**Also:** After linking, add a deduplication pass. If the same agenda_item_id is linked to >10 sections, it's likely a false positive from a generic parent heading. Clear those links (set agenda_item_id = None) except for the first 3 that matched.
  </action>
  <verify>
Re-run the chunker with linking on meeting 1096:
```python
cd apps/pipeline && uv run python -c "
from pipeline.ingestion.document_chunker import chunk_document, link_sections_to_agenda_items
from supabase import create_client
from pipeline import config
supabase = create_client(config.SUPABASE_URL, config.SUPABASE_SECRET_KEY or config.SUPABASE_KEY)
sections = chunk_document('../../viewroyal_archive/Committee of the Whole/2025/11/2025-11-12 Committee of the Whole/Agenda/2025 11 12 Committee of the Whole Meeting - Agenda - Pdf.pdf', 'Test')
sections = link_sections_to_agenda_items(sections, 1096, supabase)
linked = [s for s in sections if s.get('agenda_item_id')]
print(f'Total: {len(sections)}, Linked: {len(linked)} ({100*len(linked)//len(sections)}%)')
for s in linked[:15]:
    print(f\"  {s['section_order']:3d}. {s.get('section_title','')[:50]:50s} -> item {s['agenda_item_id']}\")
"
```
Expected: >50% linking rate (up from 15%).
  </verify>
  <done>Fuzzy title matching added as strategy 3. Deduplication pass limits over-linked agenda items. Linking rate improved to >50%.</done>
</task>

<task type="auto">
  <name>Task 3: Re-run backfill with --force and verify improvement</name>
  <files>None (runtime only)</files>
  <action>
Run the backfill with --force to regenerate all sections with the improved chunker:

```bash
cd apps/pipeline && uv run python main.py --backfill-sections --force
```

Then verify the improvement by querying the database:

```sql
-- Total sections (should be significantly fewer than 432)
SELECT count(*) FROM document_sections;

-- Linked rate (should be >50% for the agenda package)
SELECT count(*) as total, count(agenda_item_id) as linked
FROM document_sections
WHERE document_id = 13;

-- No more CARRIED/OR noise sections
SELECT section_title, count(*) as cnt
FROM document_sections
GROUP BY section_title
HAVING count(*) > 3
ORDER BY cnt DESC;
```
  </action>
  <verify>
1. Total section count decreased significantly (target: <200 from 432)
2. Linking rate >50% for document 13 (the agenda package)
3. No CARRIED or OR sections remain
4. Council Resolution Follow Up List merged to 1 section
5. Embeddings generated for new sections (--backfill-sections runs embed pass automatically)
  </verify>
  <done>Backfill re-run complete. Section quality improved: fewer noise sections, better linking, cleaner data for search and viewer.</done>
</task>

</tasks>

<verification>
1. CARRIED, OR, and other noise headings are not treated as sections
2. Sub-headings (BACKGROUND, PURPOSE, RECOMMENDATION) stay within parent sections
3. Repeating table headers merged into single sections
4. Fuzzy title matching links staff reports to their agenda items
5. Linking rate >50% (up from 15%)
6. Total section count significantly reduced
7. Document viewer shows cleaner, more meaningful sections
</verification>

<success_criteria>
- Zero noise sections (CARRIED, OR, etc.)
- Sub-headings folded into parent sections
- Repeating headers merged
- Linking rate >50% for agenda packages
- Total sections reduced by >40%
- Backfill runs clean with --force
</success_criteria>

<output>
After completion, create `.planning/phases/07-document-intelligence/07-03-SUMMARY.md`
</output>
