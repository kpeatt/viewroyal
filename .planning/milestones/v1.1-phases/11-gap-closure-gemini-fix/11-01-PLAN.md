---
phase: 11-gap-closure-gemini-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/app/services/rag.server.ts
  - apps/web/app/routes/api.search.tsx
  - apps/web/app/routes/api.intel.tsx
  - apps/pipeline/pipeline/ingestion/ai_refiner.py
  - apps/pipeline/pipeline/ingestion/process_bylaws.py
  - apps/pipeline/pipeline/ingestion/process_agenda.py
  - apps/pipeline/pipeline/ingestion/gemini_extractor.py
  - apps/pipeline/pipeline/profiling/stance_generator.py
  - README.md
autonomous: true
requirements:
  - SRCH-04

must_haves:
  truths:
    - "RAG citations for document sections display section headings (not generic document titles)"
    - "All Gemini API calls across web app and pipeline use gemini-3-flash-preview model"
    - "Web app uses @google/genai SDK (not deprecated @google/generative-ai)"
    - "Web app builds successfully for Cloudflare Workers"
    - "Pipeline tests pass with updated model names"
  artifacts:
    - path: "apps/web/app/services/rag.server.ts"
      provides: "RAG agent with new SDK + heading fix"
      contains: "GoogleGenAI"
    - path: "apps/web/app/routes/api.search.tsx"
      provides: "Search API with new SDK"
      contains: "GoogleGenAI"
    - path: "apps/web/app/routes/api.intel.tsx"
      provides: "Intel API with new SDK"
      contains: "GoogleGenAI"
    - path: "apps/pipeline/pipeline/ingestion/ai_refiner.py"
      provides: "AI refiner with updated model name"
      contains: "gemini-3-flash-preview"
  key_links:
    - from: "apps/web/app/services/rag.server.ts"
      to: "@google/genai"
      via: "import and lazy singleton"
      pattern: "import.*GoogleGenAI.*from.*@google/genai"
    - from: "apps/web/app/services/rag.server.ts:1111"
      to: "hybrid_search_document_sections RPC"
      via: "d.section_title field mapping"
      pattern: "heading: d\\.section_title"
---

<objective>
Fix RAG document section heading mismatch (SRCH-04), migrate web app from deprecated `@google/generative-ai` to `@google/genai` SDK, and update all Gemini model references to `gemini-3-flash-preview` across both web app and pipeline.

Purpose: The deprecated JS SDK is past end-of-life (Nov 30, 2025) and `gemini-2.0-flash` shuts down March 31, 2026. The heading mismatch causes document section citations to display "Unknown" instead of section titles.
Output: All Gemini calls use `gemini-3-flash-preview` via supported SDKs, RAG citations show section headings.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-gap-closure-gemini-fix/11-RESEARCH.md

Key source files:
@apps/web/app/services/rag.server.ts
@apps/web/app/routes/api.search.tsx
@apps/web/app/routes/api.intel.tsx
@apps/pipeline/pipeline/ingestion/ai_refiner.py
@apps/pipeline/pipeline/ingestion/process_bylaws.py
@apps/pipeline/pipeline/ingestion/process_agenda.py
@apps/pipeline/pipeline/ingestion/gemini_extractor.py
@apps/pipeline/pipeline/profiling/stance_generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate web app to @google/genai SDK + fix RAG heading</name>
  <files>
    apps/web/package.json
    apps/web/app/services/rag.server.ts
    apps/web/app/routes/api.search.tsx
    apps/web/app/routes/api.intel.tsx
  </files>
  <action>
    **Step 1: Swap npm package**
    From `apps/web/`, run:
    ```
    pnpm remove @google/generative-ai && pnpm add @google/genai
    ```

    **Step 2: Migrate rag.server.ts (4 changes)**

    2a. Line 1 — Update import:
    - Old: `import { GoogleGenerativeAI } from "@google/generative-ai";`
    - New: `import { GoogleGenAI } from "@google/genai";`

    2b. Lines 21-29 — Update lazy singleton type and init:
    - Old:
      ```typescript
      let genAI: GoogleGenerativeAI | null = null;
      function getGenAI(): GoogleGenerativeAI | null {
        if (!GEMINI_API_KEY) return null;
        if (!genAI) {
          genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        }
        return genAI;
      }
      ```
    - New:
      ```typescript
      let genAI: GoogleGenAI | null = null;
      function getGenAI(): GoogleGenAI | null {
        if (!GEMINI_API_KEY) return null;
        if (!genAI) {
          genAI = new GoogleGenAI({ apiKey: GEMINI_API_KEY });
        }
        return genAI;
      }
      ```

    2c. Line 1111 — Fix heading field mismatch (SRCH-04 fix):
    - Old: `heading: d.heading,`
    - New: `heading: d.section_title,`
    This is the one-line fix that restores section-level RAG citations. The `hybrid_search_document_sections` RPC returns `section_title`, not `heading`.

    2d. Lines 1180-1205 — Update model init + generateContent (non-streaming):
    - Old:
      ```typescript
      const model = client.getGenerativeModel({
        model: "gemini-flash-latest",
      });
      // ... later:
      const result = await model.generateContent([
        getOrchestratorSystemPrompt(municipalityName),
        userPrompt,
      ]);
      const responseText = result.response.text().trim();
      ```
    - New: Remove the `model = client.getGenerativeModel(...)` call entirely. Replace each `model.generateContent(...)` call with:
      ```typescript
      const result = await client.models.generateContent({
        model: "gemini-3-flash-preview",
        contents: [
          getOrchestratorSystemPrompt(municipalityName),
          userPrompt,
        ],
      });
      const responseText = (result.text ?? "").trim();
      ```
    Note: `client` here is the return value of `getGenAI()` (the `GoogleGenAI` instance). The variable is named `client` at line 1177.

    2e. Lines 1333-1338 — Update streaming call:
    - Old:
      ```typescript
      const stream = await model.generateContentStream([
        getFinalSystemPrompt(municipalityName),
        finalUserPrompt,
      ]);
      for await (const chunk of stream.stream) {
        yield { type: "final_answer_chunk", chunk: chunk.text() };
      }
      ```
    - New:
      ```typescript
      const stream = await client.models.generateContentStream({
        model: "gemini-3-flash-preview",
        contents: [
          getFinalSystemPrompt(municipalityName),
          finalUserPrompt,
        ],
      });
      for await (const chunk of stream) {
        yield { type: "final_answer_chunk", chunk: chunk.text ?? "" };
      }
      ```
    Key differences: No `.stream` property access (the result IS the async iterable), `.text` is a property not a method.

    **Step 3: Migrate api.search.tsx (lines 170-177)**
    - Line 11 — Update import:
      Old: `import { GoogleGenerativeAI } from "@google/generative-ai";`
      New: `import { GoogleGenAI } from "@google/genai";`
    - Lines 170-177 — Update follow-up generation:
      Old:
      ```typescript
      const followupAI = new GoogleGenerativeAI(geminiKey);
      const followupModel = followupAI.getGenerativeModel({
        model: "gemini-flash-latest",
      });
      // ...
      const followupResult = await followupModel.generateContent([followupPrompt]);
      const followupText = followupResult.response.text().trim();
      ```
      New:
      ```typescript
      const followupAI = new GoogleGenAI({ apiKey: geminiKey });
      const followupResult = await followupAI.models.generateContent({
        model: "gemini-3-flash-preview",
        contents: followupPrompt,
      });
      const followupText = (followupResult.text ?? "").trim();
      ```
      Remove the `followupModel` variable entirely — model is passed per-call in the new SDK.

    **Step 4: Migrate api.intel.tsx (lines 83-122)**
    - Line 2 — Update import:
      Old: `import { GoogleGenerativeAI } from "@google/generative-ai";`
      New: `import { GoogleGenAI } from "@google/genai";`
    - Lines 82-89 — Update model init:
      Old:
      ```typescript
      console.log(`[Intelligence API] Calling Gemini 2.0 Flash...`);
      const genAI = new GoogleGenerativeAI(apiKey);
      const model = genAI.getGenerativeModel({
          model: "gemini-2.0-flash",
          generationConfig: {
              responseMimeType: "application/json",
          }
      });
      ```
      New:
      ```typescript
      console.log(`[Intelligence API] Calling Gemini 3 Flash...`);
      const ai = new GoogleGenAI({ apiKey });
      ```
    - Lines 120-122 — Update generateContent call:
      Old:
      ```typescript
      const result = await model.generateContent(prompt);
      const response = await result.response;
      const intelData = JSON.parse(response.text());
      ```
      New:
      ```typescript
      const result = await ai.models.generateContent({
        model: "gemini-3-flash-preview",
        contents: prompt,
        config: { responseMimeType: "application/json" },
      });
      const intelData = JSON.parse(result.text ?? "{}");
      ```
      Remove the `model` variable and `response` variable — they're collapsed into the per-call pattern.

    **Step 5: Verify build**
    Run `cd apps/web && pnpm build` to confirm no TypeScript errors and no Workers-incompatible imports.
  </action>
  <verify>
    1. `cd apps/web && pnpm build` completes without errors
    2. `grep -r "generative-ai" apps/web/app/ --include="*.ts" --include="*.tsx"` returns no results (old SDK fully removed)
    3. `grep -r "GoogleGenAI" apps/web/app/ --include="*.ts" --include="*.tsx"` shows 3 files (rag.server.ts, api.search.tsx, api.intel.tsx)
    4. `grep "d.section_title" apps/web/app/services/rag.server.ts` confirms heading fix
    5. `grep "gemini-3-flash-preview" apps/web/app/services/rag.server.ts apps/web/app/routes/api.search.tsx apps/web/app/routes/api.intel.tsx` shows model name in all 3 files
  </verify>
  <done>
    Web app builds for Cloudflare Workers with @google/genai SDK. All 3 files using Gemini (rag.server.ts, api.search.tsx, api.intel.tsx) import from @google/genai, use GoogleGenAI class, and reference gemini-3-flash-preview. The d.heading → d.section_title fix is in place. No references to the deprecated @google/generative-ai package remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update pipeline model names + README</name>
  <files>
    apps/pipeline/pipeline/ingestion/ai_refiner.py
    apps/pipeline/pipeline/ingestion/process_bylaws.py
    apps/pipeline/pipeline/ingestion/process_agenda.py
    apps/pipeline/pipeline/ingestion/gemini_extractor.py
    apps/pipeline/pipeline/profiling/stance_generator.py
    README.md
  </files>
  <action>
    **Pipeline model name updates** — These are string-only changes. The Python pipeline already uses the `google-genai` SDK (modern Python SDK). No API pattern changes needed.

    1. `apps/pipeline/pipeline/ingestion/ai_refiner.py` — Three occurrences at lines 500, 924, 985:
       - Old: `model="gemini-flash-latest"`
       - New: `model="gemini-3-flash-preview"`

    2. `apps/pipeline/pipeline/ingestion/process_bylaws.py` — Line 33:
       - Old: `MODEL_NAME = "gemini-2.0-flash"`
       - New: `MODEL_NAME = "gemini-3-flash-preview"`

    3. `apps/pipeline/pipeline/ingestion/process_agenda.py` — Line 36:
       - Old: `MODEL_NAME = "gemini-2.0-flash"`
       - New: `MODEL_NAME = "gemini-3-flash-preview"`

    4. `apps/pipeline/pipeline/ingestion/gemini_extractor.py` — Line 23:
       - Old: `GEMINI_MODEL = os.environ.get("GEMINI_MODEL", "gemini-2.5-flash")`
       - New: `GEMINI_MODEL = os.environ.get("GEMINI_MODEL", "gemini-3-flash-preview")`

    5. `apps/pipeline/pipeline/profiling/stance_generator.py` — Line 24:
       - Old: `GEMINI_MODEL = os.environ.get("GEMINI_MODEL", "gemini-2.5-flash")`
       - New: `GEMINI_MODEL = os.environ.get("GEMINI_MODEL", "gemini-3-flash-preview")`

    Note: `profile_agent.py` imports `GEMINI_MODEL` from `stance_generator` — no change needed there.
    Note: `batch_extractor.py` imports `GEMINI_MODEL` from `gemini_extractor` — no change needed there.

    **README.md update:**
    Update the two tech stack references from "Gemini Flash" to "Gemini 3 Flash" (lines 51-52):
    - `Google Gemini Flash (structured meeting extraction)` → `Google Gemini 3 Flash (structured meeting extraction)`
    - `Google Gemini Flash (multi-tool RAG agent with citations)` → `Google Gemini 3 Flash (multi-tool RAG agent with citations)`

    **Run pipeline tests:**
    ```
    cd apps/pipeline && uv run pytest
    ```
    Tests should pass — they mock Gemini calls and don't depend on specific model name strings.
  </action>
  <verify>
    1. `grep -rn "gemini-flash-latest\|gemini-2\.0-flash\|gemini-2\.5-flash" apps/pipeline/pipeline/ --include="*.py"` returns NO results (all deprecated model names replaced)
    2. `grep -rn "gemini-3-flash-preview" apps/pipeline/pipeline/ --include="*.py"` shows 7 occurrences across 5 files
    3. `cd apps/pipeline && uv run pytest` — all tests pass
    4. `grep "Gemini 3 Flash" README.md` shows updated references
  </verify>
  <done>
    All 7 pipeline Gemini model references updated to gemini-3-flash-preview. No deprecated model names remain anywhere in the codebase. README reflects current model. Pipeline tests pass.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "generative-ai" apps/web/ --include="*.ts" --include="*.tsx"` — zero results (old SDK gone)
2. `grep -rn "gemini-flash-latest\|gemini-2\.0-flash\|gemini-2\.5-flash" apps/ --include="*.py" --include="*.ts" --include="*.tsx"` — zero results (all deprecated model names gone)
3. `grep -rn "gemini-3-flash-preview" apps/` — shows all 10+ locations using new model name
4. `cd apps/web && pnpm build` — builds successfully
5. `cd apps/pipeline && uv run pytest` — all tests pass
6. `grep "d.section_title" apps/web/app/services/rag.server.ts` — heading fix confirmed
</verification>

<success_criteria>
- @google/generative-ai removed from package.json, @google/genai added
- All 3 web app files (rag.server.ts, api.search.tsx, api.intel.tsx) use GoogleGenAI from @google/genai
- All Gemini calls use model name "gemini-3-flash-preview"
- RAG heading field uses d.section_title (not d.heading)
- Web app builds for Cloudflare Workers
- Pipeline tests pass
- No deprecated Gemini model names remain in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/11-gap-closure-gemini-fix/11-01-SUMMARY.md`
</output>
