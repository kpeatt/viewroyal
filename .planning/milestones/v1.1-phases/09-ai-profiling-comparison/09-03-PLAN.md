---
phase: 09-ai-profiling-comparison
plan: 03
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - apps/web/app/routes/person-profile.tsx
  - apps/web/app/components/profile/speaking-time-card.tsx
  - apps/web/app/components/profile/speaker-ranking.tsx
  - apps/web/app/components/profile/stance-summary.tsx
autonomous: true
requirements: [PROF-02, PROF-04, PROF-05]

must_haves:
  truths:
    - "Councillor profile page shows total speaking time as headline stat"
    - "Councillor profile page shows speaking time trend chart (per-meeting sparkline)"
    - "Councillor profile page shows speaker ranking among peers"
    - "Councillor profile page shows AI stance summaries per topic with position spectrum"
    - "Each stance shows 1-3 evidence quotes with links to source meetings"
    - "Each stance shows confidence indicator (based on N statements badge)"
    - "Councillors without transcript data show appropriate empty state, not misleading zeros"
    - "Speaking time by topic is displayed, tying into topic categorization"
    - "Profile page has a Compare with... button linking to /compare"
  artifacts:
    - path: "apps/web/app/components/profile/speaking-time-card.tsx"
      provides: "Speaking time headline stat + trend chart + topic breakdown"
      min_lines: 50
    - path: "apps/web/app/components/profile/speaker-ranking.tsx"
      provides: "Bar chart ranking councillor among peers"
      min_lines: 40
    - path: "apps/web/app/components/profile/stance-summary.tsx"
      provides: "Per-topic stance card with evidence quotes and confidence"
      min_lines: 60
    - path: "apps/web/app/routes/person-profile.tsx"
      provides: "Enhanced profile page with speaking time and stances sections"
  key_links:
    - from: "apps/web/app/routes/person-profile.tsx"
      to: "apps/web/app/services/profiling.ts"
      via: "loader imports getSpeakingTimeStats, etc."
      pattern: "import.*profiling"
    - from: "apps/web/app/components/profile/stance-summary.tsx"
      to: "apps/web/app/lib/topic-utils.ts"
      via: "import TOPIC_ICONS, TOPIC_COLORS"
      pattern: "import.*topic-utils"
---

<objective>
Add speaking time metrics and AI stance summaries to the councillor profile page with new visual components (trend chart, speaker ranking, stance spectrum, evidence cards).

Purpose: Citizens can see how active a councillor is in speaking and understand their positions on key topics, all grounded in evidence.
Output: Enhanced person-profile.tsx with 4 new profile components.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-ai-profiling-comparison/09-RESEARCH.md
@.planning/phases/09-ai-profiling-comparison/09-01-SUMMARY.md
@apps/web/app/routes/person-profile.tsx
@apps/web/app/services/profiling.ts
@apps/web/app/lib/topic-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create speaking time and stance UI components</name>
  <files>
    apps/web/app/components/profile/speaking-time-card.tsx,
    apps/web/app/components/profile/speaker-ranking.tsx,
    apps/web/app/components/profile/stance-summary.tsx
  </files>
  <action>
Create `apps/web/app/components/profile/` directory (if not already created by Plan 01) with 3 components. Note: StanceSpectrum is already created by Plan 01 -- import it from `../profile/stance-spectrum`:

**speaking-time-card.tsx** -- `SpeakingTimeCard` component:
- Props: `totalSeconds: number`, `meetingCount: number`, `segmentCount: number`, `trendData: {meeting_date: string, seconds_spoken: number}[]`, `topicBreakdown: {topic: string, total_seconds: number}[]`, `rank?: number`, `totalCouncillors?: number`
- Headline stat: total hours spoken (convert seconds to "XX.X hours"), meeting count
- Ranking context: "Nth most active speaker" with ordinal suffix
- Sparkline trend chart: hand-rolled SVG polyline showing seconds per meeting over time. Follow research SVG pattern. Use currentColor for stroke, Tailwind blue-500 class. Show on hover/tap: meeting date + minutes spoken.
- Topic breakdown: horizontal bar chart (CSS width bars, same pattern as existing Focus Areas section) using TOPIC_COLORS. Each bar shows topic name, icon (from TOPIC_ICONS), and hours spoken.
- Time range selector: tabs for "Last 12 months" (default), "Current term", "All time" per user decision. Default startDate = 12 months ago from today. "Current term" uses the current council term start date (query from meetings or hardcode 2022-11-01 for View Royal). "All time" passes no date filter. The selector updates a state variable that triggers the parent loader to re-fetch via URL search params (e.g., `?timeRange=12m|term|all`). The Plan 01 RPCs already accept p_start_date and p_end_date parameters -- pass these accordingly.
- Show council average annotation on the sparkline ("Council avg: X min/meeting" as a dashed horizontal line on the SVG)
- Use Card component from shadcn/ui. Style consistently with existing sidebar cards (border-none, shadow-md, ring-1 ring-zinc-200/50).

**speaker-ranking.tsx** -- `SpeakerRanking` component:
- Props: `rankings: {person_id: number, person_name: string, image_url?: string, total_seconds: number}[]`, `currentPersonId: number`
- Horizontal bar chart: each councillor as a row with avatar circle, name, bar (CSS width), and total hours label
- Highlight the current councillor's bar with blue-600, others zinc-200
- Only show councillors with >0 speaking time (hide votes-only councillors)
- Link each bar to that councillor's profile page
- Sort by total_seconds descending

**stance-summary.tsx** -- `StanceSummary` component:
- Props: `stances: CouncillorStance[]` (from profiling.ts types)
- Renders a list of stance cards, one per topic
- Each card contains:
  - Topic icon (from TOPIC_ICONS) + topic name
  - StanceSpectrum component (position_score visualization)
  - Confidence badge: "Based on N statements" with color coding (high=green, medium=amber, low=zinc)
  - Summary text (2-3 sentences from AI)
  - Evidence quotes section (collapsible): 1-3 quotes with meeting date and link to meeting page
  - Links to relevant motions/votes if evidence_motion_ids present
- Low-data topics (<3 statements): show italic caveat "Limited evidence" before summary
- Empty state: "No stance data available" with muted icon
- Use TOPIC_COLORS for subtle card background tinting per topic

**StanceSpectrum** -- already created by Plan 01 (`apps/web/app/components/profile/stance-spectrum.tsx`). Import it in stance-summary.tsx where needed. Do NOT recreate it.
  </action>
  <verify>Run `pnpm typecheck` from apps/web/ to verify no type errors.</verify>
  <done>All 3 components created, typed, and compiling. SpeakingTimeCard shows headline + sparkline + topic bars with "Last 12 months" as default time range and filter tabs for "Current term" and "All time". SpeakerRanking shows horizontal bar chart. StanceSummary renders per-topic stance cards with evidence, importing StanceSpectrum from Plan 01.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate speaking time + stances into person-profile.tsx loader and page</name>
  <files>apps/web/app/routes/person-profile.tsx</files>
  <action>
Modify the existing person-profile.tsx (884 lines) to add speaking time and stance data:

**Loader changes:**
1. Import `getSpeakingTimeStats`, `getSpeakingTimeByMeeting`, `getSpeakingTimeByTopic`, `getCouncillorStances` from `../services/profiling`
2. Parse time range from URL search params: `const timeRange = url.searchParams.get("timeRange") || "12m"`. Compute startDate/endDate:
   - `"12m"`: startDate = 12 months ago from today, endDate = now
   - `"term"`: startDate = current council term start (2022-11-01 for View Royal), endDate = now
   - `"all"`: startDate = undefined, endDate = undefined (no filter)
3. Add these to the Promise.all in the loader (they're independent of each other):
   - `getSpeakingTimeStats(supabase, startDate, endDate)` -- for ranking all councillors
   - `getSpeakingTimeByMeeting(supabase, id, startDate, endDate)` -- for trend chart
   - `getSpeakingTimeByTopic(supabase, id, startDate, endDate)` -- for topic breakdown
   - `getCouncillorStances(supabase, id)` -- for stance summaries (not date-filtered)
4. Return new data in loader response: `speakingTimeRanking`, `speakingTimeTrend`, `speakingTimeByTopic`, `stances`, `timeRange`
5. Compute `currentPersonSpeakingTime` from the ranking data (find by person_id) for the headline stat

**Component changes:**
1. Import new components: `SpeakingTimeCard`, `SpeakerRanking`, `StanceSummary` from `../components/profile/`
2. Destructure new loader data in the component

3. **Sidebar additions** (in the `lg:col-span-4` div, between "Attendance Strength" card and "Voting Alignment" card):
   - Add `SpeakingTimeCard` if the person has speaking time data (total_seconds > 0)
   - Pass trend data, topic breakdown, rank position, total councillors with data

4. **"Compare with..." button**: Add a Link button in the card header area, next to the SubscribeButton:
   ```tsx
   <Link to={`/compare?a=${person.id}`} className="...">
     <Users className="h-3.5 w-3.5 mr-1" /> Compare
   </Link>
   ```
   Style as a small outline button matching the Follow button aesthetic.

5. **Main content tab additions**: Add a new "Stances" tab to the existing Tabs component:
   - New TabsTrigger: "Positions" with a MessageSquare or Target icon
   - New TabsContent: renders `StanceSummary` component with stances data
   - Position after "Attendance History" tab

6. **Speaker Ranking**: Add `SpeakerRanking` as a collapsible section within the SpeakingTimeCard or as a standalone section below it in the sidebar

7. **Handle missing data**: If person has zero speaking time (pre-diarization councillors), hide the SpeakingTimeCard entirely. If stances array is empty, show "No stance analysis available -- positions will appear after data processing" empty state in the Stances tab.

8. **Replace Focus Areas section**: The existing "Focus Areas" section in the sidebar (which counts transcript segments by category) should be replaced or enhanced by the speaking time by topic breakdown, since the new data is more comprehensive and uses the normalized topics.
  </action>
  <verify>Run `pnpm typecheck` from apps/web/. Then run `pnpm build` from apps/web/ to verify the build succeeds.</verify>
  <done>Person profile page loads speaking time data and stances from loader. Sidebar shows SpeakingTimeCard with trend + ranking. Main tabs include "Positions" tab with stance summaries. Focus Areas replaced by topic speaking time. Compare button present. Councillors without transcript data show clean empty states.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Profile page renders speaking time card with sparkline
4. Stances tab shows per-topic cards (may be empty if stances haven't been generated yet)
5. "Compare" button links to /compare?a={id}
6. Pre-diarization councillors show no speaking time card (no misleading zeros)
</verification>

<success_criteria>
- Speaking time headline stat + sparkline visible on profile page
- Speaker ranking bar chart shows all councillors with data
- Stances tab renders AI summaries with evidence and confidence badges
- Position spectrum visually indicates supports-to-opposes
- Compare button navigates to comparison page
- No type errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-profiling-comparison/09-03-SUMMARY.md`
</output>
