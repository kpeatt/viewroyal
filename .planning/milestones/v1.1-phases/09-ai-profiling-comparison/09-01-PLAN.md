---
phase: 09-ai-profiling-comparison
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/*_councillor_stances_and_speaking_time.sql
  - apps/web/app/lib/topic-utils.ts
  - apps/web/app/services/profiling.ts
  - apps/web/app/components/profile/stance-spectrum.tsx
autonomous: true
requirements: [PROF-02, PROF-04]

must_haves:
  truths:
    - "Speaking time aggregation runs in SQL, not application code"
    - "Category normalization maps 470 agenda_item categories to 8 predefined topics"
    - "councillor_stances table exists with position, score, evidence, confidence fields"
    - "Topic icons and colors are mapped for all 8 topics"
  artifacts:
    - path: "supabase/migrations/*_councillor_stances_and_speaking_time.sql"
      provides: "councillor_stances table, speaking time RPCs, category normalization function"
      contains: "councillor_stances"
    - path: "apps/web/app/lib/topic-utils.ts"
      provides: "Topic icon mapping, topic colors, topic list"
      exports: ["TOPIC_ICONS", "TOPIC_COLORS", "TOPICS"]
    - path: "apps/web/app/services/profiling.ts"
      provides: "Supabase query functions for speaking time and stances"
      exports: ["getSpeakingTimeStats", "getSpeakingTimeByMeeting", "getSpeakingTimeByTopic", "getCouncillorStances"]
    - path: "apps/web/app/components/profile/stance-spectrum.tsx"
      provides: "Visual supports-to-opposes position indicator"
      min_lines: 20
  key_links:
    - from: "apps/web/app/services/profiling.ts"
      to: "get_speaking_time_stats RPC"
      via: "supabase.rpc()"
      pattern: "supabase\\.rpc.*speaking_time"
---

<objective>
Create the database foundation for councillor profiling: speaking time SQL RPCs, category normalization function, councillor_stances table, and the web app service layer + topic utilities.

Purpose: All three downstream plans (stance generation, profile UI, comparison page) depend on this database schema and service layer.
Output: Migration applied, topic-utils.ts, profiling.ts service module.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-ai-profiling-comparison/09-RESEARCH.md
@apps/web/app/services/people.ts
@apps/web/app/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration with councillor_stances table, speaking time RPCs, and category normalization</name>
  <files>supabase/migrations/*_councillor_stances_and_speaking_time.sql</files>
  <action>
Apply a Supabase migration with the following:

1. **`councillor_stances` table:**
```sql
CREATE TABLE councillor_stances (
  id bigint generated by default as identity primary key,
  person_id bigint REFERENCES people(id) ON DELETE CASCADE NOT NULL,
  topic text NOT NULL,
  position text NOT NULL,        -- 'supports', 'opposes', 'mixed', 'neutral'
  position_score float,          -- -1.0 to 1.0
  summary text NOT NULL,
  evidence_quotes jsonb,         -- [{text, meeting_id, segment_id, date}]
  evidence_motion_ids bigint[],
  evidence_vote_ids bigint[],
  statement_count int NOT NULL,
  confidence text NOT NULL,      -- 'high', 'medium', 'low'
  generated_at timestamptz NOT NULL DEFAULT now(),
  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL,
  UNIQUE(person_id, topic)
);
```
Enable RLS. Add a permissive SELECT policy for anon/authenticated (stances are public data).

2. **`normalize_category_to_topic(cat text)` function** -- IMMUTABLE plpgsql function using the CASE/ILIKE pattern from research. Maps ~300 of 470 categories; remainder falls to 'General'. SET search_path = 'public'.

3. **`get_speaking_time_stats(p_start_date, p_end_date)` RPC** -- Returns person_id, person_name, image_url, total_seconds, meeting_count, segment_count. Aggregates from transcript_segments joined to people and meetings. Filters by date range. Orders by total descending. SET search_path = 'public'.

4. **`get_speaking_time_by_meeting(p_person_id, p_start_date, p_end_date)` RPC** -- Returns meeting_id, meeting_date, seconds_spoken, segment_count for a specific person. Orders by meeting_date ascending. SET search_path = 'public'.

5. **`get_speaking_time_by_topic(p_person_id, p_start_date, p_end_date)` RPC** -- Joins transcript_segments with agenda_items (via agenda_item_id or time-overlap using discussion_start_time/end_time), applies normalize_category_to_topic(), groups by topic. Returns topic, total_seconds, segment_count. SET search_path = 'public'. For segments without agenda_item_id, use a LEFT JOIN on agenda_items via meeting_id + time overlap (segment start_time BETWEEN discussion_start_time AND discussion_end_time). Segments that don't match any agenda item get topic 'General'.

Use `mcp__supabase__apply_migration` to apply.
  </action>
  <verify>Run `mcp__supabase__execute_sql` to verify: (1) SELECT * FROM councillor_stances LIMIT 0; (2) SELECT normalize_category_to_topic('Development Permit'); (3) SELECT * FROM get_speaking_time_stats() LIMIT 3; (4) SELECT * FROM get_speaking_time_by_meeting(35) LIMIT 3; (5) SELECT * FROM get_speaking_time_by_topic(35) LIMIT 3;</verify>
  <done>All 5 database objects exist and return expected data types. Speaking time RPCs return actual data for councillor ID 35 (Sid Tobias). Category normalization returns 'Development' for 'Development Permit'.</done>
</task>

<task type="auto">
  <name>Task 2: Create topic-utils.ts, profiling.ts service module, and StanceSpectrum component</name>
  <files>apps/web/app/lib/topic-utils.ts, apps/web/app/services/profiling.ts, apps/web/app/components/profile/stance-spectrum.tsx</files>
  <action>
**topic-utils.ts:** Create with:
- `TOPICS` array of the 8 topic names
- `TOPIC_ICONS` map: topic name -> lucide-react icon component (Administration=Building2, Bylaw=ScrollText, Development=MapPin, Environment=Trees, Finance=Coins, General=FileText, Public Safety=Shield, Transportation=Car)
- `TOPIC_COLORS` map: topic name -> Tailwind class string for text/bg/border per research code example
- Export all three

**profiling.ts:** Create with typed Supabase query functions:

1. `getSpeakingTimeStats(supabase, startDate?, endDate?)` -- calls `supabase.rpc('get_speaking_time_stats', {...})`. Returns array of `{person_id, person_name, image_url, total_seconds, meeting_count, segment_count}`.

2. `getSpeakingTimeByMeeting(supabase, personId, startDate?, endDate?)` -- calls `supabase.rpc('get_speaking_time_by_meeting', {...})`. Returns array of `{meeting_id, meeting_date, seconds_spoken, segment_count}`.

3. `getSpeakingTimeByTopic(supabase, personId, startDate?, endDate?)` -- calls `supabase.rpc('get_speaking_time_by_topic', {...})`. Returns array of `{topic, total_seconds, segment_count}`.

4. `getCouncillorStances(supabase, personId)` -- queries `councillor_stances` table for a person, ordered by statement_count DESC. Returns typed array with all stance fields.

5. TypeScript interfaces: `SpeakingTimeStat`, `SpeakingTimeByMeeting`, `SpeakingTimeByTopic`, `CouncillorStance`.

Follow the existing service pattern from `apps/web/app/services/people.ts` (accept SupabaseClient, return typed data).

**stance-spectrum.tsx:** Create `apps/web/app/components/profile/stance-spectrum.tsx` -- `StanceSpectrum` component:
- Props: `score: number` (-1 to 1), `position: string` ('supports'|'opposes'|'mixed'|'neutral')
- Visual: horizontal gradient bar from red (opposes, -1) through neutral (0, gray) to green (supports, +1)
- Positioned marker (small circle/diamond) at the score position
- Text label below: position capitalized (e.g., "Supports", "Mixed")
- All CSS/Tailwind, no SVG needed. Use a relative-positioned container with absolute-positioned marker.
- Width: full width of parent card
- Pure presentational component with no data dependencies -- created here in Plan 01 so both Plan 03 (profile page) and Plan 04 (comparison page) can import it in Wave 2.
  </action>
  <verify>Run `pnpm typecheck` from apps/web/ to verify no type errors in new files.</verify>
  <done>topic-utils.ts exports TOPICS, TOPIC_ICONS, TOPIC_COLORS. profiling.ts exports 4 query functions and 4 TypeScript interfaces. StanceSpectrum component created and compiling. No type errors.</done>
</task>

</tasks>

<verification>
1. Migration applied successfully (check via `mcp__supabase__list_migrations`)
2. All RPCs return data for councillors with transcript segments
3. TypeScript compiles without errors
4. Category normalization covers Development, Bylaw, Environment, Finance, Transportation, Public Safety, Administration categories correctly
</verification>

<success_criteria>
- councillor_stances table exists with proper schema and RLS
- 3 speaking time RPCs return real data
- normalize_category_to_topic function works for known categories
- profiling.ts service module exports typed query functions
- topic-utils.ts provides icon/color mapping for all 8 topics
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-profiling-comparison/09-01-SUMMARY.md`
</output>
