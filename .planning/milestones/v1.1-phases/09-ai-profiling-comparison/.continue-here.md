---
phase: 09-ai-profiling-comparison
task: post-execution
total_tasks: 4 plans (all complete)
status: fixing_runtime_bugs
last_updated: 2026-02-18T21:37:20.499Z
---

<current_state>
Phase 9 execution is COMPLETE (4/4 plans, verification passed 12/12 must-haves). Stance generation pipeline ran successfully (104 stances for 13 councillors). Currently fixing runtime bugs discovered when loading profile pages.
</current_state>

<completed_work>

- Plan 09-01: Database foundation - Done (councillor_stances table, 3 speaking time RPCs, category normalization, profiling.ts service, topic-utils.ts, StanceSpectrum component)
- Plan 09-02: Stance generation pipeline - Done (stance_generator.py 504 lines, --generate-stances CLI flag)
- Plan 09-03: Profile page UI - Done (SpeakingTimeCard, SpeakerRanking, StanceSummary components, profile page enhanced)
- Plan 09-04: Comparison page - Done (/compare route ~700 lines with selection/comparison modes)
- Verification: Passed (12/12 must-haves, VERIFICATION.md created)
- Roadmap/State: Updated, phase marked complete
- Stance data: 104 stances generated for 13 councillors using gemini-2.0-flash
- Bug fix 1: Fixed motions.motion_text → motions.text_content in stance_generator.py (committed 21e3bcb6)
- Bug fix 2: Removed non-existent confidence_note column from upsert (committed 21e3bcb6)
- Bug fix 3: Made profiling queries graceful (catch errors, return empty arrays) so profile page doesn't crash (uncommitted)
</completed_work>

<remaining_work>

- **CRITICAL: get_speaking_time_by_topic RPC is too slow (13 seconds, causing timeouts)**
  - Root cause: time-overlap LEFT JOIN between transcript_segments and agenda_items (falls back to matching segment start_time within discussion_start_time/discussion_end_time window when agenda_item_id is NULL)
  - This join scans all agenda_items for each unlinked segment per meeting — O(segments × agenda_items)
  - Needs: index on agenda_items(meeting_id, discussion_start_time, discussion_end_time) or rewrite to avoid time-overlap join
  - The get_speaking_time_stats and get_speaking_time_by_meeting RPCs may also be slow but less so (they don't do topic normalization)
- Commit the graceful degradation fix in person-profile.tsx
- Deploy to Cloudflare Workers (pnpm deploy from apps/web/)
- Supabase advisors show pre-existing issues (unindexed foreign keys, mutable search_path functions, multiple permissive policies) — not new from Phase 9
</remaining_work>

<decisions_made>

- Used gemini-2.0-flash (not gemini-2.5-flash) for stance generation to avoid rate limits on 2.5
- Made profiling queries non-blocking with .catch() so the profile page degrades gracefully instead of crashing
- Phase 9 marked complete in ROADMAP.md — this is the last phase of v1.1 Deep Intelligence milestone
</decisions_made>

<blockers>
- get_speaking_time_by_topic RPC timeout: 13s execution time causes Supabase statement timeout on free tier. Need to optimize the SQL function before deploying.
</blockers>

<context>
The speaking time by topic RPC does a complex LEFT JOIN with a time-overlap fallback for transcript segments that don't have a direct agenda_item_id link. This is expensive because it has to check every agenda item's discussion window for each unlinked segment. Options:
1. Add a composite index on agenda_items(meeting_id, discussion_start_time, discussion_end_time)
2. Pre-compute topic assignments for transcript segments (materialized view or denormalized column)
3. Simplify: only use direct agenda_item_id links (skip time-overlap, accept some segments as "General")

Option 3 is simplest and probably good enough — most segments that matter already have agenda_item_id set.
</context>

<next_action>
Start with: Optimize get_speaking_time_by_topic RPC. Either add an index or simplify to remove the time-overlap JOIN. Then commit the person-profile.tsx graceful degradation fix, deploy, and test on production.
</next_action>
