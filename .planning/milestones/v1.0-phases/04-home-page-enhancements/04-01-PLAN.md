---
phase: 04-home-page-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/services/site.ts
  - apps/web/app/components/home/view-royal-map.tsx
autonomous: true
requirements:
  - HOME-01
  - HOME-02
  - HOME-03
  - HOME-04
  - HOME-05

must_haves:
  truths:
    - "getHomeData() returns activeMatters array with title, category, last_seen, first_seen, and plain_english_summary from agenda_items join"
    - "getHomeData() returns recentDecisions array with plain_english_summary, result, financial_cost, vote counts aggregated from votes table, and meeting link data"
    - "getHomeData() returns upcomingMeeting (singular) with agenda topic preview titles when available"
    - "getHomeData() returns recentMeetingData with summary, key decisions, and stats (motion count, divided votes, agenda items)"
    - "Vote counts come from individual votes table records, NOT from motions.yes_votes/no_votes (which are always 0)"
    - "Matter summaries come from agenda_items.plain_english_summary join, NOT from matters.plain_english_summary (which is always null)"
    - "A static SVG map component renders View Royal neighbourhood boundaries as decorative outline"
  artifacts:
    - path: "apps/web/app/services/site.ts"
      provides: "Refactored getHomeData() returning all five section data sets"
      contains: "activeMatters"
    - path: "apps/web/app/components/home/view-royal-map.tsx"
      provides: "Static SVG map component for hero background"
      contains: "ViewRoyalMap"
  key_links:
    - from: "apps/web/app/services/site.ts"
      to: "Supabase matters + agenda_items"
      via: "join on matter_id for summaries"
      pattern: "agenda_items.*matter_id"
    - from: "apps/web/app/services/site.ts"
      to: "Supabase motions + votes"
      via: "nested select with votes(vote)"
      pattern: "votes\\(vote\\)"
---

<objective>
Refactor the home page data layer and create the decorative map SVG component, preparing all data and assets needed for the full home page UI rewrite in Plan 02.

Purpose: The current `getHomeData()` only fetches meetings, council members, and public notices. The new home page needs active matters with summaries, a decisions feed with vote aggregation, upcoming meeting with agenda preview, and richer recent meeting data. Vote counts must come from the `votes` table (not the always-zero motions columns), and matter summaries must come from `agenda_items` (not the always-null matters column). The map SVG needs to be generated from the existing GeoJSON file.

Output: Refactored `services/site.ts` with new data queries, and a `ViewRoyalMap` SVG component in `components/home/`.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-home-page-enhancements/04-RESEARCH.md

@apps/web/app/services/site.ts
@apps/web/app/services/meetings.ts
@apps/web/app/lib/types.ts
@data/neighbourhoods.geojson
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor getHomeData() with new data queries</name>
  <files>apps/web/app/services/site.ts</files>
  <action>
Refactor `getHomeData()` in `apps/web/app/services/site.ts` to return data for all five home page sections. Remove the council members query and public notices fetch (no longer needed on the new home page). Keep `getPublicNotices()` and `getAboutStats()` as separate exports since they may be used elsewhere.

**Batch 1 (parallel independent queries):**

1. **Latest/recent meeting** (keep existing query, but also fetch most recent past meeting for the "featured" section):
   - Query `meetings` with `has_transcript = true`, ordered by `meeting_date DESC`, limit 1
   - Select: `id, title, type, meeting_date, summary, video_duration_seconds, organizations(name)`

2. **Upcoming meeting** (singular — only the next one):
   - Query `meetings` where `meeting_date > today`, ordered ascending, limit 1, `.maybeSingle()`
   - Select: `id, title, meeting_date, type, has_agenda, organizations(name)`

3. **Active matters** (6 items, ordered by last_seen):
   - Query `matters` where `status = 'Active'`, ordered by `last_seen DESC NULLS LAST`, limit 6
   - Select: `id, title, category, status, first_seen, last_seen`
   - IMPORTANT: Do NOT select `plain_english_summary` from matters (it is always null)

4. **Recent decisions** (15 non-procedural motions with vote data):
   - Query `motions` with nested selects: `id, plain_english_summary, text_content, result, disposition, financial_cost, meeting_id, meetings!inner(id, meeting_date, title), votes(vote)`
   - Filter: `.not("result", "is", null)` and `.neq("disposition", "Procedural")`
   - Order by `meeting_id DESC` (proxy for recency since meeting_id correlates with date)
   - Limit 15
   - IMPORTANT: Do NOT use `motions.yes_votes` or `motions.no_votes` — they are always 0. Use the nested `votes(vote)` select.
   - Note: Cannot filter by `agenda_items.category != 'Procedural'` in same query reliably with PostgREST. Filter procedural categories client-side if needed.

**Batch 2 (dependent queries — need IDs from batch 1):**

5. **Agenda preview for upcoming meeting** (if upcoming meeting has_agenda):
   - Query `agenda_items` where `meeting_id = upcomingMeeting.id` and `category != 'Procedural'`
   - Select: `title, category`
   - Limit 4

6. **Matter summaries from agenda_items** (for the 6 active matters):
   - Query `agenda_items` where `matter_id IN (matterIds)` and `plain_english_summary IS NOT NULL`
   - Select: `matter_id, plain_english_summary, created_at`
   - Order by `created_at DESC`
   - Build a Map: for each matter_id, keep only the first (most recent) summary

7. **Key decisions + stats for recent meeting** (reuse existing pattern):
   - Query `motions` for `meeting_id = recentMeeting.id` with `.not("result", "is", null)`
   - Also include `votes(vote)` to count divided votes
   - Query `agenda_items` count for `meeting_id = recentMeeting.id`

**Post-processing:**

- **Active matters:** Merge summaries from the Map into each matter object. Return array of `{ id, title, category, status, first_seen, last_seen, summary }`.

- **Decisions feed:** Process vote data client-side:
  ```typescript
  const decisionsWithVotes = recentMotions.map(m => {
    const votes = m.votes || [];
    const yesCount = votes.filter(v => v.vote === "Yes").length;
    const noCount = votes.filter(v => v.vote === "No").length;
    const isDivided = noCount > 0;
    return {
      id: m.id,
      summary: m.plain_english_summary || m.text_content,
      result: m.result,
      financialCost: m.financial_cost,
      meetingId: m.meeting_id,
      meetingDate: m.meetings?.meeting_date,
      meetingTitle: m.meetings?.title,
      yesCount,
      noCount,
      isDivided,
    };
  });
  ```

- **Recent meeting stats:** Include `dividedVotes` count (motions where votes have any "No").

**Return shape:**
```typescript
return {
  upcomingMeeting: { ...nextMeeting, agendaPreview: string[] },
  recentMeeting: latestMeetingRes.data,
  recentMeetingStats: { agendaItems, totalMotions, motionsPassed, dividedVotes, duration },
  recentMeetingDecisions: keyDecisions,
  activeMatters: mattersWithSummaries,
  recentDecisions: decisionsWithVotes,
};
```

Wrap each query batch in try/catch so individual section failures don't break the entire page. Return null/empty arrays for failed sections.
  </action>
  <verify>Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` — should pass with no new errors (existing pre-known errors are acceptable). Verify the function signature and return type are consistent.</verify>
  <done>getHomeData() returns all six data sets needed by the new home page: upcomingMeeting (with agendaPreview), recentMeeting (with stats and key decisions), activeMatters (with summaries from agenda_items), and recentDecisions (with vote counts from votes table). No N+1 queries — all data fetched in 2 parallel batches.</done>
</task>

<task type="auto">
  <name>Task 2: Generate decorative SVG map component from GeoJSON</name>
  <files>apps/web/app/components/home/view-royal-map.tsx</files>
  <action>
Create `apps/web/app/components/home/view-royal-map.tsx` — a React component that renders a static, decorative SVG outline of View Royal's neighbourhood boundaries.

**Steps:**

1. Read `data/neighbourhoods.geojson` to extract polygon coordinates.

2. Write a script or manually convert the GeoJSON polygon coordinates to SVG path `d` attributes:
   - The GeoJSON uses lon/lat coordinates (WGS84). For a decorative map, use a simple linear projection:
     - Find the bounding box of all coordinates (min/max lon and lat)
     - Map lon to x (0 to viewBox width) and lat to y (0 to viewBox height, INVERT y since lat increases northward but SVG y increases downward)
   - Simplify paths: reduce coordinate precision to 1-2 decimal places for the SVG `d` attribute
   - Each neighbourhood polygon becomes one `<path>` element

3. Create the component:
   ```typescript
   interface ViewRoyalMapProps {
     className?: string;
   }

   export function ViewRoyalMap({ className }: ViewRoyalMapProps) {
     return (
       <svg
         viewBox="0 0 800 600"
         fill="none"
         xmlns="http://www.w3.org/2000/svg"
         className={className}
         aria-hidden="true"
       >
         {/* Neighbourhood boundary paths — stroke only, no fill */}
         <path d="..." stroke="currentColor" strokeWidth="1.5" />
         {/* ... one path per neighbourhood polygon */}
       </svg>
     );
   }
   ```

**Design requirements (from user decisions):**
- Stroke-only rendering (no fill) — outline style
- `aria-hidden="true"` since it's purely decorative
- Accepts `className` prop for the parent to control size, opacity, color
- The parent (HeroSection) will apply: `opacity-[0.07]`, `pointer-events-none`, `absolute inset-0`
- Keep the SVG lightweight — aggressively simplify paths since it's shown at very low opacity

**Important:** The SVG paths should be inlined in the component (not loaded from a file) to avoid render-blocking network requests. The GeoJSON is 38KB but the simplified SVG paths should be much smaller.
  </action>
  <verify>The component file exists, exports `ViewRoyalMap`, renders a valid SVG with `viewBox`, `fill="none"`, `aria-hidden="true"`, and multiple `<path>` elements with `stroke="currentColor"`.</verify>
  <done>A static ViewRoyalMap React component exists that renders simplified SVG neighbourhood outlines suitable for decorative hero background use. It accepts className for external styling control.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` in `apps/web/` passes (no new type errors)
2. `getHomeData()` return shape includes: upcomingMeeting, recentMeeting, recentMeetingStats, recentMeetingDecisions, activeMatters, recentDecisions
3. Vote counts in recentDecisions are derived from `votes(vote)` nested select, not from `motions.yes_votes`/`no_votes`
4. Matter summaries in activeMatters come from `agenda_items.plain_english_summary` join, not from `matters.plain_english_summary`
5. ViewRoyalMap component renders valid SVG with neighbourhood outlines
</verification>

<success_criteria>
- getHomeData() fetches all data needed for five home page sections in 2 parallel query batches
- Active matters include summaries sourced from agenda_items (not the null matters.plain_english_summary)
- Decisions feed includes vote breakdown from individual vote records (not the zero-value motions columns)
- Upcoming meeting includes agenda topic preview when available
- Recent meeting includes summary, key decisions, and stats with divided vote count
- ViewRoyalMap SVG component exists and renders decorative outline map
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-home-page-enhancements/04-01-SUMMARY.md`
</output>
