---
phase: 02-multi-tenancy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/root.tsx
  - apps/web/app/lib/types.ts
  - apps/web/app/services/municipality.ts
  - apps/web/app/lib/municipality-helpers.ts
  - apps/web/app/services/site.ts
  - apps/web/app/services/people.ts
  - apps/web/app/services/rag.server.ts
  - apps/web/app/services/vimeo.server.ts
  - apps/web/app/routes/home.tsx
  - apps/web/app/routes/meetings.tsx
  - apps/web/app/routes/matters.tsx
  - apps/web/app/routes/people.tsx
  - apps/web/app/routes/bylaws.tsx
  - apps/web/app/routes/elections.tsx
  - apps/web/app/routes/ask.tsx
  - apps/web/app/routes/api.ask.tsx
  - apps/web/app/routes/api.vimeo-url.ts
  - apps/web/app/routes/person-detail.tsx
  - apps/web/app/routes/matter-detail.tsx
  - apps/web/app/routes/meeting-detail.tsx
  - apps/web/app/routes/bylaw-detail.tsx
  - apps/web/app/routes/election-detail.tsx
  - apps/web/app/components/navbar.tsx
  - apps/web/workers/app.ts
  - README.md
autonomous: false
requirements: [MT-01, MT-02, MT-03, MT-04, MT-05, MT-06]

must_haves:
  truths:
    - "Root loader fetches municipality data from the municipalities table and makes it available to all routes"
    - "Page titles and meta tags display the correct municipality name dynamically (not hardcoded 'View Royal')"
    - "Service queries accept and filter by municipality_id so data from different towns never leaks"
    - "RAG system prompts reference the municipality name dynamically"
    - "Vimeo proxy uses dynamic websiteUrl for Referer/Origin"
    - "PR #36 is merged to main with no regressions (typecheck passes, build succeeds)"
  artifacts:
    - path: "apps/web/app/services/municipality.ts"
      provides: "getMunicipality service function"
      contains: "getMunicipality"
    - path: "apps/web/app/lib/municipality-helpers.ts"
      provides: "getMunicipalityFromMatches helper for meta functions"
      contains: "getMunicipalityFromMatches"
    - path: "apps/web/app/root.tsx"
      provides: "Municipality loaded in root loader"
      contains: "getMunicipality"
  key_links:
    - from: "apps/web/app/root.tsx"
      to: "apps/web/app/services/municipality.ts"
      via: "getMunicipality import and call in loader"
      pattern: "getMunicipality"
    - from: "apps/web/app/routes/*.tsx"
      to: "apps/web/app/root.tsx"
      via: "useRouteLoaderData('root') for municipality context"
      pattern: "useRouteLoaderData.*root"
    - from: "apps/web/app/services/rag.server.ts"
      to: "municipality name parameter"
      via: "getOrchestratorSystemPrompt and getFinalSystemPrompt functions"
      pattern: "municipalityName"
---

<objective>
Merge PR #36 (municipality context layer) into main and validate the entire multi-tenancy implementation.

Purpose: The web app must dynamically adapt to any municipality in the database. PR #36 implements this by adding a municipality service, threading context through the root loader, and replacing hardcoded "View Royal" references with dynamic data. Research confirms zero merge conflicts.

Output: PR #36 merged to main with passing typecheck, successful build, and verified municipality context threading.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-tenancy/02-RESEARCH.md
@.planning/phases/02-multi-tenancy/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge PR #36 and validate build</name>
  <files>All 24 files from PR #36 branch (apps/web/ + README.md + workers/app.ts)</files>
  <action>
1. Re-verify zero conflicts before merging:
   ```
   git merge-tree $(git merge-base main phase4/municipality-context-layer) main phase4/municipality-context-layer
   ```
   If any conflicts appear, STOP and report. Research says zero conflicts -- if that changed, manual resolution is needed.

2. Merge PR #36's branch into main:
   ```
   cd /Users/kyle/development/viewroyal
   git merge phase4/municipality-context-layer --no-ff -m "feat(multi-tenancy): merge municipality context layer (PR #36)"
   ```

3. Run typecheck (note: pre-existing workers/app.ts ScheduledEvent type error may cause exit code 1 -- PR #36 includes a fix for this, so typecheck should now pass):
   ```
   cd apps/web && pnpm typecheck
   ```

4. Run build:
   ```
   cd apps/web && pnpm build
   ```

5. If typecheck or build fails with NEW errors (not the pre-existing workers/app.ts issue), investigate and fix. The merge should be clean per research.

IMPORTANT: PR #36 includes a drive-by fix changing ScheduledEvent to ScheduledController in workers/app.ts. This is a legitimate type correction -- accept it.

IMPORTANT: The pipeline files (ai_refiner.py, embed.py, ingester.py) shown in PR #36's GitHub UI are from earlier commits already on main. The merge will keep main's versions. Do NOT expect conflicts in pipeline files.
  </action>
  <verify>
- `git log --oneline -1` shows the merge commit
- `cd apps/web && pnpm typecheck` exits cleanly (or only pre-existing errors)
- `cd apps/web && pnpm build` succeeds
- `git diff --name-only HEAD~1..HEAD` shows the expected ~24 web app files
  </verify>
  <done>PR #36 is merged to main. Typecheck passes. Build succeeds. No regressions introduced.</done>
</task>

<task type="auto">
  <name>Task 2: Audit municipality context and hardcoded strings</name>
  <files>apps/web/app/</files>
  <action>
1. Verify the municipality service exists and follows locked decisions:
   - `apps/web/app/services/municipality.ts` must exist
   - Must use hardcoded slug `"view-royal"` (per user decision: slug stays in root loader code or service, not extracted to config constant)
   - Must throw a hard error if municipality lookup fails (per user decision: no graceful fallback)

2. Verify root loader threads municipality context:
   - `apps/web/app/root.tsx` loader must call `getMunicipality(supabase)` and return municipality in loader data

3. Verify municipality helper for meta functions:
   - `apps/web/app/lib/municipality-helpers.ts` must exist with `getMunicipalityFromMatches` function

4. Audit hardcoded "View Royal" strings in `apps/web/app/`:
   ```
   grep -rn "View Royal" apps/web/app/ --include="*.ts" --include="*.tsx" | grep -v node_modules
   ```
   Classify each match:
   - **Fallback default** (e.g., `|| "View Royal"`) -- ACCEPTABLE, defensive coding
   - **Product branding** (e.g., "ViewRoyal.ai") -- ACCEPTABLE, product name not municipality
   - **Hardcoded municipality name** without fallback -- NEEDS FIXING (none expected per research)

5. Verify RAG system prompts are dynamic:
   - `apps/web/app/services/rag.server.ts` must have `getOrchestratorSystemPrompt(name)` and `getFinalSystemPrompt(name)` functions (not constants)
   - `apps/web/app/routes/api.ask.tsx` must pass `municipalityName` to the RAG functions

6. Verify Vimeo proxy uses dynamic websiteUrl:
   - `apps/web/app/services/vimeo.server.ts` must accept `websiteUrl` parameter
   - `apps/web/app/routes/api.vimeo-url.ts` must pass the website URL from municipality context

7. Verify service queries accept municipality_id:
   - `apps/web/app/services/site.ts` accepts municipality parameter
   - `apps/web/app/services/people.ts` accepts municipalityId parameter

Report findings. If any hardcoded municipality names are found (not fallbacks, not branding), fix them following the pattern: use `municipality?.short_name || "View Royal"` where municipality comes from `useRouteLoaderData("root")` or `getMunicipalityFromMatches(matches)`.
  </action>
  <verify>
- `grep -rn "View Royal" apps/web/app/ --include="*.ts" --include="*.tsx"` returns only fallback defaults and product branding
- `apps/web/app/services/municipality.ts` exists and throws on failure
- `apps/web/app/root.tsx` loader returns municipality data
- `apps/web/app/services/rag.server.ts` has dynamic prompt functions
- `apps/web/app/services/vimeo.server.ts` accepts websiteUrl parameter
  </verify>
  <done>All 6 MT requirements verified: municipality context in root loader (MT-01), dynamic strings replacing hardcoded (MT-02), service queries accept municipality_id (MT-03), RAG prompts dynamic (MT-04), Vimeo uses dynamic URL (MT-05), PR #36 merged cleanly (MT-06). Any remaining "View Royal" strings are fallback defaults or product branding.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Smoke test multi-tenancy in dev server</name>
  <files>apps/web/</files>
  <action>
Start the dev server (`cd apps/web && pnpm dev`) and present the smoke test checklist to the user for manual verification. Municipality context layer merged from PR #36. The web app should dynamically use municipality data from the database instead of hardcoded "View Royal" strings. Root loader fetches municipality, all routes and meta functions use it. RAG prompts reference the municipality dynamically. Vimeo proxy uses dynamic Referer.

Smoke test checklist:
1. Open http://localhost:5173 -- home page loads with council members and public notices
2. View page source (Cmd+U) -- meta tags use dynamic municipality data, not hardcoded strings
3. Navigate to Meetings page -- page loads and title includes municipality name
4. Navigate to Ask page -- submit a test question, verify RAG response references municipality correctly
5. Navigate to a meeting detail page with Vimeo video -- verify video playback works
6. Check browser console -- no new errors related to municipality data
  </action>
  <verify>User confirms all smoke test items pass</verify>
  <done>Dev server loads correctly with dynamic municipality context. All pages display municipality name from database. No regressions in RAG or video playback.</done>
</task>

</tasks>

<verification>
1. `git log --oneline | head -3` shows the merge commit for PR #36
2. `cd apps/web && pnpm typecheck` passes (pre-existing workers/app.ts error should be fixed by PR #36's ScheduledController change)
3. `cd apps/web && pnpm build` succeeds
4. Municipality service exists at `apps/web/app/services/municipality.ts`
5. Municipality helper exists at `apps/web/app/lib/municipality-helpers.ts`
6. Root loader in `apps/web/app/root.tsx` calls `getMunicipality`
7. All "View Royal" references in `apps/web/app/` are fallback defaults or product branding
8. RAG prompts are functions, not constants
9. Vimeo service accepts `websiteUrl` parameter
10. Dev server loads and serves pages correctly
</verification>

<success_criteria>
- PR #36 merged to main with no conflicts
- `pnpm typecheck` passes
- `pnpm build` succeeds
- All 6 MT requirements verified via code audit
- Dev server smoke test approved by user
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-tenancy/02-01-SUMMARY.md`
</output>
