---
phase: 03-subscriptions-notifications
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - supabase/migrations/fix_rpc_search_path.sql
autonomous: false
requirements: [SUB-07, SUB-11]
user_setup:
  - service: supabase-auth
    why: "Public signup requires Supabase Auth dashboard configuration"
    env_vars: []
    dashboard_config:
      - task: "Enable public email signups"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> Enable Sign Ups toggle"
      - task: "Set Site URL to https://viewroyal.ai"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Site URL"
      - task: "Add redirect URLs"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Redirect URLs: https://viewroyal.ai/**, http://localhost:5173/**"
  - service: resend
    why: "Email delivery for subscription alerts and auth confirmation emails"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Create Resend account and get API key"
        location: "https://resend.com/signup"
      - task: "Add viewroyal.ai domain in Resend"
        location: "Resend Dashboard -> Domains -> Add Domain"
      - task: "Add DNS records (SPF TXT, DKIM CNAME) to viewroyal.ai"
        location: "DNS provider for viewroyal.ai"
      - task: "Set RESEND_API_KEY as Supabase Edge Function secret"
        location: "Supabase Dashboard -> Edge Functions -> Secrets, or: supabase secrets set RESEND_API_KEY=<key>"
  - service: supabase-smtp
    why: "Auth confirmation emails need custom SMTP (Supabase default: 2 emails/hour)"
    env_vars: []
    dashboard_config:
      - task: "Configure custom SMTP in Supabase Auth (can use Resend SMTP relay)"
        location: "Supabase Dashboard -> Authentication -> SMTP Settings -> Enable Custom SMTP"

must_haves:
  truths:
    - "Security advisory for mutable search_path on subscription RPC functions is resolved"
    - "User can sign up, log in, and access settings page in dev server"
    - "Subscribe button on a matter page toggles subscription state"
    - "Email configuration requirements are documented and communicated to user"
  artifacts:
    - path: "supabase/migrations/fix_rpc_search_path.sql"
      provides: "Migration fixing mutable search_path on find_matters_near, build_meeting_digest, find_meeting_subscribers"
      contains: "SET search_path"
  key_links:
    - from: "supabase/functions/send-alerts/index.ts"
      to: "Resend API"
      via: "RESEND_API_KEY environment variable"
      pattern: "RESEND_API_KEY"
---

<objective>
Fix the security advisory on subscription RPC functions, then verify the full subscription flow end-to-end in the dev server.

Purpose: The subscription UI from Plan 01 is on main but untested. This plan fixes a known security issue (mutable search_path), then runs a human-verified smoke test to confirm signup, settings, and subscribe flows work. External service configuration (Resend, Supabase Auth public signup, custom SMTP) is documented for the user to complete.

Output: Security fix applied, subscription UI verified working in dev, external config steps clearly documented.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-subscriptions-notifications/03-RESEARCH.md
@.planning/phases/03-subscriptions-notifications/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix mutable search_path on subscription RPC functions</name>
  <files>supabase/migrations/fix_rpc_search_path.sql</files>
  <action>
    The Supabase security advisor flagged three RPC functions from PR #13's schema with mutable search_path:
    - `find_matters_near`
    - `build_meeting_digest`
    - `find_meeting_subscribers`

    Apply a Supabase migration using the MCP `apply_migration` tool to add `SET search_path = 'public'` to each function. Use `CREATE OR REPLACE FUNCTION` with the existing function signatures to modify only the search_path setting.

    First, inspect the current function definitions using `execute_sql`:
    ```sql
    SELECT proname, prosrc FROM pg_proc WHERE proname IN ('find_matters_near', 'build_meeting_digest', 'find_meeting_subscribers');
    ```

    Then create the migration that adds `SET search_path = 'public'` to each function using `ALTER FUNCTION ... SET search_path = 'public'`. This is the simplest fix — no need to redefine the function body.

    ```sql
    ALTER FUNCTION public.find_matters_near(double precision, double precision, double precision, integer) SET search_path = 'public';
    ALTER FUNCTION public.build_meeting_digest(bigint) SET search_path = 'public';
    ALTER FUNCTION public.find_meeting_subscribers(bigint) SET search_path = 'public';
    ```

    After applying, re-run the Supabase security advisor to verify the warnings are resolved.
  </action>
  <verify>Run `get_advisors` (security type) via Supabase MCP tool and confirm the mutable search_path warnings for these three functions no longer appear.</verify>
  <done>All three subscription RPC functions have immutable search_path set. Security advisor no longer flags them.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Smoke test subscription flow in dev server</name>
  <files>apps/web/</files>
  <action>
    Start dev server with `cd apps/web && pnpm dev` and verify the complete subscription UI.

    What was built (in Plan 01 + Task 1): signup page, settings page, subscribe buttons on matter/person pages, API routes for subscribe/unsubscribe, navbar with alerts/settings links, security fix on RPC functions.

    Verification steps for the user:

    1. **Anonymous experience:** Visit http://localhost:5173
       - Navbar should show "Get Alerts" button (blue, top-right on desktop)
       - Visit a matter detail page — "Follow Matter" button should appear, clicking it redirects to /signup
       - Visit a person profile page — "Follow" button should appear on councillor profiles

    2. **Signup flow:** Visit http://localhost:5173/signup
       - Page should show "Get Council Alerts" heading with email/password form
       - (Note: actual signup requires Supabase Auth public signup to be enabled — if you get an error, that's expected and will be resolved by dashboard config)

    3. **Login flow:** Visit http://localhost:5173/login
       - Should show "Want council alerts? Create an account" link at bottom
       - Log in with existing admin account

    4. **Authenticated experience:** After login:
       - Navbar should show Bell icon linking to /settings
       - Visit http://localhost:5173/settings — should show profile form + subscriptions list
       - Visit a matter detail page — "Follow Matter" button should toggle (subscribe/unsubscribe)
       - Visit a councillor's profile — "Follow" button should appear and toggle

    5. **Build verification:** `pnpm build` should succeed

    User types "approved" or describes issues to fix.
  </action>
  <verify>User confirms all 5 verification steps pass by typing "approved".</verify>
  <done>Subscription UI works end-to-end in dev server for both anonymous and authenticated users. Build passes.</done>
</task>

</tasks>

<verification>
1. Security advisor shows no mutable search_path warnings for subscription functions
2. Dev server starts without errors
3. Anonymous users see "Get Alerts" in navbar and subscribe buttons redirect to signup
4. Authenticated users see settings link and can toggle subscriptions
5. Settings page loads with profile form and subscription list
6. Build passes for production deployment
</verification>

<success_criteria>
Security fix applied. Subscription UI verified working in dev server for both anonymous and authenticated flows. User has clear documentation of external configuration steps needed for production email delivery and public signup.
</success_criteria>

<output>
After completion, create `.planning/phases/03-subscriptions-notifications/03-02-SUMMARY.md`
</output>
