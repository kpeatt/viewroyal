---
phase: 01-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/lib/embeddings.server.ts
  - apps/web/app/lib/types.ts
  - apps/web/app/services/rag.server.ts
  - apps/web/app/services/vectorSearch.ts
  - apps/web/app/services/meetings.ts
  - apps/web/app/components/meeting-feed.tsx
  - apps/web/app/components/meeting/EnhancedVideoScrubber.tsx
  - apps/web/app/components/meeting/TranscriptDrawer.tsx
  - apps/web/app/components/meeting/VideoWithSidebar.tsx
  - apps/web/app/routes/meeting-explorer.tsx
  - apps/web/app/routes/speaker-alias.tsx
  - apps/pipeline/pipeline/ingestion/ai_refiner.py
  - apps/pipeline/pipeline/ingestion/embed.py
  - apps/pipeline/pipeline/ingestion/ingester.py
  - sql/bootstrap.sql
  - README.md
autonomous: true
requirements:
  - SCHEMA-01
  - SCHEMA-02
  - SCHEMA-03
  - SCHEMA-04

must_haves:
  truths:
    - "Embedding dimensions are 384 in both web app and pipeline code"
    - "Ask page transcript search uses tsvector full-text search instead of the removed match_transcript_segments RPC"
    - "No code references to corrected_text_content anywhere in the web app"
    - "Vector search returns results for queries (not empty arrays from dimension mismatch)"
    - "Key statement vector search is available via searchKeyStatements and search_key_statements tools"
  artifacts:
    - path: "apps/web/app/lib/embeddings.server.ts"
      provides: "384-dimension embedding generation"
      contains: "EMBEDDING_DIMENSIONS = 384"
    - path: "apps/web/app/services/vectorSearch.ts"
      provides: "Stubbed searchTranscriptSegments + new searchKeyStatements"
      exports: ["searchKeyStatements", "KeyStatementMatch"]
    - path: "apps/web/app/services/rag.server.ts"
      provides: "tsvector transcript search + key statement search tool"
      contains: "textSearch"
    - path: "apps/pipeline/pipeline/ingestion/embed.py"
      provides: "384-dim embeddings, key_statements in TABLE_CONFIG, no transcript_segments"
      contains: "EMBEDDING_DIMENSIONS = 384"
  key_links:
    - from: "apps/web/app/services/rag.server.ts"
      to: "match_key_statements RPC"
      via: "supabase.rpc call"
      pattern: 'rpc.*match_key_statements'
    - from: "apps/web/app/services/rag.server.ts"
      to: "transcript_segments table"
      via: "tsvector full-text search"
      pattern: 'textSearch.*text_search'
    - from: "apps/web/app/lib/embeddings.server.ts"
      to: "all match_* RPCs"
      via: "384-dim embedding passed to halfvec(384) params"
      pattern: "EMBEDDING_DIMENSIONS = 384"
---

<objective>
Merge PR #35 (phase3c/embedding-migration) to main, aligning the web app and pipeline code with the already-migrated database schema.

Purpose: Fix two live bugs — (1) embedding dimension mismatch (web app generates 768-dim, DB expects 384-dim halfvec) causing all vector searches to return zero results, and (2) match_transcript_segments RPC calls crashing because the RPC and transcript embedding column were removed. Also removes 15+ references to the deleted `corrected_text_content` column.

Output: PR #35 merged to main. Web app code matches the database schema. Vector search works. Transcript search uses tsvector FTS.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-schema-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge PR #35 branch into main</name>
  <files>
    apps/web/app/lib/embeddings.server.ts
    apps/web/app/lib/types.ts
    apps/web/app/services/rag.server.ts
    apps/web/app/services/vectorSearch.ts
    apps/web/app/services/meetings.ts
    apps/web/app/components/meeting-feed.tsx
    apps/web/app/components/meeting/EnhancedVideoScrubber.tsx
    apps/web/app/components/meeting/TranscriptDrawer.tsx
    apps/web/app/components/meeting/VideoWithSidebar.tsx
    apps/web/app/routes/meeting-explorer.tsx
    apps/web/app/routes/speaker-alias.tsx
    apps/pipeline/pipeline/ingestion/ai_refiner.py
    apps/pipeline/pipeline/ingestion/embed.py
    apps/pipeline/pipeline/ingestion/ingester.py
    sql/bootstrap.sql
    README.md
  </files>
  <action>
    Merge the `phase3c/embedding-migration` branch into `main`. The merge has been pre-verified to be conflict-free (via `git merge-tree`). The `.planning/` directory files on main will be preserved because they were added after the merge base.

    Run: `git merge phase3c/embedding-migration --no-edit`

    This merge brings in exactly 2 commits:
    - `18899eef` — Phase 3c: Migrate embeddings to halfvec(384), add key statements, FTS, and consolidation
    - `4b7708b7` — Update README to reflect Phases 0-3c changes

    Key changes landing on main:
    1. `embeddings.server.ts`: EMBEDDING_DIMENSIONS 768 -> 384
    2. `rag.server.ts`: Replace `match_transcript_segments` RPC call with tsvector FTS, add `search_key_statements` tool, remove all `corrected_text_content` references
    3. `vectorSearch.ts`: Stub `searchTranscriptSegments()` to return `[]`, add `searchKeyStatements()` and `KeyStatementMatch` type
    4. `types.ts`: Remove `corrected_text_content` from `TranscriptSegment` interface
    5. `meetings.ts`: Remove `corrected_text_content` from select string
    6. UI components (meeting-feed, EnhancedVideoScrubber, TranscriptDrawer, VideoWithSidebar, meeting-explorer, speaker-alias): Remove all `corrected_text_content || text_content` fallback patterns, replace with `text_content`
    7. Pipeline `embed.py`: 768->384, remove transcript_segments from TABLE_CONFIG, add key_statements
    8. Pipeline `ai_refiner.py`: Add KeyStatement model and extraction prompt section 7
    9. Pipeline `ingester.py`: Add key_statements ingestion
    10. `bootstrap.sql`: Updated to reflect current schema
    11. `README.md`: Updated

    After merge, verify no `.planning/` files were disturbed by checking `git diff HEAD~1 -- .planning/` shows no changes.
  </action>
  <verify>
    1. `git log --oneline -3` shows the merge commit on main
    2. `grep -n "EMBEDDING_DIMENSIONS" apps/web/app/lib/embeddings.server.ts` shows `384`
    3. `grep -rn "corrected_text_content" apps/web/` returns zero results
    4. `grep -n "match_transcript_segments" apps/web/app/services/rag.server.ts` returns zero results
    5. `grep -n "textSearch" apps/web/app/services/rag.server.ts` shows FTS calls
    6. `grep -n "searchKeyStatements" apps/web/app/services/vectorSearch.ts` shows the new function
    7. `ls .planning/ROADMAP.md .planning/STATE.md .planning/PROJECT.md` all exist (planning files preserved)
  </verify>
  <done>
    PR #35 is merged to main. EMBEDDING_DIMENSIONS is 384 in both web app and pipeline. No `corrected_text_content` references remain in web app code. Transcript search uses tsvector FTS. Key statement search function exists. Planning files are intact.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate migrations and clean up embed.py dead code</name>
  <files>
    apps/pipeline/pipeline/ingestion/embed.py
  </files>
  <action>
    After the merge, perform two validation steps:

    **1. Migration validation (SCHEMA-03):**
    Use the Supabase MCP `list_migrations` tool to get the list of applied migrations. Verify that PR #35 did NOT include any migration files that could conflict. PR #35's changes are all in app code and bootstrap.sql — no Supabase migration files exist in the PR. The 23 applied migrations cover all schema changes already. Document this validation in the summary.

    **2. Clean up embed.py dead code:**
    PR #35's `embed.py` contains conditional logic referencing `embedding_hv` column for `transcript_segments` — a transitional column that no longer exists. Since `transcript_segments` is removed from `TABLE_CONFIG`, this code is dead but should be cleaned up to avoid confusion.

    Search `embed.py` for any references to `embedding_hv`. If found in conditional blocks like `if table == "transcript_segments"`, remove those conditional branches. The functions `fetch_rows_needing_embeddings` and `update_embeddings_batch` may have these conditionals.

    Also remove `fastembed` from `apps/pipeline/pyproject.toml` if it exists as a dependency (per user decision to standardize on OpenAI text-embedding-3-small). It's a ~500MB dependency that's no longer imported anywhere.
  </action>
  <verify>
    1. `grep -n "embedding_hv" apps/pipeline/pipeline/ingestion/embed.py` returns zero results (or only in comments)
    2. `grep -n "fastembed" apps/pipeline/pyproject.toml` returns zero results
    3. Supabase MCP `list_migrations` confirms 23 migrations — no new ones added by this merge
    4. `grep -n "transcript_segments" apps/pipeline/pipeline/ingestion/embed.py` shows only the commented-out entry in TABLE_CONFIG (no active references)
  </verify>
  <done>
    Dead `embedding_hv` references removed from embed.py. fastembed dependency removed from pyproject.toml. Migration list validated — 23 applied migrations, no conflicts from the merge.
  </done>
</task>

</tasks>

<verification>
1. Web app builds without type errors: `cd apps/web && pnpm typecheck`
2. No references to removed columns: `grep -rn "corrected_text_content" apps/web/` returns nothing
3. No references to removed RPC: `grep -rn "match_transcript_segments" apps/web/app/services/rag.server.ts` returns nothing
4. Embedding dimensions correct: `grep "EMBEDDING_DIMENSIONS" apps/web/app/lib/embeddings.server.ts apps/pipeline/pipeline/ingestion/embed.py` both show 384
5. Key statement search exists: `grep -n "search_key_statements\|searchKeyStatements" apps/web/app/services/rag.server.ts apps/web/app/services/vectorSearch.ts` shows functions defined
</verification>

<success_criteria>
- PR #35 merged to main with no conflicts
- EMBEDDING_DIMENSIONS = 384 in both web app and pipeline
- All corrected_text_content references removed from web app
- match_transcript_segments RPC call replaced with tsvector FTS
- searchKeyStatements function and search_key_statements RAG tool exist
- No duplicate or conflicting migrations
- Dead code (embedding_hv, fastembed dependency) cleaned up
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-foundation/01-01-SUMMARY.md`
</output>
