---
phase: 05-advanced-subscriptions
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/web/app/routes/onboarding.tsx
  - apps/web/app/routes/settings.tsx
  - apps/web/app/root.tsx
autonomous: false
requirements: [SUB-03, SUB-04, SUB-05]

must_haves:
  truths:
    - "New users are redirected to /onboarding after first login"
    - "Onboarding wizard has 3 steps: pick topics, set address/neighbourhood, opt into digest"
    - "User can subscribe to predefined topic categories via checkboxes"
    - "User can enter a keyword for semantic topic matching"
    - "User can enter a street address that gets geocoded and saved to their profile"
    - "User can pick a neighbourhood from the dropdown"
    - "User can opt into meeting digest during onboarding"
    - "Settings page lets users manage topic and keyword subscriptions"
    - "Completing onboarding sets onboarding_completed = true (prevents redirect loop)"
  artifacts:
    - path: "apps/web/app/routes/onboarding.tsx"
      provides: "Multi-step onboarding wizard with topic, address, and digest steps"
      min_lines: 100
    - path: "apps/web/app/routes/settings.tsx"
      provides: "Enhanced settings with topic/keyword subscription management"
      contains: "topic"
  key_links:
    - from: "apps/web/app/root.tsx"
      to: "apps/web/app/routes/onboarding.tsx"
      via: "redirect when onboarding_completed is false"
      pattern: "onboarding_completed"
    - from: "apps/web/app/routes/onboarding.tsx"
      to: "/api/subscribe"
      via: "POST requests for each selected topic/keyword/digest"
      pattern: "api/subscribe"
    - from: "apps/web/app/routes/onboarding.tsx"
      to: "/api/geocode"
      via: "POST to geocode user's street address"
      pattern: "api/geocode"
---

<objective>
Build the post-signup onboarding wizard and enhance the settings page with topic/keyword/neighbourhood subscription management. After email verification and first login, new users are walked through selecting topics, setting their address, and opting into the meeting digest. Existing users manage these on the settings page.

Purpose: This is the primary user-facing interface for advanced subscriptions. Without the onboarding wizard, new users won't discover topic/neighbourhood subscriptions. Without settings page enhancements, existing users can't manage them.

Output: Working onboarding flow (/onboarding route), enhanced settings page with topic/keyword management, and root loader redirect for new users.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advanced-subscriptions/05-RESEARCH.md
@.planning/phases/05-advanced-subscriptions/05-01-SUMMARY.md
@.planning/phases/03-subscriptions-notifications/03-01-SUMMARY.md

Key existing files:
@apps/web/app/routes/settings.tsx
@apps/web/app/root.tsx
@apps/web/app/routes.ts
@apps/web/app/services/subscriptions.ts
@apps/web/app/services/topics.ts  (created in Plan 01)
@apps/web/app/routes/api.subscribe.tsx
@apps/web/app/routes/api.geocode.tsx  (created in Plan 01)
@apps/web/app/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding wizard and add root loader redirect</name>
  <files>
    apps/web/app/routes/onboarding.tsx
    apps/web/app/root.tsx
  </files>
  <action>
**1. Create `apps/web/app/routes/onboarding.tsx`** — a multi-step form wizard with 3 steps:

**Step 1: Topics**
- Load all topics via `getTopics()` in the loader (already have authenticated user check)
- Display category checkboxes (8 categories from topics table) in a grid layout — show all categories, not just active ones
- Below categories, show a text input for free-text keyword with "Add keyword" button
- Keywords display as removable badges below the input
- "Next" button advances to step 2
- Step state managed via URL search params (`?step=1|2|3`) or React state (prefer React state for smoother UX)

**Step 2: Location**
- Street address text input with "Locate" button
- When "Locate" is clicked, POST to `/api/geocode` with the address. On success, show a green checkmark and the formatted address. On failure, show a helpful message ("We couldn't find that address — try adding more detail or pick a neighbourhood instead").
- Neighbourhood dropdown with VIEW_ROYAL_NEIGHBORHOODS array (same hardcoded list from settings.tsx)
- Proximity radius slider or select: 500m, 1000m (default), 2000m, 3000m
- "Next" button advances to step 3
- Skip button available ("I'll set this up later")

**Step 3: Digest**
- Meeting digest opt-in checkbox: "Send me a summary after each council meeting — key decisions, votes, and what it means for your neighbourhood."
- Friendly description of what the digest includes
- "Finish Setup" button

**On finish (form action):**
- Process all 3 steps at once (collect state in React, submit as single form action)
- For each selected topic category: call `addSubscription(supabase, userId, 'topic', { topic_id })`
- For each keyword: generate embedding via `generateQueryEmbedding(keyword)`, then call `addSubscription(supabase, userId, 'topic', { keyword, keyword_embedding: embedding })`
- If address provided and geocoded: call `upsertUserProfile` with address, then update the geography column via the SECURITY DEFINER RPC created in Plan 01: `supabase.rpc('update_user_location', { target_user_id: userId, lng, lat })`. Do NOT use raw SQL or the user-context client for the geography update — the RPC handles RLS bypass.
  - Also create a neighbourhood subscription if the address was geocoded: `addSubscription(supabase, userId, 'neighborhood', { proximity_radius_m })`
- If neighbourhood selected: save to profile and create neighbourhood subscription
- If digest opted in: `addSubscription(supabase, userId, 'digest', {})`
- Set `onboarding_completed = true` on user_profiles (ALWAYS, even if user skipped everything)
- Redirect to `/` (home page)

**Styling:** Follow project conventions — white bg cards with rounded-2xl, border-zinc-200, shadow-sm. Use shadcn Button, Input components. Use lucide-react icons (Tag, MapPin, Bell, ChevronRight, Check). Step indicator at top showing progress (3 dots or numbered steps).

**Loader:**
- Check auth — redirect to /login if not authenticated
- Load topics from `getTopics(supabase)`
- Load existing profile to check if already completed (redirect to / if `onboarding_completed === true`)

**2. Update `apps/web/app/root.tsx` loader:**
- After getting user and municipality, if user exists, fetch their profile via `getUserProfile(supabase, user.id)`
- If profile exists and `onboarding_completed === false`, AND the current request URL is NOT `/onboarding`, `/logout`, `/api/*`, or `/login`, redirect to `/onboarding`
- If no profile exists (new user from auto-create in subscribe), treat as not completed
- Import `getUserProfile` from services/subscriptions
- Be careful not to redirect API routes or the onboarding page itself (infinite loop)
  </action>
  <verify>
Run `pnpm typecheck` from `apps/web/`. Verify `onboarding.tsx` exists with loader and action. Verify `root.tsx` has the onboarding redirect logic. Start dev server with `pnpm dev` and verify: (1) unauthenticated users are NOT redirected to /onboarding, (2) the /onboarding route renders the wizard UI.
  </verify>
  <done>
Onboarding wizard at /onboarding has 3 steps (topics, location, digest) with proper navigation. Root loader redirects new users (onboarding_completed = false) to /onboarding. Completing onboarding sets the flag and redirects home.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance settings page with topic and keyword subscription management</name>
  <files>
    apps/web/app/routes/settings.tsx
  </files>
  <action>
**Enhance the settings page** to support managing topic and keyword subscriptions alongside existing matter/person/neighbourhood subscriptions:

**1. Add "Topic Subscriptions" section** between Profile and Active Subscriptions:
- Load topics in the loader via `getTopics(supabase)`
- Show the 8 category checkboxes in a 2x4 grid
- Pre-check categories the user is already subscribed to (match subscription.topic_id against topics)
- Checking/unchecking a category immediately calls `/api/subscribe` (POST or DELETE) via fetch — same pattern as SubscribeButton component
- Below categories, show a keyword input field with "Add" button
- When added, embed + subscribe happens via POST to `/api/subscribe` with `{ type: 'topic', keyword: '...' }`
- Show existing keyword subscriptions as removable badges (filter subscriptions where `type === 'topic' && keyword`)

**2. Update address section to geocode on save:**
- When user saves their profile with a new address, call `/api/geocode` first to get lat/lng
- If geocoding succeeds, include the location update in the profile save action
- The action handler should call `supabase.rpc('update_user_location', { target_user_id: userId, lng, lat })` when lat/lng are provided — uses the SECURITY DEFINER RPC from Plan 01 to safely bypass RLS on the geography column
- Show geocoding status feedback (loading spinner, success checkmark, or error message)

**3. Add "neighbourhood proximity radius" control:**
- Only visible when user has a neighbourhood or address set
- Dropdown or radio: 500m, 1000m (default), 2000m, 3000m
- Updates the `proximity_radius_m` on their neighbourhood subscription via the existing API

**4. Improve digest section:**
- Remove the "weekly" frequency option since digest is now meeting-aligned per user decision
- Keep only "After each meeting" option (or remove the frequency radio entirely since there's only one option)
- Show the digest as a simple toggle: "Receive meeting digest after each council meeting"

**Loader changes:**
- Add `getTopics(supabase)` to the Promise.all
- Return topics in loader data

**Action changes:**
- Handle `intent === "update_profile"` with optional lat/lng fields for geocoding
- When lat/lng are provided, call `supabase.rpc('update_user_location', { target_user_id: userId, lng, lat })`

Styling follows existing settings page patterns (section headers with uppercase tracking-widest, white cards with rounded-2xl borders).
  </action>
  <verify>
Run `pnpm typecheck` from `apps/web/`. Start dev server and verify the settings page loads without errors, shows topic categories, and displays keyword subscription management UI.
  </verify>
  <done>
Settings page shows topic category checkboxes, keyword subscription input/badges, address geocoding feedback, and simplified digest toggle. Users can manage all subscription types from a single page.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify onboarding wizard and settings page</name>
  <files>apps/web/app/routes/onboarding.tsx, apps/web/app/routes/settings.tsx</files>
  <action>
Human verification checkpoint. No automated action — verify the onboarding wizard and settings page work correctly in the browser.
  </action>
  <verify>
    1. Open http://localhost:5173 in the browser
    2. Create a new account via /signup — after email confirmation and login, you should be redirected to /onboarding
    3. In the onboarding wizard:
       a. Step 1: Check 2-3 topic categories, add a keyword like "housing"
       b. Step 2: Enter your street address and click Locate (or pick a neighbourhood)
       c. Step 3: Opt into the meeting digest
       d. Click Finish
    4. Verify you land on the home page (not redirected back to onboarding)
    5. Go to /settings — verify your topic subscriptions, keyword, address, and digest preference are all visible and manageable
    6. Try adding/removing a topic category from settings
    7. Try adding another keyword from settings
  </verify>
  <done>User confirmed onboarding wizard and settings page work correctly end-to-end.</done>
</task>

</tasks>

<verification>
1. /onboarding route renders 3-step wizard
2. Root loader redirects new users to /onboarding
3. Completing onboarding sets onboarding_completed = true
4. Settings page shows topic categories, keyword management, address geocoding
5. Digest frequency section shows only "after each meeting" (not weekly)
6. `pnpm typecheck` passes
</verification>

<success_criteria>
- New users land on onboarding wizard after first login
- All 3 onboarding steps work: topics, location, digest
- Onboarding completion prevents redirect loop
- Settings page manages topic/keyword/neighbourhood subscriptions
- Address geocoding provides visual feedback
- Digest is opt-in only (no auto-subscribe, no weekly option)
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-subscriptions/05-02-SUMMARY.md`
</output>
