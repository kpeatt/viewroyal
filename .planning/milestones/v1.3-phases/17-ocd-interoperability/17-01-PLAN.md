---
phase: 17-ocd-interoperability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/api/ocd/lib/ocd-ids.ts
  - apps/web/app/api/ocd/lib/pagination.ts
  - apps/web/app/api/ocd/lib/ocd-envelope.ts
  - supabase/migrations/fix_municipality_ocd_id_and_add_divisions.sql
autonomous: true
requirements: [OCD-08, OCD-07]

must_haves:
  truths:
    - "UUID v5 generation produces deterministic, spec-compliant OCD IDs from entity type + bigint PK"
    - "Page-based pagination computes correct offset, max_page, and total_items from page number + per_page"
    - "OCD response envelope matches OpenStates format with results array and pagination object"
    - "Municipality ocd_id is corrected to ocd-division/country:ca/csd:5917047 (View Royal, not Victoria)"
    - "A divisions reference table stores OCD division strings for jurisdictions"
  artifacts:
    - path: "apps/web/app/api/ocd/lib/ocd-ids.ts"
      provides: "UUID v5 generation and OCD ID formatting for all entity types"
      exports: ["uuidV5", "ocdPersonId", "ocdEventId", "ocdBillId", "ocdVoteId", "ocdOrganizationId", "ocdDivisionId", "ocdJurisdictionId"]
    - path: "apps/web/app/api/ocd/lib/pagination.ts"
      provides: "Page-based pagination utilities for OCD list endpoints"
      exports: ["parsePaginationParams", "OcdPagination"]
    - path: "apps/web/app/api/ocd/lib/ocd-envelope.ts"
      provides: "OpenStates-style response envelope builder"
      exports: ["ocdListResponse", "ocdDetailResponse"]
  key_links:
    - from: "apps/web/app/api/ocd/lib/ocd-ids.ts"
      to: "crypto.subtle.digest"
      via: "Web Crypto SHA-1 for UUID v5"
      pattern: "crypto\\.subtle\\.digest"
    - from: "apps/web/app/api/ocd/lib/pagination.ts"
      to: "Supabase select with count"
      via: "offset/limit pagination"
      pattern: "Math\\.ceil.*total.*perPage"
---

<objective>
Create shared OCD infrastructure: deterministic UUID v5 generation for OCD IDs, page-based pagination utilities, OpenStates-style response envelope, and a database migration to fix the municipality OCD division ID and create a divisions reference table.

Purpose: All OCD endpoints in Plans 02 and 03 depend on these shared utilities and correct division data. This foundation must exist before any OCD serializer or endpoint can be implemented.

Output: Three TypeScript utility modules under `apps/web/app/api/ocd/lib/` and one Supabase migration.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-ocd-interoperability/17-RESEARCH.md

# Existing API patterns to follow
@apps/web/app/api/lib/envelope.ts
@apps/web/app/api/lib/cursor.ts
@apps/web/app/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OCD ID generation, pagination, and envelope utilities</name>
  <files>
    apps/web/app/api/ocd/lib/ocd-ids.ts
    apps/web/app/api/ocd/lib/pagination.ts
    apps/web/app/api/ocd/lib/ocd-envelope.ts
  </files>
  <action>
Create three utility modules under `apps/web/app/api/ocd/lib/`:

**ocd-ids.ts** -- Deterministic UUID v5 generation using Web Crypto API:
- Hardcode a namespace UUID for ViewRoyal.ai OCD IDs (generate one, e.g., `f47ac10b-58cc-4372-a567-0d02b2c3d479`).
- `uuidV5(name: string): Promise<string>` -- concatenate namespace bytes + name bytes, SHA-1 hash via `crypto.subtle.digest("SHA-1", ...)`, set version 5 bits (`bytes[6] = (bytes[6] & 0x0f) | 0x50`) and variant bits (`bytes[8] = (bytes[8] & 0x3f) | 0x80`), format as standard UUID string.
- Helper functions `parseUuid(uuid: string): Uint8Array` and `formatUuid(bytes: Uint8Array): string` for converting between hex string and byte array.
- Per-entity ID generators: `ocdPersonId(pk: number)`, `ocdOrganizationId(pk: number)`, `ocdEventId(pk: number)`, `ocdBillId(pk: number)`, `ocdVoteId(pk: number)` -- each calls `uuidV5("{type}:{pk}")` and returns `ocd-{type}/{uuid}`.
- Division-based IDs (NOT UUID, deterministic from geography): `ocdDivisionId(csdCode: string)` returns `ocd-division/country:ca/csd:{csdCode}`, `ocdJurisdictionId(csdCode: string)` returns `ocd-jurisdiction/country:ca/csd:{csdCode}/government`.
- All async entity ID functions return `Promise<string>` because crypto.subtle.digest is async.
- Export a batch helper: `ocdIds(type: string, pks: number[]): Promise<Map<number, string>>` that pre-computes OCD IDs for an array of PKs using `Promise.all()`. This avoids the async-in-map pitfall documented in RESEARCH.md.

**pagination.ts** -- Page-based pagination matching OpenStates v3:
- Interface `OcdPagination { page: number; per_page: number; max_page: number; total_items: number; }`.
- `parsePaginationParams(c: Context): { page: number; perPage: number }` -- parse `page` (default 1, min 1) and `per_page` (default 20, min 1, max 100) from query params. Coerce to integers. Clamp invalid values.
- `computePagination(total: number, page: number, perPage: number): OcdPagination` -- compute `max_page = Math.max(1, Math.ceil(total / perPage))`.
- Import `Context` from hono but do NOT import ApiEnv (OCD endpoints use a generic Hono context).

**ocd-envelope.ts** -- OpenStates-style response format:
- `ocdListResponse<T>(c: Context, results: T[], pagination: OcdPagination)` -- returns `c.json({ results, pagination })`.
- `ocdDetailResponse<T>(c: Context, result: T)` -- returns `c.json(result)`. Note: OCD detail responses return the entity directly at the top level (no `data` wrapper), matching OpenStates convention.
- Import `OcdPagination` from `./pagination`.

All three modules should have JSDoc header comments explaining their purpose, matching the style of existing `apps/web/app/api/lib/envelope.ts`.
  </action>
  <verify>
Run `cd apps/web && npx tsc --noEmit --pretty 2>&1 | grep -E "ocd/lib" | head -20` to verify no TypeScript errors in the new files.
  </verify>
  <done>
Three OCD utility modules exist with correct exports. UUID v5 produces deterministic IDs. Pagination parses query params and computes max_page. Envelope produces OpenStates-format JSON responses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix municipality OCD division ID and create divisions reference table</name>
  <files>
    supabase/migrations/fix_municipality_ocd_id_and_add_divisions.sql
  </files>
  <action>
Create a Supabase migration using `mcp__supabase__apply_migration` with name `fix_municipality_ocd_id_and_add_divisions` that does:

1. **Create `ocd_divisions` reference table:**
   ```sql
   CREATE TABLE IF NOT EXISTS ocd_divisions (
     id bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
     division_id text NOT NULL UNIQUE,  -- e.g., 'ocd-division/country:ca/csd:5917047'
     name text NOT NULL,                -- e.g., 'View Royal'
     country text NOT NULL DEFAULT 'ca',
     csd_code text,                     -- StatsCan Census Subdivision code
     created_at timestamptz DEFAULT now()
   );
   ```

2. **Insert View Royal division:**
   ```sql
   INSERT INTO ocd_divisions (division_id, name, country, csd_code)
   VALUES ('ocd-division/country:ca/csd:5917047', 'View Royal', 'ca', '5917047')
   ON CONFLICT (division_id) DO NOTHING;
   ```

3. **Fix municipality ocd_id** -- Update from the incorrect Victoria CSD code to the correct View Royal code:
   ```sql
   UPDATE municipalities
   SET ocd_id = 'ocd-division/country:ca/csd:5917047'
   WHERE ocd_id = 'ocd-division/country:ca/csd:5917034'
      OR slug = 'view-royal';
   ```

4. **Enable RLS on ocd_divisions** (read-only public table):
   ```sql
   ALTER TABLE ocd_divisions ENABLE ROW LEVEL SECURITY;
   CREATE POLICY "Allow public read access" ON ocd_divisions FOR SELECT USING (true);
   ```

Apply the migration via the Supabase MCP tool. Verify the municipality ocd_id was corrected and the divisions row exists.
  </action>
  <verify>
Run `mcp__supabase__execute_sql` with:
- `SELECT ocd_id FROM municipalities WHERE slug = 'view-royal'` -- should return `ocd-division/country:ca/csd:5917047`
- `SELECT * FROM ocd_divisions` -- should return the View Royal row
  </verify>
  <done>
Municipality ocd_id corrected from 5917034 (Victoria) to 5917047 (View Royal). The ocd_divisions reference table exists with the View Royal division row. RLS is enabled with public read access.
  </done>
</task>

</tasks>

<verification>
1. All three OCD utility modules exist under `apps/web/app/api/ocd/lib/` and compile without TypeScript errors
2. `ocd-ids.ts` exports UUID v5 generation + per-entity ID formatters + batch helper
3. `pagination.ts` exports page-based pagination parser and computation
4. `ocd-envelope.ts` exports OpenStates-format list and detail response builders
5. Municipality ocd_id in database is `ocd-division/country:ca/csd:5917047`
6. `ocd_divisions` table exists with View Royal division row
</verification>

<success_criteria>
- Three shared utility modules exist and compile cleanly
- Municipality division ID corrected from Victoria (5917034) to View Royal (5917047)
- Divisions reference table created with correct data
- All exports are ready for import by Plan 02 and Plan 03 serializers and endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/17-ocd-interoperability/17-01-SUMMARY.md`
</output>
