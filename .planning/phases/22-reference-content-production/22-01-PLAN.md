---
phase: 22-reference-content-production
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/docs/package.json
  - apps/docs/components/mdx/mermaid.tsx
  - apps/docs/mdx-components.tsx
  - apps/docs/content/docs/meta.json
  - apps/docs/content/docs/reference/meta.json
  - apps/docs/content/docs/reference/data-model.mdx
  - apps/docs/content/docs/reference/ocd-standard.mdx
autonomous: true
requirements:
  - REFC-01
  - REFC-02
  - FWRK-05

must_haves:
  truths:
    - "Data Model page renders a Mermaid ER diagram showing entity relationships in both light and dark mode"
    - "Data Model page describes each entity in civic domain context (Meeting, AgendaItem, Motion, Matter, etc.)"
    - "OCD Standard Reference page has a comparison table for v1 vs OCD API decision guide"
    - "OCD Standard Reference page shows entity mapping table with real ViewRoyal OCD IDs"
    - "Sidebar shows Getting Started, Guides, API Reference, and Reference sections in correct order"
    - "All sidebar sections are expanded by default"
  artifacts:
    - path: "apps/docs/components/mdx/mermaid.tsx"
      provides: "Client-side Mermaid rendering with dark/light theme support"
      contains: "use client"
    - path: "apps/docs/content/docs/reference/data-model.mdx"
      provides: "Data Model page with ER diagram and civic entity descriptions"
      contains: "Mermaid"
    - path: "apps/docs/content/docs/reference/ocd-standard.mdx"
      provides: "OCD Standard Reference with entity mapping and decision guide"
      contains: "ocd-division"
    - path: "apps/docs/content/docs/reference/meta.json"
      provides: "Reference section sidebar ordering"
      contains: "data-model"
    - path: "apps/docs/content/docs/meta.json"
      provides: "Root sidebar with all four sections"
      contains: "reference"
  key_links:
    - from: "apps/docs/mdx-components.tsx"
      to: "apps/docs/components/mdx/mermaid.tsx"
      via: "import and MDX component registration"
      pattern: "Mermaid"
    - from: "apps/docs/content/docs/reference/data-model.mdx"
      to: "apps/docs/components/mdx/mermaid.tsx"
      via: "MDX component usage"
      pattern: "<Mermaid"
---

<objective>
Create the Data Model and OCD Standard Reference content pages with Mermaid ER diagram support and configure the sidebar navigation for the complete documentation site.

Purpose: These are the two most substantial reference pages -- they require a new Mermaid component and domain-specific content authoring about entity relationships and OCD interoperability.
Output: Two MDX reference pages, a Mermaid client component, and updated sidebar configuration showing all four top-level sections.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-reference-content-production/22-CONTEXT.md
@.planning/phases/22-reference-content-production/22-RESEARCH.md
@apps/docs/mdx-components.tsx
@apps/docs/app/layout.tsx
@apps/docs/content/docs/meta.json
@apps/docs/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install mermaid, create Mermaid component, and configure sidebar</name>
  <files>
    apps/docs/package.json
    apps/docs/components/mdx/mermaid.tsx
    apps/docs/mdx-components.tsx
    apps/docs/content/docs/meta.json
    apps/docs/content/docs/reference/meta.json
  </files>
  <action>
1. Install mermaid in apps/docs:
   ```bash
   cd apps/docs && pnpm add mermaid
   ```
   Check if `next-themes` is already importable from fumadocs-ui dependencies before adding it explicitly:
   ```bash
   ls node_modules/next-themes 2>/dev/null
   ```
   Only install if not found.

2. Create `apps/docs/components/mdx/mermaid.tsx` -- a client component for Mermaid diagrams with dark/light theme support:
   - `'use client'` directive
   - Import `useTheme` from `next-themes` (available via fumadocs-ui)
   - Import `mermaid` from `mermaid`
   - Component: `Mermaid({ chart }: { chart: string })`
   - Use `mounted` state check to avoid hydration mismatch (return null during SSR)
   - Use `useRef` for the container div
   - Initialize mermaid with `startOnLoad: false`, theme based on `resolvedTheme` (dark -> 'dark', else 'default'), `securityLevel: 'loose'`
   - Call `mermaid.run({ nodes: [ref.current] })` in useEffect on mount/theme/chart change
   - Render: `<div ref={ref} className="mermaid">{chart}</div>`
   - Key detail: use a unique ID per render (e.g., `useId()`) to avoid mermaid caching stale SVGs across theme changes. Re-key the div on theme change OR clear innerHTML before re-running.

3. Register Mermaid in `apps/docs/mdx-components.tsx`:
   - Add `import { Mermaid } from '@/components/mdx/mermaid';`
   - Add `Mermaid` to the components object alongside `APIPage`

4. Update `apps/docs/content/docs/meta.json` to establish sidebar with all four sections:
   ```json
   {
     "root": true,
     "pages": [
       "---Getting Started---",
       "guides/getting-started",
       "---Guides---",
       "guides/authentication",
       "guides/pagination",
       "guides/error-handling",
       "---API Reference---",
       "api-reference",
       "---Reference---",
       "reference"
     ]
   }
   ```
   This separates Getting Started as its own top-level item (maximum onboarding visibility per user decision), then lists the other three sections. The `"..."` glob is replaced with explicit entries.

5. Create `apps/docs/content/docs/reference/meta.json`:
   ```json
   {
     "title": "Reference",
     "pages": [
       "data-model",
       "ocd-standard",
       "changelog",
       "contributing"
     ]
   }
   ```
   Lists all four reference pages in order. Changelog and Contributing MDX files will be created in Plan 02 but their ordering is established now.
  </action>
  <verify>
    <automated>cd /Users/kyle/development/viewroyal/apps/docs && ls components/mdx/mermaid.tsx && node -e "const m = require('./content/docs/meta.json'); if (!JSON.stringify(m).includes('reference')) throw 'missing reference'" 2>/dev/null || node -e "const fs = require('fs'); const m = JSON.parse(fs.readFileSync('content/docs/meta.json','utf8')); if (!JSON.stringify(m).includes('reference')) { process.exit(1); }"</automated>
    <manual>Verify mermaid.tsx exists as a 'use client' component and meta.json has all four sidebar sections</manual>
  </verify>
  <done>Mermaid component registered in MDX, sidebar configured with Getting Started / Guides / API Reference / Reference sections, reference/meta.json orders all four reference pages</done>
</task>

<task type="auto">
  <name>Task 2: Author Data Model and OCD Standard Reference pages</name>
  <files>
    apps/docs/content/docs/reference/data-model.mdx
    apps/docs/content/docs/reference/ocd-standard.mdx
  </files>
  <action>
1. Create `apps/docs/content/docs/reference/data-model.mdx`:

   Frontmatter: title "Data Model", description about entity relationships in ViewRoyal.ai API.

   Content structure (per user decisions -- civic domain context, not database schema dump):
   - **Overview** paragraph: Brief intro explaining the core entities and how they relate. Frame as civic data, not tables. Example: "The ViewRoyal.ai API models the civic decision-making process..."

   - **Entity Relationship Diagram**: Use `<Mermaid chart={...} />` component with an `erDiagram` showing the 7-8 core API entities:
     - Meeting, AgendaItem, Motion, Vote, Matter, Bylaw, Person, Organization
     - Show primary keys and key foreign keys only (not full column lists -- per discretion recommendation)
     - Relationship lines showing cardinality (one-to-many, many-to-many)
     - Omit internal entities not exposed by API (transcript_segments, documents, voice_fingerprints)

   - **Entity Descriptions** section: For each entity, 2-3 sentences in civic context:
     - **Meeting**: "A Meeting represents a council session..." (738 meetings)
     - **Agenda Item**: "An Agenda Item is a topic discussed..." (12,194 items)
     - **Motion**: "A Motion is a formal proposal..." (10,536 motions)
     - **Vote**: "A Vote records a councillor's position..." (44,919 votes)
     - **Matter**: "A Matter tracks an ongoing issue..." (1,727 matters)
     - **Bylaw**: "A Bylaw is a piece of municipal legislation..." (43 bylaws)
     - **Person**: "A Person represents a council member or staff..." (837 people)
     - **Organization**: "An Organization is a governing body..." (10 organizations: Council, Committees, Boards)

   - **Relationships** section: Brief prose explaining key relationships:
     - A Meeting belongs to an Organization and is chaired by a Person
     - Agenda Items belong to a Meeting and optionally link to a Matter
     - Motions are moved and seconded by People, with individual Votes
     - Matters track across meetings via Agenda Items and may produce Bylaws
     - People have Memberships in Organizations

   - **API Coverage** note: Link to API Reference for endpoint details. Note that not all database columns are exposed -- the API returns curated fields.

   Mermaid ER diagram content (pass as template literal string to chart prop):
   ```
   erDiagram
     Organization ||--o{ Meeting : hosts
     Person ||--o{ Meeting : chairs
     Meeting ||--o{ AgendaItem : contains
     AgendaItem }o--o| Matter : "tracks"
     AgendaItem ||--o{ Motion : "has"
     Motion ||--o{ Vote : "receives"
     Person ||--o{ Motion : "moves"
     Person ||--o{ Vote : "casts"
     Person }o--o{ Organization : "member of"
     Matter ||--o| Bylaw : "produces"

     Organization {
       int id PK
       string name
       string classification
     }
     Meeting {
       int id PK
       date date
       string meeting_type
       int organization_id FK
     }
     AgendaItem {
       int id PK
       int meeting_id FK
       int matter_id FK
       string title
     }
     Motion {
       int id PK
       int agenda_item_id FK
       string result
       int mover_id FK
     }
     Vote {
       int id PK
       int motion_id FK
       int person_id FK
       string value
     }
     Matter {
       int id PK
       string title
       string status
     }
     Bylaw {
       int id PK
       string bylaw_number
       string title
     }
     Person {
       int id PK
       string name
       string role
     }
   ```

2. Create `apps/docs/content/docs/reference/ocd-standard.mdx`:

   Frontmatter: title "OCD Standard Reference", description about Open Civic Data interoperability.

   Content structure (per user decisions -- comparison table, ViewRoyal-focused, real OCD IDs):

   - **What is Open Civic Data?**: 2-3 paragraphs explaining OCD standard. ViewRoyal-focused: explain OCD concepts only as they apply to ViewRoyal's API. Link to opencivicdata.org for deeper reading.

   - **When to Use v1 vs OCD API**: Comparison table format (NOT flowchart or narrative per user decision):
     | Feature | v1 API | OCD API |
     |---------|--------|---------|
     | Use case | ViewRoyal-specific features | Civic tech interoperability |
     | Authentication | API key required | API key required |
     | Pagination | Cursor-based | Page-based |
     | ID format | Integer IDs with slugs | OCD URIs |
     | Unique features | Search, Bylaws | Standardized entity types |
     | Best for | Building ViewRoyal apps | Multi-jurisdiction tools |

   - **OCD ID Format**: Explain the format with real ViewRoyal examples (per user decision):
     - Division: `ocd-division/country:ca/csd:5917047`
     - Jurisdiction: `ocd-jurisdiction/country:ca/csd:5917047/government`
     - Person: `ocd-person/{uuid-v5}` (deterministic from primary key)
     - Organization: `ocd-organization/{uuid-v5}`
     - Event: `ocd-event/{uuid-v5}`
     - Bill: `ocd-bill/{uuid-v5}`
     - Vote: `ocd-vote/{uuid-v5}`
     Use Callout to note UUIDs are deterministic (same entity always gets same OCD ID).

   - **Entity Mapping Table**: Standalone table (per user decision) showing v1 -> OCD:
     | v1 Entity | v1 Endpoint | OCD Entity | OCD Endpoint | Notes |
     From research: Municipality->Jurisdiction, Organization->Organization, Person->Person, Meeting->Event, Matter->Bill, Motion->Vote, Bylaw->(no equivalent), Search->(no equivalent)

   - **OCD Endpoints**: Document the 6 entity endpoints:
     - `/api/ocd/{municipality}/jurisdictions`
     - `/api/ocd/{municipality}/organizations`
     - `/api/ocd/{municipality}/people`
     - `/api/ocd/{municipality}/events`
     - `/api/ocd/{municipality}/bills`
     - `/api/ocd/{municipality}/votes`
     Plus the discovery endpoint at `/api/ocd/{municipality}`
     NOTE: These are NOT in the OpenAPI spec (they use Hono routing, not chanfana). Do NOT link to auto-generated API Reference pages for OCD endpoints. Document them inline.

   - **Response Format**: Show an example OCD response shape (the OCD envelope with results + pagination).

   - **Further Reading**: Link to OCD spec, OpenStates docs.
  </action>
  <verify>
    <automated>cd /Users/kyle/development/viewroyal/apps/docs && ls content/docs/reference/data-model.mdx content/docs/reference/ocd-standard.mdx && pnpm build 2>&1 | tail -20</automated>
    <manual>Check that data-model.mdx includes a Mermaid component usage and ocd-standard.mdx includes real OCD IDs</manual>
  </verify>
  <done>Data Model page shows Mermaid ER diagram with 8 entities in civic domain context. OCD Standard Reference has comparison table, entity mapping table, real ViewRoyal OCD IDs, and inline OCD endpoint documentation. Static build succeeds with all pages.</done>
</task>

</tasks>

<verification>
1. `pnpm build` in apps/docs completes without errors
2. Built output includes reference/data-model and reference/ocd-standard pages
3. Sidebar in built site shows Getting Started > Guides > API Reference > Reference
4. Mermaid component is registered in mdx-components.tsx
5. Data Model page uses `<Mermaid>` component with erDiagram
6. OCD Standard Reference uses real ViewRoyal OCD IDs (csd:5917047)
</verification>

<success_criteria>
- Static build produces pages for both reference documents
- Mermaid ER diagram renders entity relationships for 8 core entities
- Entity descriptions use civic domain language, not database terminology
- OCD Reference has comparison table and standalone entity mapping table
- Sidebar shows all four top-level sections in correct order
</success_criteria>

<output>
After completion, create `.planning/phases/22-reference-content-production/22-01-SUMMARY.md`
</output>
