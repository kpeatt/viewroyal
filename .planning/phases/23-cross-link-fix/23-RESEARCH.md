# Phase 23: Cross-Link Fix & Cleanup - Research

**Researched:** 2026-02-24
**Domain:** MDX content cross-links in fumadocs static site
**Confidence:** HIGH

## Summary

Phase 22 changed the fumadocs `baseUrl` from `/docs` to `/` and restructured the Next.js catch-all route from `app/docs/[[...slug]]/` to `app/[[...slug]]/`. This change was not back-propagated to 18 hard-coded inline links across 7 MDX files authored in Phases 21 and 22. Every internal cross-link in the documentation content uses the `/docs/` prefix (e.g., `/docs/guides/getting-started`) which produces a 404 because the static export generates pages at the root level (e.g., `/guides/getting-started`).

The fix is a straightforward find-and-replace: change `/docs/` to `/` in all internal link hrefs across the 7 affected MDX files. Additionally, the AREF-01 through AREF-04 checkboxes in REQUIREMENTS.md were already fixed (marked `[x]` with a note dated 2026-02-24), so that part of the success criteria is already satisfied.

**Primary recommendation:** Replace `/docs/` with `/` in all 18 internal link targets across 7 MDX files, rebuild, and verify no 404s remain.

## Standard Stack

### Core

No new libraries needed. This phase uses existing tools only.

| Tool | Version | Purpose | Already Installed |
|------|---------|---------|-------------------|
| fumadocs-core | ^16.6.5 | Content source and routing | Yes |
| fumadocs-mdx | ^14.2.8 | MDX content collection | Yes |
| Next.js | ^16.0.0 | Static site generator (`output: 'export'`) | Yes |
| wrangler | (from apps/web) | Deploy static output to Cloudflare Workers | Yes (via shamefully-hoist) |

### Alternatives Considered

None -- this is a content fix, not a technology choice.

## Architecture Patterns

### fumadocs URL Resolution

The URL for any MDX page is determined by:

1. **Content directory:** `content/docs/` (configured in `source.config.ts` via `defineDocs({ dir: 'content/docs' })`)
2. **Source loader baseUrl:** `/` (configured in `lib/source.ts` via `loader({ baseUrl: '/' })`)
3. **Catch-all route:** `app/[[...slug]]/page.tsx`

The mapping is: `content/docs/{path}.mdx` -> URL `/{path}`.

**Examples:**
| MDX File | Correct URL | Broken URL (current) |
|----------|------------|---------------------|
| `content/docs/guides/getting-started.mdx` | `/guides/getting-started` | `/docs/guides/getting-started` |
| `content/docs/api-reference/meetings/get_ListMeetings.mdx` | `/api-reference/meetings/get_ListMeetings` | `/docs/api-reference/meetings/get_ListMeetings` |
| `content/docs/reference/data-model.mdx` | `/reference/data-model` | `/docs/reference/data-model` |

### Static Export Directory Structure

The `next build` with `output: 'export'` generates:
```
out/
  index.html                                    <- /
  guides/getting-started.html                   <- /guides/getting-started
  api-reference/meetings/get_ListMeetings.html  <- /api-reference/meetings/get_ListMeetings
  reference/data-model.html                     <- /reference/data-model
```

There is no `out/docs/` directory, which is why `/docs/...` paths 404.

### Sidebar vs Inline Links

The sidebar navigation works correctly because it is auto-generated by fumadocs `source.getPages()` which respects the `baseUrl: '/'` setting. Only hard-coded inline links in MDX content are affected.

### Anti-Patterns to Avoid

- **Hard-coding baseUrl in links:** When fumadocs `baseUrl` changes, all hard-coded links break. Fumadocs does not currently provide a link helper for MDX content -- links must match the configured `baseUrl` manually.
- **Linking to folder paths without index pages:** `/api-reference` has no `index.mdx`, so it has no HTML page. Links to `/api-reference` will 404 or show a generic not-found. These links should point to the first meaningful child page (e.g., `/api-reference/system/get_HealthEndpoint`) or be accepted as non-navigable references that rely on sidebar navigation.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Link validation | Custom MDX link checker | Manual grep + build verification | Only 18 links total -- automation is overkill for a one-time fix |
| URL rewriting | Cloudflare redirect rules from /docs/* to /* | Fix the source content | Redirect masks the root cause and adds deployment complexity |

**Key insight:** This is a content fix, not an infrastructure problem. Fixing the source is simpler and more maintainable than adding redirect layers.

## Common Pitfalls

### Pitfall 1: Missing the Fragment Identifier

**What goes wrong:** The link `/docs/guides/authentication#rate-limiting` contains a fragment `#rate-limiting`. A naive find-and-replace of `/docs/` with `/` works correctly here (producing `/guides/authentication#rate-limiting`), but the planner should verify fragments are preserved.
**Why it happens:** Rushing through the replacement without checking for anchors.
**How to avoid:** After replacement, grep for `#` in link targets to verify anchors are intact.
**Warning signs:** Links that navigate to the right page but not to the right section.

### Pitfall 2: Links to Folder Paths Without Index Pages

**What goes wrong:** Three links point to `/docs/api-reference` which, after fix, becomes `/api-reference`. But there is no `content/docs/api-reference/index.mdx`, so no HTML page exists at `/api-reference`. The static export only generates `api-reference/` as a directory containing subdirectories.
**Why it happens:** `api-reference` is a sidebar folder group, not a content page.
**How to avoid:** Either (a) accept that these links navigate to a folder that fumadocs will handle (sidebar opens the group), or (b) change them to point to the first endpoint page, or (c) create an `api-reference/index.mdx` page.
**Warning signs:** Clicking "API Reference" in inline content shows 404.

**Affected links (3 of 18):**
- `index.mdx` line 26: `[API Reference](/docs/api-reference)`
- `getting-started.mdx` line 146: `[API Reference](/docs/api-reference)`
- `ocd-standard.mdx` line 167: `[API Reference](/docs/api-reference)`

**Recommendation:** The simplest fix is to redirect these to the first tagged group (e.g., `/api-reference/system/get_HealthEndpoint`). However, since the sidebar shows "API Reference" as a collapsible group, the most user-friendly approach is to point to the first child page in the sidebar order: `/api-reference/system/get_HealthEndpoint`. Alternatively, leave as `/api-reference` if fumadocs handles folder navigation gracefully (needs verification during build).

### Pitfall 3: Not Rebuilding After Fix

**What goes wrong:** Fixing the MDX source but not rebuilding means the deployed static output still has old links.
**Why it happens:** Content fixes feel small, so the rebuild step gets skipped.
**How to avoid:** Always rebuild (`pnpm build` in `apps/docs/`) and verify the output after content changes.
**Warning signs:** Local dev server works (it reads MDX live) but deployed site still has old links.

### Pitfall 4: External Links Confused with Internal Links

**What goes wrong:** Accidentally modifying external URLs that happen to contain `/docs/`.
**Why it happens:** Over-broad find-and-replace.
**How to avoid:** Only replace markdown link patterns `](/docs/` -- not arbitrary URL strings. The grep shows all 18 matches are markdown-style internal links, and none are external URLs.
**Warning signs:** External documentation links (e.g., OpenCivicData readthedocs) get broken.

## Complete Link Inventory

All 18 broken links across 7 files, with exact current and corrected values:

### `content/docs/index.mdx` (5 links)
| Line | Current | Corrected |
|------|---------|-----------|
| 17 | `(/docs/guides/getting-started)` | `(/guides/getting-started)` |
| 18 | `(/docs/guides/authentication)` | `(/guides/authentication)` |
| 19 | `(/docs/guides/pagination)` | `(/guides/pagination)` |
| 20 | `(/docs/guides/error-handling)` | `(/guides/error-handling)` |
| 26 | `(/docs/api-reference)` | `(/api-reference)` * |

### `content/docs/guides/getting-started.mdx` (5 links)
| Line | Current | Corrected |
|------|---------|-----------|
| 137 | `(/docs/api-reference/meetings/get_ListMeetings)` | `(/api-reference/meetings/get_ListMeetings)` |
| 143 | `(/docs/guides/authentication)` | `(/guides/authentication)` |
| 144 | `(/docs/guides/pagination)` | `(/guides/pagination)` |
| 145 | `(/docs/guides/error-handling)` | `(/guides/error-handling)` |
| 146 | `(/docs/api-reference)` | `(/api-reference)` * |

### `content/docs/guides/authentication.mdx` (2 links)
| Line | Current | Corrected |
|------|---------|-----------|
| 9 | `(/docs/api-reference/system/get_HealthEndpoint)` | `(/api-reference/system/get_HealthEndpoint)` |
| 179 | `(/docs/guides/error-handling)` | `(/guides/error-handling)` |

### `content/docs/guides/pagination.mdx` (1 link)
| Line | Current | Corrected |
|------|---------|-----------|
| 306 | `(/docs/api-reference/search/get_SearchEndpoint)` | `(/api-reference/search/get_SearchEndpoint)` |

### `content/docs/guides/error-handling.mdx` (2 links)
| Line | Current | Corrected |
|------|---------|-----------|
| 115 | `(/docs/guides/authentication)` | `(/guides/authentication)` |
| 163 | `(/docs/guides/authentication#rate-limiting)` | `(/guides/authentication#rate-limiting)` |

### `content/docs/reference/ocd-standard.mdx` (2 links)
| Line | Current | Corrected |
|------|---------|-----------|
| 166 | `(/docs/reference/data-model)` | `(/reference/data-model)` |
| 167 | `(/docs/api-reference)` | `(/api-reference)` * |

### `content/docs/reference/data-model.mdx` (1 link)
| Line | Current | Corrected |
|------|---------|-----------|
| 134 | `(/docs/api-reference)` | `(/api-reference)` * |

*\* These 4 links point to `/api-reference` which has no index page. See Pitfall 2 above.*

## AREF Checkbox Status

**Already fixed.** REQUIREMENTS.md shows AREF-01 through AREF-04 as `[x]` with a note: "Last updated: 2026-02-24 after gap closure planning (AREF-01-04 checkboxes fixed)". No action needed for success criterion 4.

## Build & Deploy Verification

After fixing links, the verification process is:

```bash
cd apps/docs
pnpm build                    # Rebuild static export
```

Then verify:
1. Grep the output HTML files for any remaining `/docs/` hrefs
2. Check that all 18 target paths exist in the `out/` directory as `.html` files
3. Optionally run `npx serve out` for local verification of link navigation

Deployment (if desired):
```bash
cd apps/docs
npx wrangler deploy           # Deploy to Cloudflare Workers
```

## Open Questions

1. **`/api-reference` folder links (4 of 18)**
   - What we know: No `index.mdx` exists for `api-reference/`, so there is no HTML page at `/api-reference`
   - What's unclear: Whether fumadocs or the Cloudflare Workers `not_found_handling: "404-page"` will show a 404 for `/api-reference`, or whether the browser/fumadocs handles folder navigation gracefully
   - Recommendation: During implementation, test this path. If it 404s, either (a) create a minimal `content/docs/api-reference/index.mdx` landing page, or (b) change the 4 links to point to a specific first endpoint like `/api-reference/system/get_HealthEndpoint`. Option (a) is cleaner since it gives users a real landing page for "API Reference".

## Sources

### Primary (HIGH confidence)
- Direct file inspection of all 7 affected MDX files in `apps/docs/content/docs/`
- `apps/docs/lib/source.ts` -- confirms `baseUrl: '/'`
- `apps/docs/source.config.ts` -- confirms `dir: 'content/docs'`
- `apps/docs/app/[[...slug]]/page.tsx` -- confirms catch-all route structure
- `apps/docs/out/` directory -- confirms static export URL structure
- `.planning/v1.4-MILESTONE-AUDIT.md` -- defines INT-01 gap and all affected files
- `.planning/REQUIREMENTS.md` -- confirms AREF-01-04 checkboxes already fixed

### Secondary (MEDIUM confidence)
- fumadocs URL resolution behavior inferred from source config + output structure

## Metadata

**Confidence breakdown:**
- Link inventory: HIGH - every link verified by grep against actual source files
- Fix approach: HIGH - simple string replacement, verified against output directory structure
- `/api-reference` folder issue: MEDIUM - needs testing during implementation
- AREF checkbox status: HIGH - directly verified in REQUIREMENTS.md

**Research date:** 2026-02-24
**Valid until:** 2026-03-24 (stable -- content fixes don't expire)
