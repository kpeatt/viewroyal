---
phase: 09-ai-profiling-comparison
plan: 04
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - apps/web/app/routes/compare.tsx
  - apps/web/app/routes.ts
autonomous: true
requirements: [PROF-06]

must_haves:
  truths:
    - "User can navigate to /compare and select two councillors to compare"
    - "Comparison shows overall agreement score as a percentage"
    - "Comparison shows per-topic agree/disagree indicators"
    - "Comparison highlights common ground and differences in stances"
    - "Mobile view supports swipe between councillors with fixed comparison bar"
    - "Entry point exists: standalone /compare page with dropdown selectors"
  artifacts:
    - path: "apps/web/app/routes/compare.tsx"
      provides: "Side-by-side councillor comparison page"
      min_lines: 200
    - path: "apps/web/app/routes.ts"
      provides: "/compare route registration"
      contains: "compare"
  key_links:
    - from: "apps/web/app/routes/compare.tsx"
      to: "apps/web/app/services/profiling.ts"
      via: "loader imports getSpeakingTimeStats, getCouncillorStances"
      pattern: "import.*profiling"
    - from: "apps/web/app/routes/compare.tsx"
      to: "apps/web/app/lib/alignment-utils.ts"
      via: "import calculateAlignmentForPerson for pairwise voting"
      pattern: "import.*alignment"
---

<objective>
Create a side-by-side councillor comparison page at /compare that shows voting alignment, stance agreement, speaking time, and per-topic position comparisons for any two councillors.

Purpose: Citizens can directly compare two councillors to understand alignment with their own values -- the north star of this phase.
Output: /compare route with dual-loader, selection UI, and comparison visualization.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-ai-profiling-comparison/09-RESEARCH.md
@.planning/phases/09-ai-profiling-comparison/09-01-SUMMARY.md
@apps/web/app/routes/alignment.tsx
@apps/web/app/lib/alignment-utils.ts
@apps/web/app/services/profiling.ts
@apps/web/app/services/people.ts
@apps/web/app/routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /compare route with selection mode and comparison mode</name>
  <files>apps/web/app/routes/compare.tsx, apps/web/app/routes.ts</files>
  <action>
**routes.ts:** Add `route("compare", "routes/compare.tsx")` after the alignment route.

**compare.tsx:** Create a full comparison page with two modes:

### Loader:
```typescript
export async function loader({ request }: Route.LoaderArgs) {
  const url = new URL(request.url);
  const aId = url.searchParams.get("a");
  const bId = url.searchParams.get("b");
  const supabase = getSupabaseAdminClient();
  const municipality = await getMunicipality(supabase);

  // Always load councillor list for selectors
  const councillors = await getPeopleWithStats(supabase);

  if (!aId || !bId) {
    return { mode: "select" as const, councillors, personA: null, personB: null };
  }

  // Load both profiles in parallel
  const [stancesA, stancesB, speakingA, speakingB, speakingStatsAll] = await Promise.all([
    getCouncillorStances(supabase, aId),
    getCouncillorStances(supabase, bId),
    getSpeakingTimeByTopic(supabase, aId),
    getSpeakingTimeByTopic(supabase, bId),
    getSpeakingTimeStats(supabase),
  ]);

  // Compute pairwise voting alignment using existing utility
  // (fetch votes for both, compute alignment)
  const [votesA, votesB, memberships] = await Promise.all([
    fetchRelevantVotesForAlignment(supabase, aId),  // Need to export this from people.ts
    fetchRelevantVotesForAlignment(supabase, bId),
    supabase.from("memberships").select("*, people(id, name, image_url)").eq("organization_id", municipality.id),
  ]);

  const alignmentA = calculateAlignmentForPerson(parseInt(aId), votesA, memberships.data || [], new Date(0), new Date(2100, 0, 1));
  const pairwiseAlignment = alignmentA.find(r => r.personId === parseInt(bId));

  const personA = councillors.find(c => c.id === parseInt(aId));
  const personB = councillors.find(c => c.id === parseInt(bId));

  return {
    mode: "compare" as const,
    councillors,
    personA, personB,
    stancesA, stancesB,
    speakingA, speakingB,
    speakingStatsAll,
    pairwiseAlignment,
  };
}
```

Note: `fetchRelevantVotesForAlignment` is currently a private function in people.ts. Export it, or duplicate the logic. Preferably export it.

### Component - Selection Mode:
- Page title: "Compare Councillors"
- Two dropdown selectors (or clickable avatar cards) for choosing councillor A and councillor B
- Show avatar, name, current role for each option
- When both selected, navigate to `/compare?a={id}&b={id}`
- If only `a` is provided (from "Compare with..." button on profile), show A pre-selected, prompt B selection
- Pre-populate with councillor data for instant selection

### Component - Comparison Mode:

**Header section:**
- Both councillors' avatars, names, roles side by side
- Overall agreement score prominently: "72% aligned" in large text
- Based on pairwise voting alignment (shared motions where both voted same way)

**Stance comparison section (lead with this per user decision):**
- For ALL 8 topics (fill in all topics per user decision, even if one councillor has no stance):
- Each topic row shows:
  - Topic icon + name
  - Councillor A's StanceSpectrum + position label
  - Councillor B's StanceSpectrum + position label
  - Agree/disagree indicator: green checkmark if positions are within 0.5 of each other on the -1 to 1 scale, red X if >1.0 apart, amber dash for in-between
  - Brief comparison note if both have stances (e.g., "Both support" or "A supports, B opposes")
- If only one councillor has a stance for a topic, show their position with "No data" for the other
- If neither has a stance, show "No data for either councillor"

**Activity comparison section:**
- Side-by-side stats: total speaking hours, meeting attendance rate, total votes, motions moved
- Speaking time by topic comparison: dual bar chart showing both councillors' topic distribution

**Mobile layout (per user decision):**
- CSS `scroll-snap-type: x mandatory` container
- Each councillor's data is a full-width snap point
- Fixed comparison bar at top showing both names and the overall alignment score
- Swipe left/right to toggle between A and B

### Meta function:
- Title: "Compare {A name} vs {B name} | ViewRoyal.ai" in compare mode
- Title: "Compare Councillors | ViewRoyal.ai" in select mode

### Styling:
- Consistent with the rest of the app: white bg, rounded-2xl cards, border-zinc-200
- Use Card, Badge from shadcn/ui
- Topic colors from TOPIC_COLORS
- Responsive: lg:grid-cols-2 for desktop, stacked with scroll-snap for mobile
  </action>
  <verify>Run `pnpm typecheck` and `pnpm build` from apps/web/.</verify>
  <done>
    /compare route exists and renders. Selection mode shows councillor pickers. Comparison mode shows:
    - Overall alignment score percentage
    - Per-topic stance comparison with agree/disagree indicators
    - Activity stats side-by-side
    - Mobile swipe layout with scroll-snap
    - All 8 topics filled in for comparison view
  </done>
</task>

<task type="auto">
  <name>Task 2: Export fetchRelevantVotesForAlignment and add nav entry</name>
  <files>apps/web/app/services/people.ts</files>
  <action>
1. **Export `fetchRelevantVotesForAlignment`**: Change the function from a private function to an exported function. Simply add `export` before the existing `async function fetchRelevantVotesForAlignment(...)`. This is needed by the comparison page to compute pairwise alignment.

2. **Add /compare to navigation** (if a nav component exists with links): Add a "Compare" link in the People section or as a secondary nav item. Check the existing nav structure -- if there's a navbar or sidebar with council-related links, add Compare there. If navigation changes would affect many files, skip this and rely on the profile page "Compare with..." button and direct URL entry as entry points.
  </action>
  <verify>Run `pnpm typecheck` from apps/web/.</verify>
  <done>fetchRelevantVotesForAlignment is exported from people.ts. Navigation updated if applicable.</done>
</task>

</tasks>

<verification>
1. `/compare` route loads and shows councillor selection when no params
2. `/compare?a=35&b=37` shows side-by-side comparison with real data
3. Overall agreement score renders correctly
4. Per-topic stance comparison fills all 8 topics
5. Mobile layout uses scroll-snap for swipe behavior
6. `pnpm build` succeeds
</verification>

<success_criteria>
- Comparison page accessible at /compare with councillor selection
- Overall voting agreement score prominently displayed
- All 8 topics shown in comparison with agree/disagree indicators
- Entry points work: direct URL, "Compare with..." button from profile
- Mobile responsive with scroll-snap swipe between councillors
- No type errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-profiling-comparison/09-04-SUMMARY.md`
</output>
