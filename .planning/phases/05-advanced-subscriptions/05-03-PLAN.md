---
phase: 05-advanced-subscriptions
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - supabase/functions/send-alerts/index.ts
autonomous: true
requirements: [SUB-03, SUB-04, SUB-05]

must_haves:
  truths:
    - "Post-meeting digest email highlights items matching user's topic/neighbourhood/matter/person subscriptions"
    - "Digest email uses friendly, accessible tone like a neighbour explaining what happened"
    - "Pre-meeting alert email includes matching agenda items with context and practical attending info"
    - "Pre-meeting alerts fire when the Edge Function is called with a pre_meeting trigger"
  artifacts:
    - path: "supabase/functions/send-alerts/index.ts"
      provides: "Enhanced digest with subscription highlighting + pre-meeting alert capability"
      contains: "highlighted"
  key_links:
    - from: "supabase/functions/send-alerts/index.ts"
      to: "find_meeting_subscribers"
      via: "Supabase RPC call"
      pattern: "find_meeting_subscribers"
    - from: "supabase/functions/send-alerts/index.ts"
      to: "build_meeting_digest"
      via: "Supabase RPC call"
      pattern: "build_meeting_digest"
---

<objective>
Enhance the send-alerts Edge Function with subscription-aware digest highlighting and pre-meeting alert capability. The post-meeting digest should highlight items matching each subscriber's specific subscriptions (topics, neighbourhood, matters, people) with a "You follow this" visual indicator. Add a pre-meeting alert mode that sends upcoming agenda matches with practical attending information.

Purpose: Without these enhancements, users won't see which digest items are personally relevant, and the pre-meeting alert feature (a locked user decision) won't exist. The digest email tone should shift from neutral to friendly/accessible per the user's style decision.

Output: Enhanced send-alerts Edge Function deployed to Supabase with subscription highlighting and pre-meeting alert support.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advanced-subscriptions/05-RESEARCH.md
@.planning/phases/05-advanced-subscriptions/05-01-SUMMARY.md
@.planning/phases/03-subscriptions-notifications/03-02-SUMMARY.md

The send-alerts Edge Function source is on Supabase (not in local files). Read it via `mcp__supabase__get_edge_function` with slug "send-alerts".
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance digest email with subscription highlighting and friendly tone</name>
  <files>supabase/functions/send-alerts/index.ts</files>
  <action>
**Read the current send-alerts Edge Function** via `mcp__supabase__get_edge_function({ function_slug: "send-alerts" })`.

**Enhance `buildDigestHtml`** to highlight items matching subscriber's specific subscriptions:

1. The function already receives `subs: Subscriber[]` — use this to determine which items to highlight.
2. For each subscriber's email, compute which agenda items/decisions match their specific subscriptions:
   - `matter` subscriptions: highlight decisions where the motion's matter_id matches
   - `person` subscriptions: highlight decisions involving the subscribed person (need to add person info to the digest query — or match by name from attendance)
   - `topic` subscriptions: highlight decisions where the matter category matches the subscribed topic name (match via `subscription_type === 'topic'`)
   - `neighborhood` subscriptions: highlight decisions with `neighborhood` or `related_address` fields

3. Add a visual "You follow this" indicator to highlighted items in the HTML:
```html
<span style="display:inline-block;background:#dbeafe;color:#1d4ed8;font-size:11px;font-weight:600;padding:2px 8px;border-radius:12px;margin-left:8px;">
  Following
</span>
```

4. At the top of the email, if the user has highlighted items, add a summary section:
```html
<div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;margin-bottom:16px;">
  <strong style="color:#1d4ed8;font-size:13px;">Items you follow appeared in this meeting:</strong>
  <ul style="margin:8px 0 0;padding-left:16px;color:#1e40af;font-size:13px;">
    <li>Development (topic)</li>
    <li>123 Island Highway rezoning (matter)</li>
  </ul>
</div>
```

5. **Update the email tone** to be friendlier and more accessible per user decision:
   - Change the email header from "Council Meeting Digest" to "What happened at Council"
   - Change "Key Decisions" to "What Council Decided"
   - Change "Controversial Items" to "Where Council Disagreed"
   - Add a brief human-readable intro before the decisions: e.g., "Here's a quick rundown of what your council discussed on {date}."
   - Change the attendance section header from "Attendance" to "Who was there"
   - Keep the "View Full Meeting Details" CTA button

6. **Pass the subscription types to buildDigestHtml** — the `subs` array already includes `subscription_type` per subscriber. Create a helper function `getHighlightedItems(digest, subs)` that returns a set of agenda item titles or decision indices that should be highlighted.

**Note:** The buildDigestHtml function currently builds a generic digest for all subscribers. Since the email is built per subscriber (the loop already iterates per email), the highlighting can be subscriber-specific.
  </action>
  <verify>Review the updated Edge Function source code to verify: (1) buildDigestHtml uses subs array for highlighting, (2) friendly tone headings are in place, (3) "Following" badges appear in the HTML template for matched items.</verify>
  <done>Digest email highlights items matching subscriber's specific subscriptions with "Following" badges. Email tone is friendly and accessible ("What happened at Council", "What Council Decided", etc.).</done>
</task>

<task type="auto">
  <name>Task 2: Add pre-meeting alert mode to Edge Function and deploy</name>
  <files>supabase/functions/send-alerts/index.ts</files>
  <action>
**Add pre-meeting alert mode** to the send-alerts Edge Function:

1. Accept an optional `mode` field in the request body: `{ meeting_id, mode?: "digest" | "pre_meeting" }`. Default to "digest" for backward compatibility.

2. **When `mode === "pre_meeting"`:**
   - Query the meeting data: title, meeting_date, type, location (from meetings table or organization meta)
   - Query agenda items for the meeting with their category, title, plain_english_summary, related_address
   - Find subscribers via `find_meeting_subscribers` (same RPC — it already matches by topic, neighbourhood, matter, person)
   - Build a pre-meeting alert email with:
     - Subject: `Coming up: {meeting_title} — {date}`
     - Header: "Heads up — Council is meeting soon"
     - A section showing matched agenda items relevant to THIS subscriber with why they match ("Because you follow Development", "Near your address")
     - Practical attending info:
       - Date and time
       - Location: "Council Chambers, View Royal Town Hall, 45 View Royal Ave" (hardcode for now — View Royal specific)
       - Online: "Meetings are live-streamed on the Town's YouTube channel" with link
       - Comment: "To speak during public comment, contact the municipal clerk at {contact_email from municipality}"
     - CTA: "View the full agenda" linking to `/meetings/{id}`
   - Deduplicate and log with `alert_type: "pre_meeting"` in alert_log

3. **Build the pre-meeting HTML** in a new `buildPreMeetingHtml(meeting, matchedItems, subs)` function:
   - Same responsive email template style as digest
   - Same ViewRoyal.ai header
   - Friendly tone: "Your council is meeting on {date} and some items on the agenda might interest you."
   - List only the items matching this subscriber's subscriptions (not the full agenda)
   - If no specific matches but user has digest subscription, send a generic "Council is meeting soon" with the full agenda list
   - Include the attending info box at the bottom

4. **Deploy the updated Edge Function** via `mcp__supabase__deploy_edge_function`:
   - Name: `send-alerts`
   - `verify_jwt: true`
   - Include the complete updated `index.ts` file
   - Entrypoint: `index.ts`

**Important:** The pre-meeting alert is triggered by an external caller (pipeline or pg_cron job) passing `{ meeting_id, mode: "pre_meeting" }`. This plan does NOT set up the cron scheduling — that's a future operational concern. The capability must exist in the Edge Function.
  </action>
  <verify>
Use `mcp__supabase__get_edge_function({ function_slug: "send-alerts" })` to verify the deployed function contains: (1) `mode` parameter handling, (2) `buildPreMeetingHtml` function, (3) `alert_type: "pre_meeting"` logging. Check that the existing digest mode still works by reviewing backward compatibility (default mode = "digest").
  </verify>
  <done>
send-alerts Edge Function supports both "digest" and "pre_meeting" modes. Pre-meeting alert builds a subscriber-specific email with matched agenda items and practical attending information. Digest mode enhanced with subscription highlighting. Function deployed to Supabase.
  </done>
</task>

</tasks>

<verification>
1. `mcp__supabase__get_edge_function({ function_slug: "send-alerts" })` shows updated code
2. Digest email template includes "Following" badge HTML
3. Pre-meeting email template includes attending information
4. Function handles `mode: "pre_meeting"` and `mode: "digest"` (default)
5. Backward compatible — existing callers passing just `{ meeting_id }` still work
</verification>

<success_criteria>
- Post-meeting digest highlights subscribed items with "Following" badges
- Email tone is friendly and accessible (not bureaucratic)
- Pre-meeting alert mode sends matched agenda items with attending info
- Edge Function deployed and accessible
- Backward compatible with existing digest-only callers
- Alert log correctly records both "digest" and "pre_meeting" alert types
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-subscriptions/05-03-SUMMARY.md`
</output>
