---
phase: 05-advanced-subscriptions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/add_topic_keyword_support.sql
  - apps/web/app/lib/types.ts
  - apps/web/app/services/subscriptions.ts
  - apps/web/app/services/topics.ts
  - apps/web/app/routes/api.subscribe.tsx
  - apps/web/app/routes/api.geocode.tsx
  - apps/web/app/routes/signup.tsx
  - apps/web/app/routes.ts
  - apps/pipeline/pipeline/ingestion/ingester.py
autonomous: true
requirements: [SUB-03, SUB-04, SUB-05]

must_haves:
  truths:
    - "Topics table contains the 8 matter categories as seed data"
    - "Subscriptions table supports keyword text and keyword_embedding columns for semantic matching"
    - "user_profiles has onboarding_completed boolean for onboarding flow control"
    - "find_meeting_subscribers RPC includes a topic-matching UNION branch"
    - "Server-side geocoding endpoint converts street addresses to lat/lng"
    - "Pipeline geocodes agenda item related_address values at ingestion time"
    - "New signups are NOT auto-subscribed to digest (opt-in only)"
  artifacts:
    - path: "supabase/migrations/add_topic_keyword_support.sql"
      provides: "Schema extensions for topic matching, keyword embeddings, onboarding flag"
      contains: "INSERT INTO topics"
    - path: "apps/web/app/services/topics.ts"
      provides: "Topic query functions for UI consumption"
      exports: ["getTopics"]
    - path: "apps/web/app/routes/api.geocode.tsx"
      provides: "Server-side Nominatim geocoding endpoint"
      contains: "nominatim"
  key_links:
    - from: "apps/web/app/routes/api.subscribe.tsx"
      to: "apps/web/app/lib/embeddings.server.ts"
      via: "generateQueryEmbedding for keyword subscriptions"
      pattern: "generateQueryEmbedding"
    - from: "apps/web/app/routes/api.geocode.tsx"
      to: "nominatim.openstreetmap.org"
      via: "fetch to Nominatim API"
      pattern: "nominatim.openstreetmap.org"
---

<objective>
Build the database and backend infrastructure for topic subscriptions, keyword-based semantic matching, address geocoding, and pipeline-integrated geocoding. Remove digest auto-subscribe from signup. This plan establishes all schema, RPCs, API routes, and service functions that Plans 02 and 03 depend on.

Purpose: Without the schema extensions (topics seed data, keyword columns, onboarding flag), the RPC enhancements (topic matching), and API endpoints (geocoding, keyword subscriptions), the frontend onboarding wizard and digest enhancements cannot function.

Output: Seeded topics table, keyword-capable subscriptions, onboarding_completed flag, geocoding API route, topic service, and pipeline geocoding integration.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advanced-subscriptions/05-RESEARCH.md
@.planning/phases/03-subscriptions-notifications/03-01-SUMMARY.md
@.planning/phases/03-subscriptions-notifications/03-02-SUMMARY.md

Key existing files:
@apps/web/app/services/subscriptions.ts
@apps/web/app/routes/api.subscribe.tsx
@apps/web/app/routes/signup.tsx
@apps/web/app/lib/embeddings.server.ts
@apps/web/app/lib/types.ts
@apps/web/app/routes.ts
@apps/pipeline/pipeline/ingestion/ingester.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migrations — seed topics, add keyword columns, add onboarding flag, update find_meeting_subscribers RPC</name>
  <files>supabase/migrations/add_topic_keyword_support.sql</files>
  <action>
Create a single Supabase migration via `mcp__supabase__apply_migration` that does all of the following:

**1. Seed the topics table** with the 8 clean matter categories:
```sql
INSERT INTO topics (name, description) VALUES
  ('Administration', 'Administrative matters, council procedures, appointments'),
  ('Bylaw', 'Bylaw readings, amendments, enforcement'),
  ('Development', 'Land use, rezoning, development permits, subdivisions'),
  ('Environment', 'Environmental protection, parks, trails, conservation'),
  ('Finance', 'Budget, taxation, grants, financial planning'),
  ('General', 'General business, correspondence, presentations'),
  ('Public Safety', 'Policing, fire, emergency management, public safety'),
  ('Transportation', 'Roads, transit, cycling, pedestrian infrastructure')
ON CONFLICT (name) DO NOTHING;
```

**2. Add keyword columns to subscriptions:**
```sql
ALTER TABLE subscriptions ADD COLUMN IF NOT EXISTS keyword text;
ALTER TABLE subscriptions ADD COLUMN IF NOT EXISTS keyword_embedding halfvec(384);
CREATE INDEX IF NOT EXISTS idx_subscriptions_keyword_embedding
  ON subscriptions USING hnsw (keyword_embedding halfvec_cosine_ops);
```

**3. Add onboarding flag to user_profiles:**
```sql
ALTER TABLE user_profiles ADD COLUMN IF NOT EXISTS onboarding_completed boolean DEFAULT false;
```

**4. Update `find_meeting_subscribers` RPC** to add two new UNION branches:

- **Category topic branch**: Matches subscriptions where `s.type = 'topic' AND s.topic_id IS NOT NULL` by joining `topics.name` against `matters.category` for agenda items in the target meeting.

- **Keyword topic branch**: Matches subscriptions where `s.type = 'topic' AND s.keyword_embedding IS NOT NULL` by computing `1 - (ai.embedding <=> s.keyword_embedding) > 0.45` cosine similarity against agenda_items with embeddings in the target meeting.

Use `CREATE OR REPLACE FUNCTION find_meeting_subscribers(target_meeting_id bigint)` with the same return type as existing (user_id uuid, subscription_id bigint, subscription_type text, notification_email text). Include `SET search_path = 'public'` per the security pattern established in Phase 3.

First, query the existing RPC source to get the exact current definition:
```sql
SELECT pg_get_functiondef(oid) FROM pg_proc WHERE proname = 'find_meeting_subscribers';
```
Then extend it with the two new UNION ALL branches while keeping all existing branches intact.

**Verification query after migration:**
```sql
SELECT count(*) FROM topics;  -- should be 8
SELECT column_name FROM information_schema.columns WHERE table_name = 'subscriptions' AND column_name IN ('keyword', 'keyword_embedding');  -- should return 2 rows
SELECT column_name FROM information_schema.columns WHERE table_name = 'user_profiles' AND column_name = 'onboarding_completed';  -- should return 1 row
```
  </action>
  <verify>Run verification queries via `mcp__supabase__execute_sql` to confirm: topics has 8 rows, subscriptions has keyword + keyword_embedding columns, user_profiles has onboarding_completed column, find_meeting_subscribers function exists with topic matching branches.</verify>
  <done>Topics table seeded with 8 categories. Subscriptions table has keyword and keyword_embedding columns with HNSW index. user_profiles has onboarding_completed boolean. find_meeting_subscribers RPC matches topic subscriptions by both category FK and keyword embedding similarity.</done>
</task>

<task type="auto">
  <name>Task 2: Backend services, API routes, and pipeline geocoding</name>
  <files>
    apps/web/app/services/topics.ts
    apps/web/app/services/subscriptions.ts
    apps/web/app/routes/api.subscribe.tsx
    apps/web/app/routes/api.geocode.tsx
    apps/web/app/routes/signup.tsx
    apps/web/app/routes.ts
    apps/web/app/lib/types.ts
    apps/pipeline/pipeline/ingestion/ingester.py
  </files>
  <action>
**1. Create `apps/web/app/services/topics.ts`:**
```typescript
export async function getTopics(supabase: SupabaseClient): Promise<Topic[]> {
  const { data, error } = await supabase
    .from("topics")
    .select("id, name, description")
    .order("name");
  if (error) throw error;
  return (data || []) as Topic[];
}
```

**2. Update TypeScript types in `apps/web/app/lib/types.ts`:**
- Add `keyword?: string` and `keyword_embedding?: number[]` to the `Subscription` interface
- Add `onboarding_completed?: boolean` to the `UserProfile` interface
- Ensure `Topic` interface exists (it may already — verify): `{ id: number; name: string; description?: string }`

**3. Update `apps/web/app/services/subscriptions.ts`:**
- Add `addKeywordSubscription` function that accepts `(supabase, userId, keyword, embedding)` and inserts a subscription with `type: 'topic'`, `keyword`, and `keyword_embedding` fields
- Update `addSubscription` to also accept optional `keyword` and `keyword_embedding` in its target parameter

**4. Update `apps/web/app/routes/api.subscribe.tsx`:**
- Accept `keyword` field in POST body
- When `type === 'topic'` and `keyword` is provided (but no `topic_id`), call `generateQueryEmbedding(keyword)` from `embeddings.server.ts` to create the 384-dim embedding, then call `addSubscription` with `keyword` + `keyword_embedding`
- Import `generateQueryEmbedding` from `../lib/embeddings.server`

**5. Create `apps/web/app/routes/api.geocode.tsx`:**
- Action handler for POST requests with `{ address: string }` body
- Server-side fetch to Nominatim: `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address + ", View Royal, BC, Canada")}&format=json&limit=1&viewbox=-123.55,48.42,-123.40,48.48&bounded=1`
- Include `User-Agent: ViewRoyal.ai/1.0 (civic platform)` header
- Return `{ lat, lng }` or `{ error: "Address not found" }`
- Require authentication (check supabase.auth.getUser())

**6. Register the new route in `apps/web/app/routes.ts`:**
- Add: `route("api/geocode", "routes/api.geocode.tsx")`
- Add: `route("onboarding", "routes/onboarding.tsx")` (file created in Plan 02, but register route now to avoid Plan 02 touching routes.ts)

**7. Fix auto-subscribe in `apps/web/app/routes/signup.tsx`:**
- REMOVE the auto-digest subscription block (lines 45-53 that insert a digest subscription)
- Keep the user_profiles creation (lines 32-43) intact
- Digest subscription is now opt-in only via onboarding wizard or settings page

**8. Add geocoding to pipeline ingester (`apps/pipeline/pipeline/ingestion/ingester.py`):**
- Add a `geocode_address` method that calls Nominatim with proper rate limiting (1.1s delay via `time.sleep`)
- In the `ingest_meeting` method, after creating/updating agenda items that have a `related_address` but no existing `geo` data, call `geocode_address` and update the agenda item's `geo` column with `ST_SetSRID(ST_MakePoint(lng, lat), 4326)::geography`
- Use the same View Royal bounding box bias as the existing `geocode_addresses.py` script
- Only geocode when `related_address` is a real address (skip if it starts with common non-address patterns like "Various", "N/A", "TBD")
- Import `time` and `requests` (both available in the pipeline environment)
- Add a counter to log how many addresses were geocoded

Run `pnpm typecheck` from `apps/web/` to verify TypeScript compiles.
  </action>
  <verify>
Run `pnpm typecheck` from `apps/web/` to confirm no type errors. Verify `api.geocode.tsx` and `topics.ts` exist. Verify signup.tsx no longer contains digest auto-subscribe code (grep for "Auto-subscribe to digest" should return 0 results). Verify routes.ts includes the new routes.
  </verify>
  <done>
Topics service layer exists. API subscribe route accepts keyword subscriptions with embedding generation. Geocoding API route converts addresses to lat/lng via Nominatim. Signup no longer auto-subscribes to digest. Pipeline geocodes agenda item addresses at ingestion time. All TypeScript types updated. Typecheck passes.
  </done>
</task>

</tasks>

<verification>
1. `SELECT count(*) FROM topics` returns 8
2. `SELECT column_name FROM information_schema.columns WHERE table_name = 'subscriptions' AND column_name IN ('keyword', 'keyword_embedding')` returns 2 rows
3. `pnpm typecheck` passes in `apps/web/`
4. `grep -r "Auto-subscribe to digest" apps/web/app/routes/signup.tsx` returns nothing (auto-subscribe removed)
5. `apps/web/app/routes/api.geocode.tsx` exists and handles POST with address
6. `apps/web/app/services/topics.ts` exports `getTopics`
</verification>

<success_criteria>
- Topics table has 8 seeded categories
- Subscriptions support keyword + keyword_embedding columns
- find_meeting_subscribers RPC matches by category FK AND keyword embedding similarity
- Geocoding API route works server-side via Nominatim
- Signup page does NOT auto-subscribe to digest
- Pipeline geocodes addresses incrementally at ingestion
- TypeScript types reflect all new fields
- All existing functionality preserved (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-subscriptions/05-01-SUMMARY.md`
</output>
