---
phase: 17-ocd-interoperability
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/api/ocd/endpoints/organizations.ts
  - apps/web/app/api/ocd/endpoints/bills.ts
  - apps/web/app/api/ocd/endpoints/votes.ts
  - apps/web/app/api/ocd/serializers/bill.ts
autonomous: true
requirements: [OCD-02, OCD-05, OCD-06]
gap_closure: true

must_haves:
  truths:
    - "Organization list and detail endpoints return 200 with valid data (not 500)"
    - "Bill detail endpoint returns 200 with actions and sponsors (not 500)"
    - "Vote detail endpoint returns data for recent votes (2026), not just old ones (2020)"
  artifacts:
    - path: "apps/web/app/api/ocd/endpoints/organizations.ts"
      provides: "Organization queries without parent_organization_id column"
    - path: "apps/web/app/api/ocd/endpoints/bills.ts"
      provides: "Bill detail query without document_url column, with explicit row limit"
    - path: "apps/web/app/api/ocd/endpoints/votes.ts"
      provides: "Vote detail query with explicit row limit for full-table OCD ID reverse-lookup"
    - path: "apps/web/app/api/ocd/serializers/bill.ts"
      provides: "Bill serializer without document_url reference"
  key_links:
    - from: "apps/web/app/api/ocd/endpoints/organizations.ts"
      to: "organizations table"
      via: "select string matches actual DB columns"
      pattern: 'select.*id, name, classification, created_at'
    - from: "apps/web/app/api/ocd/endpoints/bills.ts"
      to: "matters table"
      via: "select string matches actual DB columns, .limit() ensures all rows fetched"
      pattern: '\\.limit\\('
    - from: "apps/web/app/api/ocd/endpoints/votes.ts"
      to: "motions table"
      via: ".limit() ensures all 10,536 motions fetched for reverse-lookup"
      pattern: '\\.limit\\('
---

<objective>
Fix three UAT failures in OCD endpoints: organizations 500 (non-existent column), bill detail 500 (non-existent column), and vote detail 404 for recent entries (PostgREST row limit truncation).

Purpose: UAT testing revealed three runtime failures caused by (1) selecting DB columns that don't exist in the actual schema, and (2) relying on PostgREST's default row limit for full-table reverse-lookups. These are the final gaps preventing all 8 OCD UAT tests from passing.

Output: All three endpoints return correct data; all 8 UAT tests pass.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-ocd-interoperability/17-UAT.md
@apps/web/app/api/ocd/endpoints/organizations.ts
@apps/web/app/api/ocd/endpoints/bills.ts
@apps/web/app/api/ocd/endpoints/votes.ts
@apps/web/app/api/ocd/serializers/bill.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove non-existent columns from organization and bill queries</name>
  <files>
    apps/web/app/api/ocd/endpoints/organizations.ts
    apps/web/app/api/ocd/endpoints/bills.ts
    apps/web/app/api/ocd/serializers/bill.ts
  </files>
  <action>
  Two separate column-doesn't-exist bugs causing 500 errors:

  **1. organizations.ts -- remove `parent_organization_id` from both selects**

  The organizations table only has: id, name, classification, meta, created_at, municipality_id, ocd_id. There is no `parent_organization_id` column.

  In `listOrganizations` (line 43), change the select string from:
  `"id, name, classification, parent_organization_id, created_at"`
  to:
  `"id, name, classification, created_at"`

  In `getOrganization` (line 92), change the select string from:
  `"id, name, classification, parent_organization_id, created_at"`
  to:
  `"id, name, classification, created_at"`

  The serializer already hardcodes `parent_id: null` and never reads `parent_organization_id` from the row, so removing it from the select is the only change needed.

  **2. bills.ts -- remove `document_url` from getBill select**

  The matters table has no `document_url` column. Available columns include: id, title, identifier, description, status, category, first_seen, last_seen, created_at, bylaw_id, municipality_id, ocd_id, slug, etc.

  In `getBill` (line 119), change the select string from:
  `"id, title, identifier, description, status, category, first_seen, document_url, created_at"`
  to:
  `"id, title, identifier, description, status, category, first_seen, created_at"`

  **3. bill.ts serializer -- remove document_url reference**

  In `apps/web/app/api/ocd/serializers/bill.ts`, the `serializeBillDetail` function (lines 101-113) builds a documents array from `matter.document_url`. Since that column doesn't exist, this block will always produce an empty array anyway, but it's cleaner to remove the dead reference.

  Replace lines 101-113:
  ```typescript
  const documents: any[] = matter.document_url
    ? [
        {
          note: "Supporting document",
          date: null as string | null,
          media_type: "application/pdf",
          url: matter.document_url,
          text: "",
          links: [] as any[],
        },
      ]
    : [];
  ```

  With:
  ```typescript
  const documents: any[] = [];
  ```

  The `documents` field is still included in the return object (line 138) as an empty array, which is valid OCD spec.
  </action>
  <verify>
  Run `cd /Users/kyle/development/viewroyal/apps/web && npx tsc --noEmit 2>&1 | head -20` to confirm no type errors.
  Then verify the column references are gone:
  - `grep -n "parent_organization_id" apps/web/app/api/ocd/endpoints/organizations.ts` should return no matches.
  - `grep -n "document_url" apps/web/app/api/ocd/endpoints/bills.ts apps/web/app/api/ocd/serializers/bill.ts` should return no matches.
  </verify>
  <done>
  Organization endpoints no longer select `parent_organization_id` (returns 200 instead of 500). Bill detail endpoint no longer selects `document_url` (returns 200 instead of 500). Bill serializer no longer references non-existent column.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add explicit row limits to OCD ID reverse-lookup queries</name>
  <files>
    apps/web/app/api/ocd/endpoints/votes.ts
    apps/web/app/api/ocd/endpoints/bills.ts
  </files>
  <action>
  The OCD ID reverse-lookup pattern fetches ALL entities for a municipality, computes OCD IDs for each, then finds the one matching the requested ID. PostgREST has a default row limit (~1000). With 10,536 motions and 1,727 matters, newer rows are silently truncated, causing 404s for recent entities.

  Fix by adding explicit `.limit()` calls to both full-table fetch queries:

  **1. votes.ts `getVote` -- add .limit(100000) to the all-motions query**

  After `.eq("meeting.municipality_id", muni.id)` on line 125, add `.limit(100000)` before the semicolon. The query chain should read:

  ```typescript
  const { data: allMotions, error } = await supabase
    .from("motions")
    .select(
      "id, text_content, plain_english_summary, result, mover, seconder, yes_votes, no_votes, abstain_votes, created_at, agenda_item_id, meeting:meetings!inner(meeting_date, municipality_id, organization:organizations(name, id))",
    )
    .eq("meeting.municipality_id", muni.id)
    .limit(100000);
  ```

  **2. bills.ts `getBill` -- add .limit(100000) to the all-matters query**

  After `.eq("municipality_id", muni.id)` on line 121, add `.limit(100000)` before the semicolon. The query chain should read:

  ```typescript
  const { data: allMatters, error } = await supabase
    .from("matters")
    .select(
      "id, title, identifier, description, status, category, first_seen, created_at",
    )
    .eq("municipality_id", muni.id)
    .limit(100000);
  ```

  Note: 100000 is intentionally large to ensure no truncation. View Royal has ~10K motions and ~1.7K matters; this limit provides a 10x safety margin. Organizations (~10 rows) don't need this fix.

  Do NOT add `.limit()` to the paginated list queries (listVotes, listBills) -- those already use `.range()` for pagination and are not affected.
  </action>
  <verify>
  Confirm the limit calls were added:
  - `grep -n "\.limit(" apps/web/app/api/ocd/endpoints/votes.ts` should show the new limit.
  - `grep -n "\.limit(" apps/web/app/api/ocd/endpoints/bills.ts` should show the new limit.
  Run `cd /Users/kyle/development/viewroyal/apps/web && npx tsc --noEmit 2>&1 | head -20` to confirm no type errors.
  </verify>
  <done>
  Vote detail endpoint fetches all 10,536 motions (not truncated at ~1000), so recent votes (2026) are found during OCD ID reverse-lookup. Bill detail endpoint similarly fetches all 1,727 matters without truncation.
  </done>
</task>

</tasks>

<verification>
1. No TypeScript compilation errors in `apps/web/`
2. No references to `parent_organization_id` in organizations.ts
3. No references to `document_url` in bills.ts or bill.ts serializer
4. `.limit(100000)` present in getVote and getBill full-table queries
5. Paginated list queries (listVotes, listBills) are unchanged (still use .range())
</verification>

<success_criteria>
- GET /api/ocd/view-royal/organizations returns 200 with organization data (UAT test 3)
- GET /api/ocd/view-royal/bills/:id returns 200 with actions and sponsors (UAT test 7)
- GET /api/ocd/view-royal/votes/:id returns 200 for recent 2026 votes (UAT test 8)
- All 8 UAT tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/17-ocd-interoperability/17-06-SUMMARY.md`
</output>
