---
phase: 17-ocd-interoperability
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/api/middleware/municipality.ts
  - apps/web/app/api/ocd/endpoints/jurisdictions.ts
  - apps/web/app/api/ocd/endpoints/organizations.ts
  - .planning/REQUIREMENTS.md
autonomous: true
requirements: [OCD-01, OCD-02, OCD-03, OCD-04, OCD-05, OCD-06, OCD-07, OCD-08]
gap_closure: true

must_haves:
  truths:
    - "Jurisdiction endpoint returns a valid OCD ID containing csd:5917047 (not empty csd code)"
    - "Organization endpoint returns a valid jurisdictionId containing csd:5917047"
    - "REQUIREMENTS.md shows OCD-04, OCD-05, OCD-06 as complete"
  artifacts:
    - path: "apps/web/app/api/middleware/municipality.ts"
      provides: "Municipality middleware with ocd_id in select"
      contains: "ocd_id"
    - path: "apps/web/app/api/ocd/endpoints/jurisdictions.ts"
      provides: "Jurisdiction endpoints using muni.ocd_id directly"
    - path: "apps/web/app/api/ocd/endpoints/organizations.ts"
      provides: "Organization endpoints using muni.ocd_id directly"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Accurate requirement status tracking"
      contains: "[x] **OCD-04**"
  key_links:
    - from: "apps/web/app/api/middleware/municipality.ts"
      to: "municipalities table"
      via: "select includes ocd_id"
      pattern: 'select.*ocd_id'
    - from: "apps/web/app/api/ocd/endpoints/jurisdictions.ts"
      to: "municipality.ocd_id"
      via: "direct property access instead of ocd_divisions query"
      pattern: 'muni\.ocd_id'
---

<objective>
Fix the blocking ocd_divisions lookup defect in Jurisdiction and Organization endpoints, and update REQUIREMENTS.md to reflect completed OCD-04/05/06.

Purpose: The Jurisdiction and Organization OCD endpoints query `ocd_divisions.municipality_id` which does not exist, causing division lookups to silently return empty and producing malformed OCD IDs (e.g., `ocd-jurisdiction/country:ca/csd:/government`). Fix by using the municipality's own `ocd_id` column directly, eliminating the broken join.

Output: Working Jurisdiction and Organization endpoints with correct OCD IDs, accurate REQUIREMENTS.md.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-ocd-interoperability/17-VERIFICATION.md
@apps/web/app/api/middleware/municipality.ts
@apps/web/app/api/ocd/endpoints/jurisdictions.ts
@apps/web/app/api/ocd/endpoints/organizations.ts
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix division lookup in Jurisdiction and Organization endpoints</name>
  <files>
    apps/web/app/api/middleware/municipality.ts
    apps/web/app/api/ocd/endpoints/jurisdictions.ts
    apps/web/app/api/ocd/endpoints/organizations.ts
  </files>
  <action>
  The root cause: `ocd_divisions` table has no `municipality_id` column, but both endpoints query `.eq("municipality_id", muni.id)`. The municipality itself already stores the correct division ID in its `ocd_id` column (`ocd-division/country:ca/csd:5917047`).

  Fix in three steps:

  1. **apps/web/app/api/middleware/municipality.ts** — Add `ocd_id` to the select string on line 22:
     Change: `.select("id, slug, name, short_name")`
     To: `.select("id, slug, name, short_name, ocd_id")`
     This makes `muni.ocd_id` available to all downstream handlers.

  2. **apps/web/app/api/ocd/endpoints/jurisdictions.ts** — Remove the `ocd_divisions` query in BOTH `listJurisdictions` and `getJurisdiction`. Instead, derive the divisionId from `muni.ocd_id` (which the middleware now provides after re-fetching the full municipality row, or from the municipality select in the handler itself).

     In `listJurisdictions`:
     - The handler already fetches the full municipality row with `select("*")` on line 31. Use `municipality.ocd_id` as the divisionId directly.
     - Remove lines 40-52 (the ocd_divisions query block).
     - Replace `const divisionId = division?.division_id ?? "";` with `const divisionId = municipality?.ocd_id ?? "";`

     In `getJurisdiction`:
     - Move the municipality fetch (lines 108-118) BEFORE the divisionId computation.
     - Remove lines 82-93 (the ocd_divisions query block).
     - Replace `const divisionId = division?.division_id ?? "";` with `const divisionId = municipality?.ocd_id ?? "";`

  3. **apps/web/app/api/ocd/endpoints/organizations.ts** — Remove the `ocd_divisions` query in BOTH `listOrganizations` and `getOrganization`. Instead, use `muni.ocd_id` directly from the middleware-provided municipality object.

     In `listOrganizations`:
     - Remove lines 33-38 (the ocd_divisions query block).
     - Replace `const divisionId = division?.division_id ?? "";` with `const divisionId = muni.ocd_id ?? "";`
     - The csdMatch/csdCode/jurisdictionId derivation on lines 41-43 stays but uses the new divisionId source.

     In `getOrganization`:
     - Remove lines 90-94 (the ocd_divisions query block).
     - Replace `const divisionId = division?.division_id ?? "";` with `const divisionId = muni.ocd_id ?? "";`
     - The csdMatch/csdCode/jurisdictionId derivation stays.

  Do NOT remove unused imports. Let the executor clean them up naturally. The key change is eliminating every `.from("ocd_divisions")` query in both files and using the municipality's own ocd_id instead.
  </action>
  <verify>
  Run `cd /Users/kyle/development/viewroyal/apps/web && npx tsc --noEmit 2>&1 | head -50` to confirm no type errors.
  Then grep to confirm no remaining references to `municipality_id` in the OCD endpoints:
  `grep -rn "municipality_id" apps/web/app/api/ocd/endpoints/` should return zero matches.
  And confirm ocd_id is in the middleware select:
  `grep "ocd_id" apps/web/app/api/middleware/municipality.ts` should show the updated select.
  </verify>
  <done>
  Jurisdiction and Organization endpoints derive division ID from `municipality.ocd_id` directly instead of querying `ocd_divisions` by a non-existent `municipality_id` column. No runtime failures; OCD IDs will contain the correct `csd:5917047`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update REQUIREMENTS.md to mark OCD-04/05/06 as complete</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
  Update three items in `.planning/REQUIREMENTS.md`:

  1. Change the checkbox lines (around lines 46-48):
     - `- [ ] **OCD-04**:` → `- [x] **OCD-04**:`
     - `- [ ] **OCD-05**:` → `- [x] **OCD-05**:`
     - `- [ ] **OCD-06**:` → `- [x] **OCD-06**:`

  2. Change the traceability table entries (around lines 113-115):
     - `| OCD-04 | Phase 17 | Pending |` → `| OCD-04 | Phase 17 | Complete |`
     - `| OCD-05 | Phase 17 | Pending |` → `| OCD-05 | Phase 17 | Complete |`
     - `| OCD-06 | Phase 17 | Pending |` → `| OCD-06 | Phase 17 | Complete |`
  </action>
  <verify>
  `grep "OCD-0[456]" .planning/REQUIREMENTS.md` should show all three as `[x]` and `Complete`.
  </verify>
  <done>
  REQUIREMENTS.md accurately reflects that OCD-04 (Events), OCD-05 (Bills), and OCD-06 (Votes) are fully implemented and complete.
  </done>
</task>

</tasks>

<verification>
1. No TypeScript compilation errors in `apps/web/`
2. No references to `municipality_id` in any `apps/web/app/api/ocd/endpoints/` file
3. `muni.ocd_id` is available via the municipality middleware (ocd_id in select)
4. Jurisdiction endpoints use municipality.ocd_id (or muni.ocd_id) instead of ocd_divisions query
5. Organization endpoints use muni.ocd_id instead of ocd_divisions query
6. REQUIREMENTS.md shows OCD-04, OCD-05, OCD-06 as [x] Complete
</verification>

<success_criteria>
- Jurisdiction endpoint produces `ocd-jurisdiction/country:ca/csd:5917047/government` (not empty csd code)
- Organization endpoint passes correct jurisdictionId to serializer
- All 8 OCD requirements (OCD-01 through OCD-08) show as complete in REQUIREMENTS.md
- `pnpm typecheck` passes (or at least no new errors introduced)
</success_criteria>

<output>
After completion, create `.planning/phases/17-ocd-interoperability/17-04-SUMMARY.md`
</output>
