---
phase: 07.1-upgrade-document-extraction
plan: 03
type: execute
wave: 3
depends_on: ["07.1-02"]
files_modified:
  - apps/pipeline/main.py
  - apps/pipeline/pipeline/orchestrator.py
autonomous: false
requirements: [DOC-05]

must_haves:
  truths:
    - "Backfill processes all 711+ meetings with agenda PDFs from local archive"
    - "Backfill is resumable — can be interrupted and restarted without reprocessing completed meetings"
    - "CLI has --extract-documents flag for running the new extraction pipeline"
    - "After backfill, document_sections table has thousands of sections with embeddings"
    - "Existing document_sections data is deleted and replaced with new extraction output"
  artifacts:
    - path: "apps/pipeline/main.py"
      provides: "--extract-documents CLI flag"
      contains: "extract-documents"
    - path: "apps/pipeline/pipeline/orchestrator.py"
      provides: "Resumable backfill with progress tracking"
      contains: "backfill_progress"
  key_links:
    - from: "apps/pipeline/pipeline/orchestrator.py"
      to: "apps/pipeline/pipeline/ingestion/document_extractor.py"
      via: "backfill_extracted_documents calls extract_and_store_documents in loop"
      pattern: "extract_and_store_documents"
---

<objective>
Build the resumable backfill pipeline that processes all 711+ meetings with agenda PDFs, add CLI flags, and validate the results.

Purpose: Completes the DOC-05 requirement by backfilling all existing documents with the new Gemini extraction pipeline, with resilient progress tracking so the multi-hour process can be interrupted and resumed.
Output: CLI command that processes all meetings, local progress file for resumability, validation of extraction results.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-upgrade-document-extraction-with-docling-and-gemini/07.1-CONTEXT.md
@.planning/phases/07.1-upgrade-document-extraction-with-docling-and-gemini/07.1-01-SUMMARY.md
@.planning/phases/07.1-upgrade-document-extraction-with-docling-and-gemini/07.1-02-SUMMARY.md
@apps/pipeline/main.py
@apps/pipeline/pipeline/orchestrator.py
@apps/pipeline/pipeline/ingestion/document_extractor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build resumable backfill pipeline with CLI flags</name>
  <files>
    apps/pipeline/main.py
    apps/pipeline/pipeline/orchestrator.py
  </files>
  <action>
**1. Add new backfill method to `orchestrator.py`:**

Create `backfill_extracted_documents(self, force=False, limit=None)` method on the `Archiver` class. This is a NEW method separate from the existing `backfill_document_sections()` (which is kept for backward compatibility).

**Architecture:**
- This method processes meetings from the LOCAL ARCHIVE at `/viewroyal_archive/`, NOT from the database documents table
- It walks the archive directory structure: `{meeting_type}/{year}/{month}/{meeting_name}/Agenda/*.pdf`
- For each meeting folder, it looks up the corresponding meeting in the database by `archive_path`
- Then finds or creates the document record, and runs the full extraction pipeline

**Progress tracking:**
- Use a local JSON file at `apps/pipeline/backfill_progress.json` for tracking
- Structure: `{"processed_meeting_ids": [1, 2, 3...], "errors": {"4": "error msg"}, "started_at": "ISO timestamp", "last_updated": "ISO timestamp"}`
- After each successfully processed meeting, append meeting_id to processed list and write file
- On startup, load progress file and skip already-processed meetings
- If `force=True`, delete progress file and start fresh (also delete all extracted_documents, document_images, document_sections)

**Processing flow per meeting:**
1. Walk archive directory tree to find all Agenda PDF files
2. For each meeting folder with an agenda PDF:
   a. Look up meeting in DB by archive_path
   b. If no meeting found, log and skip
   c. Check if meeting_id is in processed list — skip if so (unless force)
   d. Find or create document record in `documents` table for this PDF
   e. Call `extract_and_store_documents(pdf_path, document_id, meeting_id, supabase, municipality_id)`
   f. On success: add meeting_id to processed list, save progress
   g. On error: add to errors dict, save progress, continue
3. Print summary: total processed, skipped, errors, time elapsed

**Rate limiting:**
- Add `time.sleep(2)` between meetings to respect Gemini API rate limits
- The 2-second delay gives ~30 meetings/minute, completing ~711 meetings in ~24 minutes of API time (plus extraction time)

**Progress display:**
- Use `tqdm` for progress bar showing `{processed}/{total} meetings`
- Print per-meeting: meeting name, documents found, sections created

**`limit` parameter:**
- If set, only process this many meetings (for testing)
- Useful for testing with `--limit 5`

**2. Add CLI flags to `main.py`:**

Add `--extract-documents` flag:
```python
parser.add_argument(
    "--extract-documents",
    action="store_true",
    help="Run Gemini-powered document extraction on all agenda PDFs (resumable). "
         "Replaces existing document_sections. Use --force to delete and reprocess all. "
         "Use --limit N to process only N meetings.",
)
```

Add handler in the if/elif chain (before the existing `backfill_sections` handler):
```python
elif args.extract_documents:
    print("\n--- Extract Documents (Gemini 2.5 Flash) ---")
    app.backfill_extracted_documents(force=args.force, limit=args.limit)
    if not args.skip_embed:
        print("\n--- Embedding Document Sections ---")
        app._embed_new_content()
```

**The existing `--backfill-sections` flag should be kept** for backward compatibility but add a deprecation notice in its help text.
  </action>
  <verify>
```bash
cd /Users/kyle/development/viewroyal/apps/pipeline && uv run python main.py --help | grep -A2 'extract-documents'
```
The `--extract-documents` flag appears in help output with description.

```bash
cd /Users/kyle/development/viewroyal/apps/pipeline && uv run python -c "
from pipeline.orchestrator import Archiver
a = Archiver()
assert hasattr(a, 'backfill_extracted_documents'), 'Method missing'
print('backfill_extracted_documents method exists')
"
```
  </verify>
  <done>--extract-documents CLI flag exists and calls backfill_extracted_documents(). Progress tracking via local JSON file enables resumable processing. Limit flag supports test runs.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify extraction pipeline end-to-end</name>
  <files>apps/pipeline/backfill_progress.json</files>
  <action>
Human verifies the complete Gemini-powered document extraction pipeline:
1. Database schema (extracted_documents, document_images tables)
2. Gemini 2.5 Flash two-pass extractor (boundary detection + content extraction)
3. PyMuPDF image extraction with R2 upload
4. Document extraction orchestrator
5. Pipeline integration (ingester.py + orchestrator.py)
6. Resumable backfill CLI (--extract-documents)

Steps to verify:

1. **Test extraction on a single meeting** (small test run):
   ```bash
   cd apps/pipeline
   uv run python main.py --extract-documents --limit 1
   ```
   Should process 1 meeting, show boundary detection output (N documents found), content extraction, and section creation.

2. **Check database results**:
   ```sql
   SELECT COUNT(*) FROM extracted_documents;
   SELECT COUNT(*) FROM document_sections WHERE extracted_document_id IS NOT NULL;
   SELECT ed.title, ed.document_type, ed.page_start, ed.page_end, ed.summary
   FROM extracted_documents ed LIMIT 5;
   ```
   extracted_documents rows exist with proper types and page ranges.

3. **Test resumability** — run again:
   ```bash
   uv run python main.py --extract-documents --limit 2
   ```
   First meeting is skipped ("already processed"), second meeting is processed.

4. **Run larger batch** (when satisfied):
   ```bash
   uv run python main.py --extract-documents --limit 10
   ```
   Review extraction quality for a mix of meeting types.

5. **Verify Docling removed**:
   ```bash
   grep docling apps/pipeline/pyproject.toml
   ```
   Should return no results.
  </action>
  <verify>Human confirms extraction quality and resumability are satisfactory.</verify>
  <done>Pipeline processes agenda PDFs through Gemini boundary detection and content extraction, creates proper extracted_documents and document_sections rows, and supports resumable backfill. Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
- `--extract-documents` CLI flag exists and works
- Running with `--limit 1` successfully processes one meeting through the full pipeline
- extracted_documents table has rows with correct document types and page ranges
- document_sections table has new sections with extracted_document_id set
- Progress file enables resumable processing (skips already-processed meetings)
- `--force` flag deletes existing data and reprocesses from scratch
- Embeddings generate for new sections when `--skip-embed` is not set
</verification>

<success_criteria>
Backfill pipeline processes meetings from the local archive using Gemini 2.5 Flash extraction. Processing is resumable via local progress file. A test run of 1-10 meetings confirms the pipeline produces high-quality document boundaries, content extraction, and section splitting. Ready for full 711-meeting backfill.
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-upgrade-document-extraction-with-docling-and-gemini/07.1-03-SUMMARY.md`
</output>
