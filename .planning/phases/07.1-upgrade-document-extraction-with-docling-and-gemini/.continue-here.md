---
phase: 07.1-upgrade-document-extraction-with-docling-and-gemini
task: 0
total_tasks: 0
status: planned_pending_verification
last_updated: 2026-02-17T21:10:52.512Z
---

<current_state>
Phase 7.1 plans have been created (3 plans, 3 waves) but the plan-checker verification step was interrupted by a rate limit. Plans need verification before execution.

The plans reflect a MAJOR design change made during this session: **Docling was dropped** in favor of Gemini 2.5 Flash doing both boundary detection AND content extraction. This was decided after hands-on testing showed Docling produces poor quality output while Gemini 2.5 Flash produces dramatically better results.
</current_state>

<completed_work>

- Context gathering: 07.1-CONTEXT.md existed from prior session
- Research: 07.1-RESEARCH.md created by gsd-phase-researcher (covers Gemini API, Docling, PyMuPDF, schema design, pitfalls)
- **Docling quality testing**: Read /tmp/docling_output.md — identified poor quality (mangled tables, floating page refs, spacing issues, hollow slide extraction)
- **Gemini 2.5 Flash testing**: Created /tmp/test_gemini25_flash.py, ran on 222-page/39MB Feb 2025 CoW meeting PDF
  - Boundary detection: 71s, found 31 documents with precise page ranges and agenda item links → /tmp/gemini25_boundaries.json
  - Content extraction: 15-18s per doc, dramatically better than Docling → /tmp/gemini25_content_sample.md, /tmp/gemini25_toc_sample.md, /tmp/gemini25_delegation_sample.md
  - PDFs over ~50MB fail with File API ("total referenced files bytes are too large") — need PyMuPDF splitting
- **Cost analysis**: Compared Gemini 2.0 Flash ($15-20), 2.5 Flash ($75 standard / $37-40 batch), 3 Flash ($80-95), Claude Haiku ($165 / $82 batch)
- **Design decision**: Drop Docling, go all-in on Gemini 2.5 Flash for both boundary detection and content extraction
- **CONTEXT.md updated**: Reflects Docling dropped, Gemini 2.5 Flash two-pass approach, updated cost estimates
- **Plans created**: 3 plans in 3 waves (first set with Docling was deleted, re-planned with Gemini-only approach)
- **Plan checker**: Spawned but hit rate limit before producing results

</completed_work>

<remaining_work>

- Run plan-checker verification on the 3 plans (was interrupted by rate limit)
- If verification passes → ready for /gsd:execute-phase 07.1
- If issues found → revision loop (max 3 iterations)
- Then execute all 3 plans:
  - Plan 01 (Wave 1): Schema migration + gemini_extractor.py
  - Plan 02 (Wave 2): image_extractor.py + document_extractor.py + pipeline integration + remove Docling
  - Plan 03 (Wave 3): Resumable backfill CLI + human verification checkpoint
- After pipeline code is built, run full backfill of 711+ meetings (~$37-40 Gemini cost)

</remaining_work>

<decisions_made>

- **Docling DROPPED**: Testing showed poor quality output — mangled tables, floating page references, `<!-- image -->` noise, spacing issues like "from7.5m". Gemini 2.5 Flash produces dramatically better output on the same PDFs.
- **Gemini 2.5 Flash chosen** over 2.0 Flash (8K output limit, retiring March 31) and 3 Flash (5x more expensive without proportional benefit). 2.5 Flash has 64K output limit and batch API at 50% discount.
- **Two-pass architecture**: Pass 1 = boundary detection (JSON), Pass 2 = content extraction (markdown per document). Both via Gemini.
- **Cost estimate revised**: ~$37-40 for full backfill with 2.5 Flash batch API (up from $6-10 boundary-only with 2.0 Flash). User approved this cost.
- **Markdown for content, JSON for boundaries**: Markdown is ideal for section_text (RAG/search), JSON for structured metadata. No need for langextract or structured JSON for content.
- **PDFs over 50MB**: Split with PyMuPDF before sending to Gemini (File API choked on 54MB PDF). Most PDFs are under 40MB.

</decisions_made>

<blockers>
- Rate limit hit on plan-checker agent — need to retry verification in next session
- R2 bucket setup needed before Plan 02 can fully run (user_setup documented in plan)
- Gemini 2.5 Flash retirement unknown but 2.0 Flash retires March 31, 2026 — should complete backfill well before then
</blockers>

<context>
The session started with /gsd:plan-phase 7.1, ran through research → planning → testing → design change → replanning. The biggest insight was hands-on testing of Docling vs Gemini 2.5 Flash on real View Royal agenda PDFs, which clearly showed Gemini produces far superior output.

The test artifacts in /tmp/ are valuable references:
- /tmp/test_gemini25_flash.py — the working test script
- /tmp/gemini25_boundaries.json — 31 documents detected from Feb 2025 CoW meeting
- /tmp/gemini25_content_sample.md — staff report extraction (perfect tables, headings)
- /tmp/gemini25_toc_sample.md — agenda TOC extraction (perfect numbering, page refs)
- /tmp/gemini25_delegation_sample.md — presentation slide extraction
- /tmp/docling_output.md — Docling output for comparison (poor quality)

The RESEARCH.md still references Docling patterns but the CONTEXT.md is updated to reflect the Docling-dropped decision. The plans correctly use Gemini-only approach.
</context>

<next_action>
Resume with: /gsd:plan-phase 07.1 --skip-research
This will detect existing plans, run the plan-checker verification that was interrupted, and present the final status. If plans pass verification, proceed to /gsd:execute-phase 07.1.

Alternatively, since the plans are already written and look solid, could skip verification and go straight to /gsd:execute-phase 07.1.
</next_action>
