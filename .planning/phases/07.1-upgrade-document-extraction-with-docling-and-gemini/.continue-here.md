---
phase: 07.1-upgrade-document-extraction-with-docling-and-gemini
task: 2
total_tasks: 2
status: blocked
last_updated: 2026-02-18T16:24:13.729Z
---

<current_state>
Phase 07.1 Plan 03 (backfill + verification). Task 1 (CLI) done. Task 2 (human-verify gate) in progress.

First backfill run completed 711 meetings but 309 silently fell back to PyMuPDF chunker due to Gemini API rate limits (429 RESOURCE_EXHAUSTED). All Committee of the Whole meetings (198) plus ~111 other meetings got low-quality fallback sections instead of Gemini extraction.

This session: ran data quality audit, cleaned up DB, removed fallback codepath, prepped for re-run.
</current_state>

<completed_work>

**This session:**
- Data quality audit on extracted_documents + document_sections
- Removed 323 duplicate/empty extracted_documents (12,851 → 12,528)
- Removed 5,384 tiny noise sections (<50 chars: logos, bare headings)
- Truncated 294 oversized sections (up to 1.8M chars → max 20K)
- Wiped all legacy PyMuPDF fallback sections (18,744 rows → 0 legacy remaining)
- Removed fallback-to-chunker codepath from document_extractor.py (Gemini failures now raise instead of silently degrading)
- Removed 309 meeting IDs from backfill_progress.json so they'll be reprocessed
- Diagnosed root cause: Gemini quota exhaustion during concurrent backfill → silent fallback

**Previous sessions:**
- Plans 07.1-01 and 07.1-02 complete (schema + extractor + pipeline integration)
- Plan 07.1-03 Task 1 complete (backfill CLI with --extract-documents, --concurrency, --limit, --force)
- Batch API implementation complete but abandoned (switched to ThreadPoolExecutor concurrent sync)
- First backfill run: 711 meetings processed, 12,528 extracted docs, 40,805 sections (after cleanup)

</completed_work>

<remaining_work>

1. **Wait for Gemini API quota reset** — daily quota currently at 0 (limit: 0 on generate_requests_per_model_per_day)
2. **Re-run backfill for 309 meetings**: `cd apps/pipeline && uv run python main.py --extract-documents --concurrency 3`
3. **Generate embeddings** for all 40,805+ sections (none have embeddings yet): `uv run python main.py --embed-only`
4. **Complete Plan 03 human-verify checkpoint** — approve extraction quality
5. **Phase verification**

</remaining_work>

<decisions_made>

- Removed PyMuPDF fallback from document_extractor.py — Gemini failures now raise, caller marks as error in progress file
- Sections >100K chars truncated to ~8K (paragraph boundary) — these were massive markdown tables from Gemini
- Sections <50 chars deleted as noise (logos, bare headings, image placeholders)
- All legacy sections (extracted_document_id IS NULL) for failed meetings wiped — clean slate for re-extraction
- Concurrency 3 recommended for re-run (5 was too aggressive and contributed to rate limiting)

</decisions_made>

<blockers>
- Gemini API quota exhausted: 429 RESOURCE_EXHAUSTED, limit: 0 on daily requests. Need to wait for reset or check billing.
</blockers>

<context>
DB state after cleanup:
- extracted_documents: 12,528 (all Gemini-produced)
- document_sections: 40,805 (all with extracted_document_id, zero legacy)
- embeddings: 0 (not yet generated)
- 309 meetings in backfill queue (removed from progress file)
- 10 error meetings also cleared from progress file

The 309 failed meetings include ALL Committee of the Whole meetings (~198) which are the most substantive (staff reports, financial plans, OCP updates, bylaws). These are the biggest PDFs (10-18MB) and the most important content.

Key files modified this session:
- apps/pipeline/pipeline/ingestion/document_extractor.py — removed _fallback_to_chunker function, Gemini errors now raise
- apps/pipeline/backfill_progress.json — removed 309 meeting IDs + 10 errors
</context>

<next_action>
1. Check if Gemini quota has reset: run `cd apps/pipeline && uv run python -c "from pipeline.ingestion.gemini_extractor import detect_boundaries; print(detect_boundaries.__module__)"` or try a small extraction
2. If quota available: `cd apps/pipeline && uv run python main.py --extract-documents --concurrency 3`
3. After backfill: `uv run python main.py --embed-only` to generate embeddings for all sections
4. Then verify and close out Plan 03 + phase
</next_action>
