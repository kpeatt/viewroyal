# Phase 7.1: Upgrade Document Extraction with Docling and Gemini - Context

**Gathered:** 2026-02-17
**Status:** Ready for planning

<domain>
## Phase Boundary

Replace the current PyMuPDF font-analysis document extraction pipeline with a two-tool approach:
1. **Gemini 2.5 Flash** — boundary detection (document boundaries, agenda item linking, document type, key facts) AND content extraction (clean structured markdown per document)
2. **PyMuPDF** — extract meaningful images (maps, charts, diagrams, renderings — skip logos/signatures)

**Docling has been dropped.** Testing showed Docling produces poor quality output (mangled tables, floating page references, hollow slide extraction, spacing issues like "from7.5m"). Gemini 2.5 Flash tested dramatically better on the same PDFs — perfect agenda rendering, clean tables, proper heading hierarchy, meaningful image descriptions.

Process ALL 722 agenda PDFs (~65K pages, 15GB) from the local archive at `/viewroyal_archive/`. Delete and replace existing document_sections data with the new pipeline output.

</domain>

<decisions>
## Implementation Decisions

### Gemini 2.5 Flash — two-pass extraction
- **Pass 1 (boundary detection):** Send full agenda PDF, get structured JSON with document boundaries, agenda item linking, document type classification, key_facts
- Return structured JSON with: title, page_start, page_end, type (agenda/minutes/staff_report/delegation/correspondence/appendix/table/other), agenda_item mapping, summary, key_facts
- **Pass 2 (content extraction):** For each document boundary, ask Gemini to extract clean structured markdown for those pages
- Output: clean markdown with proper headings, tables, lists, image descriptions
- Model name configurable (default `gemini-2.5-flash`) for easy future upgrades
- Must handle PDFs over 50MB — split with PyMuPDF first, send chunks to Gemini
- File API for PDFs between 20-50MB, inline bytes for smaller PDFs
- Test script at `/tmp/test_gemini25_flash.py` — proven working on 222-page/39MB meeting PDF
- Test outputs at `/tmp/gemini25_boundaries.json`, `/tmp/gemini25_content_sample.md`, `/tmp/gemini25_toc_sample.md`
- Schema may evolve to better reflect the natural hierarchy: agenda package → individual documents → sections

### Docling — DROPPED
- Docling tested poorly: mangled tables, floating page references, `<!-- image -->` noise, spacing issues, inconsistent headings
- Gemini 2.5 Flash produces dramatically better output on the same PDFs
- Remove Docling dependency from pyproject.toml

### Image extraction
- PyMuPDF extracts all meaningful images: maps, site plans, charts, diagrams, architectural renderings
- Skip decorative graphics, logos, and signatures
- Store extracted images on **Cloudflare R2** for edge serving
- **Store only for now** — do NOT update the document viewer UI to display images (that's a future phase)
- Track image metadata: page, description (from Gemini), type classification, dimensions

### Migration & backfill strategy
- **Delete and replace** all existing document_sections data
- **Update the pipeline code** for new meetings AND run backfill for all existing meetings
- Process ALL 714 meetings with agenda PDFs from local archive (`/viewroyal_archive/`)
- Archive structure: `{meeting_type}/{year}/{month}/{meeting_name}/Agenda/*.pdf`
- **Resumable processing** — track which meetings have been processed so backfill can be interrupted and resumed
- Estimated Gemini cost: ~$37-40 for full backfill with 2.5 Flash batch API (boundaries + content extraction)

### Claude's Discretion
- PDF splitting strategy for PDFs over 50MB (PyMuPDF page-range split before sending to Gemini)
- Database schema design — whether to add a document-level table between `documents` (source files) and `document_sections`
- PyMuPDF font-analysis fallback strategy (keep as fallback or fully replace)
- Table storage approach (inline markdown vs separate structured storage)
- Which individual attachments beyond the main agenda PDF to process (if any)

</decisions>

<specifics>
## Specific Ideas

- Gemini 2.5 Flash test script at `/tmp/test_gemini25_flash.py` — proven working on 222-page meeting PDF
- Gemini 2.5 Flash boundary output at `/tmp/gemini25_boundaries.json` — found 31 documents with precise page ranges and agenda item links
- Gemini 2.5 Flash content outputs at `/tmp/gemini25_content_sample.md`, `/tmp/gemini25_toc_sample.md`, `/tmp/gemini25_delegation_sample.md`
- Gemini 2.5 Flash pricing: $0.30/1M input, $2.50/1M output (includes thinking tokens); batch API 50% off
- Boundary detection took 71s for 222 pages, content extraction 15-18s per document
- PDFs over ~50MB fail with File API — need PyMuPDF page-range splitting for those
- google-genai already a dependency (>=1.59.0)
- Current pipeline has 5 phases: scrape → download audio → diarize → AI refine + ingest → embed
- The 722-page PDF outlier suggests we need robust handling for very large agenda packages

</specifics>

<deferred>
## Deferred Ideas

- Display extracted images in the document viewer UI — future phase
- Positional/sequential matching for agenda item linking (Strategy 4 from Phase 7) — evaluate if Gemini makes this unnecessary
- Full-text search improvements using better-structured sections — Phase 8 (Unified Search)

</deferred>

---

*Phase: 07.1-upgrade-document-extraction-with-docling-and-gemini*
*Context gathered: 2026-02-17*
