# Phase 7.1: Upgrade Document Extraction with Docling and Gemini - Context

**Gathered:** 2026-02-17
**Status:** Ready for planning

<domain>
## Phase Boundary

Replace the current PyMuPDF font-analysis document extraction pipeline with a three-tool approach:
1. **Gemini 2.0 Flash** — batch-process agenda PDFs to identify document boundaries, agenda item linking, document type, and key facts
2. **Docling** — extract and structure content within Gemini-identified boundaries (headings, tables, text)
3. **PyMuPDF** — extract meaningful images (maps, charts, diagrams, renderings — skip logos/signatures)

Process ALL 722 agenda PDFs (~65K pages, 15GB) from the local archive at `/viewroyal_archive/`. Delete and replace existing document_sections data with the new pipeline output.

</domain>

<decisions>
## Implementation Decisions

### Gemini boundary detection
- Gemini's role is **metadata only**: document boundaries, agenda item linking, document type classification, and key_facts
- Gemini does NOT extract content — that's Docling's job
- Process the full agenda package PDF through Gemini to identify individual documents within it (staff reports, delegations, correspondence, etc.)
- Return structured JSON with: title, page_start, page_end, type (agenda/minutes/staff_report/delegation/correspondence/appendix/table/other), agenda_item mapping, summary, key_facts
- Must handle Gemini's document size limits for large PDFs (some are 200-700+ pages)
- Test scripts at `/tmp/gemini_test.py` and `/tmp/gemini_test_structured.py` — proven working with Gemini 2.0 Flash

### Docling content extraction
- Docling extracts structured markdown content within document boundaries identified by Gemini
- Replaces PyMuPDF dict-mode font analysis for heading detection and section splitting
- Tables rendered as markdown tables inline in section content
- Test script at `/tmp/test_docling.py` — proven working, 30 pages in 20.9s, clean structural hierarchy
- Schema may evolve to better reflect the natural hierarchy: agenda package → individual documents → sections

### Image extraction
- PyMuPDF extracts all meaningful images: maps, site plans, charts, diagrams, architectural renderings
- Skip decorative graphics, logos, and signatures
- Store extracted images on **Cloudflare R2** for edge serving
- **Store only for now** — do NOT update the document viewer UI to display images (that's a future phase)
- Track image metadata: page, description (from Gemini), type classification, dimensions

### Migration & backfill strategy
- **Delete and replace** all existing document_sections data
- **Update the pipeline code** for new meetings AND run backfill for all existing meetings
- Process ALL 714 meetings with agenda PDFs from local archive (`/viewroyal_archive/`)
- Archive structure: `{meeting_type}/{year}/{month}/{meeting_name}/Agenda/*.pdf`
- **Resumable processing** — track which meetings have been processed so backfill can be interrupted and resumed
- Estimated Gemini cost: ~$6-10 for full backfill of ~65K pages

### Claude's Discretion
- PDF splitting strategy for Gemini's size limit (chunking vs TOC-guided vs other)
- Agenda item linking approach (two-pass with TOC, or include agenda pages in every chunk)
- Database schema design — whether to add a document-level table between `documents` (source files) and `document_sections`
- PyMuPDF font-analysis fallback strategy (keep as fallback or fully replace)
- Table storage approach (inline markdown vs separate structured storage)
- Which individual attachments beyond the main agenda PDF to process (if any)

</decisions>

<specifics>
## Specific Ideas

- Test scripts from previous session are preserved at `/tmp/gemini_test.py`, `/tmp/gemini_test_structured.py`, `/tmp/test_docling.py`, `/tmp/gemini_test_pymupdf_compare.py`
- Gemini structured output example at `/tmp/gemini_structured_output.json` — shows excellent section-level extraction with key_facts
- Docling output example at `/tmp/docling_output.md` — shows clean heading hierarchy but some table formatting quirks
- Docling is already a dependency in `apps/pipeline/pyproject.toml` (>=2.73.1)
- google-genai already a dependency (>=1.59.0)
- Cost comparison from research: Gemini 2.0 Flash batch is cheapest option at ~$8.64 for 84K pages
- Current pipeline has 5 phases: scrape → download audio → diarize → AI refine + ingest → embed
- The 722-page PDF outlier suggests we need robust handling for very large agenda packages

</specifics>

<deferred>
## Deferred Ideas

- Display extracted images in the document viewer UI — future phase
- Positional/sequential matching for agenda item linking (Strategy 4 from Phase 7) — evaluate if Gemini makes this unnecessary
- Full-text search improvements using better-structured sections — Phase 8 (Unified Search)

</deferred>

---

*Phase: 07.1-upgrade-document-extraction-with-docling-and-gemini*
*Context gathered: 2026-02-17*
