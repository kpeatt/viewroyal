---
phase: 04-home-page-enhancements
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - apps/web/app/routes/home.tsx
  - apps/web/app/components/home/hero-section.tsx
  - apps/web/app/components/home/upcoming-meeting-section.tsx
  - apps/web/app/components/home/recent-meeting-section.tsx
  - apps/web/app/components/home/active-matters-section.tsx
  - apps/web/app/components/home/decisions-feed-section.tsx
autonomous: false
requirements:
  - HOME-01
  - HOME-02
  - HOME-03
  - HOME-04
  - HOME-05

must_haves:
  truths:
    - "Home page displays a search-style hero with Ask input, tagline, decorative map background, and account CTA for logged-out users only"
    - "Home page shows next upcoming meeting with type badge and agenda topic preview (or 'No meetings scheduled')"
    - "Home page shows most recent past meeting with AI summary, key decisions, motion/agenda/divided-vote stats, and link to full meeting"
    - "Home page shows 5-6 active matters as compact cards with title, category badge, last activity date, summary, and subscribe button for logged-in users"
    - "Home page shows 10-15 recent non-procedural motions with summary, result, vote breakdown text and visual dots, meeting link, divided vote highlight, and financial cost badge when available"
    - "Each section has a 'View all' link to the corresponding list page"
    - "Page is fully responsive — sections stack on mobile"
  artifacts:
    - path: "apps/web/app/routes/home.tsx"
      provides: "Rewritten home route with loader and five-section layout"
      contains: "HeroSection"
    - path: "apps/web/app/components/home/hero-section.tsx"
      provides: "Hero with Ask input, map bg, and auth-conditional CTA"
      contains: "ViewRoyalMap"
    - path: "apps/web/app/components/home/upcoming-meeting-section.tsx"
      provides: "Next upcoming meeting card with agenda preview"
      contains: "UpcomingMeetingSection"
    - path: "apps/web/app/components/home/recent-meeting-section.tsx"
      provides: "Featured recent meeting recap with summary and stats"
      contains: "RecentMeetingSection"
    - path: "apps/web/app/components/home/active-matters-section.tsx"
      provides: "Active matters cards with subscribe buttons"
      contains: "ActiveMattersSection"
    - path: "apps/web/app/components/home/decisions-feed-section.tsx"
      provides: "Decisions feed with vote visuals and financial cost badges"
      contains: "DecisionsFeedSection"
  key_links:
    - from: "apps/web/app/routes/home.tsx"
      to: "apps/web/app/services/site.ts"
      via: "loader calls getHomeData()"
      pattern: "getHomeData"
    - from: "apps/web/app/components/home/hero-section.tsx"
      to: "apps/web/app/components/ask-question.tsx"
      via: "imports AskQuestion"
      pattern: "AskQuestion"
    - from: "apps/web/app/components/home/hero-section.tsx"
      to: "apps/web/app/components/home/view-royal-map.tsx"
      via: "imports ViewRoyalMap for background"
      pattern: "ViewRoyalMap"
    - from: "apps/web/app/components/home/active-matters-section.tsx"
      to: "apps/web/app/components/subscribe-button.tsx"
      via: "imports SubscribeButton for each matter card"
      pattern: "SubscribeButton"
    - from: "apps/web/app/routes/home.tsx"
      to: "useRouteLoaderData('root')"
      via: "accesses user auth state for conditional CTA and subscribe buttons"
      pattern: "useRouteLoaderData"
---

<objective>
Build all five home page section components and completely rewrite the home route to deliver the new layout: Hero, Upcoming Meeting, Recent Meeting, Active Matters, and Recent Decisions.

Purpose: Replace the current two-column home page (meetings + council sidebar + public notices) with a focused, single-column, information-dense layout that surfaces council activity. Each section answers a different question: "What can I ask?" (Hero), "What's coming up?" (Upcoming), "What just happened?" (Recent Meeting), "What's being discussed?" (Active Matters), "What was decided?" (Decisions Feed).

Output: Five new section components in `components/home/` and a completely rewritten `routes/home.tsx`.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-home-page-enhancements/04-RESEARCH.md
@.planning/phases/04-home-page-enhancements/04-01-SUMMARY.md

@apps/web/app/routes/home.tsx
@apps/web/app/services/site.ts
@apps/web/app/components/ask-question.tsx
@apps/web/app/components/subscribe-button.tsx
@apps/web/app/components/meeting/meeting-list-row.tsx
@apps/web/app/components/ui/badge.tsx
@apps/web/app/components/ui/card.tsx
@apps/web/app/components/home/view-royal-map.tsx
@apps/web/app/lib/types.ts
@apps/web/app/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create five section components for the home page</name>
  <files>
    apps/web/app/components/home/hero-section.tsx
    apps/web/app/components/home/upcoming-meeting-section.tsx
    apps/web/app/components/home/recent-meeting-section.tsx
    apps/web/app/components/home/active-matters-section.tsx
    apps/web/app/components/home/decisions-feed-section.tsx
  </files>
  <action>
Create five new component files in `apps/web/app/components/home/`. Each is a standalone section that receives data as props from the home route loader.

**1. HeroSection (`hero-section.tsx`)**
Props: `{ shortName: string; user: any }`
- Blue gradient background (`from-blue-600 to-blue-700`) with white text
- `ViewRoyalMap` component as absolute-positioned background with very low opacity (`opacity-[0.07]`), `pointer-events-none`
- Centered heading: "What's happening in {shortName}?"
- Subtitle: "Explore council meetings, decisions, and debates. Get instant answers analyzed from official records and transcripts."
- Reuse existing `AskQuestion` component with `title=""` (headerless mode), custom placeholder, and white bg styling
- Account CTA below Ask input: "Create an account to track what matters to you" as a `Link` to `/signup` — ONLY rendered when `!user` (logged-out)
- Responsive: reduce vertical padding on mobile

**2. UpcomingMeetingSection (`upcoming-meeting-section.tsx`)**
Props: `{ meeting: { id, title, meeting_date, type, has_agenda, agendaPreview: string[], organizations } | null }`
- Section header with Calendar icon + "Upcoming Meeting" + "View all" link to `/meetings`
- If `meeting` is null: show "No meetings scheduled" message in a subtle card
- If meeting exists: card with meeting type Badge, title, formatted date, and agenda preview
  - Agenda preview: list of 3-4 topic titles (from `agendaPreview` array)
  - If `!meeting.has_agenda` or `agendaPreview.length === 0`: show "Agenda not yet available" note
  - Link to full meeting: `/meetings/{id}`

**3. RecentMeetingSection (`recent-meeting-section.tsx`)**
Props: `{ meeting: any; stats: { agendaItems, totalMotions, motionsPassed, dividedVotes, duration }; decisions: Array<{ id, summary, result }> }`
- Section header with PlayCircle icon + "Latest Meeting"
- Entire card is a `Link` to `/meetings/{meeting.id}` with hover effect
- Content layout (reuse much of the current latest meeting design but enhanced):
  - Meeting type Badge + title + formatted date + duration
  - AI summary paragraph (`meeting.summary`)
  - Key decisions list (3-4 items with CheckCircle2/XCircle icons based on result)
  - Stats row: Agenda Items count, Motions Passed (X/Y), Divided Votes count
  - CTA: "View Full Meeting Details" with ArrowRight icon
- If `meeting` is null: don't render the section

**4. ActiveMattersSection (`active-matters-section.tsx`)**
Props: `{ matters: Array<{ id, title, category, first_seen, last_seen, summary }> }`
- Section header with Gavel icon + "Active Matters" + "View all" link to `/matters`
- Grid of compact matter cards (single column on mobile, 2 columns on md+)
- Each card is a `Link` to `/matters/{matter.id}`:
  - Category Badge (use appropriate variant/color per category)
  - Title (bold, line-clamp-2)
  - Last activity date using `formatDate(matter.last_seen)`
  - 1-line summary (line-clamp-1 from `matter.summary`)
  - Duration indicator: if `first_seen !== last_seen`, show "Since {formatDate(first_seen)}"; if same, show "New"
  - Inline `SubscribeButton` with `type="matter"`, `targetId={matter.id}`, `compact` prop — this uses `useRouteLoaderData("root")` internally to check auth, so it handles logged-out state automatically
- If matters array is empty: show "No active matters" message

**5. DecisionsFeedSection (`decisions-feed-section.tsx`)**
Props: `{ decisions: Array<{ id, summary, result, financialCost, meetingId, meetingDate, meetingTitle, yesCount, noCount, isDivided }> }`
- Section header with Scale icon + "Recent Decisions" + "View all" link to `/meetings`
- List of compact decision rows, each linking to `/meetings/{decision.meetingId}`
- Each row contains:
  - Plain English summary (line-clamp-2)
  - Result badge: "Carried" (green) or "Defeated" (red) using Badge component
  - Vote breakdown text: "{yesCount}-{noCount}"
  - Vote visual indicator: colored dots — green dot per Yes vote, red dot per No vote. Use small circles (`w-2 h-2 rounded-full`). Green = `bg-green-500`, Red = `bg-red-500`.
  - If `isDivided`: highlight with left accent border (`border-l-2 border-amber-400`) and/or a small "Divided" Badge (amber variant)
  - If `financialCost > 0`: show financial cost as a Badge/tag (e.g., "$X,XXX" formatted with locale string)
  - Meeting date + title (small, muted text) as context
- If decisions array is empty: show "No recent decisions" message

**Shared patterns across all components:**
- Use `cn()` from `~/lib/utils` for className composition
- Use `formatDate()` from `~/lib/utils` for date formatting
- Use `Badge` from `~/components/ui/badge` for category/type/result badges
- Use lucide-react icons consistently
- Follow existing naming conventions: named function exports, PascalCase components
- All section containers use `bg-white rounded-2xl border border-zinc-200 shadow-sm` card styling (matches current design system)
- Section headers use `text-sm font-black uppercase tracking-widest text-zinc-400` pattern (matches current home page)
  </action>
  <verify>All five component files exist in `apps/web/app/components/home/`. Each exports a named function component. Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` — no new type errors.</verify>
  <done>Five section components exist: HeroSection (with Ask + map + CTA), UpcomingMeetingSection (with agenda preview), RecentMeetingSection (with summary + stats + key decisions), ActiveMattersSection (with subscribe buttons), DecisionsFeedSection (with vote dots + divided highlight + financial cost). All follow established design patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite home route with new layout and loader</name>
  <files>apps/web/app/routes/home.tsx</files>
  <action>
Completely rewrite `apps/web/app/routes/home.tsx` to use the new data from `getHomeData()` and the five section components.

**Loader:**
- Keep the existing loader structure (createSupabaseServerClient, getMunicipality, getHomeData)
- Update the destructured return to match the new getHomeData() shape:
  ```typescript
  return {
    upcomingMeeting,
    recentMeeting,
    recentMeetingStats,
    recentMeetingDecisions,
    activeMatters,
    recentDecisions,
    municipality,
  };
  ```

**Component:**
- Get user from root loader: `const rootData = useRouteLoaderData("root") as { user: any } | undefined; const user = rootData?.user;`
- Extract `shortName` from municipality
- Render sections in locked order (top to bottom):
  1. `<HeroSection shortName={shortName} user={user} />`
  2. Container div (`container mx-auto py-12 px-4 max-w-6xl space-y-12`):
     - `<UpcomingMeetingSection meeting={upcomingMeeting} />`
     - `<RecentMeetingSection meeting={recentMeeting} stats={recentMeetingStats} decisions={recentMeetingDecisions} />`
     - `<ActiveMattersSection matters={activeMatters} />`
     - `<DecisionsFeedSection decisions={recentDecisions} />`

**Remove:**
- All old component JSX (council members grid, public notices, two-column layout, old meeting list)
- Imports no longer needed (Users, Bell, etc. — unless still used by new sections)
- Old destructured loaderData fields (councilMembers, publicNotices, recentMeetings, etc.)

**Keep:**
- The `loader` export function signature
- The `export default function Home` pattern
- Error handling in loader (try/catch with Response throw)

**Responsive design:**
- Page background: `min-h-screen bg-zinc-50`
- Hero is full-width (extends beyond container)
- Content sections are within a centered container with max-w-6xl
- On mobile, all sections stack vertically with consistent spacing (space-y-12)
- No multi-column layout needed — the new design is single-column by decision
  </action>
  <verify>Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` — passes. Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm build` — builds successfully for Cloudflare Workers.</verify>
  <done>Home route is completely rewritten with the five-section layout. Loader returns new data shape. Page renders: Hero (Ask + map + CTA) -> Upcoming Meeting -> Recent Meeting -> Active Matters -> Recent Decisions. Old council members grid, public notices, and two-column layout are removed. Build succeeds.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete home page redesign</name>
  <files>apps/web/app/routes/home.tsx</files>
  <action>
Human verification checkpoint. What was built:

Complete home page redesign with five sections: Hero (Ask input + decorative map + account CTA), Upcoming Meeting (with agenda preview), Recent Meeting (with AI summary + stats + key decisions), Active Matters (with subscribe buttons), and Recent Decisions (with vote breakdown dots + divided vote highlights + financial cost badges).

How to verify:
1. Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm dev` to start the dev server
2. Visit http://localhost:5173/ in your browser
3. Verify the five sections render in order: Hero -> Upcoming Meeting -> Recent Meeting -> Active Matters -> Recent Decisions
4. Check Hero section: Ask input is prominent and centered. Decorative map outline is faintly visible behind the blue gradient. If logged out: "Create an account" CTA appears below Ask input. If logged in: CTA is hidden.
5. Check Upcoming Meeting section: Shows the next scheduled meeting (or "No meetings scheduled" if none). Meeting type badge is displayed. Agenda topics show if available.
6. Check Recent Meeting section: Shows AI summary paragraph. Key decisions are listed with carried/defeated icons. Stats show agenda items, motions passed, divided votes. Card links to the full meeting page.
7. Check Active Matters section: 5-6 matter cards with category badges, dates, summaries. Subscribe buttons appear (if logged in). Cards link to matter detail pages.
8. Check Decisions Feed section: 10-15 rows with motion summaries and result badges. Vote breakdown shown as both "X-Y" text and colored dots. Divided votes have visual highlight (amber accent). Financial cost badge shown where applicable.
9. Resize browser to mobile width — all sections should stack cleanly.
10. Click through several links to verify they navigate correctly.
  </action>
  <verify>User visually confirms all five sections render correctly with real data.</verify>
  <done>User types "approved" or describes issues that need fixing.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes in `apps/web/`
2. `pnpm build` succeeds in `apps/web/`
3. Home page loads in dev server without errors
4. All five sections render with real data from Supabase
5. Vote breakdown uses individual vote records (dots should show actual vote counts, not all zeros)
6. Matter summaries display (not empty/null)
7. Responsive layout works on mobile
8. Account CTA only shows for logged-out users
9. Subscribe buttons appear on matter cards for logged-in users
10. All "View all" links navigate to correct list pages
</verification>

<success_criteria>
- Home page has been completely redesigned with all five sections rendering real data
- Hero section has Ask input, decorative map background, and auth-conditional CTA
- Upcoming meeting shows agenda preview or graceful fallback
- Recent meeting shows AI summary, key decisions, and comprehensive stats including divided vote count
- Active matters show category badge, date, summary from agenda_items, and subscribe button
- Decisions feed shows vote breakdown (dots + text), divided vote highlighting, and financial cost when available
- Page is responsive across all breakpoints
- Build succeeds for Cloudflare Workers deployment
</success_criteria>

<output>
After completion, create `.planning/phases/04-home-page-enhancements/04-02-SUMMARY.md`
</output>
