---
phase: 06-gap-closure-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/services/site.ts
  - apps/web/app/services/subscriptions.ts
  - apps/web/app/routes/api.subscribe.tsx
  - apps/web/app/routes/api.geocode.tsx
  - apps/web/app/routes/settings.tsx
  - apps/web/app/routes/signup.tsx
  - apps/web/app/routes/home.tsx
autonomous: true
requirements: [HOME-01, HOME-02]

must_haves:
  truths:
    - "Home page shows 6 active matters (not 5)"
    - "Decisions feed shows 10+ motions by default (already correct, verified no regression)"
    - "GET /api/subscribe?type=neighborhood&neighborhood=X returns correct subscription status"
    - "No orphaned addKeywordSubscription export exists in subscriptions.ts"
    - "Signup redirectTo defaults to /onboarding (no double-redirect through /settings)"
    - "Settings page exposes digest frequency dropdown (each_meeting or weekly)"
    - "api.geocode.tsx uses bounded=0 matching pipeline behavior"
    - "home.tsx municipality redundancy is documented or eliminated"
  artifacts:
    - path: "apps/web/app/services/site.ts"
      provides: "Active matters query with limit(6)"
      contains: ".limit(6)"
    - path: "apps/web/app/services/subscriptions.ts"
      provides: "Neighborhood-aware checkSubscription, no addKeywordSubscription"
    - path: "apps/web/app/routes/api.subscribe.tsx"
      provides: "GET handler supporting neighborhood type"
    - path: "apps/web/app/routes/api.geocode.tsx"
      provides: "bounded=0 parameter"
      contains: "bounded=0"
    - path: "apps/web/app/routes/settings.tsx"
      provides: "Digest frequency select element"
      contains: "digest_frequency"
    - path: "apps/web/app/routes/signup.tsx"
      provides: "Default redirectTo of /onboarding"
      contains: "/onboarding"
  key_links:
    - from: "apps/web/app/routes/api.subscribe.tsx"
      to: "apps/web/app/services/subscriptions.ts"
      via: "checkSubscription with optional neighborhoodName parameter"
      pattern: "checkSubscription.*neighborhood"
    - from: "apps/web/app/routes/settings.tsx"
      to: "apps/web/app/services/subscriptions.ts"
      via: "upsertUserProfile with digest_frequency from form"
      pattern: "digest_frequency.*formData"
---

<objective>
Close all 8 audit gaps identified in v1-MILESTONE-AUDIT.md. These are small, targeted fixes across 7 existing files: adjust numeric limits, fix neighborhood subscription lookup, remove dead code, fix signup redirect default, add digest frequency selector, and correct geocoding parameter.

Purpose: Satisfy HOME-01 and HOME-02 requirement counts, fix integration bugs in subscription checking and geocoding, remove dead code, and polish UX for settings and signup flows.
Output: 7 modified files, all audit success criteria met.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-gap-closure-cleanup/06-RESEARCH.md

@apps/web/app/services/site.ts
@apps/web/app/services/subscriptions.ts
@apps/web/app/routes/api.subscribe.tsx
@apps/web/app/routes/api.geocode.tsx
@apps/web/app/routes/settings.tsx
@apps/web/app/routes/signup.tsx
@apps/web/app/routes/home.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix service layer and API route bugs</name>
  <files>
    apps/web/app/services/site.ts
    apps/web/app/services/subscriptions.ts
    apps/web/app/routes/api.subscribe.tsx
    apps/web/app/routes/api.geocode.tsx
  </files>
  <action>
    **Fix 1 — Active matters limit (site.ts):**
    - Line 118: Change comment from "(5, ordered by last_seen)" to "(6, ordered by last_seen)"
    - Line 125: Change `.limit(5)` to `.limit(6)`

    **Fix 2 — Decisions feed (NO CHANGE NEEDED):**
    - Verify `decisions-feed-section.tsx` line 31 still has `.slice(0, 10)` — already correct from commit ffe1f4e5. Do NOT modify.

    **Fix 3 — Neighborhood subscription check (subscriptions.ts):**
    - Modify `checkSubscription` function signature to add optional `neighborhoodName?: string` parameter.
    - Add a `neighborhood` branch at the top of the function: if `type === "neighborhood"`, query subscriptions where `user_id`, `type`, and `is_active` match, and if `neighborhoodName` is provided, also filter by `.eq("neighborhood", neighborhoodName)`. Use `.maybeSingle()`. Return the result.
    - The existing numeric column lookup (matter_id, person_id, topic_id) and the `if (!column) return null` guard remain unchanged for non-neighborhood types.
    - Make `targetId` parameter optional (change from `targetId: number` to `targetId?: number`).

    **Fix 4 — Remove orphaned addKeywordSubscription (subscriptions.ts):**
    - Delete the entire `addKeywordSubscription` function (lines ~121-165, the exported function that is never imported anywhere). The `addSubscription` function already handles keyword subscriptions via the keyword + keyword_embedding fields in the target parameter.
    - Keep the JSDoc comment above it only if it contains useful context not covered by addSubscription's own docs. Otherwise delete entirely.

    **Fix 5 — api.subscribe GET handler (api.subscribe.tsx):**
    - In the GET handler (around lines 41-47), add support for neighborhood type:
      - Parse `neighborhood` from query params: `const neighborhood = url.searchParams.get("neighborhood") || undefined;`
      - Change the validation from `if (!type || !targetId)` to `if (!type || (!targetId && type !== "neighborhood" && type !== "digest"))` so neighborhood/digest types don't require target_id.
      - Make targetId conditional: `const targetId = url.searchParams.get("target_id") ? Number(url.searchParams.get("target_id")) : undefined;`
      - Pass `neighborhood` to `checkSubscription`: `checkSubscription(supabase, user.id, type, targetId, neighborhood)`

    **Fix 6 — Geocode bounded parameter (api.geocode.tsx):**
    - Line 36: Change `bounded=1` to `bounded=0` in the Nominatim URL string. This matches the pipeline behavior at `apps/pipeline/pipeline/ingestion/ingester.py` line 572 where `"bounded": 0` prefers but does not restrict results to the viewbox.
  </action>
  <verify>
    - `pnpm typecheck` in apps/web/ passes (no type errors from signature changes)
    - `grep -n "limit(5)" apps/web/app/services/site.ts` returns no results (only limit(6) for active matters)
    - `grep -n "addKeywordSubscription" apps/web/app/services/subscriptions.ts` returns no results
    - `grep -n "bounded=1" apps/web/app/routes/api.geocode.tsx` returns no results
    - `grep -n "bounded=0" apps/web/app/routes/api.geocode.tsx` returns 1 result
  </verify>
  <done>
    Active matters query fetches 6 items. checkSubscription handles neighborhood type with string-based lookup. Dead addKeywordSubscription function removed. api.subscribe GET handler accepts neighborhood query param. Geocode uses bounded=0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix UI routes and polish UX</name>
  <files>
    apps/web/app/routes/settings.tsx
    apps/web/app/routes/signup.tsx
    apps/web/app/routes/home.tsx
  </files>
  <action>
    **Fix 7 — Digest frequency selector (settings.tsx):**
    - In the action handler (line 84), replace hardcoded `digest_frequency: "each_meeting"` with `digest_frequency: (formData.get("digest_frequency") as string) || "each_meeting"`. This reads the user's selection from the form while keeping "each_meeting" as the safe default.
    - In the Meeting Digest section of the form (after the digest_enabled checkbox around line 687), add a digest frequency `<select>` element:
      ```
      <div className="ml-7 mt-2 space-y-1">
        <label className="text-sm font-medium text-zinc-700">
          Digest Frequency
        </label>
        <select
          name="digest_frequency"
          defaultValue={profile?.digest_frequency || "each_meeting"}
          className="w-full rounded-md border border-zinc-200 bg-white px-3 py-2 text-sm"
        >
          <option value="each_meeting">After each meeting</option>
          <option value="weekly">Weekly summary</option>
        </select>
        <p className="text-xs text-zinc-400">
          Choose how often you receive digest emails.
        </p>
      </div>
      ```
    - Place this new `<div>` just after the `<p>` description text (line 691) and before the closing `</div>` of the digest section (line 692).

    **Fix 8 — Signup redirectTo default (signup.tsx):**
    - Line 14: Change `const redirectTo = url.searchParams.get("redirectTo") || "/settings";` to `const redirectTo = url.searchParams.get("redirectTo") || "/onboarding";`
    - This prevents the double-redirect where users sign up -> /settings -> onboarding gate -> /onboarding. Going directly to /onboarding is safe because root.tsx already excludes /onboarding from the redirect guard.

    **Fix 9 — Home loader municipality optimization (home.tsx):**
    - The `getMunicipality` call in the home loader is redundant with the root loader, BUT the home loader needs `municipality.rss_url` at server time for `getPublicNotices()`. React Router 7 SSR on Cloudflare Workers does not support accessing parent loader data from child loaders on the server side.
    - Add a comment above line 16 explaining WHY this isn't using root loader data:
      ```
      // getMunicipality call is intentionally duplicated from root loader.
      // The home loader needs rss_url at server time for getPublicNotices(),
      // and React Router 7 child loaders cannot access parent loader data on the server.
      ```
    - This documents the trade-off per research recommendation (the overhead of one extra `SELECT ... WHERE slug = 'view-royal'` is negligible).
  </action>
  <verify>
    - `pnpm typecheck` in apps/web/ passes
    - `grep -n "/settings" apps/web/app/routes/signup.tsx` returns no results for the redirectTo default
    - `grep -n "/onboarding" apps/web/app/routes/signup.tsx` returns the redirectTo default
    - `grep -n "digest_frequency.*formData" apps/web/app/routes/settings.tsx` returns 1 result
    - `grep -n "select.*digest_frequency" apps/web/app/routes/settings.tsx` returns 1 result (the select element)
    - `grep -n "intentionally duplicated" apps/web/app/routes/home.tsx` returns 1 result (the documentation comment)
  </verify>
  <done>
    Settings page has a working digest frequency selector that reads from form data. Signup redirects to /onboarding by default. Home loader municipality call is documented as intentional server-side requirement.
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` in apps/web/ — must pass with no new errors
2. Run `pnpm build` in apps/web/ — must build successfully for Cloudflare Workers
3. Verify all 8 success criteria from ROADMAP Phase 6:
   - SC1: `grep "limit(6)" apps/web/app/services/site.ts` shows active matters fetches 6
   - SC2: `grep "slice(0, 10)" apps/web/app/components/home/decisions-feed-section.tsx` confirms 10+ (no change needed)
   - SC3: checkSubscription has neighborhood branch + api.subscribe GET accepts neighborhood param
   - SC4: `grep "addKeywordSubscription" apps/web/app/services/subscriptions.ts` returns empty
   - SC5: home.tsx has comment explaining intentional getMunicipality duplication
   - SC6: `grep "redirectTo.*onboarding" apps/web/app/routes/signup.tsx` confirms new default
   - SC7: settings.tsx has `<select name="digest_frequency">` element + formData reader in action
   - SC8: `grep "bounded=0" apps/web/app/routes/api.geocode.tsx` confirms parameter fix
</verification>

<success_criteria>
All 8 Phase 6 audit gaps are closed:
- Active matters shows 6 items (HOME-01 satisfied)
- Decisions feed shows 10+ items (HOME-02 already satisfied, verified no regression)
- Neighborhood subscription check returns correct status
- No orphaned exports in subscriptions.ts
- Home municipality query documented as intentional
- Signup redirects to /onboarding by default
- Digest frequency is user-selectable
- Geocode bounded matches pipeline behavior
- `pnpm typecheck` and `pnpm build` both pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-gap-closure-cleanup/06-01-SUMMARY.md`
</output>
