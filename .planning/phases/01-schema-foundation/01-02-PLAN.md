---
phase: 01-schema-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - apps/pipeline/pipeline/ingestion/ai_refiner.py
  - apps/pipeline/pipeline/ingestion/ingester.py
autonomous: true
requirements:
  - KS-01
  - KS-02

must_haves:
  truths:
    - "KeyStatement model has nullable speaker field (str | None)"
    - "Extraction prompt limits key statements to 6 per agenda item"
    - "Extraction prompt requires unique timestamps per statement"
    - "Speaker attribution rule prohibits combining names"
    - "Key statements are ingested to the key_statements table with person_id resolution"
    - "Re-ingestion deletes existing key_statements for the meeting before inserting new ones"
  artifacts:
    - path: "apps/pipeline/pipeline/ingestion/ai_refiner.py"
      provides: "Improved KeyStatement model and extraction prompt"
      contains: "speaker: str | None"
    - path: "apps/pipeline/pipeline/ingestion/ingester.py"
      provides: "Key statement ingestion with deduplication"
      contains: "key_statements"
  key_links:
    - from: "apps/pipeline/pipeline/ingestion/ai_refiner.py"
      to: "apps/pipeline/pipeline/ingestion/ingester.py"
      via: "KeyStatement model used in AgendaItemRecord.key_statements"
      pattern: "key_statements.*KeyStatement"
    - from: "apps/pipeline/pipeline/ingestion/ingester.py"
      to: "key_statements table"
      via: "supabase.table('key_statements').insert"
      pattern: "key_statements.*insert"
---

<objective>
Merge PR #37 (fix/key-statement-prompts) on top of PR #35, resolving conflicts in ai_refiner.py and ingester.py by taking PR #37's improved versions of the overlapping sections.

Purpose: Land improved key statement extraction with nullable speaker, max 6 statements per item, unique timestamps, and stricter speaker attribution rules. These improvements produce higher-quality data for semantic search.

Output: PR #37 merged to main. Key statement extraction uses the refined prompt with better quality controls.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-schema-foundation/01-RESEARCH.md
@.planning/phases/01-schema-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge PR #37 with conflict resolution</name>
  <files>
    apps/pipeline/pipeline/ingestion/ai_refiner.py
    apps/pipeline/pipeline/ingestion/ingester.py
  </files>
  <action>
    Merge the `fix/key-statement-prompts` branch into main. This WILL produce merge conflicts in two files because both PR #35 (already merged) and PR #37 modify the same sections of `ai_refiner.py` and `ingester.py`.

    Run: `git merge fix/key-statement-prompts --no-edit`

    This will fail with conflicts. Resolve them as follows:

    **`ai_refiner.py` conflict resolution:**
    PR #35 added a `KeyStatement` model with `speaker: str` (required). PR #37 adds a `KeyStatement` model with `speaker: str | None` (nullable) and better Field descriptions. **Take PR #37's version** of the `KeyStatement` class:
    ```python
    class KeyStatement(BaseModel):
        statement_text: str = Field(description="The substantive statement, paraphrased for clarity")
        speaker: str | None = Field(None, description="The person who made the statement. Must be exactly ONE person — never combine names. null only if from correspondence or truly unclear.")
        statement_type: str = Field(description="One of: claim, proposal, objection, recommendation, financial, public_input")
        context: str | None = Field(None, description="Brief context for the statement (e.g. 'During debate on rezoning')")
        timestamp: float | None = Field(None, description="Approximate start time in seconds")
    ```

    For `AgendaItemRecord`, PR #35 uses `key_statements: list[KeyStatement] = Field(default_factory=list, ...)`, PR #37 uses `key_statements: list[KeyStatement] = []`. **Take PR #37's version** (simpler, works the same since Pydantic handles it).

    For the prompt section 7 (Key Statements), **take PR #37's version** which adds:
    - "Extract at most **6 key statements** per item"
    - "Each statement must be attributed to exactly ONE speaker. NEVER combine names"
    - "Each statement MUST have a DIFFERENT `timestamp`"

    **`ingester.py` conflict resolution:**
    Both PRs add key_statements deletion on re-ingest and key_statements insertion. **Take PR #37's version** which is functionally identical but was written with the full context of the improved model.

    After resolving, `git add` the resolved files and `git commit --no-edit` to complete the merge.

    IMPORTANT: The PR also includes `.planning/` file changes (7 codebase docs). These changes predate our current planning docs and will conflict. For any `.planning/` conflicts, **keep the current main versions** (ours). Run `git checkout --ours .planning/` to discard the PR's planning changes, then `git add .planning/`.
  </action>
  <verify>
    1. `git log --oneline -3` shows the merge commit
    2. `grep -A2 "speaker:" apps/pipeline/pipeline/ingestion/ai_refiner.py | head -3` shows `str | None` with the nullable Field description
    3. `grep "at most" apps/pipeline/pipeline/ingestion/ai_refiner.py` shows "6 key statements" limit
    4. `grep "DIFFERENT" apps/pipeline/pipeline/ingestion/ai_refiner.py` shows unique timestamp requirement
    5. `grep "NEVER combine" apps/pipeline/pipeline/ingestion/ai_refiner.py` shows speaker attribution rule
    6. `grep "key_statements" apps/pipeline/pipeline/ingestion/ingester.py` shows insertion logic
    7. No conflict markers remain: `grep -rn "<<<<<<" apps/pipeline/` returns nothing
    8. `.planning/` files unchanged from pre-merge state
  </verify>
  <done>
    PR #37 merged to main. KeyStatement model uses nullable speaker (str | None). Prompt enforces max 6 statements, unique timestamps, and single-speaker attribution. Key statement ingestion with deduplication on re-ingest is in place. No merge conflict markers remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate complete phase and run typecheck</name>
  <files></files>
  <action>
    Run end-to-end validation that the full Phase 1 deliverable is working:

    1. **Web app typecheck**: `cd apps/web && pnpm typecheck`
       This runs React Router typegen + tsc. It validates that:
       - TranscriptSegment type no longer has corrected_text_content
       - All component props align with the updated types
       - KeyStatementMatch type is properly exported and used
       - Note: pre-existing type error in voice-fingerprints.tsx line 404 should be ignored

    2. **Verify no broken references remain**:
       - `grep -rn "corrected_text_content" apps/web/ apps/pipeline/` — should be zero
       - `grep -rn "match_transcript_segments" apps/web/` — should be zero (only in vectorSearch.ts deprecation comment at most)
       - `grep -rn "EMBEDDING_DIMENSIONS = 768" apps/` — should be zero
       - `grep -rn "embedding_hv" apps/pipeline/` — should be zero (cleaned up in Plan 01)

    3. **Verify critical code paths**:
       - `grep -n "EMBEDDING_DIMENSIONS = 384" apps/web/app/lib/embeddings.server.ts apps/pipeline/pipeline/ingestion/embed.py` — both show 384
       - `grep -n "match_key_statements" apps/web/app/services/rag.server.ts` — RPC call exists
       - `grep -n "textSearch.*text_search" apps/web/app/services/rag.server.ts` — tsvector FTS exists
       - `grep -n "speaker.*str.*None" apps/pipeline/pipeline/ingestion/ai_refiner.py` — nullable speaker

    If typecheck fails (other than the known voice-fingerprints.tsx error), fix any issues introduced by the merge.
  </action>
  <verify>
    1. `cd apps/web && pnpm typecheck` exits 0 (or only fails on voice-fingerprints.tsx:404 known issue)
    2. All grep checks from the action section pass
    3. `git status` shows clean working tree
  </verify>
  <done>
    Web app typechecks pass. No broken references to removed columns/RPCs/dimensions anywhere in the codebase. Both PRs #35 and #37 are merged to main. Phase 1 requirements SCHEMA-01 through SCHEMA-04, KS-01, KS-02 are all satisfied.
  </done>
</task>

</tasks>

<verification>
1. `git log --oneline -5` shows both PR merge commits on main
2. `pnpm typecheck` in apps/web passes (ignoring known voice-fingerprints error)
3. `grep -rn "corrected_text_content" apps/` — zero results
4. `grep -rn "EMBEDDING_DIMENSIONS = 768" apps/` — zero results
5. `grep "speaker.*None" apps/pipeline/pipeline/ingestion/ai_refiner.py` — nullable speaker confirmed
6. `grep "at most.*6" apps/pipeline/pipeline/ingestion/ai_refiner.py` — max 6 statements confirmed
7. Both PR branches are ancestors of main: `git merge-base --is-ancestor phase3c/embedding-migration main` and `git merge-base --is-ancestor fix/key-statement-prompts main`
</verification>

<success_criteria>
- PR #37 merged to main with conflicts resolved correctly (PR #37's versions taken for all overlapping sections)
- KeyStatement.speaker is `str | None` (nullable)
- Prompt limits to 6 key statements per item
- Prompt requires unique timestamps
- Prompt forbids combining speaker names
- Web app typechecks pass
- No broken references remain in the entire codebase
- Both PRs #35 and #37 are merged ancestors of main
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-foundation/01-02-SUMMARY.md`
</output>
