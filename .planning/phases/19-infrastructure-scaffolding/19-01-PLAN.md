---
phase: 19-infrastructure-scaffolding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pnpm-workspace.yaml
  - package.json
  - .npmrc
autonomous: true
requirements:
  - MONO-01
  - MONO-02

must_haves:
  truths:
    - "pnpm install from monorepo root resolves all workspace members (apps/web, apps/docs, apps/vimeo-proxy)"
    - "apps/web builds successfully with pnpm run build from its directory after workspace migration"
    - "apps/vimeo-proxy builds successfully (tsc compiles) after workspace migration"
    - "No lock files remain in individual app directories (apps/web/pnpm-lock.yaml, apps/vimeo-proxy/pnpm-lock.yaml deleted)"
  artifacts:
    - path: "pnpm-workspace.yaml"
      provides: "Workspace definition with apps/web, apps/docs, apps/vimeo-proxy"
      contains: "packages:"
    - path: "package.json"
      provides: "Root package.json with workspace convenience scripts"
      contains: "viewroyal"
    - path: "pnpm-lock.yaml"
      provides: "Single consolidated lock file at monorepo root"
  key_links:
    - from: "pnpm-workspace.yaml"
      to: "apps/web/package.json"
      via: "packages glob pattern"
      pattern: "apps/web"
    - from: "pnpm-workspace.yaml"
      to: "apps/vimeo-proxy/package.json"
      via: "packages glob pattern"
      pattern: "apps/vimeo-proxy"
---

<objective>
Migrate the existing project to a pnpm workspace monorepo with a single root lock file, and verify that all existing apps continue to build correctly.

Purpose: Establish the monorepo infrastructure that all subsequent phases (fumadocs scaffold, deployment) depend on. Without a working workspace, apps/docs cannot be added as a workspace member.

Output: Root pnpm-workspace.yaml, root package.json, consolidated pnpm-lock.yaml, verified existing app builds.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-infrastructure-scaffolding/19-RESEARCH.md
@apps/web/package.json
@apps/web/vite.config.ts
@apps/vimeo-proxy/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pnpm workspace configuration and root package.json</name>
  <files>
    pnpm-workspace.yaml
    package.json
    .npmrc
  </files>
  <action>
Create three files at the monorepo root:

1. **pnpm-workspace.yaml** — Define workspace members:
```yaml
packages:
  - 'apps/web'
  - 'apps/docs'
  - 'apps/vimeo-proxy'
```
Note: `apps/pipeline` is Python (uv-managed) and is NOT a workspace member.
Note: `apps/docs` does not exist yet but is listed so it will be recognized once scaffolded in Plan 02.

2. **package.json** — Minimal root package.json:
```json
{
  "name": "viewroyal",
  "private": true,
  "scripts": {
    "dev:web": "pnpm --filter web dev",
    "dev:docs": "pnpm --filter docs dev",
    "build:web": "pnpm --filter web build",
    "build:docs": "pnpm --filter docs build"
  }
}
```
No `type: "module"` at root — each app defines its own module type.

3. **.npmrc** — pnpm settings to ensure smooth workspace behavior:
```ini
shamefully-hoist=true
```
`shamefully-hoist=true` ensures packages that expect hoisted node_modules (like wrangler, vite plugins) work correctly across workspace members.

Then clean up stale artifacts:
- Delete `apps/web/pnpm-lock.yaml`
- Delete `apps/vimeo-proxy/pnpm-lock.yaml`
- Delete the existing root `node_modules/` directory (contains stale `pg`-related packages from a prior install)
- Delete `apps/web/node_modules/` to get a fresh install
- Delete `apps/vimeo-proxy/node_modules/` to get a fresh install

Finally, run `pnpm install` from the monorepo root to generate the consolidated root `pnpm-lock.yaml` and install all workspace dependencies.
  </action>
  <verify>
    <automated>cd /Users/kyle/development/viewroyal && test -f pnpm-workspace.yaml && test -f package.json && test -f pnpm-lock.yaml && test ! -f apps/web/pnpm-lock.yaml && test ! -f apps/vimeo-proxy/pnpm-lock.yaml && echo "PASS: workspace files exist, old lock files removed"</automated>
    <manual>Verify pnpm install completed without errors</manual>
  </verify>
  <done>Root pnpm-workspace.yaml, package.json, and .npmrc exist. Consolidated pnpm-lock.yaml at root. Old lock files and node_modules deleted. pnpm install succeeds from root.</done>
</task>

<task type="auto">
  <name>Task 2: Verify existing apps build correctly after workspace migration</name>
  <files></files>
  <action>
Run the build commands for both existing JS apps to verify the workspace migration didn't break anything:

1. **apps/web build**: Run `pnpm run build` from `apps/web/`. This runs `react-router build` which uses Vite + Cloudflare plugin. Verify it completes without errors.
   - IMPORTANT: The `vite.config.ts` uses `path.resolve(process.cwd(), "../../")` to find the root `.env` file. Since the directory structure doesn't change (apps/web is still 2 levels deep), this path should still work. Confirm this is the case.
   - If build fails due to missing env vars, the build should still succeed (env vars fallback to empty strings). The key test is that the bundler/compiler completes.

2. **apps/vimeo-proxy build**: Run `pnpm exec tsc --noEmit` from `apps/vimeo-proxy/` to verify TypeScript compiles. This app doesn't have a build script — it deploys directly via wrangler which handles bundling. Verify tsc succeeds (or has only pre-existing type warnings).

3. **Root workspace commands**: Run `pnpm run build:web` from the monorepo root to verify the filter convenience scripts work.

If any build fails:
- Check if the issue is a missing dependency (pnpm install didn't hoist correctly)
- Check if .npmrc needs `public-hoist-pattern` adjustments
- Fix the issue before marking task complete
  </action>
  <verify>
    <automated>cd /Users/kyle/development/viewroyal && pnpm --filter web build 2>&1 | tail -5 && echo "---" && pnpm --filter vimeo-proxy exec tsc --noEmit 2>&1 | tail -5 && echo "BUILDS CHECKED"</automated>
  </verify>
  <done>apps/web builds successfully via pnpm --filter web build. apps/vimeo-proxy TypeScript compiles without errors. Root convenience scripts (pnpm run build:web) work correctly.</done>
</task>

</tasks>

<verification>
1. `pnpm-workspace.yaml` exists at monorepo root with 3 workspace members
2. `package.json` exists at monorepo root with convenience scripts
3. `pnpm-lock.yaml` exists at monorepo root (not in individual apps)
4. `pnpm install` from root succeeds
5. `pnpm --filter web build` succeeds
6. `pnpm --filter vimeo-proxy exec tsc --noEmit` succeeds
</verification>

<success_criteria>
- Root pnpm-workspace.yaml configures apps/web, apps/docs, and apps/vimeo-proxy as workspace members (MONO-01)
- Existing apps/web and apps/vimeo-proxy build correctly after workspace migration (MONO-02)
- Single consolidated lock file at root, no lock files in app directories
</success_criteria>

<output>
After completion, create `.planning/phases/19-infrastructure-scaffolding/19-01-SUMMARY.md`
</output>
