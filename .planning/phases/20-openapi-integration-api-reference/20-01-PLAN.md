---
phase: 20-openapi-integration-api-reference
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/docs/package.json
  - apps/docs/scripts/generate-openapi.mjs
  - apps/docs/lib/openapi.ts
  - apps/docs/openapi.json
  - apps/docs/.gitignore
autonomous: true
requirements: [AREF-01, AREF-04]

must_haves:
  truths:
    - "Prebuild script fetches live OpenAPI spec from viewroyal.ai and writes fallback"
    - "Prebuild script falls back to committed openapi.json when live API is unreachable"
    - "createOpenAPI instance generates code samples in curl, JavaScript, and Python"
    - "Generated MDX files appear in content/docs/api-reference/ grouped by tag"
  artifacts:
    - path: "apps/docs/scripts/generate-openapi.mjs"
      provides: "Prebuild script: fetch spec, inject servers, run generateFiles"
      min_lines: 30
    - path: "apps/docs/lib/openapi.ts"
      provides: "createOpenAPI instance with generateCodeSamples"
      exports: ["openapi"]
    - path: "apps/docs/openapi.json"
      provides: "Committed fallback OpenAPI 3.1 spec"
      contains: "openapi"
    - path: "apps/docs/package.json"
      provides: "prebuild script wiring"
      contains: "prebuild"
  key_links:
    - from: "apps/docs/scripts/generate-openapi.mjs"
      to: "apps/docs/openapi.json"
      via: "fetch + writeFileSync"
      pattern: "writeFileSync.*openapi\\.json"
    - from: "apps/docs/scripts/generate-openapi.mjs"
      to: "fumadocs-openapi generateFiles"
      via: "import generateFiles"
      pattern: "generateFiles"
    - from: "apps/docs/lib/openapi.ts"
      to: "apps/docs/openapi.json"
      via: "input config"
      pattern: "input.*openapi\\.json"
---

<objective>
Set up the OpenAPI integration infrastructure: install fumadocs-openapi + shiki, create the prebuild script that fetches the live spec with committed fallback, create the createOpenAPI instance with multi-language code samples, and run the generation to produce API reference MDX files.

Purpose: Establishes the automated spec-to-docs pipeline that all API reference pages depend on. Without this, no API reference content exists.
Output: Working prebuild script, committed fallback spec, generated MDX files in content/docs/api-reference/, and openapi.ts module ready for the APIPage component.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-openapi-integration-api-reference/20-RESEARCH.md
@.planning/phases/19-infrastructure-scaffolding/19-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create prebuild script with spec fetch + generation</name>
  <files>
    apps/docs/package.json
    apps/docs/scripts/generate-openapi.mjs
    apps/docs/openapi.json
    apps/docs/.gitignore
  </files>
  <action>
1. Install fumadocs-openapi and shiki in apps/docs:
   ```bash
   cd apps/docs && pnpm add fumadocs-openapi shiki
   ```

2. Create `apps/docs/scripts/generate-openapi.mjs` -- a Node.js prebuild script that:
   - Fetches the OpenAPI spec from `https://viewroyal.ai/api/v1/openapi.json` with a 10-second timeout
   - On fetch failure, falls back to reading the committed `./openapi.json` file
   - Parses the spec as JSON and injects a `servers` array if missing: `[{ url: 'https://viewroyal.ai', description: 'Production' }]`
   - Writes the (possibly updated) spec to `./openapi.json` as the committed fallback
   - Calls `generateFiles()` from `fumadocs-openapi` with these options:
     - `input`: `['./openapi.json']`
     - `output`: `'./content/docs/api-reference'`
     - `per`: `'operation'`
     - `groupBy`: `'tag'`
   - Logs success/failure messages to console
   - NOTE: The research has an open question about whether `generateFiles()` can run standalone or needs Next.js context. If the import from `fumadocs-openapi` fails in a standalone script, try importing from `fumadocs-openapi/server` instead. Check the actual export paths in node_modules.

3. Update `apps/docs/package.json` scripts:
   - Add `"prebuild": "node scripts/generate-openapi.mjs"`
   - Update `"build"` to `"prebuild && next build"` (so prebuild runs as part of build). Alternatively, keep them separate and chain: `"build": "node scripts/generate-openapi.mjs && next build"`

4. Add `content/docs/api-reference/` to `apps/docs/.gitignore` since these files are generated at build time. Keep `openapi.json` tracked (do NOT gitignore it -- it's the committed fallback).

5. Run the prebuild script to fetch the live spec and generate the initial MDX files:
   ```bash
   cd apps/docs && node scripts/generate-openapi.mjs
   ```
   Verify that:
   - `openapi.json` exists and contains valid OpenAPI 3.1 JSON with a `servers` array
   - `content/docs/api-reference/` contains subdirectories for tags (meetings/, people/, etc.)
   - Each subdirectory contains `.mdx` files (one per operation)
  </action>
  <verify>
    <automated>cd /Users/kyle/development/viewroyal/apps/docs && node scripts/generate-openapi.mjs && test -f openapi.json && test -d content/docs/api-reference && ls content/docs/api-reference/*/</automated>
    <manual>Inspect openapi.json to confirm servers array present. Check generated MDX files contain APIPage references.</manual>
  </verify>
  <done>
    - openapi.json exists at apps/docs/openapi.json with servers array injected
    - content/docs/api-reference/ has subdirectories matching API tags
    - Each tag directory has .mdx files for its operations
    - package.json has prebuild script wired
    - Generated MDX directory is gitignored
  </done>
</task>

<task type="auto">
  <name>Task 2: Create openapi.ts server module with multi-language code samples</name>
  <files>
    apps/docs/lib/openapi.ts
  </files>
  <action>
1. Create `apps/docs/lib/openapi.ts` with:
   - Import `createOpenAPI` from `fumadocs-openapi/server`
   - Export `openapi` instance configured with:
     - `input: ['./openapi.json']`
     - `generateCodeSamples` function that receives an endpoint parameter and returns an array of 3 code samples:
       a. **cURL** (lang: 'bash', label: 'cURL'): `curl -X METHOD 'https://viewroyal.ai/PATH' -H 'X-API-Key: YOUR_API_KEY'`
       b. **JavaScript** (lang: 'js', label: 'JavaScript'): fetch-based example with X-API-Key header
       c. **Python** (lang: 'python', label: 'Python'): requests library example with X-API-Key header

2. The endpoint parameter shape from research: has `method` and `path` properties. Start with those. If TypeScript compilation reveals different property names, adjust accordingly.

3. For the base URL in code samples, use `https://viewroyal.ai` (the production API).

4. Handle both GET and POST/PUT methods in code sample templates:
   - GET: simple fetch/requests.get
   - POST/PUT: include example JSON body with Content-Type header

NOTE: This file is server-only. It will be imported by the api-page.tsx component (created in Plan 20-02) and possibly by the prebuild script. Do NOT add 'use client' directive.
  </action>
  <verify>
    <automated>cd /Users/kyle/development/viewroyal/apps/docs && npx tsc --noEmit lib/openapi.ts 2>&1 || echo "Type check may need full project context -- verify in build step"</automated>
    <manual>Inspect lib/openapi.ts to confirm generateCodeSamples returns curl, JS, and Python examples.</manual>
  </verify>
  <done>
    - apps/docs/lib/openapi.ts exports an `openapi` instance
    - generateCodeSamples produces code samples in curl, JavaScript, and Python
    - Code samples use the correct production API base URL
    - File is server-only (no 'use client' directive)
  </done>
</task>

</tasks>

<verification>
1. `apps/docs/openapi.json` exists with valid OpenAPI 3.1 content and servers array
2. `apps/docs/scripts/generate-openapi.mjs` runs without errors
3. `apps/docs/content/docs/api-reference/` contains generated MDX files grouped by tag
4. `apps/docs/lib/openapi.ts` exports openapi with generateCodeSamples
5. `apps/docs/package.json` has prebuild script
6. `apps/docs/.gitignore` excludes generated api-reference directory
</verification>

<success_criteria>
- Running `node scripts/generate-openapi.mjs` in apps/docs/ fetches the spec and generates MDX files
- openapi.json fallback is committed and contains a servers array
- lib/openapi.ts provides createOpenAPI instance with 3-language code samples
- Generated content/docs/api-reference/ has tag-grouped subdirectories with .mdx files
</success_criteria>

<output>
After completion, create `.planning/phases/20-openapi-integration-api-reference/20-01-SUMMARY.md`
</output>
