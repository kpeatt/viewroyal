---
phase: 03-subscriptions-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/components/navbar.tsx
  - apps/web/app/components/subscribe-button.tsx
  - apps/web/app/lib/types.ts
  - apps/web/app/routes.ts
  - apps/web/app/routes/signup.tsx
  - apps/web/app/routes/settings.tsx
  - apps/web/app/routes/login.tsx
  - apps/web/app/routes/api.subscribe.tsx
  - apps/web/app/routes/api.digest.tsx
  - apps/web/app/routes/matter-detail.tsx
  - apps/web/app/routes/person-profile.tsx
  - apps/web/app/services/subscriptions.ts
autonomous: true
requirements: [SUB-01, SUB-02, SUB-06, SUB-08, SUB-09, SUB-10, SUB-11, SUB-12]

must_haves:
  truths:
    - "PR #13's subscription frontend code exists on main branch"
    - "New routes (signup, settings, api/subscribe, api/digest) are registered and load without errors"
    - "Subscribe buttons appear on matter detail and person profile pages"
    - "Navbar shows Settings/Bell icon for logged-in users and Get Alerts link for anonymous users"
    - "Login page links to signup page"
    - "TypeScript typecheck passes with subscription types added"
    - "Build succeeds for Cloudflare Workers deployment"
  artifacts:
    - path: "apps/web/app/components/subscribe-button.tsx"
      provides: "Reusable subscription toggle component"
    - path: "apps/web/app/services/subscriptions.ts"
      provides: "Service layer for profiles, subscriptions, and digest queries"
    - path: "apps/web/app/routes/signup.tsx"
      provides: "Public signup page with profile+digest auto-creation"
    - path: "apps/web/app/routes/settings.tsx"
      provides: "User settings page with profile form and subscription management"
    - path: "apps/web/app/routes/api.subscribe.tsx"
      provides: "API route for subscribe/unsubscribe/check actions"
    - path: "apps/web/app/routes/api.digest.tsx"
      provides: "API route for meeting digest preview"
  key_links:
    - from: "apps/web/app/components/subscribe-button.tsx"
      to: "apps/web/app/routes/api.subscribe.tsx"
      via: "fetch /api/subscribe (GET/POST/DELETE)"
      pattern: "fetch.*api/subscribe"
    - from: "apps/web/app/routes/settings.tsx"
      to: "apps/web/app/services/subscriptions.ts"
      via: "getUserProfile, getSubscriptions, upsertUserProfile, removeSubscription"
      pattern: "import.*from.*services/subscriptions"
    - from: "apps/web/app/routes/signup.tsx"
      to: "supabase.from('user_profiles').insert"
      via: "Profile creation on signup"
      pattern: "user_profiles.*insert"
    - from: "apps/web/app/routes.ts"
      to: "apps/web/app/routes/signup.tsx"
      via: "route('signup', 'routes/signup.tsx')"
      pattern: "route.*signup"
---

<objective>
Manually apply all PR #13 code changes onto current main, resolving merge conflicts with Phase 2's municipality context layer.

Purpose: PR #13 contains the complete subscription system frontend (9800+ lines), but was branched before Phase 2 added municipality context. Direct `git merge` will conflict on 5+ files. This plan cherry-picks PR #13's changes file-by-file, adapting each conflicting file to preserve Phase 2's patterns while adding PR #13's subscription features.

Output: All subscription frontend code on main — new routes, components, services, types — with typecheck and build passing.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-subscriptions-notifications/03-RESEARCH.md
@.planning/phases/02-multi-tenancy/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new files from PR #13 (no conflicts)</name>
  <files>
    apps/web/app/components/subscribe-button.tsx
    apps/web/app/services/subscriptions.ts
    apps/web/app/routes/signup.tsx
    apps/web/app/routes/settings.tsx
    apps/web/app/routes/api.subscribe.tsx
    apps/web/app/routes/api.digest.tsx
  </files>
  <action>
    Extract each new file from PR #13 using `git show claude/add-geolocation-proximity-5lwv4:<path>` and write to the working tree. These are brand-new files with no conflict risk.

    Files to extract:
    1. `apps/web/app/components/subscribe-button.tsx` — Client-side subscription toggle. Uses `useRouteLoaderData("root")` for user check (already compatible with Phase 2 pattern).
    2. `apps/web/app/services/subscriptions.ts` — Service layer with getUserProfile, upsertUserProfile, getSubscriptions, addSubscription, removeSubscription, checkSubscription, getMeetingDigest, findMattersNear.
    3. `apps/web/app/routes/signup.tsx` — Public signup with auto profile+digest creation. Uses createSupabaseServerClient pattern.
    4. `apps/web/app/routes/settings.tsx` — Profile management + subscription list. **IMPORTANT:** This file has a hardcoded `VIEW_ROYAL_NEIGHBORHOODS` array. Leave it as-is for now — this is acceptable as the platform only serves View Royal currently. A TODO comment noting it should be dynamic when multi-town is needed is sufficient.
    5. `apps/web/app/routes/api.subscribe.tsx` — POST/DELETE/GET for subscription management.
    6. `apps/web/app/routes/api.digest.tsx` — GET for meeting digest preview.

    Do NOT extract:
    - `sql/002_subscriptions_and_geolocation.sql` — schema already applied to production
    - `apps/web/package-lock.json` — project uses pnpm, not npm
    - `supabase/functions/send-alerts/index.ts` — already deployed as Edge Function

    After writing all files, verify each exists with correct content.
  </action>
  <verify>All 6 files exist in the working tree. `ls apps/web/app/components/subscribe-button.tsx apps/web/app/services/subscriptions.ts apps/web/app/routes/signup.tsx apps/web/app/routes/settings.tsx apps/web/app/routes/api.subscribe.tsx apps/web/app/routes/api.digest.tsx` succeeds.</verify>
  <done>All 6 new files from PR #13 exist on disk with correct content, ready for integration.</done>
</task>

<task type="auto">
  <name>Task 2: Resolve conflicts and integrate PR #13 changes into existing files</name>
  <files>
    apps/web/app/lib/types.ts
    apps/web/app/routes.ts
    apps/web/app/routes/login.tsx
    apps/web/app/routes/matter-detail.tsx
    apps/web/app/routes/person-profile.tsx
    apps/web/app/components/navbar.tsx
  </files>
  <action>
    For each conflicting file, apply PR #13's additions on top of current main (which has Phase 2's municipality context). The strategy: KEEP main's current content, ADD PR #13's new code.

    **1. `apps/web/app/lib/types.ts`**
    - PR #13 appends ~105 lines of subscription types after the existing `Candidacy` interface
    - Append these types: `SubscriptionType`, `DigestFrequency`, `UserProfile`, `Subscription`, `AlertLogEntry`, `MeetingDigest`, `NearbyMatter`
    - Main's current types.ts already has Phase 2 additions — just append PR #13's block at the end

    **2. `apps/web/app/routes.ts`**
    - Add 4 new route registrations: `signup`, `settings`, `api/digest`, `api/subscribe`
    - Insert `route("signup", "routes/signup.tsx")` after the login route
    - Insert `route("settings", "routes/settings.tsx")` after the logout route
    - Insert `route("api/digest", "routes/api.digest.tsx")` and `route("api/subscribe", "routes/api.subscribe.tsx")` in the API routes section after `api/ask`

    **3. `apps/web/app/routes/login.tsx`**
    - Add `Link` to the import from "react-router" (may already be there from Phase 2)
    - Add signup link paragraph after the Form closing tag: `<p>Want council alerts? <Link to="/signup">Create an account</Link></p>`

    **4. `apps/web/app/routes/matter-detail.tsx`**
    - Add import: `import { SubscribeButton } from "../components/subscribe-button";`
    - Add `<SubscribeButton type="matter" targetId={matter.id} label="Follow Matter" />` next to the matter status badge in the header

    **5. `apps/web/app/routes/person-profile.tsx`**
    - Add import: `import { SubscribeButton } from "../components/subscribe-button";`
    - Wrap the CardTitle (person name) in a flex container with the SubscribeButton:
      ```
      <div className="flex items-start justify-between gap-3">
        <CardTitle>...</CardTitle>
        {person.is_councillor && <SubscribeButton type="person" targetId={person.id} label="Follow" />}
      </div>
      ```

    **6. `apps/web/app/components/navbar.tsx`**
    - Add `Bell` and `Settings` to lucide-react imports
    - In the desktop user menu (authenticated section): add a Bell/Settings link to `/settings` before the speaker-alias link
    - Change the `{user && (` conditional to `{user ? (` with an else branch showing a "Get Alerts" signup link for anonymous users
    - In mobile menu: add Settings & Alerts link, change `{user && (` to `{user ? (` with else branch for mobile "Get Alerts" link
    - **CRITICAL:** Preserve Phase 2's municipality context usage in navbar (useRouteLoaderData pattern, dynamic branding). PR #13's navbar changes are purely additive (new links/icons), not structural.

    After all edits, run `pnpm typecheck` from `apps/web/` to verify no type errors. Then run `pnpm build` to verify the Cloudflare Workers build succeeds.
  </action>
  <verify>`cd apps/web && pnpm typecheck && pnpm build` passes with zero errors (the pre-existing voice-fingerprints.tsx error on line 404 is expected and can be ignored if present).</verify>
  <done>All PR #13 changes are integrated into main's existing files. Typecheck passes. Build succeeds. Routes register correctly. Subscribe buttons render on matter and person pages.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes in `apps/web/`
2. `pnpm build` passes in `apps/web/`
3. All 6 new files exist: subscribe-button.tsx, subscriptions.ts, signup.tsx, settings.tsx, api.subscribe.tsx, api.digest.tsx
4. `routes.ts` includes signup, settings, api/subscribe, api/digest routes
5. `types.ts` includes SubscriptionType, UserProfile, Subscription types
6. `navbar.tsx` has Bell import and /settings link
7. `matter-detail.tsx` imports and renders SubscribeButton
8. `person-profile.tsx` imports and renders SubscribeButton
9. `login.tsx` has link to /signup
</verification>

<success_criteria>
All PR #13 frontend code is on main with Phase 2's municipality context preserved. Typecheck and build pass. The web app can be deployed with subscription UI features visible (though email delivery requires Plan 02's external configuration).
</success_criteria>

<output>
After completion, create `.planning/phases/03-subscriptions-notifications/03-01-SUMMARY.md`
</output>
