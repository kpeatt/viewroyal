---
phase: 12-update-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/pipeline/pipeline/update_detector.py
  - apps/pipeline/tests/pipeline/test_update_detector.py
autonomous: true
requirements:
  - DETECT-01
  - DETECT-02

must_haves:
  truths:
    - "Running the detector returns a list of meetings with new documents on CivicWeb not yet on disk"
    - "Running the detector returns a list of meetings with Vimeo video available but no audio/transcript on disk"
    - "Meetings with no changes are not included in the change report"
  artifacts:
    - path: "apps/pipeline/pipeline/update_detector.py"
      provides: "UpdateDetector class with detect_document_changes() and detect_video_changes()"
      min_lines: 80
    - path: "apps/pipeline/tests/pipeline/test_update_detector.py"
      provides: "Tests for both document and video change detection"
      min_lines: 60
  key_links:
    - from: "apps/pipeline/pipeline/update_detector.py"
      to: "pipeline.scrapers.civicweb.CivicWebScraper"
      via: "CivicWeb API call to list documents per meeting folder"
      pattern: "_fetch_items|scrape_recursive"
    - from: "apps/pipeline/pipeline/update_detector.py"
      to: "pipeline.video.vimeo.VimeoClient"
      via: "get_video_map() to find available videos"
      pattern: "get_video_map|VimeoClient"
    - from: "apps/pipeline/pipeline/update_detector.py"
      to: "pipeline.ingestion.audit.check_disk_documents"
      via: "Reuses disk checking logic for local state"
      pattern: "check_disk_documents"
---

<objective>
Create the UpdateDetector module that compares remote CivicWeb document listings and Vimeo video availability against the local archive, producing a structured change report identifying meetings with new content.

Purpose: This is the core detection engine for DETECT-01 (new documents) and DETECT-02 (new video). Without this, the pipeline has no way to know what changed since the last run.

Output: `update_detector.py` module with `UpdateDetector` class, plus comprehensive tests.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@apps/pipeline/pipeline/orchestrator.py
@apps/pipeline/pipeline/ingestion/audit.py
@apps/pipeline/pipeline/scrapers/civicweb.py
@apps/pipeline/pipeline/video/vimeo.py
@apps/pipeline/pipeline/paths.py
@apps/pipeline/pipeline/utils.py
@apps/pipeline/tests/orchestrator/test_orchestrator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UpdateDetector module with document and video change detection</name>
  <files>apps/pipeline/pipeline/update_detector.py</files>
  <action>
Create `apps/pipeline/pipeline/update_detector.py` with an `UpdateDetector` class that takes the same constructor args as Archiver (archive_root, scraper, vimeo_client).

The module should contain:

1. **`ChangeReport` dataclass** with fields:
   - `meetings_with_new_docs: list[MeetingChange]` -- meetings where CivicWeb has documents not yet on disk
   - `meetings_with_new_video: list[MeetingChange]` -- meetings where Vimeo has video but no audio/transcript on disk
   - `total_changes: int` -- convenience count
   - `checked_at: str` -- ISO timestamp

2. **`MeetingChange` dataclass** with fields:
   - `archive_path: str` -- path to the meeting folder on disk
   - `meeting_date: str` -- date string
   - `meeting_type: str` -- e.g. "Council", "Committee of the Whole"
   - `change_type: str` -- "new_documents" or "new_video"
   - `details: list[str]` -- human-readable descriptions of what's new (e.g. "Minutes PDF available", "Vimeo video found")

3. **`UpdateDetector` class** with methods:

   a. `__init__(self, archive_root, scraper, vimeo_client)` -- stores references

   b. `detect_document_changes(self) -> list[MeetingChange]`:
      - Walk the archive directory (same pattern as orchestrator's `_ingest_meetings`)
      - For each meeting folder that has an "Agenda" dir, check if there's also a "Minutes" dir with files
      - Key check: use `check_disk_documents()` from `pipeline.ingestion.audit` to see current disk state
      - Then run the scraper in a "check-only" mode to see what CivicWeb has. The simplest approach: the existing scraper already downloads only NEW files (it checks `os.path.exists(file_path)` before downloading). So we can leverage this by running `scraper.scrape_recursive()` which will naturally download any new files, and then re-check disk state. If disk state changed, that meeting has new content.
      - HOWEVER, a lighter approach is better for detection: compare the DB flags (has_minutes) against disk state using the existing `find_meetings_needing_reingest()` from audit.py. This already does exactly what DETECT-01 needs -- finds meetings where disk has content the DB doesn't know about.
      - **Implementation:** Call `find_meetings_needing_reingest(supabase)` (reusing existing audit logic) after scraping. The scraper downloads new files, then audit detects what's new. Convert audit results to `MeetingChange` objects.
      - Additionally, detect meetings where disk has NO minutes but scraper's most recent run created a Minutes folder (indicating new minutes were just downloaded from CivicWeb).

   c. `detect_video_changes(self) -> list[MeetingChange]`:
      - Call `vimeo_client.get_video_map()` to get all available Vimeo videos
      - Walk the archive to find meeting folders
      - For each meeting folder, check if there's a matching Vimeo video (by date) but NO audio files on disk (no .mp3/.m4a/.wav in Audio/ dir) and NO transcript JSON
      - Use the same date-matching logic from `orchestrator._download_vimeo_content()` (extract date from folder name, match against video_map)
      - Return a `MeetingChange` for each meeting that has Vimeo video available but no local audio/transcript

   d. `detect_all_changes(self, supabase=None) -> ChangeReport`:
      - Runs both detect methods
      - Combines into a `ChangeReport`
      - Prints a human-readable summary to stdout

Important implementation notes:
- Import `check_disk_documents` and `find_meetings_needing_reingest` from `pipeline.ingestion.audit`
- Import `utils` for `extract_date_from_string` (the same date matching used by the orchestrator)
- The module should NOT import heavy deps (diarizer, Gemini) -- it's a lightweight checker
- Use `from __future__ import annotations` for type hints
  </action>
  <verify>
Run `cd /Users/kyle/development/viewroyal/apps/pipeline && python -c "from pipeline.update_detector import UpdateDetector, ChangeReport, MeetingChange; print('Import OK')"` to confirm the module loads without errors.
  </verify>
  <done>
UpdateDetector class exists with detect_document_changes(), detect_video_changes(), and detect_all_changes() methods. MeetingChange and ChangeReport dataclasses are defined. Module imports cleanly without loading heavy dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for UpdateDetector</name>
  <files>apps/pipeline/tests/pipeline/test_update_detector.py</files>
  <action>
Create `apps/pipeline/tests/pipeline/test_update_detector.py` with tests following the project's existing patterns (pytest, unittest.mock).

Tests should cover:

1. **`test_detect_document_changes_finds_new_minutes`**: Mock `find_meetings_needing_reingest` to return a meeting with "New minutes found on disk" reason. Verify `detect_document_changes()` returns a `MeetingChange` with change_type="new_documents".

2. **`test_detect_document_changes_no_changes`**: Mock audit returning empty list. Verify empty result.

3. **`test_detect_video_changes_finds_new_video`**: Set up a temp archive dir with a meeting folder (e.g., `Council - January 15, 2025/Agenda/`) that has an agenda PDF but no Audio dir. Mock `vimeo_client.get_video_map()` to return a matching video for that date. Verify `detect_video_changes()` returns a MeetingChange with change_type="new_video".

4. **`test_detect_video_changes_skips_meeting_with_existing_audio`**: Same setup but add an Audio dir with an .mp3 file. Verify the meeting is NOT in the results.

5. **`test_detect_video_changes_no_vimeo_videos`**: Mock get_video_map returning empty dict. Verify empty result.

6. **`test_detect_all_changes_combines_both`**: Mock both detection paths to return results. Verify `ChangeReport` has both lists populated and `total_changes` is correct.

Use `tmp_path` fixture for creating temp archive structures. Mock the Supabase client and VimeoClient as done in existing orchestrator tests.

Ensure the test file has the `__init__.py` in the `tests/pipeline/` directory if it doesn't exist.
  </action>
  <verify>
Run `cd /Users/kyle/development/viewroyal/apps/pipeline && uv run pytest tests/pipeline/test_update_detector.py -v` and confirm all tests pass.
  </verify>
  <done>
All 6 tests pass. Tests cover document change detection (positive + negative), video change detection (positive + skip-existing + no-videos), and combined report generation.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/kyle/development/viewroyal/apps/pipeline && python -c "from pipeline.update_detector import UpdateDetector, ChangeReport, MeetingChange"` succeeds
2. `cd /Users/kyle/development/viewroyal/apps/pipeline && uv run pytest tests/pipeline/test_update_detector.py -v` -- all tests pass
3. The module does NOT import LocalDiarizer, Gemini, or other heavy dependencies
</verification>

<success_criteria>
- UpdateDetector module exists and imports cleanly
- detect_document_changes() identifies meetings where disk has content the DB doesn't (DETECT-01)
- detect_video_changes() identifies meetings where Vimeo has video but local archive has no audio/transcript (DETECT-02)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-update-detection/12-01-SUMMARY.md`
</output>
