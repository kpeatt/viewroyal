---
phase: 24-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/docs/package.json
  - apps/docs/wrangler.toml
  - package.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "generate-openapi.mjs runs exactly once during pnpm build (not twice)"
    - "pnpm deploy from apps/docs runs typecheck, build, and wrangler deploy in one command"
    - "wrangler is a direct devDependency of apps/docs (not relying on shamefully-hoist)"
    - "docs.viewroyal.ai serves the documentation site (or DNS configuration is documented)"
  artifacts:
    - path: "apps/docs/package.json"
      provides: "Fixed build scripts with deploy command and wrangler devDependency"
      contains: "wrangler"
    - path: "apps/docs/wrangler.toml"
      provides: "Custom domain route configuration"
      contains: "docs.viewroyal.ai"
    - path: "package.json"
      provides: "Root deploy:docs convenience script"
      contains: "deploy:docs"
  key_links:
    - from: "apps/docs/package.json prebuild"
      to: "apps/docs/scripts/generate-openapi.mjs"
      via: "npm lifecycle hook (automatic before build)"
      pattern: "prebuild.*generate-openapi"
    - from: "apps/docs/package.json deploy"
      to: "wrangler deploy"
      via: "deploy script chain"
      pattern: "deploy.*wrangler deploy"
---

<objective>
Fix duplicate prebuild execution, add deploy script, add wrangler dependency, and configure custom domain for the docs site.

Purpose: Make the docs build/deploy pipeline clean, self-contained, and production-ready. Eliminate reliance on pnpm shamefully-hoist for wrangler access and stop running the OpenAPI generation script twice per build.

Output: Updated package.json files and wrangler.toml with proper scripts and configuration.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/docs/package.json
@apps/docs/wrangler.toml
@apps/docs/scripts/generate-openapi.mjs
@apps/web/package.json
@apps/web/wrangler.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix duplicate prebuild and add deploy script with wrangler dependency</name>
  <files>apps/docs/package.json, package.json</files>
  <action>
  In `apps/docs/package.json`:

  1. **Fix build script duplication:** The current `build` script is `"node scripts/generate-openapi.mjs && next build"` but `prebuild` already runs the same script automatically via npm lifecycle. Change `build` to just `"next build"`. The `prebuild` hook (`"node scripts/generate-openapi.mjs"`) stays as-is — it fires automatically before `build`.

  2. **Add deploy script:** Add `"deploy": "tsc --noEmit && pnpm build && wrangler deploy"` to the scripts section. This matches the CONTEXT.md decision: typecheck before build, prebuild runs automatically as part of build, then wrangler deploy. Follow the same pattern as `apps/web/package.json` which has `"deploy": "pnpm run build && wrangler deploy"` (docs adds typecheck per user decision).

  3. **Add wrangler devDependency:** Add `"wrangler": "^4.64.0"` to `devDependencies`. This matches the version used in `apps/web/package.json` and `apps/vimeo-proxy/package.json`. Currently wrangler works only because `.npmrc` has `shamefully-hoist=true` — this makes docs self-contained.

  In root `package.json`:

  4. **Add deploy:docs convenience script:** Add `"deploy:docs": "pnpm --filter docs deploy"` to the root scripts section. This mirrors the existing `build:docs` and `dev:docs` patterns.

  After editing, run `cd apps/docs && pnpm install` to update the lockfile with the new wrangler dependency.
  </action>
  <verify>
    <automated>cd apps/docs && node -e "const p=require('./package.json'); const b=p.scripts.build; const d=p.scripts.deploy; const w=p.devDependencies.wrangler; console.log('build:', b); console.log('deploy:', d); console.log('wrangler:', w); if(b.includes('generate-openapi')) throw new Error('build still calls generate-openapi directly'); if(!d) throw new Error('no deploy script'); if(!w) throw new Error('no wrangler devDep'); console.log('OK')"</automated>
    <manual>Verify generate-openapi.mjs runs only once: run `pnpm --filter docs build` and count "[openapi]" log lines — should appear exactly once (from prebuild), not twice.</manual>
  </verify>
  <done>
  - `build` script is `"next build"` (no direct generate-openapi call)
  - `prebuild` script unchanged (`"node scripts/generate-openapi.mjs"`)
  - `deploy` script is `"tsc --noEmit && pnpm build && wrangler deploy"`
  - `wrangler` is in devDependencies at `^4.64.0`
  - Root package.json has `deploy:docs` script
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure custom domain routing for docs.viewroyal.ai</name>
  <files>apps/docs/wrangler.toml</files>
  <action>
  Update `apps/docs/wrangler.toml` to add a route for the custom domain.

  Add a `routes` directive following the same pattern as `apps/web/wrangler.toml`:

  ```toml
  routes = [
    { pattern = "docs.viewroyal.ai/*", zone_name = "viewroyal.ai" }
  ]
  ```

  This tells Cloudflare Workers to serve this worker for requests to `docs.viewroyal.ai`. The `zone_name` must match the Cloudflare zone (same as `apps/web/wrangler.toml` uses).

  **DNS requirement:** A CNAME record for `docs` pointing to the worker must exist in Cloudflare DNS. This should already exist if FWRK-03 was completed (requirement says "Docs site deployed to docs.viewroyal.ai via Cloudflare"). If the DNS record doesn't exist yet, it needs to be created in the Cloudflare DNS dashboard:
  - Type: CNAME
  - Name: docs
  - Target: viewroyal-docs.<account-subdomain>.workers.dev
  - Proxy: Yes (orange cloud)

  Also set `workers_dev = false` since the site should be served on the custom domain only (not on *.workers.dev). If the user wants to keep workers_dev access, this can be changed back.

  Keep the existing `[assets]` configuration unchanged.
  </action>
  <verify>
    <automated>cd apps/docs && node -e "const fs=require('fs'); const t=fs.readFileSync('wrangler.toml','utf8'); if(!t.includes('docs.viewroyal.ai')) throw new Error('no custom domain route'); console.log('OK: custom domain route present')"</automated>
    <manual>After deploy, verify https://docs.viewroyal.ai loads the documentation site. If DNS is not yet configured, document the required CNAME record.</manual>
  </verify>
  <done>
  - `wrangler.toml` has a route for `docs.viewroyal.ai/*` with `zone_name = "viewroyal.ai"`
  - Custom domain serves the docs site (or DNS steps are documented if propagation is pending)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end build pipeline</name>
  <files></files>
  <action>
  Run the full build pipeline to verify everything works together:

  1. Run `pnpm --filter docs build` and verify:
     - `[openapi]` log messages appear exactly once (from prebuild, not twice)
     - `next build` completes successfully
     - `out/` directory is generated with static files

  2. Run `cd apps/docs && pnpm exec wrangler --version` to verify wrangler is accessible as a direct dependency.

  3. Confirm the deploy script is wired correctly by running a dry check (do NOT actually deploy): `node -e "const p=require('./apps/docs/package.json'); console.log('deploy:', p.scripts.deploy); console.log('prebuild:', p.scripts.prebuild); console.log('build:', p.scripts.build)"` — should show the correct chain.

  If the build fails, diagnose and fix. The most likely issue is the prebuild script failing to fetch the live spec (network), in which case it should fall back to the committed `openapi.json`.
  </action>
  <verify>
    <automated>pnpm --filter docs build 2>&1 | grep -c "\[openapi\]" | xargs -I{} test {} -le 4 && echo "OK: openapi runs once" || echo "FAIL: openapi may run twice"</automated>
  </verify>
  <done>
  - `pnpm --filter docs build` succeeds with generate-openapi.mjs running exactly once
  - wrangler is accessible as a direct dependency in apps/docs
  - Deploy script chain is correct: typecheck -> build (with prebuild) -> wrangler deploy
  </done>
</task>

</tasks>

<verification>
1. `generate-openapi.mjs` runs exactly once per build (not duplicated)
2. `apps/docs/package.json` has a `deploy` script for one-command deployment
3. Wrangler is a direct devDependency of `apps/docs` (not relying on shamefully-hoist)
4. Custom domain `docs.viewroyal.ai` route is configured in wrangler.toml
5. Root package.json has deploy:docs convenience script
</verification>

<success_criteria>
- pnpm --filter docs build succeeds with single prebuild execution
- apps/docs/package.json has deploy, prebuild, and build scripts with correct chain
- wrangler ^4.64.0 in devDependencies
- wrangler.toml has docs.viewroyal.ai route
- Root deploy:docs script works
</success_criteria>

<output>
After completion, create `.planning/phases/24-tech-debt-cleanup/24-01-SUMMARY.md`
</output>
