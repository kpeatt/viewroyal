---
phase: 15-api-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/wrangler.toml
  - apps/web/workers/app.ts
  - apps/web/app/api/index.ts
  - apps/web/app/api/types.ts
  - apps/web/app/api/lib/api-errors.ts
  - apps/web/app/api/middleware/error-handler.ts
  - apps/web/app/api/middleware/municipality.ts
  - apps/web/app/api/middleware/request-id.ts
  - apps/web/app/api/endpoints/health.ts
autonomous: true
requirements:
  - INFRA-05
  - INFRA-06
  - INFRA-07

must_haves:
  truths:
    - "A GET request to /api/v1/health returns 200 JSON with status ok"
    - "A GET request to /api/v1/view-royal/health returns 200 JSON with municipality name"
    - "A GET request to /api/v1/nonexistent/health returns 404 with consistent error JSON"
    - "All API error responses use the shape { error: { code, message, status } }"
    - "Cross-origin requests to /api/v1/* receive proper CORS headers"
    - "All API responses include an X-Request-Id header"
    - "Existing React Router routes continue to work unchanged"
  artifacts:
    - path: "apps/web/app/api/index.ts"
      provides: "Hono app with chanfana OpenAPI, CORS, error handling"
      min_lines: 40
    - path: "apps/web/app/api/lib/api-errors.ts"
      provides: "ApiError class with toJSON() producing consistent error shape"
      exports: ["ApiError"]
    - path: "apps/web/app/api/middleware/municipality.ts"
      provides: "Municipality resolution from URL param via Supabase"
    - path: "apps/web/app/api/endpoints/health.ts"
      provides: "Health check endpoint as chanfana OpenAPIRoute"
    - path: "apps/web/workers/app.ts"
      provides: "URL-prefix split routing /api/v1/* to Hono, rest to React Router"
  key_links:
    - from: "apps/web/workers/app.ts"
      to: "apps/web/app/api/index.ts"
      via: "URL prefix check in fetch handler"
      pattern: "pathname\\.startsWith.*api/v1"
    - from: "apps/web/app/api/middleware/municipality.ts"
      to: "apps/web/app/lib/supabase.server.ts"
      via: "getSupabaseAdminClient() for DB lookup"
      pattern: "getSupabaseAdminClient"
    - from: "apps/web/app/api/middleware/error-handler.ts"
      to: "apps/web/app/api/lib/api-errors.ts"
      via: "catches ApiError instances and formats response"
      pattern: "instanceof ApiError"
---

<objective>
Set up the Hono API framework with chanfana OpenAPI support, mount it alongside React Router in the Worker fetch handler, and implement the foundational infrastructure: consistent error handling, CORS, municipality-scoped routing, and a health endpoint.

Purpose: Establish the API skeleton that Phase 15 Plan 02 (auth + rate limiting) and all subsequent API phases (16-18) build on. After this plan, `/api/v1/` routes are live and serving JSON with proper error formatting and CORS.

Output: Working Hono API app with health endpoint, error handling, CORS, municipality resolution, mounted at `/api/v1/` in the same Worker as the existing React Router app.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-api-foundation/15-RESEARCH.md

@apps/web/workers/app.ts
@apps/web/wrangler.toml
@apps/web/package.json
@apps/web/vite.config.ts
@apps/web/app/lib/supabase.server.ts
@apps/web/app/services/municipality.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure wrangler bindings</name>
  <files>
    apps/web/package.json
    apps/web/wrangler.toml
  </files>
  <action>
Install hono, chanfana, and zod in the web app:
```bash
cd apps/web && pnpm add hono chanfana zod
```

Add the Rate Limit binding configuration to `wrangler.toml` (needed now so the Env type can reference it; the middleware that uses it comes in Plan 02):
```toml
[[ratelimits]]
binding = "API_RATE_LIMITER"
namespace_id = "1001"
simple = { limit = 100, period = 60 }
```

This MUST be in wrangler.toml (not dashboard) because `wrangler deploy` overwrites dashboard-set bindings (known issue from CLAUDE.md).
  </action>
  <verify>
Run `cd apps/web && pnpm ls hono chanfana zod` and confirm all three are installed. Verify wrangler.toml contains `[[ratelimits]]` section.
  </verify>
  <done>hono, chanfana, and zod are in package.json dependencies. wrangler.toml has the rate limit binding configured.</done>
</task>

<task type="auto">
  <name>Task 2: Create Hono API app with error handling, CORS, municipality middleware, health endpoint, and mount in Worker</name>
  <files>
    apps/web/app/api/types.ts
    apps/web/app/api/lib/api-errors.ts
    apps/web/app/api/middleware/error-handler.ts
    apps/web/app/api/middleware/municipality.ts
    apps/web/app/api/middleware/request-id.ts
    apps/web/app/api/endpoints/health.ts
    apps/web/app/api/index.ts
    apps/web/workers/app.ts
  </files>
  <action>
Create the `app/api/` directory structure with these files:

**`app/api/types.ts`** — Central Env type for the Hono app. Extends the Worker Env with the Rate Limit binding and context variables set by middleware:
```typescript
export interface ApiEnv {
  Bindings: {
    VITE_SUPABASE_URL: string;
    VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY: string;
    SUPABASE_SECRET_KEY: string;
    GEMINI_API_KEY: string;
    API_RATE_LIMITER: RateLimit;
    [key: string]: unknown;
  };
  Variables: {
    requestId: string;
    apiKeyId?: string;
    userId?: string;
    municipality?: { id: string; slug: string; name: string; short_name: string };
  };
}
```

**`app/api/lib/api-errors.ts`** — ApiError class. Constructor takes `(status, code, message, headers?)`. Has `toJSON()` returning `{ error: { code, message, status } }`. Per user decision: errors are detailed and helpful. Error codes should be SCREAMING_SNAKE_CASE strings.

**`app/api/middleware/error-handler.ts`** — Hono `onError` handler function. Catches `ApiError` and returns its JSON with correct status. Catches chanfana `InputValidationException` (check for err.name === "InputValidationException" or message containing "validation") and reformats to consistent shape with code "VALIDATION_ERROR". Catches all other errors and returns 500 with code "INTERNAL_ERROR". Always sets Content-Type: application/json. Copies any custom headers from ApiError.headers onto the response.

**`app/api/middleware/request-id.ts`** — Hono middleware using `createMiddleware`. Generates a UUID via `crypto.randomUUID()`, stores it as `c.set("requestId", id)`, adds `X-Request-Id` response header via `c.header()`. Run this middleware first (before all others).

**`app/api/middleware/municipality.ts`** — Hono middleware using `createMiddleware<ApiEnv>`. Extracts `:municipality` param from `c.req.param("municipality")`. If present, looks up via `getSupabaseAdminClient().from("municipalities").select("id, slug, name, short_name").eq("slug", slug).maybeSingle()`. If not found, throws `ApiError(404, "MUNICIPALITY_NOT_FOUND", ...)` with helpful message suggesting the correct format. Stores the municipality record in `c.set("municipality", data)`. Import `getSupabaseAdminClient` from `~/lib/supabase.server`.

**`app/api/endpoints/health.ts`** — A chanfana `OpenAPIRoute` class. Define the schema with a summary "Health check" and description. The `handle()` method returns JSON: `{ status: "ok", municipality: c.get("municipality")?.name || null, timestamp: new Date().toISOString() }`. This endpoint does NOT require authentication (it's a health check).

**`app/api/index.ts`** — The main Hono app:
1. Create `new Hono<ApiEnv>()`
2. Apply request-id middleware to all routes: `app.use("*", requestId)`
3. Apply CORS via `cors()` from `hono/cors` to all routes: origin `"*"`, allowMethods `["GET", "HEAD", "OPTIONS"]`, allowHeaders `["X-API-Key", "Content-Type"]`, exposeHeaders `["X-Request-Id", "X-RateLimit-Limit", "Retry-After"]`, maxAge `86400`
4. Set up the `onError` handler from error-handler middleware
5. Set up `notFound` handler that returns the consistent error JSON shape with code "NOT_FOUND" and status 404
6. Initialize chanfana with `fromHono(app, { ... })` using base "/api/v1", docs_url "/api/v1/docs", openapi_url "/api/v1/openapi.json", openapiVersion "3.1", and schema info for "ViewRoyal.ai API"
7. Register the health endpoint at TWO paths: `/api/v1/health` (no municipality scope) and `/api/v1/:municipality/health` (with municipality middleware applied). For the municipality-scoped path, apply the municipality middleware using Hono's route-level middleware.
8. Export the app as default

IMPORTANT: For the municipality-scoped health route, the municipality middleware must run before the endpoint handler. Use Hono's per-route middleware pattern or a route group.

**`workers/app.ts`** — Modify the existing fetch handler:
1. Import the API app: `import apiApp from "../app/api";`
2. In the `fetch` method, BEFORE the React Router handler call, add a URL check: if `url.pathname.startsWith("/api/v1/")`, delegate to `apiApp.fetch(request, env, ctx)`
3. Keep the existing React Router handler and `scheduled` handler completely untouched
4. Update the `Env` interface to include `API_RATE_LIMITER: RateLimit` (and keep the existing `[key: string]: unknown`)

IMPORTANT: Verify that Zod v4 import path works. chanfana v3 requires Zod v4. In endpoint files, import from `zod/v4` if needed: `import { z } from "zod/v4"`. If chanfana re-exports z, use that instead.
  </action>
  <verify>
Run `cd apps/web && pnpm typecheck` to verify no TypeScript errors. If typecheck fails due to chanfana/zod import issues, check the chanfana v3 migration docs for the correct import pattern and fix accordingly.

Then run `cd apps/web && pnpm build` to verify the Worker builds successfully.

Then verify the structure:
```bash
ls apps/web/app/api/
ls apps/web/app/api/lib/
ls apps/web/app/api/middleware/
ls apps/web/app/api/endpoints/
```
  </verify>
  <done>
Hono API app is mounted at /api/v1/ in the Worker fetch handler. Health endpoint responds at /api/v1/health and /api/v1/{municipality}/health. All errors return consistent JSON shape. CORS headers are present on API responses. X-Request-Id header is on all API responses. Existing React Router routes are unaffected.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `pnpm build` succeeds in apps/web/
2. `pnpm typecheck` succeeds in apps/web/
3. The Worker can be started locally with `pnpm dev` and:
   - GET http://localhost:5173/api/v1/health returns `{ "status": "ok", "municipality": null, "timestamp": "..." }`
   - GET http://localhost:5173/api/v1/view-royal/health returns `{ "status": "ok", "municipality": "View Royal", "timestamp": "..." }`
   - GET http://localhost:5173/api/v1/nonexistent/health returns 404 with `{ "error": { "code": "MUNICIPALITY_NOT_FOUND", "message": "...", "status": 404 } }`
   - GET http://localhost:5173/api/v1/nothing/here returns 404 with `{ "error": { "code": "NOT_FOUND", ... } }`
   - Response headers include `X-Request-Id` and CORS headers (`Access-Control-Allow-Origin: *`)
   - GET http://localhost:5173/ still returns the React Router home page
4. `pnpm test` passes (existing tests still work)
</verification>

<success_criteria>
- Hono + chanfana mounted at /api/v1/ alongside React Router in same Worker
- Health endpoint at /api/v1/health and /api/v1/{municipality}/health
- Municipality resolution middleware looks up slug in DB
- All errors return { error: { code, message, status } }
- CORS headers on all /api/v1/* responses
- X-Request-Id on all responses
- No regressions to existing React Router routes
- TypeScript compiles, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/15-api-foundation/15-01-SUMMARY.md`
</output>
