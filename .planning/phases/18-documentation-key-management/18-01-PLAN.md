---
phase: 18-documentation-key-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/api/index.ts
  - apps/web/app/api/endpoints/health.ts
  - apps/web/app/api/endpoints/test-auth.ts
  - apps/web/app/api/endpoints/meetings/list.ts
  - apps/web/app/api/endpoints/meetings/detail.ts
  - apps/web/app/api/endpoints/people/list.ts
  - apps/web/app/api/endpoints/people/detail.ts
  - apps/web/app/api/endpoints/matters/list.ts
  - apps/web/app/api/endpoints/matters/detail.ts
  - apps/web/app/api/endpoints/motions/list.ts
  - apps/web/app/api/endpoints/motions/detail.ts
  - apps/web/app/api/endpoints/bylaws/list.ts
  - apps/web/app/api/endpoints/bylaws/detail.ts
  - apps/web/app/api/endpoints/search.ts
autonomous: true
requirements:
  - DOCS-01
  - DOCS-02

must_haves:
  truths:
    - "GET /api/v1/openapi.json returns a valid OpenAPI 3.1 JSON spec documenting all v1 and OCD endpoints"
    - "GET /api/v1/docs renders interactive Swagger UI with default theme and working 'Authorize' button for API key auth"
    - "Swagger UI 'Try it out' works for authenticated endpoints after entering an API key via the Authorize button"
    - "All v1 endpoints appear grouped by tags (Meetings, People, Matters, Motions, Bylaws, Search, System)"
    - "OCD endpoints appear under an OCD tag in the same spec"
    - "The spec includes error response schemas for 401, 404, 429, 500"
  artifacts:
    - path: "apps/web/app/api/index.ts"
      provides: "Security scheme registration, tag definitions, OCD path registration, corrected docs_url/openapi_url"
      contains: "registerComponent.*securitySchemes"
  key_links:
    - from: "apps/web/app/api/index.ts"
      to: "/api/v1/openapi.json"
      via: "chanfana fromHono() auto-generation"
      pattern: "openapi_url.*openapi\\.json"
    - from: "apps/web/app/api/index.ts"
      to: "/api/v1/docs"
      via: "chanfana Swagger UI serving"
      pattern: "docs_url.*docs"
---

<objective>
Enrich the auto-generated OpenAPI 3.1 spec with security schemes, endpoint tags, error schemas, OCD endpoint documentation, and a useful API description -- then fix the chanfana docs_url/openapi_url path doubling so Swagger UI actually loads.

Purpose: Fulfills DOCS-01 (serve OpenAPI 3.1 spec) and DOCS-02 (interactive Swagger UI with Authorize button). The spec and Swagger UI already partially exist via chanfana but need critical fixes (doubled URL paths) and enrichment (security scheme, tags, OCD docs, error schemas).

Output: A fully-functional `/api/v1/openapi.json` and `/api/v1/docs` Swagger UI page documenting all public API endpoints.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-documentation-key-management/18-RESEARCH.md

@apps/web/app/api/index.ts
@apps/web/app/api/endpoints/health.ts
@apps/web/app/api/endpoints/meetings/list.ts
@apps/web/workers/app.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix chanfana config and register security scheme, tags, error schema, and OCD paths</name>
  <files>apps/web/app/api/index.ts</files>
  <action>
  In `apps/web/app/api/index.ts`, make these changes:

  **1. Fix chanfana URL path doubling (CRITICAL):**
  The current config has `docs_url: "/api/v1/docs"` and `openapi_url: "/api/v1/openapi.json"`, but chanfana prepends `base` to these, producing `/api/v1/api/v1/docs` (broken). Fix by changing to paths relative to the base:
  ```typescript
  const openapi = fromHono(app, {
    base: "/api/v1",
    docs_url: "/docs",           // chanfana prepends base -> /api/v1/docs
    openapi_url: "/openapi.json", // chanfana prepends base -> /api/v1/openapi.json
    openapiVersion: "3.1",
    schema: {
      info: {
        title: "ViewRoyal.ai API",
        version: "1.0.0",
        description:
          "Public API for the ViewRoyal.ai civic intelligence platform.\n\n" +
          "Provides access to council meeting data, people, matters, motions, bylaws, " +
          "and cross-content search for the Town of View Royal, BC.\n\n" +
          "**Authentication:** Pass your API key in the `X-API-Key` header or as a `?apikey=` query parameter. " +
          "Get your key at [/settings/api-keys](/settings/api-keys).\n\n" +
          "**Open Civic Data:** OCD-standard endpoints are available under the OCD tag for civic tech interoperability.",
      },
      tags: [
        { name: "System", description: "Health checks and API status" },
        { name: "Meetings", description: "Council meeting agendas, minutes, and attendance" },
        { name: "People", description: "Council members, staff, and their voting records" },
        { name: "Matters", description: "Agenda matters, issues, and their lifecycle" },
        { name: "Motions", description: "Motions, resolutions, and roll call votes" },
        { name: "Bylaws", description: "Municipal bylaws and their status" },
        { name: "Search", description: "Cross-content keyword search" },
        { name: "OCD", description: "Open Civic Data specification endpoints for civic tech interoperability" },
      ],
    },
  });
  ```

  **2. Register API key security scheme** (after the `fromHono()` call, before route registrations):
  ```typescript
  openapi.registry.registerComponent("securitySchemes", "ApiKeyAuth", {
    type: "apiKey",
    in: "header",
    name: "X-API-Key",
    description:
      "API key for authentication. Get your key at /settings/api-keys. " +
      "Alternatively, pass as ?apikey= query parameter.",
  });
  ```

  **3. Register shared error response schemas** (after security scheme):
  ```typescript
  openapi.registry.registerComponent("schemas", "ApiError", {
    type: "object",
    properties: {
      error: {
        type: "object",
        properties: {
          code: { type: "string", example: "NOT_FOUND" },
          message: { type: "string", example: "Resource not found" },
          status: { type: "integer", example: 404 },
        },
        required: ["code", "message", "status"],
      },
    },
    required: ["error"],
  });
  ```

  **4. Register OCD endpoint paths** (after the `app.route("/api/ocd", ocdApp)` line). Use `openapi.registry.registerPath()` to document OCD endpoints in the combined spec. Register these paths:

  - `GET /api/ocd/{municipality}/jurisdictions` - List OCD jurisdictions
  - `GET /api/ocd/{municipality}/jurisdictions/{id}` - Get OCD jurisdiction by ID
  - `GET /api/ocd/{municipality}/organizations` - List OCD organizations
  - `GET /api/ocd/{municipality}/organizations/{id}` - Get OCD organization by ID
  - `GET /api/ocd/{municipality}/people` - List OCD people
  - `GET /api/ocd/{municipality}/people/{id}` - Get OCD person by ID
  - `GET /api/ocd/{municipality}/events` - List OCD events
  - `GET /api/ocd/{municipality}/events/{id}` - Get OCD event by ID
  - `GET /api/ocd/{municipality}/bills` - List OCD bills
  - `GET /api/ocd/{municipality}/bills/{id}` - Get OCD bill by ID
  - `GET /api/ocd/{municipality}/votes` - List OCD votes
  - `GET /api/ocd/{municipality}/votes/{id}` - Get OCD vote by ID

  Each registration should include: tag "OCD", a clear summary, description, municipality path param, page/per_page query params for list endpoints, id path param for detail endpoints, and 200 response description. Keep it concise -- no need for full response schemas since OCD follows its own spec.

  Import `z` from `"zod"` at the top if not already imported (needed for registerPath request schemas).

  **Important:** If `registerPath` with `/api/ocd/` paths fails at runtime because they're outside the chanfana base path `/api/v1`, that's acceptable -- the OCD paths in the spec are a nice-to-have. The critical items are the security scheme, tags, error schema, and URL fix.
  </action>
  <verify>
  Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` to verify no TypeScript errors from the changes.
  </verify>
  <done>
  The `fromHono()` config uses relative `docs_url: "/docs"` and `openapi_url: "/openapi.json"`. Security scheme "ApiKeyAuth" is registered. Tags for all endpoint groups are defined. Error schema is registered. OCD paths are documented (or gracefully skipped if registerPath doesn't support out-of-base paths).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add security and tag annotations to all endpoint schemas</name>
  <files>
    apps/web/app/api/endpoints/health.ts
    apps/web/app/api/endpoints/test-auth.ts
    apps/web/app/api/endpoints/meetings/list.ts
    apps/web/app/api/endpoints/meetings/detail.ts
    apps/web/app/api/endpoints/people/list.ts
    apps/web/app/api/endpoints/people/detail.ts
    apps/web/app/api/endpoints/matters/list.ts
    apps/web/app/api/endpoints/matters/detail.ts
    apps/web/app/api/endpoints/motions/list.ts
    apps/web/app/api/endpoints/motions/detail.ts
    apps/web/app/api/endpoints/bylaws/list.ts
    apps/web/app/api/endpoints/bylaws/detail.ts
    apps/web/app/api/endpoints/search.ts
  </files>
  <action>
  Add `tags` and `security` fields to the `schema` object of every `OpenAPIRoute` class. This makes Swagger UI group endpoints by category and shows lock icons on authenticated routes.

  For **each endpoint**, add these two fields to the existing `schema` object (do NOT replace other schema fields -- add alongside `summary`, `description`, `request`, `responses`):

  **Health endpoint** (`health.ts`):
  ```typescript
  tags: ["System"],
  // No security -- health is public
  ```

  **Test auth endpoint** (`test-auth.ts`):
  ```typescript
  tags: ["System"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Meetings list** (`meetings/list.ts`):
  ```typescript
  tags: ["Meetings"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Meeting detail** (`meetings/detail.ts`):
  ```typescript
  tags: ["Meetings"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **People list** (`people/list.ts`):
  ```typescript
  tags: ["People"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Person detail** (`people/detail.ts`):
  ```typescript
  tags: ["People"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Matters list** (`matters/list.ts`):
  ```typescript
  tags: ["Matters"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Matter detail** (`matters/detail.ts`):
  ```typescript
  tags: ["Matters"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Motions list** (`motions/list.ts`):
  ```typescript
  tags: ["Motions"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Motion detail** (`motions/detail.ts`):
  ```typescript
  tags: ["Motions"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Bylaws list** (`bylaws/list.ts`):
  ```typescript
  tags: ["Bylaws"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Bylaw detail** (`bylaws/detail.ts`):
  ```typescript
  tags: ["Bylaws"],
  security: [{ ApiKeyAuth: [] }],
  ```

  **Search endpoint** (`search.ts`):
  ```typescript
  tags: ["Search"],
  security: [{ ApiKeyAuth: [] }],
  ```

  Place `tags` and `security` as the first two fields in each `schema` object, before `summary`, for consistent ordering across all endpoints.
  </action>
  <verify>
  Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` to verify no TypeScript errors. Spot-check one endpoint file to confirm the fields are present.
  </verify>
  <done>
  All 13 endpoint schemas include `tags` for Swagger UI grouping. All authenticated endpoints (12 of 13, excluding health) include `security: [{ ApiKeyAuth: [] }]` so Swagger UI shows lock icons and the "Authorize" button applies the key to "Try it out" requests.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes in `apps/web/`
2. `pnpm build` succeeds in `apps/web/` (verifies runtime-compatible code)
3. Verify the OpenAPI spec conceptually: chanfana docs_url/openapi_url use relative paths, security scheme is registered, tags are defined, endpoint schemas have tags and security annotations
</verification>

<success_criteria>
- chanfana config uses `docs_url: "/docs"` and `openapi_url: "/openapi.json"` (relative to base `/api/v1`)
- Security scheme "ApiKeyAuth" registered with type "apiKey", in "header", name "X-API-Key"
- All 8 tags defined (System, Meetings, People, Matters, Motions, Bylaws, Search, OCD)
- All endpoint schemas have `tags` field
- All authenticated endpoint schemas have `security` field
- Error schema registered as reusable component
- OCD endpoints documented in spec (or gracefully omitted if registerPath doesn't support out-of-base paths)
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/18-documentation-key-management/18-01-SUMMARY.md`
</output>
