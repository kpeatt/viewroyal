---
phase: 18-documentation-key-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/routes/settings.api-keys.tsx
  - apps/web/app/routes/settings.tsx
autonomous: true
requirements:
  - DOCS-03
  - DOCS-04

must_haves:
  truths:
    - "Authenticated user can navigate to /settings/api-keys and see their existing API keys (prefix + creation date)"
    - "Authenticated user can create a new API key and see the full plaintext key exactly once with a copy button"
    - "User sees a clear warning that the key will not be shown again after dismissal"
    - "Authenticated user can revoke a key after confirming in a dialog that warns the key will stop working immediately"
    - "User cannot create more than 3 active API keys"
    - "Settings page at /settings has a visible navigation card linking to /settings/api-keys"
    - "Unauthenticated visitor is redirected to /login?redirectTo=/settings/api-keys"
    - "Key list shows only key prefix and creation date (never the full key or hash)"
  artifacts:
    - path: "apps/web/app/routes/settings.api-keys.tsx"
      provides: "API key management page with loader, action, and UI"
      min_lines: 100
  key_links:
    - from: "apps/web/app/routes/settings.api-keys.tsx"
      to: "api_keys table"
      via: "Supabase client in loader/action"
      pattern: "from.*api_keys"
    - from: "apps/web/app/routes/settings.api-keys.tsx"
      to: "apps/web/app/api/lib/api-key.ts"
      via: "import generateApiKey, hashApiKey"
      pattern: "import.*generateApiKey.*hashApiKey"
    - from: "apps/web/app/routes/settings.tsx"
      to: "/settings/api-keys"
      via: "Navigation card/link in settings hub"
      pattern: "settings/api-keys"
---

<objective>
Build a self-service API key management page where authenticated users can create, view (prefix + creation date), and revoke their API keys -- with inline reveal on creation, copy button, and confirmation dialog for revocation.

Purpose: Fulfills DOCS-03 (create/view/revoke keys) and DOCS-04 (show prefix + creation date only). Users can get API keys to use with the documented API without operator intervention.

Output: A new route at `/settings/api-keys` with full CRUD for API keys.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-documentation-key-management/18-RESEARCH.md

@apps/web/app/routes/settings.tsx
@apps/web/app/api/lib/api-key.ts
@apps/web/app/lib/supabase.server.ts
@apps/web/app/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API key management route with loader, actions, and UI</name>
  <files>apps/web/app/routes/settings.api-keys.tsx, apps/web/app/routes/settings.tsx</files>
  <action>
  Create a new React Router route at `apps/web/app/routes/settings.api-keys.tsx` following the existing settings page patterns.

  **Loader:**
  - Import `createSupabaseServerClient` from `~/lib/supabase.server`
  - Get user via `supabase.auth.getUser()` -- redirect to `/login?redirectTo=/settings/api-keys` if not authenticated
  - Query `api_keys` table: `select("id, key_prefix, is_active, created_at").eq("user_id", user.id).order("created_at", { ascending: false })`
  - Return `{ keys, user }`

  **Action** (handles two intents via `formData.get("intent")`):

  *Intent: `create_key`*
  - Get user (redirect if not authenticated)
  - Check active key count: `supabase.from("api_keys").select("id", { count: "exact", head: true }).eq("user_id", user.id).eq("is_active", true)`
  - If count >= 3, return `{ error: "Maximum 3 active API keys allowed. Revoke an existing key to create a new one." }`
  - Import `generateApiKey` and `hashApiKey` from `~/api/lib/api-key`
  - Generate key: `const plainKey = generateApiKey()`
  - Hash: `const keyHash = await hashApiKey(plainKey)`
  - Extract prefix: `const prefix = plainKey.substring(0, 8)` (produces "vr_xxxxx")
  - Insert into `api_keys`: `{ user_id: user.id, key_hash: keyHash, key_prefix: prefix, name: "Default", is_active: true }`
  - Return `{ newKey: plainKey, prefix, success: true }`
  - **CRITICAL:** Never log `plainKey`. It is returned to the client exactly once.

  *Intent: `revoke_key`*
  - Get user (redirect if not authenticated)
  - Get `key_id` from formData
  - Update: `supabase.from("api_keys").update({ is_active: false }).eq("id", key_id).eq("user_id", user.id)`
  - Return `{ success: true, revoked: true }`

  **Component UI (`export default function ApiKeysPage`):**

  Use the same visual language as `settings.tsx`:
  - `min-h-screen bg-zinc-50` wrapper
  - `container mx-auto py-12 px-4 max-w-2xl` content area
  - Header with icon (use `Key` from lucide-react) + "API Keys" title + subtitle "Create and manage API keys for the ViewRoyal.ai API."
  - Back link to `/settings` at the top

  **Sections:**

  1. **New Key Reveal** (shown only when `actionData?.newKey` is present):
     - Highlighted card with amber/yellow background (`bg-amber-50 border-amber-300`)
     - Show the full plaintext key in a monospace `<code>` block
     - Copy button (use `navigator.clipboard.writeText()` with a "Copied!" state toggle using `useState`)
     - Clear warning text: "Save this key now -- you will not see it again."
     - Dismiss button that clears the reveal (use local state `showNewKey` initialized from actionData)

  2. **Create Key Button:**
     - Show "Create API Key" button (use `<Form method="post">` with hidden `intent=create_key`)
     - Disable when active key count >= 3 (count from loaderData keys where `is_active === true`)
     - Show helper text: "X of 3 keys used" below the button

  3. **Active Keys List:**
     - Card for each active key showing:
       - Key prefix in monospace font (e.g., `vr_a3b1c`)
       - Creation date formatted as locale date string
       - "Active" badge (green)
       - Revoke button (red trash icon)
     - Revoke button opens a confirmation dialog (use the existing `Dialog` component from `~/components/ui/dialog`):
       - Title: "Revoke API Key"
       - Description: "Are you sure? This key will stop working immediately. Any applications using this key will lose access."
       - Cancel + Confirm buttons
       - On confirm, submit a `<Form method="post">` with `intent=revoke_key` and `key_id`

  4. **Revoked Keys Section** (if any):
     - Collapsed/muted list of revoked keys (is_active === false)
     - Key prefix + creation date + "Revoked" badge (zinc/gray)
     - No actions available

  5. **Info Section** at bottom:
     - Card with usage instructions:
       - "Pass your key in the `X-API-Key` header or as `?apikey=` query parameter"
       - Link to API docs: "Explore the API at [/api/v1/docs](/api/v1/docs)"
       - Note about rate limiting

  **Imports needed:**
  - `useState` from "react"
  - `Form, redirect, useActionData, useLoaderData, Link` from "react-router"
  - `createSupabaseServerClient` from `~/lib/supabase.server`
  - `generateApiKey, hashApiKey` from `~/api/lib/api-key`
  - `Button` from `~/components/ui/button`
  - `Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger` from `~/components/ui/dialog`
  - `Key, Copy, Trash2, Check, ArrowLeft, AlertTriangle, Plus` from "lucide-react"
  - Route type import: `import type { Route } from "./+types/settings.api-keys"`

  **Styling conventions** (match settings.tsx):
  - Section headers: `text-sm font-black uppercase tracking-widest text-zinc-400 mb-4 flex items-center gap-2`
  - Cards: `bg-white p-6 rounded-2xl border border-zinc-200 shadow-sm`
  - Buttons: Use shadcn `Button` component with appropriate variants

  **6. Add navigation link in settings.tsx:**
  In `apps/web/app/routes/settings.tsx`, add a navigation card linking to `/settings/api-keys` so the page is discoverable from the settings hub. Add it as a new section between the header and the Profile section (before `{/* Profile Section */}`):

  - Import `Key` from "lucide-react" (add to existing import) and `Link` from "react-router" (add to existing import if not present)
  - Add this JSX block:
  ```tsx
  {/* Quick Links */}
  <section className="mb-8">
    <Link
      to="/settings/api-keys"
      className="flex items-center gap-4 bg-white p-4 rounded-2xl border border-zinc-200 shadow-sm hover:border-zinc-300 hover:shadow transition-all group"
    >
      <div className="p-2 bg-amber-50 rounded-lg group-hover:bg-amber-100 transition-colors">
        <Key className="h-5 w-5 text-amber-600" />
      </div>
      <div>
        <h3 className="text-sm font-semibold text-zinc-900">API Keys</h3>
        <p className="text-xs text-zinc-500">Manage API keys for the ViewRoyal.ai API</p>
      </div>
    </Link>
  </section>
  ```
  </action>
  <verify>
  Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` to verify no TypeScript errors. Check that the file exists and has loader, action, and default export.
  </verify>
  <done>
  The route `/settings/api-keys` exists with: (1) loader fetching user's keys, (2) action handling create_key (with 3-key limit, plaintext shown once) and revoke_key (with is_active=false update), (3) UI showing key list with prefix + creation date, inline new key reveal with copy button and warning, revocation confirmation dialog, and helpful usage info. Unauthenticated users are redirected to login. The settings hub at `/settings` has a navigation card linking to `/settings/api-keys`.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes in `apps/web/`
2. The route file exports `loader`, `action`, and a default component
3. Key creation action generates key via `generateApiKey()`, hashes via `hashApiKey()`, stores only hash, returns plaintext once
4. Key revocation uses a confirmation dialog before submitting
5. Active key count is checked before creation (max 3)
6. Key list shows only `key_prefix` and `created_at` (never full key or hash)
</verification>

<success_criteria>
- Route at `/settings/api-keys` renders for authenticated users
- Unauthenticated users redirect to login with proper redirectTo
- Create action: generates key, hashes, stores hash + prefix, returns plaintext exactly once
- Create action: refuses if user already has 3 active keys
- Revoke action: sets is_active=false after confirmation dialog
- Key list: shows prefix (monospace) + creation date + active/revoked badge
- New key reveal: highlighted card with full key, copy button, "save now" warning, dismiss button
- Revocation dialog: warns key stops working immediately, has cancel + confirm
- Info section: links to API docs, explains usage
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/18-documentation-key-management/18-02-SUMMARY.md`
</output>
