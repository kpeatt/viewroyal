---
phase: 10-add-better-test-suite
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/vitest.config.ts
  - apps/web/package.json
  - apps/web/tests/setup.ts
  - apps/web/tests/lib/intent.test.ts
  - apps/web/tests/lib/supabase.server.test.ts
  - apps/web/tests/services/meetings.test.ts
  - apps/web/tsconfig.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "Running `pnpm test` from apps/web/ executes Vitest tests and shows coverage report"
    - "Intent classifier tests cover question marks, question starters, short keywords, long phrases, and edge cases"
    - "Supabase server client tests verify initialization patterns without hitting real Supabase"
    - "Meetings service tests validate query builder logic with mocked Supabase client"
  artifacts:
    - path: "apps/web/vitest.config.ts"
      provides: "Vitest configuration with coverage, env var handling, path aliases"
      min_lines: 20
    - path: "apps/web/tests/setup.ts"
      provides: "Test setup with env vars and global mocks"
      min_lines: 10
    - path: "apps/web/tests/lib/intent.test.ts"
      provides: "Comprehensive intent classifier tests"
      min_lines: 40
    - path: "apps/web/tests/services/meetings.test.ts"
      provides: "Meetings service query builder tests"
      min_lines: 50
  key_links:
    - from: "apps/web/vitest.config.ts"
      to: "apps/web/vite.config.ts"
      via: "Shares path aliases and env var define block"
      pattern: "defineConfig"
    - from: "apps/web/tests/lib/intent.test.ts"
      to: "apps/web/app/lib/intent.ts"
      via: "Direct import of classifyIntent"
      pattern: "classifyIntent"
---

<objective>
Set up Vitest for the web app and write server-layer tests for the highest-value targets: intent classifier (pure function), Supabase server client initialization, and meetings service query builders.

Purpose: Light but meaningful web app test coverage for server-side logic that drives search routing and data fetching.
Output: Vitest config, test setup, and tests for intent.ts, supabase.server.ts, meetings.ts.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-add-better-test-suite/10-RESEARCH.md

@apps/web/vite.config.ts
@apps/web/package.json
@apps/web/tsconfig.json
@apps/web/app/lib/intent.ts
@apps/web/app/lib/supabase.server.ts
@apps/web/app/services/meetings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vitest and configure for Cloudflare Workers compatibility</name>
  <files>
    apps/web/package.json
    apps/web/vitest.config.ts
    apps/web/tests/setup.ts
    apps/web/tsconfig.json
  </files>
  <action>
    1. Install Vitest and coverage:
       ```bash
       cd apps/web && pnpm add -D vitest @vitest/coverage-v8
       ```

    2. Create `vitest.config.ts` in `apps/web/`:
       ```typescript
       import { defineConfig } from "vitest/config";
       import path from "path";

       export default defineConfig({
         test: {
           globals: true,
           environment: "node",
           setupFiles: ["./tests/setup.ts"],
           include: ["tests/**/*.test.ts"],
           coverage: {
             provider: "v8",
             reporter: ["text", "html"],
             reportsDirectory: "./coverage",
             include: [
               "app/services/**",
               "app/routes/api.*",
               "app/lib/intent.ts",
               "app/lib/supabase.server.ts",
             ],
           },
         },
         resolve: {
           alias: {
             "~": path.resolve(__dirname, "./app"),
           },
         },
         // Define env vars the same way vite.config.ts does for Workers compatibility
         define: {
           "process.env.SUPABASE_URL": JSON.stringify("https://test.supabase.co"),
           "process.env.SUPABASE_SECRET_KEY": JSON.stringify("test-secret-key"),
           "process.env.VITE_SUPABASE_URL": JSON.stringify("https://test.supabase.co"),
           "process.env.VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY": JSON.stringify("test-anon-key"),
           "process.env.GEMINI_API_KEY": JSON.stringify("test-gemini-key"),
           "process.env.OPENAI_API_KEY": JSON.stringify("test-openai-key"),
           "process.env.VIMEO_PROXY_URL": JSON.stringify(""),
           "process.env.VIMEO_PROXY_FALLBACK_URL": JSON.stringify(""),
           "process.env.VIMEO_PROXY_API_KEY": JSON.stringify(""),
           "process.env.VIMEO_PROXY_FALLBACK_API_KEY": JSON.stringify(""),
           "process.env.VIMEO_TOKEN": JSON.stringify(""),
         },
       });
       ```

    3. Create `tests/setup.ts`:
       ```typescript
       // Global test setup for web app tests
       // Env vars are handled via vitest.config.ts define block
       // Add any global mocks here

       // Suppress console output in tests unless debugging
       // import { vi } from "vitest";
       // vi.spyOn(console, "log").mockImplementation(() => {});
       ```

    4. Add `"test": "vitest"` script to `package.json` scripts section. Keep any existing scripts. Also add `"test:coverage": "vitest run --coverage"`.

    5. Add `coverage/` to `.gitignore` in `apps/web/` if one exists, or to the root `.gitignore`.

    6. If `tsconfig.json` doesn't include `tests/` in its paths, add `"tests"` to the `include` array or ensure vitest can resolve imports.
  </action>
  <verify>
    `cd apps/web && pnpm test run` -- Vitest initializes without errors (0 tests found is fine at this stage).
    `pnpm test:coverage` -- coverage report generates without errors.
  </verify>
  <done>Vitest installed, configured with env vars matching vite.config.ts define block, test setup file created, test scripts added to package.json.</done>
</task>

<task type="auto">
  <name>Task 2: Write server-layer tests for intent, supabase.server, and meetings service</name>
  <files>
    apps/web/tests/lib/intent.test.ts
    apps/web/tests/lib/supabase.server.test.ts
    apps/web/tests/services/meetings.test.ts
  </files>
  <action>
    1. **Create `tests/lib/intent.test.ts`** -- comprehensive intent classifier tests:
       - Question mark detection (ends with ?)
       - Question starter words (who, what, when, where, why, how, is, are, etc.)
       - Multi-word starters ("tell me", "explain", "describe", "compare")
       - Short keyword queries (1-3 words -> "keyword")
       - Long phrases (5+ words without markers -> "question")
       - 4-word ambiguous queries (defaults to "question")
       - Empty string (returns "keyword")
       - Case insensitivity
       - Edge cases: single question word alone, trailing whitespace, mixed case

       This is a pure function test -- no mocks needed. Import directly from `~/lib/intent` or `../../app/lib/intent`.

    2. **Create `tests/lib/supabase.server.test.ts`** -- test server client initialization:
       - Read `app/lib/supabase.server.ts` first to understand the exports (createSupabaseServerClient, getSupabaseAdminClient)
       - Mock `@supabase/ssr` and `@supabase/supabase-js` with `vi.mock()`
       - Test that `getSupabaseAdminClient()` returns a singleton (calling twice returns same instance)
       - Test that `createSupabaseServerClient()` creates a client with correct URL and key
       - Test that it uses request cookies for auth context
       - Verify env vars are correctly passed through

    3. **Create `tests/services/meetings.test.ts`** -- meetings service query logic:
       - Read `app/services/meetings.ts` to understand the exported functions
       - Mock Supabase client (pass as argument or mock the import)
       - Test `getMeetings()` or equivalent with various filter combinations:
         - No filters returns all meetings
         - Date range filtering
         - Meeting type filtering
         - Pagination (limit/offset)
       - Test `getMeetingById()` with valid ID returns meeting data
       - Test `getMeetingById()` with invalid ID returns null/error
       - Test that select strings include expected columns (no neighborhood column per CLAUDE.md)
       - Focus on testing the query construction logic, not Supabase responses

    4. Run all tests: `pnpm test run`
  </action>
  <verify>
    `cd apps/web && pnpm test run` -- all tests pass.
    `pnpm test run --reporter=verbose` -- shows individual test names.
    At least 10 intent tests pass, at least 3 supabase.server tests pass, at least 5 meetings tests pass.
  </verify>
  <done>Web app server-layer tests written and passing for intent classifier, Supabase initialization, and meetings service query builders.</done>
</task>

</tasks>

<verification>
1. `cd apps/web && pnpm test run` -- all tests pass
2. `pnpm test:coverage` -- coverage report shows coverage for intent.ts, supabase.server.ts, meetings.ts
3. Tests don't hit real Supabase or any external services
4. Tests run in under 10 seconds total
</verification>

<success_criteria>
- Vitest installed and configured with coverage reporting
- Intent classifier has 10+ tests covering all branches
- Supabase server initialization tests verify singleton and client creation
- Meetings service tests validate query builder patterns
- All tests pass and generate coverage report
- No real external service calls made during tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-add-better-test-suite/10-02-SUMMARY.md`
</output>
