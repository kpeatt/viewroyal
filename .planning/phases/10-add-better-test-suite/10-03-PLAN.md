---
phase: 10-add-better-test-suite
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - apps/pipeline/tests/core/test_alignment.py
  - apps/pipeline/tests/core/test_matter_matching.py
  - apps/pipeline/tests/core/test_paths.py
  - apps/pipeline/tests/ingestion/test_ingester.py
  - apps/pipeline/tests/ingestion/test_ai_refiner.py
  - apps/pipeline/tests/ingestion/test_document_extractor.py
  - apps/pipeline/tests/ingestion/test_embed.py
  - apps/pipeline/tests/ingestion/test_audit.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "MeetingIngester pure functions (to_seconds, extract_identifier, normalize_address_list) have comprehensive tests"
    - "AI refiner tests verify Gemini interaction, retry logic, and agenda-only vs full refinement modes"
    - "Document extractor tests verify orchestration logic with mocked Gemini and PyMuPDF"
    - "Embedding generation tests verify OpenAI API interaction and batch processing with mocks"
    - "Alignment, matter matching, and path utilities have unit tests for their core logic"
    - "Audit module tests verify disk-vs-DB comparison logic"
  artifacts:
    - path: "apps/pipeline/tests/ingestion/test_ingester.py"
      provides: "MeetingIngester pure function tests (to_seconds, extract_identifier, normalize_address_list)"
      min_lines: 80
    - path: "apps/pipeline/tests/ingestion/test_ai_refiner.py"
      provides: "AI refiner tests covering Gemini mocking, retry, agenda-only mode"
      min_lines: 60
    - path: "apps/pipeline/tests/ingestion/test_document_extractor.py"
      provides: "Document extraction orchestrator tests"
      min_lines: 40
    - path: "apps/pipeline/tests/ingestion/test_embed.py"
      provides: "Embedding generation tests with mocked OpenAI"
      min_lines: 40
    - path: "apps/pipeline/tests/core/test_alignment.py"
      provides: "Transcript-agenda alignment tests"
      min_lines: 30
  key_links:
    - from: "apps/pipeline/tests/ingestion/test_ai_refiner.py"
      to: "apps/pipeline/pipeline/ingestion/ai_refiner.py"
      via: "unittest.mock.patch on module-level client singleton"
      pattern: "patch.*ai_refiner\\.client"
    - from: "apps/pipeline/tests/ingestion/test_ingester.py"
      to: "apps/pipeline/pipeline/ingestion/ingester.py"
      via: "Direct import of pure functions + MeetingIngester class"
      pattern: "from pipeline\\.ingestion\\.ingester import"
---

<objective>
Write comprehensive tests for pipeline core utilities (alignment, matter matching, paths) and ingestion modules (ingester pure functions, AI refiner, document extractor, embed, audit). This is the bulk of pipeline test coverage.

Purpose: Cover the highest-risk code paths -- ingestion is where data quality issues originate and where expensive mistakes happen.
Output: 8 new test files covering core utilities and all major ingestion modules.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-add-better-test-suite/10-RESEARCH.md
@.planning/phases/10-add-better-test-suite/10-01-SUMMARY.md

@apps/pipeline/tests/conftest.py
@apps/pipeline/pipeline/ingestion/ingester.py
@apps/pipeline/pipeline/ingestion/ai_refiner.py
@apps/pipeline/pipeline/ingestion/document_extractor.py
@apps/pipeline/pipeline/ingestion/gemini_extractor.py
@apps/pipeline/pipeline/ingestion/embed.py
@apps/pipeline/pipeline/ingestion/audit.py
@apps/pipeline/pipeline/alignment.py
@apps/pipeline/pipeline/ingestion/matter_matching.py
@apps/pipeline/pipeline/paths.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Core utility tests (alignment, matter_matching, paths) and ingester pure functions</name>
  <files>
    apps/pipeline/tests/core/test_alignment.py
    apps/pipeline/tests/core/test_matter_matching.py
    apps/pipeline/tests/core/test_paths.py
    apps/pipeline/tests/ingestion/test_ingester.py
  </files>
  <action>
    1. **Read source modules** to understand their public APIs:
       - `pipeline/alignment.py` -- look for `align_meeting_items` and any helpers
       - `pipeline/ingestion/matter_matching.py` -- look for `MatterMatcher` class and methods
       - `pipeline/paths.py` -- look for path resolution functions
       - `pipeline/ingestion/ingester.py` -- focus on pure functions: `to_seconds`, `extract_identifier_from_text`, `normalize_address_list`, and any other utility methods

    2. **Create `tests/core/test_alignment.py`:**
       - Test `align_meeting_items` with matching agenda+minutes items
       - Test with no overlap (items only in agenda)
       - Test with items only in minutes
       - Test empty inputs
       - Test boundary: items with similar but not identical titles

    3. **Create `tests/core/test_matter_matching.py`:**
       - Test `MatterMatcher` initialization and matching logic
       - Test exact match, fuzzy match, and no match cases
       - Test deduplication behavior
       - Test with empty matter list

    4. **Create `tests/core/test_paths.py`:**
       - Test path resolution functions with various inputs
       - Test with existing and non-existing paths
       - Use `tmp_path` fixture for filesystem tests

    5. **Create `tests/ingestion/test_ingester.py`:**
       Following the research example patterns:
       - `TestToSeconds`: float passthrough, int passthrough, HH:MM:SS, MM:SS, None, invalid string
       - `TestExtractIdentifier`: bylaw numbers, amendment bylaws, rezoning, development permits, no identifier, None input
       - `TestNormalizeAddressList`: None, list passthrough, multi-number pattern ("105, 106 and 107 Glentana Road"), comma-separated addresses, single address string, empty string
       - These are pure functions that don't need mocks (MeetingIngester can be constructed with dummy URLs for testing pure methods, or test the functions directly if they're module-level)
       - Note: `MeetingIngester.__init__` calls `create_client()` which may need patching. If so, patch `pipeline.ingestion.ingester.create_client` to return a MagicMock.

    6. Create `tests/ingestion/__init__.py` if it doesn't exist.
  </action>
  <verify>
    `cd apps/pipeline && uv run pytest tests/core/test_alignment.py tests/core/test_matter_matching.py tests/core/test_paths.py tests/ingestion/test_ingester.py -v`
    All tests pass. At least 15 tests across these 4 files.
  </verify>
  <done>Core utility and ingester pure function tests cover happy paths, edge cases, and error paths.</done>
</task>

<task type="auto">
  <name>Task 2: Ingestion module tests (ai_refiner, document_extractor, embed, audit)</name>
  <files>
    apps/pipeline/tests/ingestion/test_ai_refiner.py
    apps/pipeline/tests/ingestion/test_document_extractor.py
    apps/pipeline/tests/ingestion/test_embed.py
    apps/pipeline/tests/ingestion/test_audit.py
  </files>
  <action>
    1. **Read source modules** to understand public APIs and singleton patterns:
       - `pipeline/ingestion/ai_refiner.py` -- has module-level `client` and `local_client` singletons, `refine_meeting_data` function, `_merge_refinements` helper, Pydantic models
       - `pipeline/ingestion/document_extractor.py` -- orchestrator for document extraction
       - `pipeline/ingestion/embed.py` -- embedding generation with OpenAI
       - `pipeline/ingestion/audit.py` -- disk-vs-DB comparison logic

    2. **Create `tests/ingestion/test_ai_refiner.py`:**
       Merge/restructure the concepts from existing `test_agenda_only.py` and `test_local_refiner_logic.py` into a comprehensive file:
       - `TestRefineMeetingData`:
         - Full refinement (all 3 inputs): mock Gemini, verify result structure
         - Agenda-only mode (only agenda text): verify different prompt path
         - Gemini failure with retries: mock side_effect=Exception, verify retry count
         - No API key available: patch `client` to None, verify graceful return
       - `TestMergeRefinements`:
         - Merge two partial refinements (keep the test logic from the now-fixed test_local_refiner_logic.py, but add more cases)
         - Empty items merge
         - Overlapping items merge
       - Patch at `pipeline.ingestion.ai_refiner.client` (module-level singleton)
       - DO NOT delete the existing test files (test_agenda_only.py, test_local_refiner_logic.py) -- they'll continue to pass alongside the new tests

    3. **Create `tests/ingestion/test_document_extractor.py`:**
       - Read the module to find the main orchestration function (likely `extract_documents` or similar)
       - Test with mocked Gemini extractor responses
       - Test fallback to PyMuPDF chunker when Gemini fails
       - Test with no PDFs (empty directory)
       - Test with PDF that has no extractable content
       - Mock file system operations using `tmp_path`

    4. **Create `tests/ingestion/test_embed.py`:**
       - Read the module to find the embedding functions (likely `generate_embeddings` or `embed_texts`)
       - Mock OpenAI embeddings API (`openai.Client.embeddings.create`)
       - Test batch processing (multiple texts)
       - Test empty text handling
       - Test MAX_EMBED_CHARS truncation
       - Test error handling when API fails

    5. **Create `tests/ingestion/test_audit.py`:**
       - Read the module to find audit functions
       - Test disk-vs-DB comparison with matching and mismatching data
       - Test with empty DB results
       - Test with empty disk directory
       - Use `tmp_path` for filesystem operations

    6. Run all new tests to confirm they pass.
  </action>
  <verify>
    `cd apps/pipeline && uv run pytest tests/ingestion/ -v`
    All ingestion tests pass. At least 20 tests across the 4 new files.
    `uv run pytest -v` -- full suite still passes (existing + new tests).
  </verify>
  <done>AI refiner, document extractor, embed, and audit modules have comprehensive tests with mocked external services.</done>
</task>

</tasks>

<verification>
1. `cd apps/pipeline && uv run pytest -v` -- all tests pass (existing + new)
2. `uv run pytest --cov=pipeline --cov-report=term-missing` -- coverage has increased significantly from baseline
3. No test hits real Supabase, Gemini, OpenAI, or any external service
4. Tests run in under 30 seconds total
</verification>

<success_criteria>
- 8 new test files created covering core utilities and ingestion modules
- At least 35 new tests passing
- Ingester pure functions have comprehensive coverage (to_seconds, extract_identifier, normalize_address_list)
- AI refiner tests cover full/agenda-only mode, retry logic, and no-API-key graceful handling
- Document extractor, embed, and audit modules have meaningful test coverage
- All external services are mocked; no network calls during tests
- Full test suite (existing + new) passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/10-add-better-test-suite/10-03-SUMMARY.md`
</output>
