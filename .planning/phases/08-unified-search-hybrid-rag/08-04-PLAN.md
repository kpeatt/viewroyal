---
phase: 08-unified-search-hybrid-rag
plan: 04
type: execute
wave: 4
depends_on:
  - 08-03
files_modified:
  - apps/web/app/routes/search.tsx
  - apps/web/app/components/search/follow-up.tsx
  - apps/web/app/routes/ask.tsx
  - apps/web/app/components/navbar.tsx
  - apps/web/app/components/ask-question.tsx
  - apps/web/app/components/home/hero-section.tsx
requirements:
  - SRCH-01
  - SRCH-05
  - SRCH-06
autonomous: true
must_haves:
  truths:
    - "User can ask follow-up questions that reference previous AI answers in the same session"
    - "Conversation history is limited to the last 5 turns"
    - "Follow-up questions show suggested question chips below the AI answer"
    - "The /ask route redirects 301 to /search with query preserved"
    - "Navbar shows single 'Search' nav item instead of 'Ask' and search icon"
    - "Home page hero search navigates to /search instead of /ask"
    - "New search button clears conversation context"
  artifacts:
    - path: "apps/web/app/components/search/follow-up.tsx"
      provides: "Suggested follow-up question chips"
      min_lines: 20
    - path: "apps/web/app/routes/ask.tsx"
      provides: "301 redirect from /ask to /search"
      min_lines: 5
  key_links:
    - from: "apps/web/app/routes/search.tsx"
      to: "/api/search"
      via: "context parameter for follow-up"
      pattern: "context.*encodeURIComponent"
    - from: "apps/web/app/components/ask-question.tsx"
      to: "/search"
      via: "buildAskUrl returns /search URL"
      pattern: "/search\\?"
    - from: "apps/web/app/routes/ask.tsx"
      to: "/search"
      via: "301 redirect"
      pattern: "redirect.*301"
---

<objective>
Add conversation continuity (follow-up questions), navigation updates, and redirects to complete the unified search experience.

Purpose: The search page needs follow-up question support, and all old navigation pointing to /ask must redirect to /search. This plan wires up conversation memory, adds follow-up UI, updates all navigation links, and sets up the /ask redirect.

Output: Follow-up conversation support, /ask redirect, updated navbar and hero section, suggested follow-up chips.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-unified-search-hybrid-rag/08-RESEARCH.md
@.planning/phases/08-unified-search-hybrid-rag/08-03-SUMMARY.md

Key existing files:
@apps/web/app/routes/search.tsx
@apps/web/app/routes/ask.tsx
@apps/web/app/components/navbar.tsx
@apps/web/app/components/ask-question.tsx
@apps/web/app/components/home/hero-section.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add follow-up conversation support to search page</name>
  <files>apps/web/app/routes/search.tsx, apps/web/app/components/search/follow-up.tsx</files>
  <action>
**Create `apps/web/app/components/search/follow-up.tsx`:**

A component that shows 2-3 suggested follow-up question chips below the AI answer.

Props: `{ suggestions: string[]; onSelect: (q: string) => void; disabled: boolean }`

Design:
- Horizontal row of pill-shaped buttons
- Each chip: `text-xs px-3 py-1.5 bg-zinc-100 hover:bg-blue-50 hover:text-blue-700 rounded-full text-zinc-600 transition-colors font-medium`
- Prefixed with "Follow up:" label in zinc-400
- Hidden when `suggestions.length === 0`

**Update `apps/web/app/routes/search.tsx` for conversation continuity:**

Add the following state and behavior to the search page:

1. **Conversation state:**
```typescript
const conversationRef = useRef<{ question: string; answer: string }[]>([]);
const [suggestedFollowups, setSuggestedFollowups] = useState<string[]>([]);
```

2. **Build conversation context** when making follow-up queries:
```typescript
function buildConversationContext(): string | undefined {
  const history = conversationRef.current;
  if (history.length === 0) return undefined;

  // Limit to last 5 turns (SRCH-06)
  const recent = history.slice(-5);
  return recent
    .map((turn) => `Q: ${turn.question}\nA: ${turn.answer}`)
    .join('\n\n');
}
```

3. **After AI answer completes** (on "done" event from EventSource):
- Push `{ question: currentQuery, answer: fullAnswer }` to `conversationRef.current`
- Keep only last 5 entries: `conversationRef.current = conversationRef.current.slice(-5)`
- Generate 2-3 suggested follow-up questions by prompting Gemini (or simpler: derive from the answer's topic). For simplicity, use a rule-based approach:
  - Parse the answer for entities (councillor names, dates, topics)
  - Generate questions like: "Who voted against it?", "What happened before that?", "Are there related motions?"
  - OR: Emit suggested_followups from the API (add to the RAG agent's final synthesis prompt: "After your answer, suggest 2-3 follow-up questions the citizen might want to ask. Return them as a JSON array in a `suggested_followups` field.")

For the initial implementation, use a simple approach: after the AI answer completes, make a small fetch call to generate followups, OR hard-code 3 contextual follow-up patterns based on the query topic:
  - "What were the specific votes on this?"
  - "Who spoke about this in council?"
  - "Are there any related documents?"

A better approach: Emit suggested follow-ups from the streaming endpoint. Update the RAG streaming to emit a `suggested_followups` event type after the "sources" event and before "done":
```typescript
// In api.search.tsx streaming handler, after collecting full answer:
// Generate follow-ups using Gemini
const followupPrompt = `Based on this civic question and answer, suggest 2-3 natural follow-up questions a citizen might ask. Return ONLY a JSON array of strings, nothing else.\n\nQuestion: ${question}\n\nAnswer summary: ${answer.slice(0, 500)}`;
const followupResult = await model.generateContent([followupPrompt]);
const followups = JSON.parse(followupResult.response.text().trim());
enqueue({ type: "suggested_followups", followups });
```

Add `| { type: "suggested_followups"; followups: string[] }` to the `AgentEvent` type in rag.server.ts.

Handle this event in search.tsx:
```typescript
case "suggested_followups":
  setSuggestedFollowups(data.followups || []);
  break;
```

4. **Topic change detection:**
When a new query is submitted:
```typescript
function isTopicChange(newQuery: string, history: { question: string }[]): boolean {
  if (history.length === 0) return false;
  const lastQ = history[history.length - 1].question.toLowerCase();
  const newQ = newQuery.toLowerCase();
  // Simple: check if they share any significant words (3+ chars)
  const lastWords = new Set(lastQ.split(/\s+/).filter(w => w.length >= 3));
  const newWords = newQ.split(/\s+/).filter(w => w.length >= 3);
  const shared = newWords.filter(w => lastWords.has(w));
  return shared.length === 0; // No shared words = topic change
}
```

If topic changes: clear `conversationRef.current`, clear `suggestedFollowups`, start fresh.

5. **"New search" clear button:**
Add a small "New search" button (X icon + text) that:
- Clears conversationRef.current
- Clears suggestedFollowups
- Clears the query input
- Resets to empty state
- Clears URL params

Position it next to the search input or as a subtle link below the answer.

6. **Follow-up UI integration:**
After the AI answer card and source cards, show the FollowUp component:
```tsx
{!isStreaming && suggestedFollowups.length > 0 && (
  <FollowUp
    suggestions={suggestedFollowups}
    onSelect={(q) => {
      setLocalQuery(q);
      // Trigger search with follow-up context
      performSearch(q);
    }}
    disabled={isStreaming}
  />
)}
```

When a follow-up is selected, the search includes context from previous turns.

7. **Input placement for follow-ups:**
When in results mode (answer showing), add a secondary input at the bottom (sticky, like ask.tsx):
```tsx
<div className="sticky bottom-0 py-4 bg-zinc-50/80 backdrop-blur-md">
  <form onSubmit={handleSearch} className="relative">
    <Input placeholder="Ask a follow-up or new question..." ... />
    <Button type="submit" ... />
  </form>
</div>
```

This follow-up input is in addition to the top search bar. The top search bar is always visible for new searches; the bottom input is a convenience for follow-ups.
  </action>
  <verify>
Run `cd /Users/kyle/development/viewroyal/apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` to verify compilation.
Check: `grep -c 'conversationRef\|suggestedFollowups\|FollowUp' apps/web/app/routes/search.tsx` should return multiple matches.
  </verify>
  <done>Follow-up questions work with conversation context. Last 5 turns tracked. Suggested follow-up chips appear below AI answer. Topic change auto-clears context. "New search" button resets everything.</done>
</task>

<task type="auto">
  <name>Task 2: Update navigation and add /ask redirect</name>
  <files>apps/web/app/routes/ask.tsx, apps/web/app/components/navbar.tsx, apps/web/app/components/ask-question.tsx, apps/web/app/components/home/hero-section.tsx</files>
  <action>
**1. Replace `apps/web/app/routes/ask.tsx` with a 301 redirect:**

Remove all the existing ask.tsx content and replace with:
```typescript
import { redirect } from "react-router";
import type { Route } from "./+types/ask";

export function loader({ request }: Route.LoaderArgs) {
  const url = new URL(request.url);
  const q = url.searchParams.get("q");
  const person = url.searchParams.get("person");
  const params = new URLSearchParams();
  if (q) params.set("q", q);
  if (person) params.set("person", person);
  const searchUrl = params.toString() ? `/search?${params.toString()}` : "/search";
  return redirect(searchUrl, 301);
}

export default function AskRedirect() {
  return null; // Never rendered due to redirect
}
```

This preserves backward compatibility: old `/ask?q=...` links will 301 to `/search?q=...`.

**2. Update `apps/web/app/components/navbar.tsx`:**

Desktop navigation changes:
- Replace the "Ask" NavLink (`href="/ask"`, icon=Sparkles) with "Search" NavLink (`href="/search"`, icon=Search)
- Remove the separate Search icon button in the right section (the magnifying glass icon that links to /search)
- The Search nav item replaces both the Ask link and the separate search icon

Mobile navigation changes:
- Replace the "Ask" MobileNavLink with "Search" pointing to `/search`
- Keep the same position in the nav order

Updated desktop nav should look like:
```tsx
<NavLink name="Search" href="/search" icon={Search} isActive={isLinkActive("/search")} />
<NavLink name="Meetings" href="/meetings" icon={Calendar} isActive={isLinkActive("/meetings")} />
{/* ... rest of nav */}
```

Remove the standalone search icon button:
```tsx
{/* DELETE THIS: */}
<Link to="/search" className="p-2 text-zinc-400 hover:text-zinc-900 ..." aria-label="Search">
  <Search className="h-5 w-5" />
</Link>
```

**3. Update `apps/web/app/components/ask-question.tsx`:**

Change `buildAskUrl` to navigate to `/search` instead of `/ask`:
```typescript
const buildAskUrl = (q: string) => {
  const params = new URLSearchParams({ q });
  if (personName) params.set("person", personName);
  return `/search?${params.toString()}`;
};
```

No other changes needed -- the component is used on the hero section and person profile pages.

**4. Update `apps/web/app/components/home/hero-section.tsx`:**

The hero section uses the AskQuestion component which now navigates to /search (via the change above). No direct changes needed to hero-section.tsx itself since AskQuestion handles the URL.

However, verify that the hero section still works correctly after the AskQuestion change. The AskQuestion component should still render the same UI -- just navigate to /search instead of /ask.

**5. Keep api.ask.tsx for backward compatibility:**

Do NOT remove or modify `apps/web/app/routes/api.ask.tsx`. It should remain functional for any external integrations or bookmarks. It already works independently.
  </action>
  <verify>
Run `cd /Users/kyle/development/viewroyal/apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` to verify compilation.
Verify redirect: `grep 'redirect' apps/web/app/routes/ask.tsx`
Verify navbar: `grep -c '/ask' apps/web/app/components/navbar.tsx` should return 0 (no more /ask links).
Verify ask-question: `grep '/search' apps/web/app/components/ask-question.tsx` should match.
  </verify>
  <done>/ask redirects 301 to /search. Navbar shows single "Search" nav item. Hero section AskQuestion navigates to /search. No broken links to /ask remain in navigation.</done>
</task>

</tasks>

<verification>
1. Navigating to `/ask?q=test` redirects to `/search?q=test`
2. Navbar shows "Search" link pointing to /search (no "Ask" link)
3. No search icon button in navbar right section (merged into Search nav item)
4. Home page hero "Ask a Question" navigates to /search
5. Person profile AskQuestion component navigates to /search
6. Follow-up questions include context from previous answers
7. Suggested follow-up chips appear after AI answer completes
8. Conversation limited to last 5 turns
9. "New search" button clears conversation and resets
10. Topic changes auto-clear conversation context
</verification>

<success_criteria>
- Follow-up questions work with conversation memory
- Conversation capped at 5 turns
- Suggested follow-up chips appear
- Topic change detection auto-clears context
- All /ask links redirect to /search
- Navigation unified -- single "Search" entry point
- No dead links to /ask anywhere in the UI
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/08-unified-search-hybrid-rag/08-04-SUMMARY.md`
</output>
