---
phase: 16-core-data-search-api
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - apps/web/app/api/serializers/matter.ts
  - apps/web/app/api/serializers/motion.ts
  - apps/web/app/api/serializers/bylaw.ts
  - apps/web/app/api/endpoints/matters/list.ts
  - apps/web/app/api/endpoints/matters/detail.ts
  - apps/web/app/api/endpoints/motions/list.ts
  - apps/web/app/api/endpoints/motions/detail.ts
  - apps/web/app/api/endpoints/bylaws/list.ts
  - apps/web/app/api/endpoints/bylaws/detail.ts
  - apps/web/app/api/index.ts
autonomous: true
requirements: [DATA-05, DATA-06, DATA-07, DATA-08, DATA-09, DATA-10]

must_haves:
  truths:
    - "API consumer can list matters with filters (status, category, date range) and cursor pagination at GET /api/v1/:municipality/matters"
    - "API consumer can get matter detail with agenda item timeline at GET /api/v1/:municipality/matters/:slug"
    - "API consumer can list motions with filters (result, meeting, mover) and cursor pagination at GET /api/v1/:municipality/motions"
    - "API consumer can get motion detail with individual roll call votes at GET /api/v1/:municipality/motions/:slug"
    - "API consumer can list bylaws with filters (status, category, year) and cursor pagination at GET /api/v1/:municipality/bylaws"
    - "API consumer can get bylaw detail with linked matters at GET /api/v1/:municipality/bylaws/:slug"
  artifacts:
    - path: "apps/web/app/api/serializers/matter.ts"
      provides: "Matter summary and detail serializers"
      exports: ["serializeMatterSummary", "serializeMatterDetail"]
    - path: "apps/web/app/api/serializers/motion.ts"
      provides: "Motion summary and detail serializers"
      exports: ["serializeMotionSummary", "serializeMotionDetail"]
    - path: "apps/web/app/api/serializers/bylaw.ts"
      provides: "Bylaw summary and detail serializers"
      exports: ["serializeBylawSummary", "serializeBylawDetail"]
    - path: "apps/web/app/api/endpoints/matters/list.ts"
      provides: "ListMatters chanfana endpoint"
      exports: ["ListMatters"]
    - path: "apps/web/app/api/endpoints/motions/list.ts"
      provides: "ListMotions chanfana endpoint"
      exports: ["ListMotions"]
    - path: "apps/web/app/api/endpoints/bylaws/list.ts"
      provides: "ListBylaws chanfana endpoint"
      exports: ["ListBylaws"]
  key_links:
    - from: "apps/web/app/api/endpoints/motions/detail.ts"
      to: "votes table"
      via: "Supabase query for roll call votes by motion_id"
      pattern: "from\\(['\"]votes['\"]\\)"
    - from: "apps/web/app/api/endpoints/matters/detail.ts"
      to: "agenda_items table"
      via: "Supabase query for agenda items timeline by matter_id"
      pattern: "from\\(['\"]agenda_items['\"]\\)"
    - from: "apps/web/app/api/index.ts"
      to: "endpoint classes"
      via: "route registration"
      pattern: "ListMatters|ListMotions|ListBylaws"
---

<objective>
Implement matters, motions, and bylaws REST endpoints with list + detail views, cursor pagination, filters, serializers, and route registration.

Purpose: Complete the data endpoint coverage for all civic entity types. Matters track council business over time, motions capture votes and decisions, and bylaws are the resulting legislation. Together with meetings and people (Plan 02), this completes DATA-01 through DATA-10.

Output: 3 serializer modules, 6 chanfana endpoint classes, and updated route registration in index.ts.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/16-core-data-search-api/16-RESEARCH.md
@.planning/phases/16-core-data-search-api/16-01-SUMMARY.md
@apps/web/app/api/index.ts
@apps/web/app/api/types.ts
@apps/web/app/api/lib/api-errors.ts
@apps/web/app/api/lib/cursor.ts
@apps/web/app/api/lib/envelope.ts
@apps/web/app/services/matters.ts
@apps/web/app/services/bylaws.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create matter, motion, and bylaw serializers plus list/detail endpoints</name>
  <files>
    apps/web/app/api/serializers/matter.ts
    apps/web/app/api/serializers/motion.ts
    apps/web/app/api/serializers/bylaw.ts
    apps/web/app/api/endpoints/matters/list.ts
    apps/web/app/api/endpoints/matters/detail.ts
    apps/web/app/api/endpoints/motions/list.ts
    apps/web/app/api/endpoints/motions/detail.ts
    apps/web/app/api/endpoints/bylaws/list.ts
    apps/web/app/api/endpoints/bylaws/detail.ts
  </files>
  <action>
**Serializers** (allowlist pattern -- explicitly list included fields, never spread `...row`):

**matter.ts:**
- `serializeMatterSummary(row)` -- Returns: `{ slug, title, status, category, description (truncated to 200 chars or null), first_seen, last_seen }`. All snake_case, nulls included.
- `serializeMatterDetail(row, related)` -- Returns: `{ ...summary fields, plain_english_summary, agenda_items (array of { slug, title, meeting_slug, meeting_date, item_number } timeline summaries sorted by date DESC), motions (array of { slug, text (truncated), result, meeting_date } summaries) }`.
- Export `serializeMatterTimelineItem(item)` helper.

**motion.ts:**
- `serializeMotionSummary(row)` -- Returns: `{ slug, text (plain_english_summary or text_content truncated to 200 chars), result, mover_name (from person join or null), seconder_name (from person join or null), meeting_slug, meeting_date }`.
- `serializeMotionDetail(row, related)` -- Returns: `{ ...summary fields, text_content (full text), plain_english_summary, agenda_item_slug, agenda_item_title, votes (array of { person_slug, person_name, vote_value } roll call records) }`.
- Export `serializeVoteSummary(vote)` helper for the roll call votes array.

**bylaw.ts:**
- `serializeBylawSummary(row)` -- Returns: `{ slug, title, bylaw_number, status, category, year (extract from date or bylaw_number) }`.
- `serializeBylawDetail(row, related)` -- Returns: `{ ...summary fields, description, plain_english_summary, matters (array of { slug, title, status } matter summaries linked via matters.bylaw_id FK) }`.

**Endpoints** (extend chanfana `OpenAPIRoute`):

**matters/list.ts -- ListMatters:**
- Query params: `cursor`, `per_page` (default 20, max 100), `status` (optional), `category` (optional), `date_from` (optional -- filter on last_seen), `date_to` (optional).
- Sort: `last_seen DESC, id DESC` (most recently active first). Handle NULL last_seen by using `COALESCE(last_seen, first_seen)` -- express via Supabase `.order("last_seen", { ascending: false, nullsFirst: false })`.
- Apply cursor keyset pagination on (last_seen, id).

**matters/detail.ts -- GetMatter:**
- Lookup by slug + municipality_id. Fetch agenda_items (with meeting join for meeting_slug + meeting_date) and motions in parallel. Return timeline sorted by date DESC.

**motions/list.ts -- ListMotions:**
- Query params: `cursor`, `per_page` (default 20, max 100), `result` (optional -- e.g., "Carried", "Defeated"), `meeting` (optional -- meeting slug filter), `mover` (optional -- person slug filter).
- Sort: `id DESC` (chronological, most recent first).
- Join with `people` (mover/seconder) and `meetings` (for meeting_slug/date) and `agenda_items` (for agenda_item reference).
- For `meeting` filter: join meetings and filter by `meetings.slug`.
- For `mover` filter: join people via mover_id and filter by `people.slug`.

**motions/detail.ts -- GetMotion:**
- Lookup by slug + municipality_id (motions.municipality_id). Fetch motion with person joins (mover, seconder), meeting join, agenda_item join. Fetch votes with person join in parallel. Include full roll call in `votes` array.

**bylaws/list.ts -- ListBylaws:**
- Query params: `cursor`, `per_page` (default 20, max 100), `status` (optional), `category` (optional), `year` (optional coerce number).
- Sort: `id DESC` (most recent first). Bylaws table is small (43 rows) but paginate for API consistency.
- For `year` filter: filter on bylaw_number pattern or a date field if available.

**bylaws/detail.ts -- GetBylaw:**
- Lookup by slug + municipality_id. Fetch related matters via the `matters.bylaw_id` FK (confirmed: `matters` table has `bylaw_id` column referencing `bylaws.id`). Query: `supabase.from("matters").select("slug, title, status").eq("bylaw_id", bylaw.id)`. No join table needed -- there is no `bylaw_matters` table; the relationship is a direct FK on matters. Return matter summaries inline.

All endpoints use `getSupabaseAdminClient()`, `decodeCursor`/`extractPage` from cursor.ts, `listResponse`/`detailResponse` from envelope.ts, and throw `ApiError` for 404s.
  </action>
  <verify>Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` -- should pass with no errors related to the new files.</verify>
  <done>All 9 files exist with correct exports and pass typecheck. Serializers use allowlist pattern. Endpoints use chanfana OpenAPIRoute with proper filters and pagination.</done>
</task>

<task type="auto">
  <name>Task 2: Register matter, motion, and bylaw routes in Hono app</name>
  <files>
    apps/web/app/api/index.ts
  </files>
  <action>
Update `apps/web/app/api/index.ts` to register the 6 new endpoints.

**IMPORTANT:** Plan 02 also modifies index.ts (meetings + people routes). Since Plans 02 and 03 are in the same wave, they may execute in either order. To avoid merge conflicts:
- If Plan 02 has already executed (meetings/people routes present), add after them.
- If Plan 02 has NOT executed, add after the test endpoint block and leave space for meetings/people routes to be added.
- Use a clear comment block to delineate each entity group.

1. Import endpoint classes:
   ```typescript
   import { ListMatters } from "./endpoints/matters/list";
   import { GetMatter } from "./endpoints/matters/detail";
   import { ListMotions } from "./endpoints/motions/list";
   import { GetMotion } from "./endpoints/motions/detail";
   import { ListBylaws } from "./endpoints/bylaws/list";
   import { GetBylaw } from "./endpoints/bylaws/detail";
   ```

2. Register routes with per-route middleware chaining (same pattern as Phase 15):
   ```typescript
   // Matters
   app.use("/api/v1/:municipality/matters", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/matters", ListMatters);
   app.use("/api/v1/:municipality/matters/:slug", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/matters/:slug", GetMatter);

   // Motions
   app.use("/api/v1/:municipality/motions", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/motions", ListMotions);
   app.use("/api/v1/:municipality/motions/:slug", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/motions/:slug", GetMotion);

   // Bylaws
   app.use("/api/v1/:municipality/bylaws", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/bylaws", ListBylaws);
   app.use("/api/v1/:municipality/bylaws/:slug", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/bylaws/:slug", GetBylaw);
   ```

3. Keep all existing routes unchanged.
  </action>
  <verify>Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` -- passes. Verify index.ts imports all 6 new endpoint classes and registers 6 route pairs.</verify>
  <done>Hono app registers matter, motion, and bylaw list/detail routes with auth + rate-limit + municipality middleware. Typecheck passes.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes in apps/web/
2. All 9 new files exist: 3 serializers + 6 endpoints
3. index.ts has 6 new route registrations with proper middleware chain
4. Serializers use allowlist pattern (no `...row` spread)
5. List endpoints accept cursor, per_page, and entity-specific filters
6. Detail endpoints look up by slug, return 404 ApiError if not found
7. Motion detail includes roll call votes array
8. Matter detail includes timeline of agenda items sorted by date
</verification>

<success_criteria>
- GET /api/v1/:municipality/matters returns paginated matters with filters
- GET /api/v1/:municipality/matters/:slug returns matter with agenda item timeline
- GET /api/v1/:municipality/motions returns paginated motions with filters
- GET /api/v1/:municipality/motions/:slug returns motion with roll call votes
- GET /api/v1/:municipality/bylaws returns paginated bylaws with filters
- GET /api/v1/:municipality/bylaws/:slug returns bylaw with linked matters
- All responses use consistent { data, pagination, meta } envelope
</success_criteria>

<output>
After completion, create `.planning/phases/16-core-data-search-api/16-03-SUMMARY.md`
</output>
