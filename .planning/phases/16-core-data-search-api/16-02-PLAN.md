---
phase: 16-core-data-search-api
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - apps/web/app/api/serializers/meeting.ts
  - apps/web/app/api/serializers/person.ts
  - apps/web/app/api/endpoints/meetings/list.ts
  - apps/web/app/api/endpoints/meetings/detail.ts
  - apps/web/app/api/endpoints/people/list.ts
  - apps/web/app/api/endpoints/people/detail.ts
  - apps/web/app/api/index.ts
autonomous: true
requirements: [DATA-01, DATA-02, DATA-03, DATA-04]

must_haves:
  truths:
    - "API consumer can list meetings with cursor pagination and filters (date range, type, has_transcript, organization) at GET /api/v1/:municipality/meetings"
    - "API consumer can get meeting detail with agenda items, motions, and attendance at GET /api/v1/:municipality/meetings/:slug"
    - "API consumer can list people with filters (is_councillor, name search) at GET /api/v1/:municipality/people"
    - "API consumer can get person detail with memberships and voting summary at GET /api/v1/:municipality/people/:slug"
  artifacts:
    - path: "apps/web/app/api/serializers/meeting.ts"
      provides: "Meeting summary and detail serializers"
      exports: ["serializeMeetingSummary", "serializeMeetingDetail"]
    - path: "apps/web/app/api/serializers/person.ts"
      provides: "Person summary and detail serializers"
      exports: ["serializePersonSummary", "serializePersonDetail"]
    - path: "apps/web/app/api/endpoints/meetings/list.ts"
      provides: "ListMeetings chanfana endpoint class"
      exports: ["ListMeetings"]
    - path: "apps/web/app/api/endpoints/meetings/detail.ts"
      provides: "GetMeeting chanfana endpoint class"
      exports: ["GetMeeting"]
    - path: "apps/web/app/api/endpoints/people/list.ts"
      provides: "ListPeople chanfana endpoint class"
      exports: ["ListPeople"]
    - path: "apps/web/app/api/endpoints/people/detail.ts"
      provides: "GetPerson chanfana endpoint class"
      exports: ["GetPerson"]
  key_links:
    - from: "apps/web/app/api/endpoints/meetings/list.ts"
      to: "apps/web/app/api/lib/cursor.ts"
      via: "cursor pagination for meeting list"
      pattern: "decodeCursor|extractPage"
    - from: "apps/web/app/api/endpoints/meetings/list.ts"
      to: "apps/web/app/api/lib/envelope.ts"
      via: "listResponse wrapper"
      pattern: "listResponse"
    - from: "apps/web/app/api/endpoints/meetings/detail.ts"
      to: "apps/web/app/api/serializers/meeting.ts"
      via: "serializeMeetingDetail for response body"
      pattern: "serializeMeetingDetail"
    - from: "apps/web/app/api/index.ts"
      to: "apps/web/app/api/endpoints/meetings/list.ts"
      via: "route registration in Hono app"
      pattern: "ListMeetings|GetMeeting"
---

<objective>
Implement meetings and people REST endpoints with list + detail views, cursor pagination, filters, serializers, and route registration.

Purpose: Meetings and people are the two most-accessed entity types. These 4 endpoints (list meetings, get meeting, list people, get person) establish the pattern for all subsequent entity endpoints and deliver the highest-value data to API consumers first.

Output: 2 serializer modules, 4 chanfana endpoint classes, and updated route registration in index.ts.
</objective>

<execution_context>
@/Users/kyle/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kyle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/16-core-data-search-api/16-RESEARCH.md
@.planning/phases/16-core-data-search-api/16-01-SUMMARY.md
@apps/web/app/api/index.ts
@apps/web/app/api/types.ts
@apps/web/app/api/lib/api-errors.ts
@apps/web/app/api/lib/cursor.ts
@apps/web/app/api/lib/envelope.ts
@apps/web/app/services/meetings.ts
@apps/web/app/services/people.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create meeting and person serializers plus list/detail endpoints</name>
  <files>
    apps/web/app/api/serializers/meeting.ts
    apps/web/app/api/serializers/person.ts
    apps/web/app/api/endpoints/meetings/list.ts
    apps/web/app/api/endpoints/meetings/detail.ts
    apps/web/app/api/endpoints/people/list.ts
    apps/web/app/api/endpoints/people/detail.ts
  </files>
  <action>
**Serializers** (allowlist pattern -- explicitly list included fields, never spread `...row`):

**meeting.ts:**
- `serializeMeetingSummary(row)` -- Returns: `{ slug, title, date (from meeting_date), type, has_agenda, has_minutes, has_transcript, organization (row.organization?.name ?? null), summary }`. All fields snake_case. Null fields included explicitly.
- `serializeMeetingDetail(row, related)` -- Returns: `{ ...summary fields, video_url, minutes_url, agenda_url, video_duration_seconds, chair (slug + name object or null), agenda_items (array of { slug, title, item_number, type } summaries), motions (array of { slug, text (plain_english_summary or text_content truncated to 200 chars), result, mover_name, seconder_name } summaries), attendance (array of { person_slug, person_name, role, present } summaries) }`.
- Also export `serializeAgendaItemSummary(item)` and `serializeAttendanceSummary(record)` as helper serializers.

**person.ts:**
- `serializePersonSummary(row)` -- Returns: `{ slug, name, is_current_councillor (derive from active membership), party (null for municipal -- BC has no parties), image_url (null for now) }`.
- `serializePersonDetail(row, related)` -- Returns: `{ ...summary fields, memberships (array of { organization_name, role, start_date, end_date }), voting_summary ({ total_votes, votes_for, votes_against, abstentions } from vote counts) }`.

**Endpoints** (extend chanfana `OpenAPIRoute` with Zod schema validation):

**meetings/list.ts -- ListMeetings:**
- Schema request.query: `cursor` (optional string), `per_page` (coerce number, min 1, max 100, default 20), `type` (optional string -- meeting type filter), `date_from` (optional string YYYY-MM-DD), `date_to` (optional string YYYY-MM-DD), `has_transcript` (optional coerce boolean), `organization` (optional string -- organization slug filter).
- Handler: Get municipality from `c.get("municipality")`. Build Supabase query on `meetings` table selecting necessary columns + `organization:organizations(name, slug)`. Apply filters with `.eq()`, `.gte()`, `.lte()`. Apply cursor pagination using `decodeCursor` for keyset `(meeting_date DESC, id DESC)`. Fetch `per_page + 1` rows. Use `extractPage` to determine has_more + build next_cursor. Map through `serializeMeetingSummary`. Return via `listResponse`.
- Use `getSupabaseAdminClient()` for all queries (bypasses RLS -- API key auth already verified).

**meetings/detail.ts -- GetMeeting:**
- Schema request.params: `slug` (string), `municipality` (string).
- Handler: Query `meetings` by slug + municipality_id with `.maybeSingle()`. If not found, throw `ApiError(404, "MEETING_NOT_FOUND", ...)`. Fetch related data in parallel via `Promise.all()`: agenda_items (with nested motions), attendance records (with person join). Serialize via `serializeMeetingDetail`. Return via `detailResponse`.
- Related data approach (per locked decision): Inline compact summaries (slug, title, id-level fields), NOT full nested objects.

**people/list.ts -- ListPeople:**
- Schema request.query: `cursor` (optional), `per_page` (default 20, max 100), `is_councillor` (optional coerce boolean), `name` (optional string -- partial name search).
- Handler: Query `people` with optional filters. For `is_councillor`, join with memberships to check for active council membership. For `name`, use `.ilike("name", `%${name}%`)`. Sort by `name ASC, id ASC`. Apply cursor pagination. Map through `serializePersonSummary`. Return via `listResponse`.

**people/detail.ts -- GetPerson:**
- Schema request.params: `slug`, `municipality`.
- Handler: Query person by slug + municipality_id. If not found, throw `ApiError(404, "PERSON_NOT_FOUND", ...)`. Fetch memberships and vote counts in parallel. Serialize via `serializePersonDetail`. Return via `detailResponse`.
- Voting summary: Query `votes` table grouped by `vote_value` WHERE `person_id = person.id`, aggregate counts.
  </action>
  <verify>Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` -- should pass with no errors related to the new endpoint files.</verify>
  <done>All 6 files exist with correct exports and pass typecheck. Serializers use allowlist pattern (no `...row` spread). Endpoints use chanfana OpenAPIRoute with Zod schemas.</done>
</task>

<task type="auto">
  <name>Task 2: Register meeting and people routes in Hono app</name>
  <files>
    apps/web/app/api/index.ts
  </files>
  <action>
Update `apps/web/app/api/index.ts` to register the 4 new endpoints:

1. Import the endpoint classes:
   ```typescript
   import { ListMeetings } from "./endpoints/meetings/list";
   import { GetMeeting } from "./endpoints/meetings/detail";
   import { ListPeople } from "./endpoints/people/list";
   import { GetPerson } from "./endpoints/people/detail";
   ```

2. Register middleware + routes following the established pattern from Phase 15 (per-route auth middleware chaining):

   ```typescript
   // Meetings
   app.use("/api/v1/:municipality/meetings", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/meetings", ListMeetings);
   app.use("/api/v1/:municipality/meetings/:slug", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/meetings/:slug", GetMeeting);

   // People
   app.use("/api/v1/:municipality/people", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/people", ListPeople);
   app.use("/api/v1/:municipality/people/:slug", apiKeyAuth, rateLimit, municipality);
   openapi.get("/api/v1/:municipality/people/:slug", GetPerson);
   ```

3. Keep existing routes (health, test) unchanged. Add new routes AFTER the existing test endpoint block.

Verify the route registration doesn't break existing endpoints by checking that the health endpoint still works conceptually (no runtime test needed -- typecheck is sufficient).
  </action>
  <verify>Run `cd /Users/kyle/development/viewroyal/apps/web && pnpm typecheck` -- passes. Verify the index.ts file imports all 4 new endpoint classes and registers 4 new route pairs (middleware + openapi.get).</verify>
  <done>Hono app registers meeting and people list/detail routes with auth + rate-limit + municipality middleware. Existing routes unchanged. Typecheck passes.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes in apps/web/
2. All 6 new files exist: 2 serializers + 4 endpoints
3. index.ts has 4 new route registrations with proper middleware chain
4. Serializers use allowlist pattern (explicitly construct new objects, never `...row`)
5. List endpoints accept cursor, per_page, and entity-specific filters
6. Detail endpoints look up by slug, return 404 ApiError if not found
7. All responses use listResponse/detailResponse envelope helpers
</verification>

<success_criteria>
- GET /api/v1/:municipality/meetings returns paginated meeting list with filters
- GET /api/v1/:municipality/meetings/:slug returns meeting detail with inline agenda item, motion, and attendance summaries
- GET /api/v1/:municipality/people returns paginated people list with filters
- GET /api/v1/:municipality/people/:slug returns person detail with memberships and voting summary
- All responses use consistent { data, pagination, meta } envelope
</success_criteria>

<output>
After completion, create `.planning/phases/16-core-data-search-api/16-02-SUMMARY.md`
</output>
